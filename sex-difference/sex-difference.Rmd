---
title: "Drivers of sex differences in consumption"
author: "Scott Olesen"
date: "2/24/2017"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE)
```

# Background

Why do females account for 25% more antibiotic claims per capita than males? I have two easy explanations:

- More females are alive at later ages, and older people consume more antibiotics.
- Females consume more of the same antibiotics.
- Females consume different antibiotics.

# Methods

I'll use the Medicare 2011 data. Or, use all years, pool that data, and include calendar year as part of the regression.

*Outcome*: At least one claim for azithromycin, Bactrim, TMP/SMX, or nitrofurantoin. *Exposure*: A diagnosis with a UTI, COPD, or an acute RTI.

- In the first pass, look for any claim and any diagnosis.
- In a second pass, look for a diagnosis that came at most two weeks before a claim.
- Maybe, in a third pass, look for diagnosis that came at most two weeks before the first claim for that drug for the beneficiary. (Imagine someone is on year-long prophylaxis. Then a diagnosis at any time of the year will make it look like the diagnosis caused the claims.)

Before a model, I should just stratify by sex and exposure. Do we already see the signal (or lack of it)? Then we can go onto including age and calendar year as covariates.

```{r load_data}
year = 2011
bene = read_tsv(sprintf('../bene_%i.tsv', year)) %>%
  mutate(is_female=sex=='female', is_white=race=='white')

pde = read_tsv(sprintf('../pde_%i.tsv', year))

sex_icd = read_tsv('sex_codes.tsv', col_types=cols(code='c')) %>%
  rename(dx_code=code, dx_desc=short_desc)
```

```{r load_dx}
dx = read_tsv(sprintf('../../data/dx/dx_car_claims_%i.tsv', year), col_types=cols(diagnosis='c')) %>%
  select(bene_id=BENE_ID, dx_code=diagnosis) %>%
  left_join(sex_icd, by='dx_code')

dx_counts = dx %>%
  count(dx_code)

total_pde = pde %>% count(bene_id) %>% rename(n_claims=n)
```

## Diagnostic codes and counts

```{r}
sex_icd %>%
  left_join(dx_counts, by='dx_code') %>%
  kable
```

# Results

## Consumption by age and sex

It seems that females consume more antibiotics even within each age bracket (except for those over 95).

```{r consumption_by_age_and_sex}
bene %>%
  left_join(total_pde, by='bene_id') %>%
  replace_na(list(n_claims=0)) %>%
  group_by(sex, age) %>%
  summarize(mean_n_claims=mean(n_claims)) %>%
  ungroup() %>%
  ggplot(aes(x=age, y=mean_n_claims, color=sex)) +
  geom_point()
```

## Consumption of drugs by sex

Looking at top drugs by sex.

```{r drugs_by_sex}
usage_by_sex = function(drug) {
  bene %>%
    left_join(pde %>% filter(antibiotic==drug) %>% count(bene_id) %>% rename(n_claims=n), by='bene_id') %>%
    replace_na(list(n_claims=0)) %>%
    group_by(sex) %>%
    summarize(mean_n_claims=mean(n_claims)) %>%
    ungroup() %>%
    spread(sex, mean_n_claims) %>%
    mutate(drug=drug)
}

dbs = lapply(unique(pde$antibiotic), usage_by_sex) %>% bind_rows
```

```{r}
denom = bene %>% count(sex) %>% rename(n_denom=n)
ubs = pde %>%
  select(bene_id, antibiotic) %>%
  distinct() %>%
  left_join(select(bene, bene_id, sex), by='bene_id') %>%
  count(sex, antibiotic) %>%
  ungroup() %>%
  rename(n_user=n) %>%
  left_join(denom, by='sex') %>%
  mutate(frac_using=n_user/n_denom) %>%
  select(antibiotic, sex, frac_using) %>%
  spread(sex, frac_using)
```

```{r drug_by_sex_plot}
ubs %>%
  mutate(highlight=antibiotic %in% c('azithromycin', 'ciprofloxacin', 'trimethoprim/sulfamethoxazole', 'fosfomycin', 'nitrofurantoin')) %>%
  ggplot(aes(x=male, y=female, label=antibiotic, color=highlight)) +
  geom_text() +
  geom_point() +
  geom_abline() +
  xlab('claims per 1,000 male beneficiaries') +
  ylab('claims per 1,000 female beneficiaries') +
  theme_minimal() +
  coord_fixed()
```

For a more quantitative approach, this is a table showing, for each antibiotic, the CPKP for female and males, the difference (residual) between the two, and the residual fraction (the residual over the mean of the female and male consumptions). Positive residuals means more consumption by females.

```{r}
dbs %>% head %>% kable
```

```{r drug_by_sex_residuals, eval=FALSE}
dbs %>%
  select(antibiotic, sex, cpkp) %>%
  spread(sex, cpkp) %>%
  mutate(residual=female-male, residual_fraction=residual/(0.5 * (male + female))) %>%
  arrange(desc(abs(residual))) %>%
  head(10) %>%
  kable
```

## Azithromycin

Nitrofurantoin, ciprofloxacin, and TMP-SMX are all used as urinary anti-infectives, and UTIs more commonly affect women. This does not explain, however, the increased consumption of azithromycin.

```{r women_azithro_vs_uai, eval=FALSE}
any_in = function(lst, elts) match(elts, lst) %>% { .[!is.na(.)] } %>% { length(.) > 0 }

usage %>%
  filter(age >= 65, sex=='female') %>%
  group_by(bene_id) %>%
  mutate(used_azithro='azithromycin' %in% antibiotic,
         used_uai=any_in(antibiotic, c('nitrofurantoin', 'trimethoprim/sulfamethoxazole', 'ciprofloxacin')),
         used_both=used_azithro && used_uai,
         is_white=race=='white') %>%
  ungroup() %>%
  mutate(user_type=case_when(.$used_both ~ 'both',
                             .$used_azithro ~ 'azithro',
                             .$used_uai ~ 'UAI',
                             TRUE ~ 'none')) %>%
  group_by(bene_id) %>%
  summarize(age=age[1],
            is_white=is_white[1],
            chronic=chronic[1],
            user_type=user_type[1],
            n_claims=sum(n_claims)) %>%
  group_by(user_type) %>%
  summarize(n_beneficiaries=n(),
            mean_age=mean(age),
            percent_white=mean(is_white)*100,
            mean_n_chronic_cond=mean(chronic),
            mean_n_claims=mean(n_claims)) %>%
  arrange(desc(n_beneficiaries)) %>%
  kable
```

Does that mean that:

- women are older and therefore use more azithromycin,
- women have more chronic conditions (esp. COPD) and therefore use more, or
- women have more encounters with doctors and therefore are prescribed more?

### Sex by age

The older people are more female: age 65 is about 60% female. This stays constant around 60% (or dips slightly) until age 75, when it steadily increases up to 85-90% female at age 100. So we'll need to account for this age difference.

```{r sex_by_age, eval=FALSE}
plot_dat = usage %>%
  select(age, sex) %>%
  filter(sex %in% c('male', 'female')) %>%
  group_by(age) %>% count(sex) %>% ungroup() %>%
  spread(sex, n, fill=0L) %>%
  mutate(total=female+male, grand_total=sum(total),
         fraction_year=total/grand_total, fraction_female=female/total)

ggplot(mapping=aes(x=age, y=fraction)) +
  geom_point(data=rename(plot_dat, fraction=fraction_female)) +
  geom_line(data=mutate(plot_dat, fraction=fraction_year*10), col='red') +
  ylab('fraction female') + ylim(0, 1) +
  theme_minimal()
```

### Chronic conditions

Cf. the chronic conditions report.

### Encounters by sex

Do women have more encounters than men? Does that explain their increased usage?

```{r load_carrier_data, eval=FALSE}
carrier = read_tsv('../../data/carrier_count_2011.tsv') %>%
  rename(bene_id=BENE_ID, n_carrier_dates=n_from_dates)

inpatient = read_tsv('../../data/inpatient_count_2011.tsv') %>%
  rename(bene_id=BENE_ID, n_inpatient_dates=n_from_dates)

outpatient = read_tsv('../../data/outpatient_count_2011.tsv') %>%
  rename(bene_id=BENE_ID, n_outpatient_dates=n_from_dates)

denom = usage %>% select(bene_id, sex, age) %>% distinct
```

```{r azithromycin_usage}
na_to_zero = function(x) if_else(is.na(x), 0L, x)

azi_usage = usage %>%
  filter(antibiotic=='azithromycin') %>%
  group_by(bene_id) %>%
  summarize(n_claims=sum(n_claims)) %>%
  left_join(denom, by='bene_id') %>%
  filter(age >= 65, sex %in% c('male', 'female')) %>%
  left_join(carrier, by='bene_id') %>%
  left_join(inpatient, by='bene_id') %>%
  left_join(outpatient, by='bene_id') %>%
  mutate(age_group=bounds_group(age, c(65, 75, 85, 95))) %>%
  mutate_at(vars(n_claims, n_carrier_dates, n_inpatient_dates, n_outpatient_dates), na_to_zero)
```

```{r azithromycin_usage_table}
azi_usage %>%
  group_by(age_group, sex) %>%
  summarize(n_beneficiaries=n(),
            mean_n_azithromycin_claims=mean(n_claims),
            med_n_carrier_dates=median(n_carrier_dates),
            med_n_outpatient_dates=median(n_outpatient_dates),
            med_n_inpatient_dates=median(n_inpatient_dates)) %>%
  kable
```

And I'll do a Poisson regression of number of azithromycin claims against age, being female, and number of carrier dates:

```{r azithromycin_usage_model}
library(broom)
azi_usage %>%
  mutate(is_female=sex=='female') %>%
  glm(n_claims ~ age + is_female + n_carrier_dates + n_inpatient_dates + n_outpatient_dates, data=., family='poisson') %>%
  tidy %>%
  mutate(pct.increase=round((exp(estimate)-1.0)*100, 2)) %>%
  kable
```

The coefficient for being female (0.05) accounts for almost the entire difference in consumption between men and women (56 per thousand). Note that age has an approximately zero correlation (i.e.,
