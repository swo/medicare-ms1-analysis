---
title: "Drivers of sex differences in consumption (NAMCS)"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE)

import::from(survey, svyglm)
import::from(survey, svydesign)
```

```{r load_data}
sex_codes = read_tsv('namcs_sex_codes.tsv') %>%
  rename(dx=code)

dx = read_tsv('../../db/namcs/data/namcs_2014_dx.tsv') %>%
  left_join(sex_codes, by='dx')

dx_visit = dx %>%
  group_by(visit_id) %>%
  summarize(uti='uti' %in% diagnosis_type,
            skin='skin' %in% diagnosis_type,
            vaginitis='vaginitis' %in% diagnosis_type)

top_abx = read_tsv('../../db/namcs/analysis/top_abx.tsv')

# abx_drug_codes = read_tsv('../../db/namcs/drug-codes/abx-codes.tsv') %>%
#   select(drug_code, antibiotic) %>%
#   mutate(antibiotic=tolower(antibiotic))

drug = read_tsv('../../db/namcs/data/namcs_2014_drugs.tsv')

abx = top_abx %>% left_join(drug, by='desc')

abx_visit = abx %>%
  select(visit_id, abx) %>%
  distinct() %>%
  mutate(value=TRUE) %>% spread(abx, value) %>%
  mutate(any_abx=TRUE)

visit = read_tsv('../../db/namcs/data/namcs_2014_visits.tsv') %>%
  left_join(dx_visit, by='visit_id') %>%
  replace_na(list(uti=FALSE, skin=FALSE, vaginitis=FALSE)) %>%
  left_join(abx_visit, by='visit_id') %>%
  mutate_at(c('any_abx', top_abx$abx), function(x) !is.na(x))
```

# Methods

## Data & overall methods

I used the 2014 NAMCS data. Because this is a survey, you can't just look at the individual records; they all need to be weighted, and the variances need to be adjusted by the stratum sampling used. I rely on the `survey` package, to which the entry point is the `svydesign` function, for which I use:

- NAMCS's `CPSUM` variable for `ids`
- `CSTRATM` for `strata`
- `PATWT` for `weights`

## The most-consumed antibiotics

I wanted to focus my analysis on the top few most important antibiotics. The NAMCS data includes information about the therapeutic category of each drug. I looked through those categories and identified the ones that could refer to antibiotics.

```{r abx_cat_table}
abx_cat = read_tsv('../../db/namcs/data/parse/drug_codes/abx_codes.tsv')
abx_cat %>% kable
```

Then I looked through all the drugs that fell into one of these categories, summed up their usage, and then looked at the names of the top 20 drugs:

```{r find_top_abx}
drug %>%
  semi_join(abx_cat, by=c('cat1'='category')) %>%
  select(visit_id, desc) %>%
  left_join(select(visit, visit_id, survey_id, stratum, weight), by='visit_id') %>%
  mutate(dummy=1) %>%
  svydesign(data=., ids=~survey_id, strata=~stratum, weights=~weight) %>%
  svyby(~dummy, ~desc, design=., svytotal) %>%
  arrange(desc(dummy)) %>%
  select(abx=desc, n_rx=dummy, se) %>%
  mutate(f=100*round(n_rx/sum(n_rx), 2),
         cum_f_rx=100*round(cumsum(n_rx/sum(n_rx)), 2),
         relative_se=100*round(se/n_rx, 2)) %>%
  select(drug=abx, `fraction (%)`=f, `relative SE (%)`=relative_se, `cumulative fraction (%)`=cum_f_rx) %>%
  head(15) %>%
  kable
```

I kept the drugs from azithromycin through clindamycin. I skipped moxifloxacin because it has a high relative SE and mostly won't make it through future analyses. I keep nitrofurantoin because it's interesting from the Medicare data.

# Results

## Overall consumption by sex

Overall, more of the antibiotic claims were made by women. Women consume roughly 21% more antibiotics than men.

```{r sex_total_odds}
drug %>%
  semi_join(abx_cat, by=c('cat1'='category')) %>%
  select(visit_id, desc) %>%
  left_join(select(visit, visit_id, sex, survey_id, stratum, weight), by='visit_id') %>%
  mutate(dummy=1) %>%
  svydesign(data=., ids=~survey_id, strata=~stratum, weights=~weight) %>%
  svyby(~dummy, ~sex, design=., svytotal) %>%
  mutate_at(vars(-sex), function(x) x/1e6) %>%
  mutate(fraction=dummy/sum(dummy),
         odds=fraction/min(fraction)) %>%
  select(sex, `no. rx. (millions)`=dummy, `SE (millions)`=se, odds) %>%
  kable
```

```{r models}
des = visit %>%
  mutate(sex=factor(sex, levels=c('male', 'female'))) %>%
  as.data.frame() %>%
  svydesign(data=., id=~survey_id, strata=~stratum, weights=~weight)

abx_total_f = function(abx) {
  svyby(as.formula(paste0('~', abx)), ~sex, des, svytotal) %>%
    rename_(.dots=setNames(list(paste0(abx, 'TRUE'), paste0('se.', abx, 'TRUE')), c('total', 'se'))) %>%
    select(sex, total, se) %>%
    mutate(abx=abx)
}

chisq_f = function(abx) {
  svychisq(as.formula(paste0('~sex+', abx)), des) %>%
    tidy %>%
    mutate(abx=abx) %>%
    select(abx, p.value)
}

ttest_f = function(abx) {
  svyttest(as.formula(paste0(abx, '~sex')), des) %>%
    tidy %>%
    mutate(abx=abx) %>% select(abx, estimate, p.value)
}

abx_totals = lapply(top_abx$abx, abx_total_f) %>% bind_rows()
abx_chisq = lapply(top_abx$abx, chisq_f) %>% bind_rows()
abx_ttest = lapply(top_abx$abx, ttest_f) %>% bind_rows()
```

For each drug, I asked how many visits were made, stratified by sex. I show two lines on the graph. The lower lines is exactly $y=x$ and shows the line of equal consumption. The upper line has a slope equal to the odds of a visit belong to a female; this is the line of equal consumption per visit. 

```{r total_plot}
abx_totals %>%
  mutate_at(vars(total, se), function(x) x/1e6) %>%
  mutate(ci=se*1.96,
         ci_low=total-ci,
         ci_high=total+ci) %>%
  select(abx, sex, total, ci_low, ci_high) %>%
  gather('key', 'value', total:ci_high) %>%
  mutate(key=case_when(.$sex=='male' & .$key=='total' ~ 'x',
                       .$sex=='male' & .$key=='ci_low' ~ 'xmin',
                       .$sex=='male' & .$key=='ci_high' ~ 'xmax',
                       .$sex=='female' & .$key=='total' ~ 'y',
                       .$sex=='female' & .$key=='ci_low' ~ 'ymin',
                       .$sex=='female' & .$key=='ci_high' ~ 'ymax')) %>%
  select(-sex) %>%
  spread(key, value) %>%
  mutate(ymin=if_else(ymin<0, 0, ymin)) %>% # fix the negative ymin for moxi
  mutate(highlight=abx %in% c('nitro')) %>%
  ggplot(aes(x=x, xmin=xmin, xmax=xmax, y=y, ymin=ymin, ymax=ymax, label=abx, color=highlight)) +
  geom_abline(col='gray') + geom_abline(slope=1.21277, col='gray') +
  geom_point() + geom_errorbar() + geom_errorbarh() +
  scale_color_manual(values=c('black', 'red')) +
  geom_text(nudge_x=1, nudge_y=0.5) +
  scale_x_continuous(breaks=c(0, 5, 10), limits=c(0, 10)) + xlab('No. rx. for men (millions)') +
  scale_y_continuous(breaks=c(0, 5, 10), limits=c(0, 12)) + ylab('No. rx. for women (millions)') +
  coord_fixed() +
  theme_minimal()
```

Caveat: As per NAMCS recommendations, the male/nitro combination is too small (20 records) and too disperse (relative standard error 31%) to be considered accurate, and the female/moxi combination is too disperse (RSE 56%) to be considered accurate. (The female/moxi error bar actually doesn't even fit on the page!)

## Claims per visit

To examine claims per visit (the upper line), I run $\chi^2$ tests of independence on the 2x2 contingency tables: female vs. male, this drug prescribed vs. not. Nitrofurantoin is definitely distributed differently (minding the caveat mentioned above), and amoxicillin and amox/clav only marginally so (they are the two crosses that could maybe be falling *below* the line of equal consumption per visit; i.e., men getting more of those drugs per visit).

```{r chisq_table}
scientific_round = function(x, digits) {
  if_else(round(x, digits) == 0, sprintf(paste0('%.', as.character(digits), 'g'), x), as.character(round(x, digits)))
}

abx_chisq %>%
  arrange(p.value) %>%
  mutate(p.value.adj=p.adjust(p.value, method='BH')) %>%
  mutate_at(vars(-abx), function(x) scientific_round(x, 3)) %>%
  kable
```

## Claims overall

To evaluate the difference in overall numbers of claims by sex, I use *t*-tests. Again, nitro is the only clear deviation.

```{r ttest_table}
abx_ttest %>%
  arrange(p.value) %>%
  mutate(p.value.adj=p.adjust(p.value, method='BH')) %>%
  mutate_at(vars(-abx), function(x) scientific_round(x, 3)) %>%
  kable
```

# Conclusions

Women definitely have more prescriptions overall than men, and definitely more nitrofurantoin prescriptions. However, the difference in nitrofurantoin prescriptions (slightly less than 2 million) is a small fraction of the total difference in prescriptions (about 11 million).

Broadly speaking, it seems like the increased consumption of antibiotics among women is mostly due to increased healthcaure utilization. Unfortunately, NAMCS doesn't have enough data (at least from a single year) to be able to show that any particular drug beyond nitrofurantoin is definitely consumed more among women than men.

Interestingly, there are some hints that amox and amox/clav, though consumed at nearly-equal rates overall, are prescribed at a lower rate *per visit* for women.

The lack of power in this single year motivates either adding more years and/or moving toward Medicare.
