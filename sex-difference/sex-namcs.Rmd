---
title: "Drivers of sex differences in consumption (NAMCS)"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE)

library(survey)
```

```{r load_data}
# Caveat: I removed a stratum from the 2011 data that had only one PSU in it.
# Also: I'm not sure that combining years like this is going to be kosher.

years = 2011:2014
n_years = length(years)
mpy = function(x) x/(1e6 * n_years) # millions per year

read_tsv_years = function(fn_template, ...) {
  f = function(y) sprintf(fn_template, y) %>% read_tsv(..., guess_max=1e6) %>% mutate(year=y, visit_id=paste0(y, '_', visit_id))
  lapply(years, f) %>% bind_rows
}

sex_codes = read_tsv('namcs_sex_codes.tsv') %>%
  rename(dx=code)

dx = read_tsv_years('../../db/namcs/data/namcs_dx_%i.tsv') %>%
  left_join(sex_codes, by='dx')

dx_visit = dx %>%
  group_by(visit_id) %>%
  summarize(uti='uti' %in% diagnosis_type,
            acne='acne' %in% diagnosis_type,
            arc='acute_rc' %in% diagnosis_type)

top_abx = read_tsv('../../db/namcs/analysis/top_abx.tsv')
abx_cat = read_tsv('../../db/namcs/data/parse/drug_codes/abx_codes.tsv')

drugs = read_tsv_years('../../db/namcs/data/namcs_drugs_%i.tsv') %>%
  mutate(is_abx=cat1 %in% abx_cat$category)

n_abx = drugs %>%
  filter(is_abx) %>%
  group_by(visit_id) %>%
  summarize(n_abx=n())

abx_visit = left_join(top_abx, drugs, by='desc') %>%
  count(visit_id, abx) %>% ungroup() %>%
  spread(abx, n)

visits = read_tsv_years('../../db/namcs/data/namcs_visits_%i.tsv') %>%
  mutate(age_group=case_when(.$age <= 19 ~ 'child',
                             .$age <= 64 ~ 'adult',
                             .$age <= 92 ~ 'elderly')) %>%
  left_join(dx_visit, by='visit_id') %>%
  replace_na(list(uti=FALSE, acne=FALSE, arc=FALSE)) %>%
  left_join(n_abx, by='visit_id') %>% replace_na(list(n_abx=0)) %>%
  left_join(abx_visit, by='visit_id') %>%
  mutate_at(top_abx$abx, function(x) if_else(is.na(x), 0L, x))

filter_strata = function(df) {
  bad_strata = select(df, survey_id, stratum) %>% distinct() %>% count(stratum) %>% filter(n==1) %$% stratum
  filter(df, !(stratum %in% bad_strata))
}

design_f = function(df) {
  filter_strata(df) %>%
    as.data.frame() %>%
    svydesign(data=., ids=~survey_id, strata=~stratum, weights=~weight, nest=TRUE)
}

design = design_f(visits)
adult_design = subset(design, age_group != 'child')
```

# Methods

## Data & overall methods

I used the 2014 NAMCS data. Because this is a survey, you can't just look at the individual records; they all need to be weighted, and the variances need to be adjusted by the stratum sampling used. I rely on the `survey` package, to which the entry point is the `svydesign` function, for which I use:

- NAMCS's `CPSUM` variable for `ids`
- `CSTRATM` for `strata`
- `PATWT` for `weights`

All numbers of prescriptions will be presented in millions per year.

# Results

## In children, overall consumption is similar between the sexes

I show total consumption (in millions of prescriptions per year) for the three age groups (children 0-19, adults 20-64, elderly 64-92+). Consumption is similar between the sexes for children. (This probably isn't a surprise, since we don't expect that children have many UTIs or display large differences in healthcare seeking.) Therefore, I'll consider only adults for the rest of this analysis.

```{r children}
svyby(~n_abx, ~sex+age_group, design=design, svytotal) %>%
  mutate_at(vars(n_abx, se), mpy) %>%
  group_by(age_group) %>%
  mutate(odds=n_abx/min(n_abx),
         ci=1.96*se) %>%
  select(age_group, sex, n_abx, `95% CI (one side)`=ci, odds) %>%
  kable
```

## Most-consumed drugs

The common explanation about differences in consumption is that women experience more UTIs than men. We therefore expect that the difference between the sexes will be mostly due to consumption of a few drugs (i.e., ciprofloxacin, TMP/SMX, nitrofurantoin). To simplify analysis, I'll focus on a few of the most-consumed drugs.

The NAMCS data includes information about the therapeutic category of each drug. I looked through those categories and identified the ones that could refer to antibiotics.

```{r abx_cat_table}
abx_cat %>% kable
```

Then I looked through all the drugs that fell into one of these categories, summed up their usage, and then looked at the names of the top 20 drugs:

```{r find_top_abx}
# get a list of all the antibiotic names
abx_names = drugs %>%
  semi_join(abx_cat, by=c('cat1'='category')) %$%
  unique(desc)

# for each name, count the visits in which it appears
f = function(name) {
  drugs %>%
    filter(desc==name) %>%
    count(visit_id) %>%
    right_join(select(visits, visit_id, age_group, survey_id, stratum, weight), by='visit_id') %>%
    replace_na(list(n=0)) %>%
    design_f() %>%
    subset(age_group != 'child') %>%
    svytotal(~n, design=.) %>%
    as_data_frame() %>%
    mutate(abx=name) %>%
    select(abx, total, se=n)
}

abx_counts = lapply(abx_names, f) %>% bind_rows()
```

```{r top_abx_table}
abx_counts %>%
  arrange(desc(total)) %>%
  mutate(f=100*round(total/sum(total), 2),
         cum_f_rx=100*round(cumsum(total/sum(total)), 2),
         n=1:nrow(.)) %>%
  select(n, drug=abx, `fraction (%)`=f, `cumulative fraction (%)`=cum_f_rx) %>%
  head(15) %>%
  kable
```

I kept the drugs from azithromycin through cefdinir, but excluding clindamycin, accounting for 80% of all prescriptions. I exclude clindamycin because NAMCS doesn't have any information about route of administration. In some cases, the old IDs can be used to distinguish different form, but other times there is no hope. For example, in the 2011 data, there are 118 visits that include clindamycin. In 84 cases, it is just "clindamycin"; in 18, it is "Cleocin" (which can be oral, injected, or vaginal); in 9 cases, it is "clindamycin phosphate", which is normally topical, etc.

## Overall healthcare usage by sex

```{r visit_total_odds}
x = svymean(~sex, design=adult_design) %>%
  as_data_frame() %>%
  mutate(sex=c('female', 'male'))

odds = function(x) x/(1-x)

p = x %>% filter(sex=='female') %$% mean
se = x %>% filter(sex=='female') %$% SE
female_visit_odds = odds(c(p-se, p, p+se))

x %>%
  select(sex, `fraction of visits`=mean, SE) %>%
  kable
```

Overall, more of the visits were made by women. Women make `r round(female_visit_odds[2]-1, 3)*100`% more visits than men.

What fraction of these visits are due to UTIs? We can see what fraction of visits are made for UTIs:

```{r}
svytable(~sex+uti, adult_design) %>%
  as_data_frame() %>%
  mutate(n=mpy(n)) %>%
  kable
```

So of the ~150 million extra visits per year made by women, a difference of ~5 million visits (or 3%) can be attributed to UTIs.

Of the top 3 diagnoses (hypertension, gynecological exam, and observation of pregnancy), two are woman-specific. Those account for 25 million visits per year, or about one-sixth of the total. So the difference is diffuse across diagnoses. Very few antibiotics are prescribed during those visits, less than 1 million per year.

Acute respiration complaints explain another ~5 million:

```{r}
svytable(~sex+arc, adult_design) %>%
  as_data_frame() %>%
  mutate(n=mpy(n)) %>%
  kable
```

## Consumption by drug

I'll therefore evaluate consumption by two standards: first, do women consume more antibiotics overall; second, do women consume more antibiotics *per visit*.

```{r models}
abx_diff_f = function(abx) {
  visits %>%
    mutate(sex_abx=case_when(.$sex == 'female' ~ .[[abx]],
                             .$sex == 'male' ~ -.[[abx]])) %>%
    design_f() %>%
    subset(age_group != 'child') %>%
    svyttest(sex_abx~0, design=.) %$%
    data_frame(abx=abx, estimate=estimate, p.value=p.value)
}

abx_total_f = function(abx, design=adult_design) {
  svyby(as.formula(paste0('~', abx)), ~sex, design, svytotal) %>%
    rename_(.dots=setNames(list(abx), c('total'))) %>%
    select(sex, total, se) %>%
    mutate(abx=abx)
}

poisson_f = function(abx, design=adult_design) {
  svyglm(as.formula(paste0(abx, '~sex')), design) %>%
    tidy %>%
    filter(term != '(Intercept)') %>%
    mutate(abx=abx) %>%
    select(abx, term, estimate, p.value)
}

abx_diff = lapply(top_abx$abx, abx_diff_f) %>% bind_rows()
abx_totals = lapply(top_abx$abx, abx_total_f) %>% bind_rows()
abx_pois = lapply(top_abx$abx, poisson_f) %>% bind_rows()
```

For each drug, I asked how many visits were made, stratified by sex. I show two lines on the graph. The lower line is exactly $y=x$ and shows the line of equal consumption. The upper line has a slope equal to the odds of a visit belong to a female; this is the line of equal consumption per visit. 

```{r total_plot}
total_plot_f = function(df, highlight=character(0)) {
  df %>%
    mutate_at(vars(total, se), mpy) %>%
    mutate(ci=se*1.96,
           ci_low=total-ci,
           ci_high=total+ci) %>%
    select(abx, sex, total, ci_low, ci_high) %>%
    gather('key', 'value', total:ci_high) %>%
    mutate(key=case_when(.$sex=='male' & .$key=='total' ~ 'x',
                         .$sex=='male' & .$key=='ci_low' ~ 'xmin',
                         .$sex=='male' & .$key=='ci_high' ~ 'xmax',
                         .$sex=='female' & .$key=='total' ~ 'y',
                         .$sex=='female' & .$key=='ci_low' ~ 'ymin',
                         .$sex=='female' & .$key=='ci_high' ~ 'ymax')) %>%
    select(-sex) %>%
    spread(key, value) %>%
    mutate(highlight=abx %in% highlight) %>%
    ggplot(aes(x=x, xmin=xmin, xmax=xmax, y=y, ymin=ymin, ymax=ymax, label=abx, color=highlight)) +
    geom_abline(col='gray') +
    geom_point() + geom_errorbar() + geom_errorbarh() +
    scale_color_manual(values=c('black', 'red')) +
    geom_text() +
    #geom_text(nudge_x=1, nudge_y=0.5) +
    #scale_x_continuous(breaks=c(0, 5, 10), limits=c(0, 12)) +
    #scale_y_continuous(breaks=c(0, 5, 10), limits=c(0, 14)) +
    xlab('No. rx. for men (millions)') + ylab('No. rx. for women (millions)') +
    coord_fixed() +
    theme_minimal()
}
  
total_plot_f(abx_totals, highlight=c('nitro', 'clinda')) +
  geom_abline(slope=female_visit_odds[2], col='gray') +
  geom_abline(slope=female_visit_odds[-2], col='gray', linetype='dotted')
```

## Prescriptions overall

To evaluate the difference in overall numbers of prescriptions by sex (i.e., deviations from the $y=x$ line in the plot), I performed a one-sample *t*-test on a kludge variable. This variable is the number of antibiotic prescriptions if the visit was made by a woman and *negative* the number of prescriptions if made by a man. The test asks if this value has mean zero.

As we would expect from examining the chart, almost all the drugs have a mean greater than zero, i.e., consumption is greater among women.

```{r abx_diff_table}
scientific_round = function(x, digits=3) {
  if_else(round(x, digits) == 0, sprintf(paste0('%.', as.character(digits), 'g'), x), as.character(round(x, digits)))
}

sig_f = function(df) {
  stopifnot('adj.p.value' %in% names(df) && 'p.value' %in% names(df))
  case_when(df$adj.p.value < 0.05 ~ '**',
            df$p.value < 0.05 ~ '*',
            TRUE ~ '')
}

abx_diff %>%
  mutate(adj.p.value=p.adjust(p.value, method='BH')) %>%
  mutate(sig=sig_f(.)) %>%
  mutate_if(is.numeric, scientific_round) %>%
  kable
```

## Prescriptions per visit

To examine claims per visit (the upper line), I run Poisson regressions of the number of prescriptions for each drug per visit against sex. The *p*-values here are for the significance of the sex term. Nitro and clinda are enriched among women *per visit*.

```{r pois_table}
abx_pois %>%
  select(abx, estimate, p.value) %>%
  arrange(p.value) %>%
  mutate(adj.p.value=p.adjust(p.value, method='BH')) %>%
  mutate(sig=sig_f(.)) %>%
  mutate_if(is.numeric, scientific_round) %>%
  kable
```

## Nitrofurantoin

Nitrofurantoin prescriptions among women are associated with a number of diagnoses, but only two of them---UTI (`5990-`) and dysuria (`7881-`)---meet the basic requirement for data validity (at least 30 counts). Among men, UTI is the leading diagnosis, but it doesn't meet the data validity requirement (there are only 10 records for nitro prescriptions to a male with a UTI diagnosis in the 4 years of data).

## Just among the elderly

```{r elderly}
elderly_design = subset(design, age_group == 'elderly')

elderly_usage = svymean(~sex, design=elderly_design) %>%
  as_data_frame() %>%
  mutate(sex=c('female', 'male'))

elderly_female_odds = elderly_usage %>% filter(sex=='female') %$% mean %>% odds

elderly_totals = abx_totals = lapply(top_abx$abx, function(x) abx_total_f(x, design=elderly_design)) %>% bind_rows()
total_plot_f(elderly_totals) +
  geom_abline(slope=elderly_female_odds, color='gray')
```

Usage among the elderly is more even: women make `r 100*round(elderly_female_odds - 1, digits=3)`% more visits than men. Patterns of consumption appear to be a little difference: more ciprofloxacin, azithro is more concentrated among women, and some drugs (e.g., doxy) appear to approach the line of equal consumption.

# Conclusions

Women definitely have more prescriptions overall than men, but that consumption seems to be distributed broadly across drugs. For only a few drugs---nitro and clinda---do these data suggest that consumption per visit is greater among women, and those drugs contribute to a minority of the difference in total consumption.

Among the elderly, patterns of consumption appear to be somewhat different, and those patterns are not exactly what we see in the adult NAMCS data or even in the Medicare data I have.
