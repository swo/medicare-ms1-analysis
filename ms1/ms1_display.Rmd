---
title: "Ms 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('pdf', 'png'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE, autodep=TRUE)
import::from(knitr, kable)
import::from(stringr, str_replace, str_detect)
library(forcats)
import::from(tools, md5sum)
```

# Abstract

```{r abstract}
pctize = function(df, denom_name) {
  for (n_name in Filter(function(x) str_detect(x, '^n_'), names(df))) {
    pct_name = str_replace(n_name, '^n_', 'pct_')
    df[[pct_name]] = df[[n_name]] / df[[denom_name]] * 100
  }
  df
}

totals = read_tsv('tables/totals.tsv') %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sd_age, mean_n_cc, sd_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west)

claims_by_abx = read_tsv('tables/claims_by_abx.tsv')

n_million_bene = totals %$% unique(n_bene) %>% { round(. / 1e6, 1) }
n_million_pde = claims_by_abx %$% sum(n) %>% { round(. / 1e6, 1) }

est2pct = function(x) (exp(x) - 1)*100
model_ci = function(df) {
  df %>%
    filter(model=='poisson', term=='year') %>%
    mutate(pct_change=est2pct(estimate),
           ci=1.96*std.error,
           ci_low=est2pct(estimate - ci),
           ci_high=est2pct(estimate + ci),
           change_str=sprintf('%.2f%% (%.2f--%.2f%%)', pct_change, ci_low, ci_high))
}

model_abx = read_tsv('tables/model_abx.tsv') %>%
  model_ci()

total_adjusted_change_str = model_abx %>%
  filter(antibiotic=='overall') %$%
  change_str

azithro_adjusted_change_str = model_abx %>%
  filter(antibiotic=='azithromycin') %$%
  change_str

levo_adjusted_change_str = model_abx %>%
  filter(antibiotic=='levofloxacin') %$%
  change_str
```

There are `r n_million_bene` million beneficiaries and `r n_million_pde` million PDEs. Adjusted total consumption changed by `r total_adjusted_change_str`. Azithromycin changed by `r azithro_adjusted_change_str`. Levofloxacin changed by `r levo_adjusted_change_str`.

# Beneficiary characteristics

In the cohort, all the values remain fixed, except for:

- age
- chronic conditions
- to a lesser degree, dual enrollment
- to a very small degree, geographical location

A star indicates that the trend (*t*-test for mean difference between years equal to zero) is significant after multiple hypothesis correction.

```{r bene_char_table}
trend_p = function(x) tidy(t.test(diff(x)))$p.value
totals_trends = totals %>%
  gather('var', 'val', -year) %>%
  arrange(var, year, val) %>%
  group_by(var) %>%
  summarize(p=trend_p(val)) %>%
  mutate(adj.p=p.adjust(p, method='BH')) %>%
  mutate(sig=case_when(.$adj.p < 0.05 ~ '*',
                       .$p < 0.05 ~ '.',
                       TRUE ~ ''))

totals %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sd_age, mean_n_cc, sd_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west) %>%
  mutate_at(vars(starts_with('pct_')), function(x) round(x, digits=1)) %>%
  mutate(n_bene=prettyNum(n_bene, big.mark=','),
         mean_age=round(mean_age, digits=1)) %>%
  mutate_at(vars(mean_n_cc, sd_age, sd_n_cc),
            function(x) round(x, digits=2)) %>% 
  gather('var', 'val', -year) %>% spread(year, val) %>% # transpose
  left_join(totals_trends %>% select(var, sig), by='var') %>%
  kable
```

# Patterns of consumption

All consumption rates are reported as claims per thousand people per year (CPKP).

## Claims by abx

```{r claims_by_abx}
top_abx = claims_by_abx %>%
  group_by(antibiotic) %>%
  summarize(cpkp=mean(cpkp)) %>%
  arrange(desc(cpkp)) %$%
  head(antibiotic, 10)

# this should be the same list as for the models
stopifnot(all(top_abx %in% model_abx$antibiotic))

# but "overall" should not be in the claims_by_abx list
if('overall' %in% claims_by_abx$antibiotic) stop()

claims_overall = claims_by_abx %>%
  select(-n_bene) %>%
  group_by(year) %>%
  summarize_at(vars(n, cpkp), sum) %>%
  mutate(antibiotic='overall')

claims_by_top_abx = claims_by_abx %>%
  bind_rows(claims_overall) %>%
  mutate(antibiotic=fct_relevel(fct_other(antibiotic, keep=c('overall', top_abx)),
                                c('overall', top_abx, 'Other'))) %>%
  group_by(year, antibiotic) %>%
  summarize_at(vars(n, cpkp), sum) %>% ungroup()

claims_by_top_abx %>%
  ggplot(aes(x=year, y=cpkp)) +
  facet_wrap(~antibiotic, ncol=3, scales='free_y') +
  geom_point() + geom_line() +
  theme_minimal() +
  ggtitle('Unadjusted consumption')

claims_by_top_abx %>%
  filter(antibiotic != 'overall') %>%
  ggplot(aes(x=year, y=cpkp)) +
  facet_wrap(~antibiotic, ncol=3) +
  geom_point() + geom_line() +
  theme_minimal() +
  ggtitle('Unadjusted consumption')

claims_by_top_abx %>%
  select(year, antibiotic, cpkp) %>%
  filter(year %in% c(2011, 2014)) %>%
  spread(year, cpkp) %>%
  mutate(pct_change=(`2014`-`2011`)/`2011`*100) %>%
  kable
```

## Claims by age group

```{r claims_by_age}
read_tsv('tables/claims_by_age_group.tsv') %>%
  mutate(cpkp=round(cpkp)) %>%
  select(year, age_group, cpkp) %>%
  spread(year, cpkp) %>%
  kable
```

## Consumption by sex

```{r claims_by_sex}
read_tsv('tables/claims_by_sex.tsv') %>%
  select(sex, year, cpkp) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>% 
  mutate_at(vars(-sex), round) %>%
  kable
```

## Consumption by region

```{r claims_by_region}
read_tsv('tables/claims_by_region.tsv') %>%
  select(region, year, cpkp) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>% 
  mutate_at(vars(-region), round) %>%
  kable
```

## Consumption by race

```{r claims_by_race}
read_tsv('tables/claims_by_race.tsv') %>%
  select(race, year, cpkp) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>% 
  mutate_at(vars(-race), round) %>%
  kable
```

# Adjusted consumption changes

"Adjusted" means the `year` coefficient in `y ~ year + age + n_cc + is_dual + region`. Gender and race, though important covariates, are not confounded with time.

```{r adjusted_changes, cache.extra=md5sum('tables/model_abx.tsv')}
x = model_abx %>%
  filter(term=='year') %>%
  select(antibiotic, pct_change, ci_low, ci_high) %>%
  mutate(is_overall=antibiotic=='overall') %>%
  arrange(is_overall, pct_change) %>%
  mutate(antibiotic=fct_inorder(antibiotic)) %>%
  select(-is_overall)

x %>%
  ggplot(aes(x=antibiotic, y=pct_change, ymin=ci_low, ymax=ci_high)) +
  geom_point() +
  geom_linerange() +
  coord_flip() +
  ggtitle('Adjusted changes in consumption') +
  xlab('') +
  ylab('adjusted yearly change in claims per beneficiary per year') +
  #scale_y_continuous(limits=c(-16, 17), breaks=c(-15, -10, -5, 0, 5, 10, 15)) +
  theme_minimal()
```

```{r adjusted_changes_table}
x %>% arrange(-row_number()) %>% kable
```

# Azithro and levo

I used the encounter data to anotate which beneficiaries had COPD or an ARTI in that year. I used these primary diagnoses:

```{r}
read_tsv('../sex-difference/sex_codes.tsv') %>%
  filter(diagnosis_type %in% c('acute_rc', 'copd')) %>%
  kable
```

Then I ran models predicting azithromycin and levofloxacin consumption using these some standard demographic variables and a narrowly-defined health status (COPD and ARTI).

## Azithromycin

`y ~ year + start_age + is_female + is_dual + is_white + region + copd + copd:year + copd:start_age + acute_rc + acute_rc:year + acute_rc:start_age`

That is, add COPD, ARTI, and the interactions of those terms with beneficiary age (in 2011) and calendar year.

```{r, cache.extra=md5sum('tables/tbl_cohort_model_azithro.tsv')}
read_tsv('tables/tbl_cohort_model_azithro.tsv') %>%
  model_ci_cpkp() %>%
  filter(term != '(Intercept)') %>%
  select(term, cpkp, ci_low, ci_high, p.value) %>%
  mutate_at(vars(cpkp, ci_low, ci_high), function(x) round(x, 1)) %>%
  kable
```

Azithromycin prescribing decreases with calendar year and with age, even for those who have COPD or an ARTI.

## Levofloxacin

`y ~ year + start_age + is_female + is_dual + is_white + region + acute_rc + acute_rc:year + acute_rc:start_age`

That is, add ARTI and the interactions with beneficiary age and calendar year.

```{r, cache.extra=md5sum('tables/tbl_cohort_model_levo.tsv')}
read_tsv('tables/tbl_cohort_model_levo.tsv') %>%
  model_ci_cpkp() %>%
  filter(term != '(Intercept)') %>%
  select(term, cpkp, ci_low, ci_high, p.value) %>%
  mutate_at(vars(cpkp, ci_low, ci_high), function(x) round(x, 1)) %>%
  kable
```

By contrast, levofloxacin prescribing increases with calendar year and with age, including for those who have and ARTI. The overall increase with time is about half the size of the increase with time for those who have an ARTI, meaning that levofloxacin, aside from being prescribed more overall, is being prescribed more especially for those with ARTIs.

Interestingly, the effect of dual-enrollment is much higher for levofloxacin than azithromycin (about triple). Why would being poorer make you more likely to take levofloxacin?

# Diagnoses

```{r}
read_tsv('tables/model_abx.tsv') %>%
  filter(term=='year') %>%
  mutate(model=case_when(.$model=='trimethoprim/sulfamethoxazole' ~ 'TMP/SMX',
                         .$model=='amoxicillin/clavulanate' ~ 'amox/clav',
                         TRUE ~ .$model)) %>%
  mutate(model=forcats::fct_reorder(model, estimate),
         cpkp=1000*estimate) %>%
  ggplot(aes(x=model, y=cpkp)) +
  geom_point() +
  geom_linerange(aes(x=model, ymin=0, ymax=cpkp)) +
  coord_flip() +
  xlab('') + ylab('Adjusted yearly change in claims per 1k bene. per yr') +
  scale_y_continuous(limits=c(-16, 17), breaks=c(-15, -10, -5, 0, 5, 10, 15)) +
  theme_minimal()
```

# Supplemental results

## Summary of data for the entire group

```{r}
read_tsv('tables/tbl_totals.tsv') %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sem_age, mean_n_cc, sem_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west) %>%
  mutate_at(vars(starts_with('pct_')), function(x) round(x, digits=1)) %>%
  mutate(n_bene=prettyNum(n_bene, big.mark=','),
         mean_age=round(mean_age, digits=1),
         mean_n_cc=round(mean_n_cc, digits=2)) %>%
  gather('var', 'val', -year) %>% spread(year, val) %>% # transpose
  kable
```

## Consumption trends in both groups

```{r}
dat = read_tsv('tables/tbl_claims_by_abx.tsv')

all_dat = bind_rows(
  top_abx_f(dat) %>% mutate(group='all'),
  top_abx_f(cohort_dat) %>% mutate(group='cohort')
)

all_dat %>%
  ggplot(aes(x=year, y=cpkp, color=group)) +
  facet_wrap(~ antibiotic, ncol=3, scales='free_y') +
  geom_point() + geom_line() +
  theme_minimal() +
  ggtitle('Unadjusted consumption, overall or in cohort')
```