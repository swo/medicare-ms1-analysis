---
title: "Ms 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE, autodep=TRUE)
import::from(knitr, kable)
```

# Population characteristics

```{r pop_chars}
pop_chars = read_tsv('tables/new/study_pop_chars.tsv')

pop_chars = read_tsv('tables/new/study_pop_chars.tsv') %>%
  spread(key, value) %>%
  (function (df) {
    ns1 = names(df)
    ns2 = str_replace(ns1, '^n_(?!bene|cc)', 'pct_')
    rename(df, !!!setNames(as.list(ns1), ns2))
  }) %>%
  mutate_at(vars(matches('^pct_')), function(x) x / .$n_bene * 100) %>%
  gather('key', 'value', -year)

pop_chars %>%
  mutate(key=factor(key, levels=c('n_bene', 'mean_age', 'sd_age', 'n_cc', 'sd_cc', 'pct_female', 'pct_white', 'pct_dual', 'pct_south', 'pct_midwest', 'pct_west', 'pct_northeast'))) %>%
  mutate(value=case_when(
    .$key == 'n_bene' ~ prettyNum(.$value, big.mark=','),
    .$key %in% c('n_cc', 'sd_cc') ~ format(.$value, digits=2, nsmall=2, scientific=FALSE),
    TRUE ~ format(.$value, digits=2, nsmall=1, scientific=FALSE)
  )) %>%
  spread(year, value) %>%
  kable(caption='Population characteristics')

trend_p = function(x) tidy(t.test(diff(x)))$p.value

pop_chars %>%
  arrange(key, year) %>%
  group_by(key) %>%
  summarize(p_value=trend_p(value)) %>%
  kable(caption='Trends in population characteristics')
```

There are `r scan('tables/n_unique_bene.txt') %>% prettyNum(big.mark=',')` unique beneficiaries.

The top 10 drugs take up `r round(scan('tables/top10_cumf.txt') * 100, 2)`% of all claims.

# Trends in drug usage

## Raw trends

```{r raw_drug_trends_table}
claims_by_abx = read_tsv('tables/new/claims_by_abx.tsv') %>%
  gather('abx', 'n', c(-year, -bene)) %>%
  mutate(cpkp=n/bene*1000)

claims_by_abx %>%
  mutate(cpkp=round(cpkp)) %>%
  select(year, abx, cpkp) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>%
  kable(caption='Raw drug CPKP')
```

```{r raw_drug_trends}
abx_levels = levels(claims_by_abx$abx)

claims_by_abx %>%
  filter(abx %in% c('pde', 'pde_approp', 'pde_inapprop', 'pde_nodx')) %>%
  ggplot(aes(x=year, y=cpkp, color=abx)) +
  geom_line() +
  scale_y_continuous(limits=c(0, 1400), breaks=c(0, 250, 500, 750, 1000, 1250, 1400)) +
  coord_fixed(ratio=4/1400*1.25) +
  theme_minimal() +
  theme(panel.grid.minor.x=element_blank()) +
  ggtitle('Unadjusted consumption, all abx')

claims_by_abx %>%
  filter(abx %in% c('azithromycin', 'ciprofloxacin', 'amoxicillin', 'cephalexin', 'tmpsmx', 'levofloxacin')) %>%
  ggplot(aes(x=year, y=cpkp, color=abx)) +
  geom_line() +
  scale_y_continuous(limits=c(0, 250), breaks=c(0, 50, 100, 150, 200, 250)) +
  coord_fixed(ratio=4/250*1.25) +
  theme_minimal() +
  theme(panel.grid.minor.x=element_blank()) +
  ggtitle('Unadjusted consumption, top 5')

claims_by_abx %>%
  filter(abx %in% c('amoxclav', 'doxycycline', 'nitrofurantoin', 'clindamycin')) %>%
  ggplot(aes(x=year, y=cpkp, color=abx)) +
  geom_line() +
  scale_y_continuous(limits=c(0, 100), breaks=c(0, 50, 100)) +
  coord_fixed(ratio=4/100*1.25) +
  theme_minimal() +
  theme(panel.grid.minor.x=element_blank()) +
  ggtitle('Unadjusted consumption, next 5')
```

## Adjusted trends

```{r abx_trends}
est2pct = function(x) (x - 1)*100
format_p = function(p) if_else(p<0.0001, '<.0001', format(round(p, 4), digits=4, nsmall=4))

ceiling_at = function(x, n) {
  mult = 10 ** n
  x %>% { . * mult } %>% ceiling %>% { . / mult }
}
  
format_model = function(df) {
  df %>%
    mutate_at(vars(estimate, lower_ci, upper_ci), est2pct) %>%
    mutate(pm=pmax(estimate-lower_ci, upper_ci-estimate)) %>%
    mutate(change=sprintf('%.1f ± %.1f', estimate, ceiling_at(pm, 1))) %>%
    mutate(p.value=format_p(p_value))
}

abx_trends = read_tsv('tables/new/abx_models.tsv') %>%
  format_model()

abx_trends %>%
  mutate_at(vars(estimate, lower_ci, upper_ci), function(x) format(x, digits=1, nsmall=1, scientific=FALSE)) %>%
  kable(caption='Drug trends: Percent change from 2011 to 2014')

abx_trends %>%
  # put the abx in order
  arrange(desc(estimate)) %>%
  mutate(antibiotic=fct_inorder(factor(antibiotic))) %>%
  mutate(antibiotic=fct_relevel(antibiotic, c('n_pde', 'n_pde_approp', 'n_pde_inapprop', 'n_pde_nodx'))) %>%
  mutate(antibiotic=fct_rev(antibiotic)) %>%
  # plot
  ggplot(aes(x=antibiotic, y=estimate, ymin=lower_ci, ymax=upper_ci)) +
  geom_bar(stat='identity', fill='white', color='black') +
  geom_errorbar(width=0.5) +
  coord_flip() +
  xlab('') +
  ylab('adjusted change in consumption 2011 to 2014 (%)') +
  scale_y_continuous(limits=c(-22, 32.5), breaks=c(-20, -10, 0, 10, 20, 30)) +
  theme_minimal() +
  theme(axis.title.x = element_text(size=16),
        axis.text = element_text(size=16))
```

## Raw inappropriate fractions

```{r inappropriate_fraction}
claims_by_abx %>%
  filter(str_detect(abx, '^pde')) %>%
  select(year, abx, n) %>%
  spread(abx, n) %>%
  mutate_at(vars(matches('^pde_')), function(x) round(x / .$pde * 100, 1)) %>%
  select(-pde) %>%
  kable(caption='Proportion of app., inapp., and no-dx prescribing')
```

# Prescribing practice

```{r top_dx}
denom = claims_by_abx %>%
  select(year, bene) %>%
  distinct()

rxdx_table = read_tsv('tables/new/rxdx_counts.tsv') %>%
  left_join(denom, by='year') %>%
  mutate(cpkp=n_pdedx / bene * 1000)

top_dx = rxdx_table %>%
  filter(year==2011) %>%
  group_by(dx_cat) %>%
  summarize(max_cpkp=max(cpkp)) %>%
  mutate(over_10=max_cpkp >= 10) %>%
  arrange(desc(max_cpkp))

top_dx %>%
  kable(caption='Diagnoses by maximum drug usage in 2011')
```

```{r top_rxdx}
infection_sites = read_tsv('infection_sites.tsv')

top_dx %>%
  filter(over_10) %>%
  slice(-1) %>% # drop "remaining codes"
  select(dx_cat) %>%
  inner_join(rxdx_table, by='dx_cat') %>%
  left_join(infection_sites, by='dx_cat') %>%
  filter(year==2011) %>%
  group_by(site, antibiotic) %>%
  summarize(cpkp=sum(cpkp)) %>%
  arrange(site, desc(cpkp)) %>%
  group_by(site) %>%
  mutate(f=cpkp/sum(cpkp), cumf=cumsum(f)/sum(f)) %>%
  do(head(., 5)) %>%
  kable(caption='Top drugs by diagnosis in 2011')
```

```{r prescribing_practice}
rxdx_models = read_tsv('tables/new/rxdx_models.tsv')

combined_table = rxdx_table %>%
  mutate(cpkp=round(n_pdedx / bene * 1000, 1)) %>%
  filter(year %in% c(2011, 2014)) %>%
  select(antibiotic, dx_cat, year, cpkp) %>%
  spread(year, cpkp) %>%
  right_join(rxdx_models, by=c('antibiotic', 'dx_cat')) %>%
  format_model() %>%
  select(dx_cat, antibiotic, `2011`, `2014`, change, p.value) %>%
  arrange(dx_cat, antibiotic)
```

## Respiratory

```{r respiratory}
rxdx_kable = function(abxs, dxs) {
  combined_table %>%
    filter(dx_cat %in% dxs, antibiotic %in% abxs) %>%
    mutate(dx_cat=factor(dx_cat, levels=dxs),
           antibiotic=factor(antibiotic, levels=abxs)) %>%
    arrange(dx_cat, antibiotic) %>%
    kable()
}

rxdx_kable(c('azithromycin', 'levofloxacin', 'amoxclav'),
           c('pneumonia', 'sinusitis', 'uri', 'bronchitis', 'other_resp', 'asthma'))
```

# Supplement

## Claims by demography

```{r claims_by_demography}
subpop_table = read_tsv('tables/new/claims_by_subpop.tsv') %>%
  mutate(cpkp=round(n_pde/n_bene*1000)) %>%
  filter(year %in% c(2011, 2014)) %>%
  select(subpop, year, cpkp) %>%
  spread(year, cpkp)

subpop_models = read_tsv('tables/new/subpop_models.tsv') %>%
  mutate_at(vars(estimate, lower_ci, upper_ci), est2pct) %>%
  mutate(pm=pmax(estimate-lower_ci, upper_ci-estimate)) %>%
  mutate(change=sprintf('%.1f (%.1f -- %.1f)', estimate, lower_ci, upper_ci)) %>%
  mutate(change2=sprintf('%.1f ± %.1f', estimate, pm)) %>%
  mutate(p.value=format_p(p_value)) %>%
  select(subpop, change2, p.value)

left_join(subpop_table, subpop_models, by='subpop') %>%
  kable(caption='Claims and trends by subpopulation')
```

## GI

```{r gi}
rxdx_kable(c('ciprofloxacin', 'metronidazole', 'levofloxacin'),
           c('gi', 'gi_t3'))
```

## UTI

```{r uti}
rxdx_kable(c('ciprofloxacin', 'tmpsmx', 'nitrofurantoin'),
           c('uti', 'uti_t3'))
```

## SSTI

```{r ssti}
rxdx_kable(c('cephalexin', 'tmpsmx'),
           c('ssti', 'ssti_t3'))
```
