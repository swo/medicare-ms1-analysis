---
title: "Ms 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE, autodep=TRUE)
import::from(knitr, kable)

est2pct = function(x) (x - 1)*100
```

# Population characteristics

```{r pop_chars}
pop_chars = read_tsv('tables/study_pop_chars.tsv') %>%
  spread(key, value) %>%
  (function (df) {
    ns1 = names(df)
    ns2 = str_replace(ns1, '^n_(?!bene|cc)', 'pct_')
    rename(df, !!!setNames(as.list(ns1), ns2))
  }) %>%
  mutate_at(vars(matches('^pct_')), function(x) x / .$n_bene * 100) %>%
  gather('key', 'value', -year)

pop_chars %>%
  mutate(key=factor(key, levels=c('n_bene', 'mean_age', 'sd_age', 'n_cc', 'sd_cc', 'pct_female', 'pct_white', 'pct_dual', 'pct_south', 'pct_midwest', 'pct_west', 'pct_northeast'))) %>%
  mutate(value=case_when(
    .$key == 'n_bene' ~ prettyNum(.$value, big.mark=','),
    .$key %in% c('n_cc', 'sd_cc') ~ format(.$value, digits=2, nsmall=2, scientific=FALSE),
    TRUE ~ format(.$value, digits=2, nsmall=1, scientific=FALSE)
  )) %>%
  spread(year, value) %>%
  kable(caption='Population characteristics')
```

```{r popchar_models}
pop_char_models = read_tsv('tables/pop_char_models.tsv')

pop_char_models %>%
  mutate_at(vars(estimate, lower_ci, upper_ci), function(x) prettyNum(est2pct(x), digits=3, width=0, format='fg')) %>%
  kable(caption='Trends in study population characteristics')
```

# Trends in drug usage

## Raw trends

```{r raw_drug_trends_table}
claims_by_abx = read_tsv('tables/claims_by_abx.tsv') %>%
  gather('abx', 'n', c(-year, -bene)) %>%
  mutate(n=if_else(year == 2015 & abx %in% c('pde_approp', 'pde_inapprop', 'pde_nodx'),
                   as.integer(round(n * 4/3)),
                   n)) %>%
  mutate(cpkp=n/bene*1000)

claims_by_abx %>%
  mutate(cpkp=round(cpkp)) %>%
  select(year, abx, cpkp) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>%
  kable(caption='Raw drug CPKP. 2015 values for abx-assoc. are projected.')
```

The changes in overall use and appropriate use are so small that I'll give it another decimal place:

```{r}
# N.B.: 2015 claims were adjusted during loading of the data file
claims_by_abx %>%
  filter(abx %in% c('pde', 'pde_approp'), year %in% c(2011, 2015)) %>%
  select(year, abx, cpkp) %>%
  mutate(cpkp=round(cpkp, 1)) %>%
  spread(year, cpkp) %>%
  kable(caption='CPKP for small changes')
```

```{r raw_drug_trends}
abx_levels = levels(claims_by_abx$abx)

dummy = data_frame(
  year = rep(c(2011, 2014), 3),
  cpkp = c(0, 1500, 0, 250, 0, 100),
  panel = factor(c(1, 1, 2, 2, 3, 3)),
  abx = 'pde'
)

panel_labels = c('1'='a) Overall antibiotic consumption',
                 '2'='b) Top 6 most-used antibiotics',
                 '3'='c) Next 4 most-used antibiotics')

claims_by_abx %>%
  mutate(panel = factor(case_when(
    .$abx %in% c('pde', 'pde_approp', 'pde_inapprop', 'pde_nodx') ~ 1,
    .$abx %in% c('azithromycin', 'ciprofloxacin', 'amoxicillin', 'cephalexin', 'tmpsmx', 'levofloxacin') ~ 2,
    .$abx %in% c('amoxclav', 'doxycycline', 'nitrofurantoin', 'clindamycin') ~ 3
  ))) %>%
  filter(!is.na(panel)) %>% # remove metro
  mutate(abx=case_when(
    .$abx == 'pde' ~ 'Overall use',
    .$abx == 'pde_inapprop' ~ 'Inappropriate use',
    .$abx == 'pde_approp' ~ 'Appropriate use',
    .$abx == 'pde_nodx' ~ 'Indeterminate use',
    .$abx == 'amoxclav' ~ 'amox/clav',
    .$abx == 'tmpsmx' ~ 'TMP/SMX',
    TRUE ~ .$abx)
  ) %>%
  arrange(year, desc(cpkp)) %>%
  {
  ggplot(., aes(x=year, y=cpkp, group=abx)) +
  geom_blank(data=dummy) +
  geom_line() +
  geom_text_repel(
    data=filter(., year==2013),
    aes(label=abx)
  ) +
  facet_wrap(~panel, scales='free_y', labeller=labeller(panel=panel_labels)) +
  theme_classic() +
  theme(panel.grid.minor.x=element_blank(),
        strip.background = element_blank(),
        plot.margin=unit(c(1.0, 1.0, 0.5, 0.5), 'lines')) +
  scale_x_continuous(expand=c(0, 0), name='') +
  scale_y_continuous(expand=c(0, 0), name='claims per 1,000 beneficiaries per year')
  }

ggsave('fig/raw_drug.pdf', height=5.0, width=9.0, unit='in')
```

## Adjusted trends

```{r abx_trends}
format_p = function(p) if_else(p<0.0001, '<.0001', format(round(p, 4), digits=4, nsmall=4))

ceiling_at = function(x, n) {
  mult = 10 ** n
  x %>% { . * mult } %>% ceiling %>% { . / mult }
}
  
format_model = function(df) {
  df %>%
    mutate_at(vars(estimate, lower_ci, upper_ci), est2pct) %>%
    mutate(pm=pmax(estimate-lower_ci, upper_ci-estimate)) %>%
    #mutate(change=sprintf('%.1f ± %.1f', estimate, ceiling_at(pm, 1))) %>%
    mutate(change=sprintf('%.1f (%.1f -- %.1f)', estimate, lower_ci, upper_ci)) %>%
    mutate(p.value=format_p(p_value))
}

abx_trends_raw = read_tsv('tables/abx_models.tsv')

abx_trends = abx_trends_raw %>%
  format_model()

abx_trends %>%
  mutate_at(vars(estimate, lower_ci, upper_ci), function(x) format(x, digits=1, nsmall=1, scientific=FALSE)) %>%
  kable(caption='Drug trends: Percent change from 2011 to 2014')

abx_trends %>%
  filter(antibiotic != 'metronidazole') %>%
  mutate(antibiotic=case_when(
    .$antibiotic == 'n_pde' ~ 'Overall use',
    .$antibiotic == 'n_pde_inapprop' ~ 'Inappropriate use',
    .$antibiotic == 'n_pde_approp' ~ 'Appropriate use',
    .$antibiotic == 'n_pde_nodx' ~ 'Indeterminate use',
    .$antibiotic == 'amoxclav' ~ 'amox/clav',
    .$antibiotic == 'tmpsmx' ~ 'TMP/SMX',
    TRUE ~ .$antibiotic)
  ) %>%
  # put the abx in order
  arrange(desc(estimate)) %>%
  mutate(antibiotic=fct_inorder(factor(antibiotic))) %>%
  mutate(antibiotic=fct_relevel(antibiotic, c('Overall use', 'Inappropriate use', 'Appropriate use', 'Indeterminate use'))) %>%
  mutate(antibiotic=fct_rev(antibiotic)) %>%
  # plot
  ggplot(aes(x=antibiotic, y=estimate, ymin=lower_ci, ymax=upper_ci)) +
  geom_col(fill='white', color='black') +
  geom_errorbar(width=0.5) +
  coord_flip() +
  xlab('') +
  ylab('adjusted change in claims per beneficiary per year from 2011 to 2015 (%)') +
  scale_y_continuous(limits=c(-20, 30), breaks=c(-20, -10, 0, 10, 20, 30), expand=c(0.0, 0.00)) +
  theme_minimal() +
  theme(axis.title.x = element_text(size=12),
        axis.text = element_text(size=12))

ggsave('fig/abx_trends.pdf', width=6.4, height=4.5, units='in')
```

Again, overall use declines so little that I'll give it one more decimal place:

```{r}
abx_trends_raw %>%
  filter(antibiotic=='n_pde') %>%
  select(-antibiotic) %>%
  mutate_at(vars(estimate, lower_ci, upper_ci), est2pct) %>%
  mutate(pm=pmax(estimate-lower_ci, upper_ci-estimate)) %>%
  #mutate(change=sprintf('%.2f ± %.2f', estimate, ceiling_at(pm, 2))) %>%
  mutate(change=sprintf('%.2f (%.2f -- %.2f)', estimate, lower_ci, upper_ci)) %>%
  mutate(p.value=format_p(p_value)) %>%
  kable
```

## Raw inappropriate fractions

```{r inappropriate_fraction}
claims_by_abx %>%
  filter(str_detect(abx, '^pde')) %>%
  select(year, abx, n) %>%
  spread(abx, n) %>%
  mutate(denom=pde_approp + pde_inapprop + pde_nodx) %>%
  mutate_at(vars(matches('^pde_')), function(x) round(x / .$denom * 100, 1)) %>%
  select(-pde, -denom) %>%
  kable(caption='Proportion of app., inapp., and no-dx prescribing')
```

# Prescribing practice

```{r top_dx}
denom = claims_by_abx %>%
  select(year, bene) %>%
  distinct()

rxdx_table = read_tsv('tables/rxdx_counts.tsv') %>%
  left_join(denom, by='year') %>%
  mutate(cpkp=n_pdedx / bene * 1000) %>%
  mutate(cpkp=if_else(year==2015,
                      cpkp * 4/3,
                      cpkp))

top_dx = rxdx_table %>%
  filter(year==2011) %>%
  group_by(dx_cat) %>%
  summarize(max_cpkp=max(cpkp)) %>%
  mutate(over_10=max_cpkp >= 10) %>%
  arrange(desc(max_cpkp))

top_dx %>%
  kable(caption='Diagnoses by maximum drug usage in 2011')
```

```{r top_rxdx}
infection_sites = read_tsv('infection_sites.tsv')

top_dx %>%
  filter(over_10) %>%
  slice(-1) %>% # drop "remaining codes"
  select(dx_cat) %>%
  inner_join(rxdx_table, by='dx_cat') %>%
  left_join(infection_sites, by='dx_cat') %>%
  filter(year==2011) %>%
  group_by(site, antibiotic) %>%
  summarize(cpkp=sum(cpkp)) %>%
  arrange(site, desc(cpkp)) %>%
  group_by(site) %>%
  mutate(f=cpkp/sum(cpkp), cumf=cumsum(f)/sum(f)) %>%
  do(head(., 5)) %>%
  kable(caption='Top drugs by diagnosis in 2011')
```

```{r prescribing_practice}
rxdx_models = read_tsv('tables/rxdx_models.tsv')

combined_table = rxdx_table %>%
  mutate(cpkp=round(cpkp, 1)) %>%
  filter(year %in% c(2011, 2015)) %>%
  select(antibiotic, dx_cat, year, cpkp) %>%
  spread(year, cpkp) %>%
  right_join(rxdx_models, by=c('antibiotic', 'dx_cat')) %>%
  #format_model() %>%
  mutate_at(vars(estimate, lower_ci, upper_ci), est2pct) %>%
  mutate(pm=pmax(estimate-lower_ci, upper_ci-estimate)) %>%
  mutate(change=sprintf('%.1f ± %.1f', estimate, ceiling_at(pm, 1))) %>%
  mutate(p.value=format_p(p_value)) %>%
  select(dx_cat, antibiotic, `2011`, `2015`, change, p.value) %>%
  arrange(dx_cat, antibiotic)
```

## Respiratory

```{r respiratory}
rxdx_kable = function(abxs, dxs) {
  combined_table %>%
    filter(dx_cat %in% dxs, antibiotic %in% abxs) %>%
    mutate(dx_cat=factor(dx_cat, levels=dxs),
           antibiotic=factor(antibiotic, levels=abxs)) %>%
    arrange(dx_cat, antibiotic) %>%
    kable()
}

rxdx_kable(c('azithromycin', 'levofloxacin', 'amoxclav'),
           c('pneumonia', 'sinusitis', 'uri', 'bronchitis', 'other_resp', 'asthma'))
```

## Any respiratory

```{r any_respiratory}
read_tsv('tables/rxdx_resp_counts.tsv') %>%
  left_join(denom, by='year') %>%
  mutate(n_pdedx=if_else(year==2015, n_pdedx * 4/3, as.numeric(n_pdedx))) %>%
  mutate(cpkp=round(n_pdedx / bene * 1000, 1)) %>%
  filter(year %in% c(2011, 2015)) %>%
  select(antibiotic, year, cpkp) %>%
  spread(year, cpkp) %>%
  mutate(change=`2015`-`2011`) %>%
  kable(caption='Claims per 1,000 beneficiaries of each drug in association with any of the considered respiratory diagnoses')
```

# Supplement

## Claims by demography

```{r claims_by_demography}
subpop_table = read_tsv('tables/claims_by_subpop.tsv') %>%
  mutate(cpkp=round(n_pde/n_bene*1000)) %>%
  filter(year %in% c(2011, 2015)) %>%
  select(subpop, year, cpkp) %>%
  spread(year, cpkp)

subpop_models = read_tsv('tables/subpop_models.tsv') %>%
  mutate_at(vars(estimate, lower_ci, upper_ci), est2pct) %>%
  mutate(pm=pmax(estimate-lower_ci, upper_ci-estimate)) %>%
  #mutate(change=sprintf('%.1f ± %.1f', estimate, ceiling_at(pm, 1))) %>%
  mutate(change=sprintf('%.2f (%.2f -- %.2f)', estimate, lower_ci, upper_ci)) %>%
  mutate(p.value=format_p(p_value)) %>%
  select(subpop, change, p.value)

left_join(subpop_table, subpop_models, by='subpop') %>%
  kable(caption='Claims and trends by subpopulation')
```

## GI

```{r gi}
rxdx_kable(c('ciprofloxacin', 'metronidazole', 'levofloxacin'),
           c('gi', 'gi_t3'))
```

## UTI

```{r uti}
rxdx_kable(c('ciprofloxacin', 'tmpsmx', 'nitrofurantoin'),
           c('uti', 'uti_t3'))
```

## SSTI

```{r ssti}
rxdx_kable(c('cephalexin', 'tmpsmx', 'ciprofloxacin'),
           c('ssti', 'ssti_t3'))
```
