---
title: "Ms 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE, autodep=TRUE)
import::from(knitr, kable)
import::from(tools, md5sum)
library(forcats)
```

# Abstract

```{r abstract, cache.extra=md5sum('tables/model_abx.tsv')}
pctize = function(df, denom_name) {
  for (n_name in Filter(function(x) str_detect(x, '^n_'), names(df))) {
    pct_name = str_replace(n_name, '^n_', 'pct_')
    df[[pct_name]] = df[[n_name]] / df[[denom_name]] * 100
  }
  df
}

totals = read_tsv('tables/totals.tsv') %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sd_age, mean_n_cc, sd_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west)

claims_by_abx = read_tsv('tables/claims_by_abx.tsv')

n_unique_bene = scan('tables/n_unique_bene.tsv')
n_million_unique_bene = round(scan('tables/n_unique_bene.tsv') / 1e6, 2)
n_million_pde = claims_by_abx %$% sum(n) %>% { round(. / 1e6, 2) }

est2pct = function(x) (exp(x) - 1)*100
model_ci = function(df) {
  df %>%
    mutate(pct_change=est2pct(estimate),
           ci=1.96*std.error,
           ci_low=est2pct(estimate - ci),
           ci_high=est2pct(estimate + ci),
           change_str=sprintf('%.2f%% (%.2f -- %.2f%%)', pct_change, ci_low, ci_high))
}

model_abx = read_tsv('tables/model_abx.tsv') %>%
  rename(antibiotic=name) %>%
  model_ci()

total_adjusted_change_str = model_abx %>%
  filter(term=='year0', antibiotic=='overall') %$%
  change_str

azithro_adjusted_change_str = model_abx %>%
  filter(term=='year0', antibiotic=='azithromycin') %$%
  change_str

levo_adjusted_change_str = model_abx %>%
  filter(term=='year0', antibiotic=='levofloxacin') %$%
  change_str
```

There are `r n_million_unique_bene` million unique beneficiaries and `r n_million_pde` million PDEs across all study years. Adjusted total consumption changed by `r total_adjusted_change_str` per year. Azithromycin changed by `r azithro_adjusted_change_str` per year. Levofloxacin changed by `r levo_adjusted_change_str` per year.

# Beneficiary characteristics

A star indicates that the trend (*t*-test for mean difference between years equal to zero) is significant after multiple hypothesis correction. A dot indicates significance ($p < 0.05$) before multiple hypothesis correction. Mean age decreased during the study.

```{r bene_char_table}
trend_p = function(x) tidy(t.test(diff(x)))$p.value
totals_trends = totals %>%
  gather('var', 'val', -year) %>%
  arrange(var, year, val) %>%
  group_by(var) %>%
  summarize(p=trend_p(val)) %>%
  mutate(adj.p=p.adjust(p, method='BH')) %>%
  mutate(sig=case_when(.$adj.p < 0.05 ~ '*',
                       .$p < 0.05 ~ '.',
                       TRUE ~ ''))

totals %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sd_age, mean_n_cc, sd_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west) %>%
  mutate_at(vars(starts_with('pct_')), function(x) round(x, digits=1)) %>%
  mutate(n_bene=prettyNum(n_bene, big.mark=','),
         mean_age=round(mean_age, digits=1)) %>%
  mutate_at(vars(mean_n_cc, sd_age, sd_n_cc),
            function(x) round(x, digits=2)) %>% 
  gather('var', 'val', -year) %>% spread(year, val) %>% # transpose
  left_join(totals_trends %>% select(var, sig), by='var') %>%
  kable
```

# Patterns of consumption

All consumption rates are reported as claims per thousand people per year (CPKP).

## Claims by abx

```{r claims_by_abx}
top_abx = claims_by_abx %>%
  group_by(antibiotic) %>%
  summarize(cpkp=mean(cpkp)) %>%
  arrange(desc(cpkp)) %$%
  head(antibiotic, 10)

# this should be the same list as for the models
stopifnot(all(top_abx %in% model_abx$antibiotic))

# but "overall" should not be in the claims_by_abx list
if('overall' %in% claims_by_abx$antibiotic) stop()

claims_overall = claims_by_abx %>%
  select(-n_bene) %>%
  group_by(year) %>%
  summarize_at(vars(n, cpkp), sum) %>%
  mutate(antibiotic='overall')

claims_by_top_abx = claims_by_abx %>%
  bind_rows(claims_overall) %>%
  mutate(antibiotic=fct_relevel(fct_other(antibiotic, keep=c('overall', top_abx)),
                                c('overall', top_abx, 'Other'))) %>%
  group_by(year, antibiotic) %>%
  summarize_at(vars(n, cpkp), sum) %>% ungroup()
```

```{r claims_by_top_abx_figs}
claims_by_top_abx %>%
  filter(antibiotic=='overall') %>%
  ggplot(aes(x=year, y=cpkp)) +
  geom_point() + geom_line() +
  #ylim(0, 1520) +
  scale_y_continuous(limits=c(0, 1525), breaks=c(0, 250, 500, 1000, 1500)) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, all abx')

claims_by_top_abx %>%
  filter(antibiotic %in% c('azithromycin', 'ciprofloxacin', 'amoxicillin', 'cephalexin', 'trimethoprim/sulfamethoxazole', 'levofloxacin')) %>%
  ggplot(aes(x=year, y=cpkp, color=antibiotic)) +
  #ggplot(aes(x=year, y=cpkp)) +
  #facet_wrap(~antibiotic, ncol=5) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, 250), breaks=c(0, 50, 100, 150, 200, 250)) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, top 5')

claims_by_top_abx %>%
  filter(antibiotic %in% c('amoxicillin/clavulanate', 'doxycycline', 'nitrofurantoin', 'clindamycin')) %>%
  ggplot(aes(x=year, y=cpkp, color=antibiotic)) +
  #ggplot(aes(x=year, y=cpkp)) +
  #facet_wrap(~antibiotic, ncol=5) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, 100), breaks=c(0, 50, 100)) +
  #ylim(0, 140) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, next 5')
```

## Claims by age group

```{r claims_by_age}
read_tsv('tables/claims_by_age.tsv') %>%
  mutate(age_group=case_when(between(.$age, 65, 75) ~ '65-75',
                             between(.$age, 76, 85) ~ '76-85',
                             between(.$age, 86, 95) ~ '86-95')) %>%
  group_by(year, age_group) %>%
  summarize_at(vars(n_bene, n_claims), sum) %>%
  ungroup() %>%
  mutate(cpkp=round(1000*n_claims/n_bene)) %>%
  select(year, age_group, cpkp) %>%
  spread(year, cpkp) %>%
  kable
```

## Consumption by sex

```{r claims_by_sex}
read_tsv('tables/claims_by_sex.tsv') %>%
  select(sex, year, cpkp) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>% 
  mutate_at(vars(-sex), round) %>%
  kable
```

## Consumption by region

```{r claims_by_region}
read_tsv('tables/claims_by_region.tsv') %>%
  select(region, year, cpkp) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>% 
  mutate_at(vars(-region), round) %>%
  kable
```

## Consumption by race

```{r claims_by_race}
read_tsv('tables/claims_by_race.tsv') %>%
  select(race, year, cpkp) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>% 
  mutate_at(vars(-race), round) %>%
  kable
```

# Adjusted consumption changes

Adjusted changes were computed using a Poisson regression predicting claims per capita. The unit of analysis were individual beneficiaries in each year. The covariates in the regression were age, number of chronic conditions, dual eligibility, sex, race (white or not), and region.

```{r adjusted_changes}
x = model_abx %>%
  filter(term=='year0') %>%
  select(antibiotic, pct_change, ci_low, ci_high) %>%
  arrange(pct_change) %>%
  mutate(antibiotic=fct_inorder(antibiotic),
         antibiotic=fct_relevel(antibiotic, 'overall', after=Inf))

x %>%
  ggplot(aes(x=antibiotic, y=pct_change, ymin=ci_low, ymax=ci_high)) +
  geom_bar(stat='identity', fill=NA, color='black') +
  geom_errorbar(width=0.5) +
  coord_flip() +
  ggtitle('Adjusted changes in consumption') +
  xlab('') +
  ylab('adjusted yearly change in claims per beneficiary per year') +
  scale_y_continuous(limits=c(-10, 10), breaks=c(-10, -5, 0, 5, 10)) +
  theme_minimal()
```

```{r adjusted_changes_table}
x %>% arrange(desc(antibiotic)) %>% kable
```

## Fluoroquinolones

Consumption of ciprofloxacin is slightly decreasing, and consumption of levofloxacin is increasing. How does fluoroquinolone consumption overall change?

```{r fq}
read_tsv('tables/model_fq.tsv') %>%
  model_ci() %>%
  select(term, pct_change, ci_low, ci_high, p.value) %>%
  kable
```

Overall, fluoroquinolones changed by about 0% per year during this period.

## Heart disease

We suspected that changes in azithromycin and levofloxacin consumption could be due to altered prescribing guidelines, including one that recommends that azithromycin not be used to treat people at risk for heart fibrillations. This includes all elderly, but we epxect the risk would be especially high for those people with heart disease (i.e., AMI | ATRIALFB | CHF | ISCHMCHT). I ran separate models for azithromycin and levofloxacin where I include an interaction between a heart disease flag and the year.

```{r heart_model}
bind_rows(
  read_tsv('tables/model_azithro.tsv') %>% mutate(model='azithro'),
  read_tsv('tables/model_levo.tsv') %>% mutate(model='levo')
) %>%
  model_ci() %>%
  select(term, model, pct_change) %>%
  spread(model, pct_change) %>%
  kable
```

For azithromycin, there is a moderate interaction: azithromycin consumption decrease 6.6% per year amongst those without heart disease and 10.2% per year ($1.06588 \times 1.03344$) among those with heart disease. For levofloxacin, there is a small interaction that is the opposite of what we might expect: levo consumption increased 10.1% per year among those without heart disease and at a lower rate, 9.4% ($1.10149*(1-0.006782)$), among those with heart disease.

The weakness to this analysis is that I use the CCW flag for heart disease during each year, which means that someone might be getting a lot of azithromycin before they have a heart attack, and afterward they get none. I'm also using the one-year chronic conditions, so if someone has a heart attack last year, I don't know about that for the next eyar. Nevertheless, as a rough slice, it seems like heart disease doesn't explain what's going on.

# Prescribing practice

## Methodology

The unit of analysis are encounters recorded in the Carrier Line File whose HCPCS code indicated an office visit. We only examined encounters whose primary diagnosis fell into set of groups: skin and soft tissue infections (SSTIs), UTIs, probably viral URIs, pneumonia, bronchitis, pharyngitis, sinusitis.

## Trends in diagnoses

Trends per 1,000 beneficiaries in each year. The $p$-value indicates a linear trend.

```{r dx_counts}
dx_counts = read_tsv('tables/dx_counts.tsv') %>%
  left_join(totals, by='year') %>%
  mutate(dx_pkb=round(n/n_bene*1000, 1)) %>%
  select(diagnosis_type, year, dx_pkb)

dx_counts_trends = dx_counts %>%
  group_by(diagnosis_type) %>%
  arrange(year) %>%
  summarize(p=round(trend_p(dx_pkb), 2))

dx_counts %>%
  spread(year, dx_pkb) %>%
  left_join(dx_counts_trends, by='diagnosis_type') %>%
  arrange(desc(`2011`)) %>%
  kable
```

## Delays between diagnosis and prescription

The table shows the number of diagnoses that were followed by that number of days' delay before the following antibiotic prescription. Most prescriptions were filled on the same day as the diagnosis.

```{r dx_delay}
dx_delay = read_tsv('tables/dx_delay.tsv')

dx_delay %>%
  filter(!is.na(delay)) %>%
  mutate(f=n/sum(n)) %>%
  kable

f_dx_not_followed = dx_delay %>%
  group_by(a=!is.na(delay)) %>%
  summarize(n=sum(n)) %>%
  spread(a, n) %>%
  rename(yes=`TRUE`, no=`FALSE`) %$%
  { yes / (yes + no) }
```

However, only `r f_dx_not_followed*100`% of these diagnoses were followed by an antibiotic prescription fill.

## Unadjusted changes in prescribing practice

For each diagnosis type, I computed what fraction of diagnoses were followed by treatment with each antibiotic. In the table, I only include dx/rx combinations where the antibiotic was filled after at least 5% of diagnoses.

```{r dxrx_fraction}
dxrx_frac = read_tsv('tables/dxrx_fractions.tsv') %>%
  group_by(year, diagnosis_type) %>%
  mutate(total=sum(n)) %>%
  ungroup() %>%
  mutate(f=round(100*n/total, 1)) %>%
  filter(antibiotic %in% top_abx) %>%
  select(diagnosis_type, antibiotic, year, f) %>%
  spread(year, f) %>%
  filter(`2011` >= 5) %>%
  arrange(diagnosis_type, desc(`2011`))

dxrx_frac %>%
  kable
```

## Adjusted changes in prescribing practice

To correct for the changing population, I ran a logistic regression for each diagnosis/antibiotic combination. The units of analysis were encounters with a primary diagnosis in that diagnosis group, and the outcome was whether that antibiotic was filled after the encounter. The main predictor variable was the year, and adjusted covariates included the same as before (age, # chronic conditions, sex, white race, region, dual eligibility).

```{r dxrx_models}
read_tsv('tables/model_dxrx.tsv') %>%
  model_ci() %>%
  filter(term=='year0') %>%
  # swo: pick the right models to show
  right_join(dxrx_frac, by=c('diagnosis_type', 'antibiotic')) %>%
  filter(!is.na(pct_change)) %>%
  select(antibiotic, diagnosis_type, pct_change, ci_low, ci_high, p.value) %>%
  arrange(antibiotic, desc(pct_change)) %>%
  kable
```
