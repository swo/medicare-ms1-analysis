---
title: "Ms 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE, autodep=TRUE)
import::from(knitr, kable)
import::from(tools, md5sum)
library(forcats)
```

# Abstract

```{r abstract, cache.extra=md5sum('tables/model_abx.tsv')}
pctize = function(df, denom_name) {
  for (n_name in Filter(function(x) str_detect(x, '^n_'), names(df))) {
    pct_name = str_replace(n_name, '^n_', 'pct_')
    df[[pct_name]] = df[[n_name]] / df[[denom_name]] * 100
  }
  df
}

totals = read_tsv('tables/totals.tsv') %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sd_age, mean_n_cc, sd_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west)

claims_by_abx = read_tsv('tables/claims_by_abx.tsv')

n_unique_bene = scan('tables/n_unique_bene.tsv')
n_million_unique_bene = round(scan('tables/n_unique_bene.tsv') / 1e6, 2)
n_pde = sum(claims_by_abx$n)
n_million_pde = round(n_pde / 1e6, 2)

est2pct = function(x) (exp(x) - 1)*100
mult_est = function(df, m) {
  mutate(df, estimate=m*estimate, std.error=sqrt(m)*std.error)
}
model_ci = function(df) {
  df %>%
    mutate(pct_change=est2pct(estimate),
           ci=1.96*std.error,
           ci_low=est2pct(estimate - ci),
           ci_high=est2pct(estimate + ci),
           change_str=sprintf('%.2f%% (%.2f -- %.2f%%)', pct_change, ci_low, ci_high))
}

claims_overall = claims_by_abx %>%
  select(-n_bene) %>%
  group_by(year) %>%
  summarize_at(vars(n, cpkp), sum) %>%
  mutate(antibiotic='overall')

bind_rows(claims_by_abx, claims_overall) %>%
  filter(antibiotic %in% c('overall', 'azithromycin', 'levofloxacin'), year %in% c(2011, 2014)) %>%
  select(antibiotic, year, cpkp) %>%
  spread(year, cpkp) %>%
  mutate(pct_change=round(100*(`2014`-`2011`)/`2011`, 2)) %>%
  kable
```

There are `r n_million_unique_bene` million unique beneficiaries and `r n_million_pde` million PDEs across all study years.

# Beneficiary characteristics

There were `r prettyNum(n_unique_bene, big.mark=',')` unique beneficiaries and `r prettyNum(n_pde, big.mark=',')` PDEs.

A star indicates that the trend (*t*-test for mean difference between years equal to zero) is significant after multiple hypothesis correction. A dot indicates significance ($p < 0.05$) before multiple hypothesis correction. Mean age decreased during the study.

```{r bene_char_table}
trend_p = function(x) tidy(t.test(diff(x)))$p.value
totals_trends = totals %>%
  gather('var', 'val', -year) %>%
  arrange(var, year, val) %>%
  group_by(var) %>%
  summarize(p=trend_p(val)) %>%
  mutate(adj.p=p.adjust(p, method='BH')) %>%
  mutate(sig=case_when(.$adj.p < 0.05 ~ '*',
                       .$p < 0.05 ~ '.',
                       TRUE ~ ''))

totals %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sd_age, mean_n_cc, sd_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west) %>%
  mutate_at(vars(starts_with('pct_')), function(x) round(x, digits=1)) %>%
  mutate(n_bene=prettyNum(n_bene, big.mark=','),
         mean_age=round(mean_age, digits=1)) %>%
  mutate_at(vars(mean_n_cc, sd_age, sd_n_cc),
            function(x) round(x, digits=2)) %>% 
  gather('var', 'val', -year) %>% spread(year, val) %>% # transpose
  left_join(totals_trends %>% select(var, sig), by='var') %>%
  kable
```

# Patterns of consumption

All consumption rates are reported as claims per thousand people per year (CPKP).

## Claims by abx

```{r claims_by_abx}
top_abx = claims_by_abx %>%
  group_by(antibiotic) %>%
  summarize(cpkp=mean(cpkp)) %>%
  arrange(desc(cpkp)) %$%
  head(antibiotic, 10)

claims_by_top_abx = claims_by_abx %>%
  bind_rows(claims_overall) %>%
  mutate(antibiotic=fct_relevel(fct_other(antibiotic, keep=c('overall', top_abx)),
                                c('overall', top_abx, 'Other'))) %>%
  group_by(year, antibiotic) %>%
  summarize_at(vars(n, cpkp), sum) %>% ungroup()
```

```{r claims_by_top_abx_figs}
claims_by_top_abx %>%
  filter(antibiotic=='overall') %>%
  ggplot(aes(x=year, y=cpkp)) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(975, 1525), breaks=c(1000, 1125, 1250, 1375, 1500)) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, all abx')

claims_by_top_abx %>%
  filter(antibiotic %in% c('azithromycin', 'ciprofloxacin', 'amoxicillin', 'cephalexin', 'trimethoprim/sulfamethoxazole', 'levofloxacin')) %>%
  ggplot(aes(x=year, y=cpkp, color=antibiotic)) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, 250), breaks=c(0, 50, 100, 150, 200, 250)) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, top 5')

claims_by_top_abx %>%
  filter(antibiotic %in% c('amoxicillin/clavulanate', 'doxycycline', 'nitrofurantoin', 'clindamycin')) %>%
  ggplot(aes(x=year, y=cpkp, color=antibiotic)) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, 100), breaks=c(0, 50, 100)) +
  #ylim(0, 140) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, next 5')
```

```{r claims_by_top_abx_facet, eval=FALSE}
claims_by_top_abx %>%
  filter(antibiotic %in% c('azithromycin', 'ciprofloxacin', 'amoxicillin', 'cephalexin', 'trimethoprim/sulfamethoxazole')) %>%
  ggplot(aes(x=year, y=cpkp, color=antibiotic)) +
  #ggplot(aes(x=year, y=cpkp)) +
  facet_wrap(~antibiotic, ncol=5) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, 250), breaks=c(0, 50, 100, 150, 200, 250)) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, top 5')

claims_by_top_abx %>%
  filter(antibiotic %in% c('levofloxacin', 'amoxicillin/clavulanate', 'doxycycline', 'nitrofurantoin', 'clindamycin')) %>%
  ggplot(aes(x=year, y=cpkp, color=antibiotic)) +
  #ggplot(aes(x=year, y=cpkp)) +
  facet_wrap(~antibiotic, ncol=5) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, 150), breaks=c(0, 50, 100)) +
  #ylim(0, 140) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, next 5')
```

## Claims by age group

```{r claims_by_age}
change_demog = read_tsv('tables/model_overall_demography.tsv') %>%
  mutate(estimate=3*estimate,
         std.error=sqrt(3)*std.error) %>%
  model_ci() %>%
  filter(term=='year') %>%
  select(name, adj_change=change_str)

claims_by = function(x) {
  read_tsv(str_interp("tables/claims_by_${x}.tsv")) %>%
    rename_(.dots=list(name=x)) %>%
    select(name, year, cpkp) %>%
    filter(year %in% c(2011, 2014)) %>%
    spread(year, cpkp) %>%
    mutate(pct_change=round((`2014`-`2011`)/`2011`*100, 2)) %>%
    mutate_at(vars(`2011`, `2014`), round) %>%
    mutate(group=x)
}

# do claims by age group separate
# this could be baked into the analysis step
claims_by_age = read_tsv('tables/claims_by_age.tsv') %>%
  filter(year %in% c(2011, 2014)) %>%
  mutate(name=case_when(between(.$age, 65, 75) ~ 'age65_75',
                        between(.$age, 76, 85) ~ 'age76_85',
                        between(.$age, 86, 95) ~ 'age86_95')) %>%
  group_by(year, name) %>%
  summarize_at(vars(n_bene, n_claims), sum) %>%
  ungroup() %>%
  mutate(cpkp=1000*n_claims/n_bene) %>%
  select(year, name, cpkp) %>%
  spread(year, cpkp) %>%
  mutate(pct_change=round((`2014`-`2011`)/`2011`*100, 2)) %>%
  mutate_at(vars(`2011`, `2014`), round) %>%
  mutate(group='age')

# use a common interface for all the others
bind_rows(claims_by_age,
          claims_by('sex'),
          claims_by('race'),
          claims_by('region')) %>%
  left_join(change_demog, by='name') %>%
  select(group, name, `2011`, `2014`, pct_change, adj_change) %>%
  kable
```

# Adjusted consumption changes by drug

Adjusted changes were computed using a Poisson regression predicting claims per capita. The unit of analysis were individual beneficiaries in each year. The covariates in the regression were age, number of chronic conditions, dual eligibility, sex, race (white or not), and region.

## By drug

```{r adjusted_changes}
adjusted_changes = read_tsv('tables/model_abx.tsv') %>%
  rename(antibiotic=name) %>%
  filter(term=='year') %>%
  mutate(estimate=3*estimate,
         std.error=sqrt(3)*std.error) %>%
  model_ci() %>%
  select(antibiotic, pct_change, ci_low, ci_high) %>%
  arrange(pct_change) %>%
  mutate(antibiotic=fct_inorder(antibiotic),
         antibiotic=fct_relevel(antibiotic, 'overall', after=Inf))

unadjusted_changes = bind_rows(claims_by_abx, claims_overall) %>%
  filter(antibiotic %in% c('overall', top_abx), year %in% c(2011, 2014)) %>%
  select(antibiotic, year, cpkp) %>%
  spread(year, cpkp) %>%
  mutate(change=`2014`-`2011`,
         fold_change=change/`2011`,
         pct_change=100*fold_change) %>%
  select(antibiotic, pct_change)

adjusted_changes %>%
  ggplot(aes(x=antibiotic, y=pct_change, ymin=ci_low, ymax=ci_high)) +
  geom_bar(stat='identity', fill=NA, color='black') +
  geom_errorbar(width=0.5) +
  geom_point(dat=unadjusted_changes, aes(x=antibiotic, y=pct_change, ymin=NULL, ymax=NULL), shape=1) +
  coord_flip() +
  xlab('') +
  ylab('adjusted change in consumption 2011 to 2014 (%)') +
  scale_y_continuous(limits=c(-22, 32), breaks=c(-20, -10, 0, 10, 20, 30)) +
  theme_minimal() +
  theme(axis.title.x = element_text(size=16),
        axis.text = element_text(size=16))
```

```{r adjusted_changes_table}
adjusted_changes %>% arrange(desc(antibiotic)) %>% kable

adjusted_az_decrease = adjusted_changes %>%
  filter(antibiotic=='azithromycin') %>%
  pull(pct_change) %>%
  round(2)

adjusted_levo_increase = adjusted_changes %>%
  filter(antibiotic=='levofloxacin') %>%
  pull(pct_change) %>%
  round(2)
```

Consumption of azithromycin fell by `r adjusted_az_decrease`% over the entire study period. Levofloxacin consumption increased by `r adjusted_levo_increase`% over the entire study period.

## Fluoroquinolones

Consumption of ciprofloxacin is slightly decreasing, and consumption of levofloxacin is increasing. How does fluoroquinolone consumption overall change?

```{r fq_table}
fq_names = claims_by_abx %>%
  filter(str_detect(antibiotic, 'floxacin')) %>%
  group_by(antibiotic) %>%
  summarize(n=sum(n)) %>%
  arrange(desc(n)) %$%
  antibiotic

fq_table = claims_by_abx %>%
  filter(antibiotic %in% fq_names) %>%
  group_by(year) %>%
  summarize(cpkp=sum(cpkp))

fq_change_pct_unadj = fq_table %>%
  spread(year, cpkp) %$%
  { (`2014`-`2011`)/`2011` } %>%
  { round(100*., 2) }
```

```{r fq_trends}
fq_trends = read_tsv('tables/model_fq.tsv') %>%
  mult_est(3) %>%
  model_ci() %>%
  select(term, pct_change, ci_low, ci_high, p.value)

fq_change_adj = fq_trends %>%
  filter(term=='year') %>% 
  mutate_at(vars(pct_change, ci_low, ci_high), function(x) round(x, 2)) %$%
  str_interp("${pct_change}% (${ci_low}% -- ${ci_high}%)")
```

Overall, fluoroquinolones changed by a tiny amount, `r fq_change_pct_unadj`% (unadjusted). The adjusted change is `r fq_change_adj` over this period. This included `r fq_names`.

# Prescribing practice

## Methodology

First, I looked at all encounters recorded in the Carrier Line File and the Outpatient file. A large fraction, I think 78%, of PDEs had an encounter 0-7 days before.

Next, I limited by analysis to encounters who HCPCS code indicated an E&M visit, and I grouped diagnostic codes into categories using Fleming-Dutra eTable 2. I determined the trends in the prevalence of these diagnosis categories by counting the diagnoses per beneficiary per year and by using Poisson regressions that account for the unusual covariates.

I analyzed trends in prescribing practice by computing the fraction of encounters in each diagnosis category that were followed by PDEs for each drug. I computed adjusted trends using logistic regression.

Finally, I considered only those PDEs that are downstream of those E&M diagnoses. For each antibiotic, I computed the fraction of PDEs that have each diagnosis category upstream.

## Trends in diagnoses

Are some diagnoses becoming more or less common?

First, unadjusted trends in the number of diagnoses per 1,000 beneficiaries in each year. The percent change is between 2011 and 2014.

Second, adjusted trends, using Poisson regressions. The unit of analysis is the beneficiary in a year. The outcome variable is number of diagnoses in that category. The main predictor is year; the other covariates are as above. The percent change is between 2011 and 2014.

```{r dx_trends}
dx_unadj = read_tsv('tables/dx_trends_table.tsv') %>%
  filter(year %in% c(2011, 2014)) %>%
  left_join(select(totals, year, n_bene), by='year') %>%
  mutate(dxpkp=1000*n_dx/n_bene) %>%
  select(dx_cat, year, dxpkp) %>%
  spread(year, dxpkp) %>%
  mutate(pct_change=(`2014`/`2011`-1)*100) %>%
  arrange(desc(`2011`)) %>%
  mutate_if(is.numeric, function(x) round(x, 2))

dx_adj = read_tsv('tables/dx_trends.tsv') %>%
  rename(dx_cat=model) %>%
  filter(term=='year') %>%
  mult_est(3) %>%
  model_ci() %>%
  select(dx_cat, adj_change=change_str, p.value)

dx_trends = full_join(dx_unadj, dx_adj, by='dx_cat')

dx_trends %>% kable
```

## Common diagnoses by drug

For each drug, I asked what fraction of PDEs are associated with each diagnosis. This gives you a sense that, say, the diagnoses that give rise to azithromycin are bronchitis, URI, etc. The values are percents in 2011.

```{r dx_from_pde}
dx_from_pde = read_tsv('tables/dx_from_pde.tsv') %>% 
  spread(present, n) %>%
  mutate(pct=`TRUE`/(`TRUE` + `FALSE`)*100 %>% round(2)) %>%
  select(antibiotic, dx_cat, pct) %>%
  spread(dx_cat, pct) %T>%
  kable
```

## Trends in prescribing practice

For each diagnosis and each drug, I ask what fraction of diagnoses are followed by a PDE for that drug in 2011 and 2014. I compute the percent change in those fractions.

Second, I do logistic regressions. The unit of analysis is the diagnosis. The outcome is whether a PDE for that drug follows a diagnosis in that category. The main predictor is year; covariates are as above. The adjusted percent change is between 2011 and 2014. (I computed this adjusted change, which is a relative risk, using the odds ratio from the regression and the mean probability of PDE for that diagnosis in 2011. This strictly incorrect: the mean relative risk is the mean of the risks computed using the predicted probabilities for each 2011 diagnosis, *not* the relative risk computed using the mean probability in 2011.)

```{r dx_to_pde}
dx_to_pde_unadj = read_tsv('tables/dx_rx_table.tsv') %>%
  filter(year %in% c(2011, 2014)) %>%
  select(dx_cat, antibiotic, year, f) %>%
  spread(year, f)

dx_to_pde_adj = read_tsv('tables/dx_rx_trends.tsv') %>%
  filter(term=='year') %>%
  mult_est(3) %>%
  mutate(ci=1.96*std.error,
         ci_low=estimate-ci,
         ci_high=estimate+ci) %>%
  select(dx_cat, antibiotic, estimate, ci_low, ci_high) %>%
  arrange(dx_cat, antibiotic)

risk_ratio_f = function(odr, p) odr / (1 + p * (odr - 1))

dx_to_pde = inner_join(dx_to_pde_unadj,
                       dx_to_pde_adj,
                       by=c('dx_cat', 'antibiotic')) %>%
  # convert model estimates to odds ratios, then to risk ratios,
  # then to adjusted fractional changes, then to percentages
  mutate(or=exp(estimate),
         or_low=exp(ci_low),
         or_high=exp(ci_high),
         rr=risk_ratio_f(or, `2011`),
         rr_low=risk_ratio_f(or_low, `2011`),
         rr_high=risk_ratio_f(or_high, `2011`),
         adj_change=rr-1,
         adj_change_low=rr_low-1,
         adj_change_high=rr_high-1,
         pct_change=(`2014`-`2011`)/`2011`) %>%
  mutate_if(is.numeric, function(x) round(x*100, 2)) %>%
  mutate(adj_change=sprintf('%.2f%% (%.2f -- %.2f%%)', adj_change, adj_change_low, adj_change_high)) %>%
  select(dx_cat, antibiotic, `2011`, `2014`, pct_change, adj_change) %T>%
  kable
```

## Combined tables

```{r}
x = dx_trends %>%
  select(-p.value) %>%
  gather('key', 'value', -dx_cat) %>%
  spread(dx_cat, value) %>%
  mutate(antibiotic='dx_trends')

y = dx_from_pde %>%
  mutate(key='dx_from_pde') %>%
  mutate_if(is.numeric, function(x) as.character(round(x, 2)))

z = dx_to_pde %>%
  gather('key', 'value', -dx_cat, -antibiotic) %>%
  spread(dx_cat, value)

combined_table = bind_rows(x, y, z) %>%
  mutate(antibiotic=factor(antibiotic, levels=c('dx_trends', top_abx)),
         key=factor(key, levels=c('dx_from_pde', '2011', '2014', 'pct_change', 'adj_change'))) %>%
  arrange(antibiotic, key)
```

### Respiratory stuff

All respiratory diagnoses fell, bronchitis the most sharply. Azithromycin prescribing fell for all diagnoses, while levofloxacin, amox, and amox/clav prescribing rose for all diagnoses. 

```{r respiratory}
combined_table %>%
  filter(antibiotic %in% c('dx_trends', 'azithromycin', 'levofloxacin', 'amoxicillin', 'amoxicillin/clavulanate')) %>%
  select(antibiotic, key, not_infectious, asthma, bronchitis, other_resp, pharyngitis, pneumonia, sinusitis, uri) %>%
  kable
```

### UTIs

UTIs declined somewhat in prevalence. Ciprofloxacin prescribing remained nearly constant, nitrofurantion fell 3%, and Bactrim rose 4-6%.

```{r uti}
combined_table %>%
  filter(antibiotic %in% c('dx_trends', 'ciprofloxacin', 'trimethoprim/sulfamethoxazole', 'nitrofurantoin')) %>%
  select(antibiotic, key, not_infectious, uti, uti_t3) %>%
  kable
```

### SSTI

Although skin and soft tissue infections declined in prevalence, prescribing of clindamycin, cephalexin, Bactrim, amox, and amox/clav increased, with one exception: amox/clav use for Tier 2 SSTIs stay nearly constant. Clindamycin was the biggest winner.

```{r ssti}
# swo: I removed amox and amox/clav because they mostly
# showed trends in Tier 3, which is confusing
combined_table %>%
  filter(antibiotic %in% c('dx_trends', 'clindamycin', 'cephalexin', 'trimethoprim/sulfamethoxazole')) %>%
  select(antibiotic, key, not_infectious, ssti, ssti_t3) %>%
  kable
```

### GI

GI indications became less prevalent, and cipro prescribing fell 1-2%. Only a small amount of cipro is used for GI indications: compare the 5-6% of cipro PDEs preceded by GI indications with the 14-20% preceded by UTIs.

```{r gi}
combined_table %>%
  filter(antibiotic %in% c('dx_trends', 'ciprofloxacin')) %>%
  select(antibiotic, key, not_infectious, gi, gi_t3) %>%
  kable
```

# Questions for the paper

## Lumping together diagnoses

I could lump the multiple tiers for diagnoses together. This
makes the table easier to interpret, but it doesn't make the point that
diagnosing patterns for multiple tiers for the same diagnosis genus have
similar dynamics, i.e., appropriate and inappropriate prescribing are changing
the same ways.
