---
title: "Ms 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE, autodep=TRUE)
import::from(knitr, kable)
```

# Population characteristics

```{r pop_chars}
pop_chars = read_tsv('tables/pop_chars.tsv') %>%
  select(-sem_age, -sem_n_cc) %>%
  mutate_at(vars(n_female:n_region_midwest), function(x) x / .$n_bene * 100)

trend_p = function(x) tidy(t.test(diff(x)))$p.value

pop_char_trends = pop_chars %>%
  select(year, n_bene, mean_age, mean_n_cc, n_female:n_region_midwest) %>%
  gather('key', 'value', -year) %>%
  arrange(key, year) %>%
  group_by(key) %>%
  summarize(p=trend_p(value)) %>%
  mutate(adj.p=p.adjust(p, method='BH'))

pop_chars %>%
  mutate(n_bene=prettyNum(n_bene, big.mark=',')) %>%
  mutate_at(vars(mean_age, sd_age, n_female:n_region_midwest), function(x) format(x, digits=1, nsmall=1)) %>%
  mutate_at(vars(mean_n_cc, sd_n_cc), function(x) format(x, digits=2, nsmall=2)) %>%
  gather('key', 'value', -year) %>%
  spread(year, value) %>%
  mutate(key=factor(key, levels=names(pop_chars))) %>%
  arrange(key) %>%
  kable(caption='Population characteristics')

pop_char_trends %>%
  kable(caption='Trends in population characteristics')
```

There are `r scan('tables/n_unique_bene.txt') %>% prettyNum(big.mark=',')` unique beneficiaries.

**swo**: Double-check that number.

There are **swo: PDES** and first fills.

# Trends in drug usage

## Raw trends

```{r raw_drug_trends}
claims_by_abx = read_tsv('tables/claims_by_abx.tsv') %>%
  mutate(abx=fct_inorder(factor(abx)))

abx_levels = levels(claims_by_abx$abx)

claims_by_abx %>%
  filter(abx=='overall') %>%
  ggplot(aes(x=year, y=cpkp)) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(975, 1525), breaks=c(1000, 1125, 1250, 1375, 1500)) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, all abx')

claims_by_abx %>%
  filter(abx %in% c('azithromycin', 'ciprofloxacin', 'amoxicillin', 'cephalexin', 'tmpsmx', 'levofloxacin')) %>%
  ggplot(aes(x=year, y=cpkp, color=abx)) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, 250), breaks=c(0, 50, 100, 150, 200, 250)) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, top 5')

claims_by_abx %>%
  filter(abx %in% c('amoxclav', 'doxycycline', 'nitrofurantoin', 'clindamycin')) %>%
  ggplot(aes(x=year, y=cpkp, color=abx)) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, 100), breaks=c(0, 50, 100)) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, next 5')
```

## Trends in appropriateness

```{r approp_trends}
# fold change in consumption
pde_trend = drug_trends %>%
  filter(abx=='overall') %>%
  mutate(rr=exp(estimate),
         rr_lo=exp(ci_lo),
         rr_hi=exp(ci_hi))

d_c = pde_trend$rr
d_c_lo = pde_trend$rr_lo
d_c_hi = pde_trend$rr_hi

# fraction inappropriate in 2011
risk_ratio_f = function(or, p) or / (1 + p * (or - 1))
f_i = scan('tables/inapprop_risk_2011.txt')

inapprop_trend = read_tsv('tables/inapprop_trend.tsv') %>%
  filter(term=='year') %>%
  mutate(estimate=3*estimate,
         std.error=sqrt(3)*std.error) %>%
  mutate(ci=1.96*std.error,
         ci_lo=estimate-ci,
         ci_hi=estimate+ci) %>%
  mutate(or   =exp(estimate),
         or_lo=exp(ci_lo),
         or_hi=exp(ci_hi)) %>%
  mutate(rr   =risk_ratio_f(or, f_i),
         rr_lo=risk_ratio_f(or_lo, f_i),
         rr_hi=risk_ratio_f(or_hi, f_i))

d_f = inapprop_trend$rr
d_f_lo = inapprop_trend$rr_lo
d_f_hi = inapprop_trend$rr_hi
  
rr2pct = function(x) round((x - 1) * 100, 2)

inapprop_trends = data_frame(
  abx=c('overall_inapp', 'overall_app'),
  y   =c(d_c    * d_f,    (1.0 - d_f    * f_i) / (1.0 - f_i) * d_c),
  ymin=c(d_c_lo * d_f_lo, (1.0 - d_f_hi * f_i) / (1.0 - f_i) * d_c_lo),
  ymax=c(d_c_hi * d_f_hi, (1.0 - d_f_lo * f_i) / (1.0 - f_i) * d_c_hi)
) %>%
  mutate_if(is.numeric, rr2pct)

kable(inapprop_changes)
```

## Adjusted trends

```{r drug_trends}
est2pct = function(x) (exp(x) - 1)*100

drug_trends = read_tsv('tables/trend_models.tsv') %>%
  filter(term=='year') %>%
  arrange(estimate) %>%
  mutate(estimate=3*estimate,
         std.error=sqrt(3)*std.error) %>%
  mutate(ci=1.96*std.error,
         ci_lo=estimate-ci,
         ci_hi=estimate+ci) %>%
  mutate(y=est2pct(estimate),
         ymin=est2pct(ci_lo),
         ymax=est2pct(ci_hi)) %>%
  mutate(change=sprintf('%.2f (%.2f -- %.2f)', y, ymin, ymax))

drug_trends %>%
  select(abx, y, ymin, ymax) %>%
  mutate_if(is.numeric, function(x) format(x, digits=2, nsmall=2)) %>%
  kable(caption='Drug trends: Percent change from 2011 to 2014')

abx_trends_levels = drug_trends %>%
  filter(abx != 'overall') %$%
  { c('overall', 'overall_app', 'overall_inapp', rev(abx)) }

drug_and_inapprop_trends = drug_trends %>%
  select(abx, y, ymin, ymax) %>%
  bind_rows(inapprop_trends) %>%
  mutate(abx=factor(abx, levels=rev(abx_trends_levels)))

drug_and_inapprop_trends %>%
  ggplot(aes(x=abx, y=y, ymin=ymin, ymax=ymax)) +
  geom_bar(stat='identity', fill='white', color='black') +
  geom_errorbar(width=0.5) +
  coord_flip() +
  xlab('') +
  ylab('adjusted change in consumption 2011 to 2014 (%)') +
  scale_y_continuous(limits=c(-22, 32), breaks=c(-20, -10, 0, 10, 20, 30)) +
  theme_minimal() +
  theme(axis.title.x = element_text(size=16),
        axis.text = element_text(size=16))

drug_and_inapprop_trends %>%
  arrange(desc(abx)) %>%
  kable(caption='Percent changes; same data as in figure')
```

# Supplement

## Claims by demography

```{r claims_by_demography}
claims_by = function(by) {
  read_tsv(str_interp("tables/claims_by_${by}.tsv")) %>%
    mutate(group_type=by) %>%
    rename(group=!!rlang::sym(by)) %>%
    filter(year %in% c(2011, 2014)) %>%
    select(group_type, group, year, cpkp) %>%
    spread(year, cpkp) %>%
    mutate_at(vars(`2011`, `2014`), round)
}

trends_by_demography = read_tsv('tables/demography_models.tsv') %>%
  filter(term=='year') %>%
  mutate(estimate=3*estimate,
         std.error=sqrt(3)*std.error) %>%
  mutate(ci=1.96*std.error,
         ci_lo=estimate-ci,
         ci_hi=estimate+ci) %>%
  mutate(y=est2pct(estimate),
         ymin=est2pct(ci_lo),
         ymax=est2pct(ci_hi)) %>%
  mutate(change=sprintf('%.2f (%.2f -- %.2f)', y, ymin, ymax)) %>%
  select(group_type, group, change)

# overall trend row
overall_change = drug_trends %>% filter(abx=='overall') %>% pull(change)
overall_row = claims_by_abx %>%
  filter(abx=='overall', year %in% c(2011, 2014)) %>%
  mutate(cpkp=round(cpkp)) %>%
  spread(year, cpkp) %>%
  mutate(group_type='overall', group='overall', change=overall_change) %>%
  select(group_type, group, `2011`, `2014`, change)

bind_rows(
  claims_by('age_group'),
  claims_by('sex'),
  claims_by('race'),
  claims_by('region')
) %>%
  left_join(trends_by_demography, by=c('group', 'group_type')) %>%
  bind_rows(overall_row, .) %>%
  kable
```



# ***Earlier content



### All fills

# Prescribing practice

## Methodology

First, I looked at all encounters recorded in the Carrier Line File and the Outpatient file. A large fraction, I think 78%, of PDEs had an encounter 0-7 days before.

Next, I limited by analysis to encounters who HCPCS code indicated an E&M visit, and I grouped diagnostic codes into categories using Fleming-Dutra eTable 2. I determined the trends in the prevalence of these diagnosis categories by counting the diagnoses per beneficiary per year and by using Poisson regressions that account for the unusual covariates.

I analyzed trends in prescribing practice by computing the fraction of encounters in each diagnosis category that were followed by PDEs for each drug. I computed adjusted trends using logistic regression.

Finally, I considered only those PDEs that are downstream of those E&M diagnoses. For each antibiotic, I computed the fraction of PDEs that have each diagnosis category upstream.

To compute appropriateness, I classified each PDE with the maximum appropriateness of all its linked diagnoses. I put PDEs with no associated infectious disease (i.e., FD) diagnoses into their own, lower tier.

## Numbers of diagnoses

The fraction of diagnoses that have E&M HCPCS codes:

```{r hcpcs_count}
encounter_counts = read_tsv('raw_data/dx_cat_count.tsv') %>%
  summarize(n_encounters=sum(n_encounters),
            n_em_encounters=sum(n_encounters[hcpcs_em]),
            f_em_encounters=weighted.mean(hcpcs_em, weights=n_encounters))

hcpcs_count %>% kable
```

This equals a total of `r prettyNum(sum(encounter_counts$n_encounters), big.mark=',')` encounters.

The fraction of first-fill PDEs that have upstream:

```{r pde_with_dx_upstream}
read_tsv('tables/pde_with_dx_upstream.tsv') %>%
  group_by(has_dx, has_em_dx) %>%
  summarize(n=sum(n)) %>%
  ungroup() %>%
  mutate(f=n/sum(n), cumf=cumsum(f), cumf1=1-cumf) %>%
  kable
```

## Common diagnoses by drug

For each drug, I asked what fraction of PDEs are associated with each diagnosis. This gives you a sense that, say, the diagnoses that give rise to azithromycin are bronchitis, URI, etc. The values are percents in 2011. A row can add up to more than 100% because one PDE can be associated with multiple diagnoses.

```{r dx_from_pde}
dx_from_pde = read_tsv('tables/dx_from_pde.tsv') %>% 
  spread(present, n) %>%
  mutate(pct=`TRUE`/(`TRUE` + `FALSE`)*100 %>% round(2)) %>%
  select(antibiotic, dx_cat, pct) %>%
  spread(dx_cat, pct)

dx_from_pde %>% kable
```

## Trends in prescribing practice

For each diagnosis and each drug, I ask what fraction of diagnoses are followed by a PDE for that drug in 2011 and 2014. I compute the percent change in those fractions.

Second, I do logistic regressions. The unit of analysis is the diagnosis. The outcome is whether a PDE for that drug follows a diagnosis in that category. The main predictor is year; covariates are as above. The adjusted percent change is between 2011 and 2014. (I computed this adjusted change, which is a relative risk, using the odds ratio from the regression and the mean probability of PDE for that diagnosis in 2011. This strictly incorrect: the mean relative risk is the mean of the risks computed using the predicted probabilities for each 2011 diagnosis, *not* the relative risk computed using the mean probability in 2011.)

```{r dx_to_pde}
dx_to_pde_unadj = read_tsv('tables/dx_to_pde_table.tsv') %>%
  filter(year %in% c(2011, 2014)) %>%
  select(dx_cat, antibiotic, year, f=f_encounters_with_abx) %>%
  spread(year, f)

dx_to_pde_adj = read_tsv('tables/dx_to_pde_trends.tsv') %>%
  filter(term=='year') %>%
  mult_est(3) %>%
  mutate(ci=1.96*std.error,
         ci_low=estimate-ci,
         ci_high=estimate+ci) %>%
  select(dx_cat, antibiotic, estimate, ci_low, ci_high) %>%
  arrange(dx_cat, antibiotic)

dx_to_pde = inner_join(dx_to_pde_unadj,
                       dx_to_pde_adj,
                       by=c('dx_cat', 'antibiotic')) %>%
  # convert model estimates to odds ratios, then to risk ratios,
  # then to adjusted fractional changes, then to percentages
  mutate(or=exp(estimate),
         or_low=exp(ci_low),
         or_high=exp(ci_high),
         rr=risk_ratio_f(or, `2011`),
         rr_low=risk_ratio_f(or_low, `2011`),
         rr_high=risk_ratio_f(or_high, `2011`),
         adj_change=rr-1,
         adj_change_low=rr_low-1,
         adj_change_high=rr_high-1,
         pct_change=(`2014`-`2011`)/`2011`) %>%
  mutate_if(is.numeric, function(x) round(x*100, 2)) %>%
  mutate(adj_change=sprintf('%.2f (%.2f -- %.2f)', adj_change, adj_change_low, adj_change_high)) %>%
  select(dx_cat, antibiotic, `2011`, `2014`, pct_change, adj_change) %T>%
  kable
```

## Combined tables

```{r}
x = read_tsv('tables/dx_cat_counts.tsv') %>%
  mutate(value=n_dx/n_bene*1000) %>%
  group_by(dx_cat) %>%
  summarize(value=mean(value)) %>%
  # convert to character to fit with other parts
  mutate(value=as.character(round(value))) %>%
  spread(dx_cat, value) %>%
  mutate(antibiotic='dx', key='mean_per_1kyr')

y = dx_from_pde %>%
  mutate(key='dx_from_pde') %>%
  mutate_if(is.numeric, function(x) as.character(round(x, 2)))

z = dx_to_pde %>%
  gather('key', 'value', -dx_cat, -antibiotic) %>%
  spread(dx_cat, value)

combined_table = bind_rows(x, y, z) %>%
  mutate(antibiotic=factor(antibiotic, levels=c('dx', top_abx)),
         key=factor(key, levels=c('mean_per_1kyr', 'dx_from_pde', '2011', '2014', 'pct_change', 'adj_change'))) %>%
  arrange(antibiotic, key)
```

### Respiratory stuff

All respiratory diagnoses fell, bronchitis the most sharply. Azithromycin prescribing fell for all diagnoses, while levofloxacin, amox, and amox/clav prescribing rose for all diagnoses. 

```{r respiratory}
combined_table %>%
  filter(antibiotic %in% c('dx', 'azithromycin', 'levofloxacin', 'amoxicillin', 'amoxicillin/clavulanate')) %>%
  select(antibiotic, key, asthma, bronchitis, other_resp, pharyngitis, pneumonia, sinusitis, uri) %>%
  kable
```

### UTIs

UTIs declined somewhat in prevalence. Ciprofloxacin prescribing remained nearly constant, nitrofurantion fell 3%, and Bactrim rose 4-6%.

```{r uti}
combined_table %>%
  filter(antibiotic %in% c('dx', 'ciprofloxacin', 'trimethoprim/sulfamethoxazole', 'nitrofurantoin')) %>%
  select(antibiotic, key, uti, uti_t3) %>%
  kable
```

### SSTI

Although skin and soft tissue infections declined in prevalence, prescribing of clindamycin, cephalexin, Bactrim, amox, and amox/clav increased, with one exception: amox/clav use for Tier 2 SSTIs stay nearly constant. Clindamycin was the biggest winner.

```{r ssti}
# swo: I removed amox and amox/clav because they mostly
# showed trends in Tier 3, which is confusing
combined_table %>%
  filter(antibiotic %in% c('dx', 'clindamycin', 'cephalexin', 'trimethoprim/sulfamethoxazole')) %>%
  select(antibiotic, key, ssti, ssti_t3) %>%
  kable
```

### GI

GI indications became less prevalent, and cipro prescribing fell 1-2%. Only a small amount of cipro is used for GI indications: compare the 5-6% of cipro PDEs preceded by GI indications with the 14-20% preceded by UTIs.

```{r gi}
combined_table %>%
  filter(antibiotic %in% c('dx', 'ciprofloxacin')) %>%
  select(antibiotic, key, gi, gi_t3) %>%
  kable
```
