---
title: "Ms 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE, autodep=TRUE)
import::from(knitr, kable)
```

# Population characteristics

```{r pop_chars}
pop_chars = read_tsv('tables/pop_chars.tsv') %>%
  mutate_at(vars(n_female:n_region_midwest), function(x) x / .$n_bene * 100)

trend_p = function(x) tidy(t.test(diff(x)))$p.value

pop_char_trends = pop_chars %>%
  select(year, n_bene, mean_age, mean_n_cc, n_female:n_region_midwest) %>%
  gather('key', 'value', -year) %>%
  arrange(key, year) %>%
  group_by(key) %>%
  summarize(p=trend_p(value)) %>%
  mutate(adj.p=p.adjust(p, method='BH'))

pop_chars %>%
  mutate(n_bene=prettyNum(n_bene, big.mark=',')) %>%
  mutate_at(vars(mean_age, sd_age, n_female:n_region_midwest), function(x) format(x, digits=1, nsmall=1)) %>%
  mutate_at(vars(mean_n_cc, sd_n_cc), function(x) format(x, digits=2, nsmall=2)) %>%
  gather('key', 'value', -year) %>%
  spread(year, value) %>%
  mutate(key=factor(key, levels=names(pop_chars))) %>%
  arrange(key) %>%
  kable(caption='Population characteristics')

pop_char_trends %>%
  kable(caption='Trends in population characteristics')
```

There are `r scan('tables/n_unique_bene.txt') %>% prettyNum(big.mark=',')` unique beneficiaries.

```{r claims_by_fill}
claims_by_fill = read_tsv('tables/claims_by_fill.tsv') %>%
  mutate(f_refill=refills/overall_wrefill)

claims_by_fill %>%
  mutate_at(vars(-f_refill), function(x) prettyNum(x, big.mark=',')) %>%
  kable(caption='PDEs by refill')
```

The top 10 drugs take up `r round(scan('tables/top10_cumf.txt') * 100, 2)`% of all claims.

# Trends in drug usage

## Raw trends

```{r raw_drug_trends}
claims_by_abx = read_tsv('tables/claims_by_abx.tsv') %>%
  mutate(abx=fct_inorder(factor(abx)))

claims_by_abx %>%
  mutate(cpkp=round(cpkp)) %>%
  spread(year, cpkp) %>%
  kable(caption='Raw drug CPKP')
```

```{r raw_drug_trends_figure}
abx_levels = levels(claims_by_abx$abx)

claims_by_abx %>%
  filter(abx %in% c('overall', 'overall_approp', 'overall_inapprop')) %>%
  ggplot(aes(x=year, y=cpkp, color=abx)) +
  geom_line() +
  scale_y_continuous(limits=c(0, 1400), breaks=c(0, 250, 500, 750, 1000, 1250, 1400)) +
  coord_fixed(ratio=4/1400*1.25) +
  theme_minimal() +
  theme(panel.grid.minor.x=element_blank()) +
  ggtitle('Unadjusted consumption, all abx')

claims_by_abx %>%
  filter(abx %in% c('azithromycin', 'ciprofloxacin', 'amoxicillin', 'cephalexin', 'tmpsmx', 'levofloxacin')) %>%
  ggplot(aes(x=year, y=cpkp, color=abx)) +
  geom_line() +
  scale_y_continuous(limits=c(0, 250), breaks=c(0, 50, 100, 150, 200, 250)) +
  coord_fixed(ratio=4/250*1.25) +
  theme_minimal() +
  theme(panel.grid.minor.x=element_blank()) +
  ggtitle('Unadjusted consumption, top 5')

claims_by_abx %>%
  filter(abx %in% c('amoxclav', 'doxycycline', 'nitrofurantoin', 'clindamycin')) %>%
  ggplot(aes(x=year, y=cpkp, color=abx)) +
  geom_line() +
  scale_y_continuous(limits=c(0, 100), breaks=c(0, 50, 100)) +
  coord_fixed(ratio=4/100*1.25) +
  theme_minimal() +
  theme(panel.grid.minor.x=element_blank()) +
  ggtitle('Unadjusted consumption, next 5')
```

## Adjusted trends

```{r drug_trends}
est2pct = function(x) (exp(x) - 1)*100

drug_trends = read_tsv('tables/trend_models.tsv') %>%
  filter(term=='year') %>%
  arrange(estimate) %>%
  mutate(estimate=3*estimate,
         std.error=sqrt(3)*std.error) %>%
  mutate(ci=1.96*std.error,
         ci_lo=estimate-ci,
         ci_hi=estimate+ci) %>%
  mutate(y=est2pct(estimate),
         ymin=est2pct(ci_lo),
         ymax=est2pct(ci_hi)) %>%
  mutate(change=sprintf('%.2f (%.2f -- %.2f)', y, ymin, ymax))
```

```{r drug_trends_display}
format_p = function(p) {
  if_else(p < 0.001, '< 0.001', as.character(round(p, 3)))
}

drug_trends %>%
  filter(abx != 'overall_wrefill') %>%
  mutate(adj.p=p.adjust(p.value, method='BH')) %>%
  select(abx, y, ymin, ymax, p.value) %>%
  mutate_at(vars(y, ymin, ymax), function(x) format(x, digits=2, nsmall=2)) %>%
  mutate(p.value=format_p(p.value)) %>%
  kable(caption='Drug trends: Percent change from 2011 to 2014')

drug_trends %>%
  filter(abx != 'overall_wrefill') %>%
  # put the abx in order
  arrange(desc(y)) %>%
  mutate(abx=fct_inorder(factor(abx))) %>%
  mutate(abx=fct_relevel(abx, c('overall', 'overall_inapprop', 'overall_approp'))) %>%
  mutate(abx=fct_rev(abx)) %>%
  # plot
  ggplot(aes(x=abx, y=y, ymin=ymin, ymax=ymax)) +
  geom_bar(stat='identity', fill='white', color='black') +
  geom_errorbar(width=0.5) +
  coord_flip() +
  xlab('') +
  ylab('adjusted change in consumption 2011 to 2014 (%)') +
  scale_y_continuous(limits=c(-22, 32.5), breaks=c(-20, -10, 0, 10, 20, 30)) +
  theme_minimal() +
  theme(axis.title.x = element_text(size=16),
        axis.text = element_text(size=16))
```

## Raw inappropriate fractions

```{r inappropriate_fraction}
claims_by_abx %>%
  spread(abx, cpkp) %>%
  mutate(pct_inapprop = overall_inapprop / overall * 100) %>%
  select(year, pct_inapprop) %>%
  kable(caption='Raw fraction of inappropriate prescribing')
```

# Prescribing practice

```{r prescribing_practice}
dx_to_pde_table = read_tsv('tables/dx_to_pde_table.tsv') %>%
  select(-n_encounters) %>%
  filter(year %in% c(2011, 2014)) %>%
  gather('abx', 'f_with_abx', azithromycin:clindamycin)

# swo: convert ORs to RRs!
risk_ratio_f = function(or, p) or / (1 + p * (or - 1))
rr2pct = function(x) (x - 1) * 100

dx_to_pde_trends = read_tsv('tables/dx_to_pde_trends.tsv') %>%
  filter(term=='year') %>%
  mutate(estimate=3*estimate,
         std.error=sqrt(3)*std.error) %>%
  mutate(ci=1.96*std.error,
         ci_lo=estimate-ci,
         ci_hi=estimate+ci) %>%
  mutate(or=   exp(estimate),
         or_lo=exp(ci_lo),
         or_hi=exp(ci_hi)) %>%
  left_join(filter(dx_to_pde_table, year==2011), by=c('dx_cat', 'abx')) %>%
  mutate(rr=   risk_ratio_f(or,    f_with_abx),
         rr_lo=risk_ratio_f(or_lo, f_with_abx),
         rr_hi=risk_ratio_f(or_hi, f_with_abx)) %>%
  mutate(y=rr2pct(rr),
         ymin=rr2pct(rr_lo),
         ymax=rr2pct(rr_hi)) %>%
  mutate(change=sprintf('%.2f (%.2f -- %.2f)', y, ymin, ymax)) %>%
  select(dx_cat, abx, change, p.value)
```

```{r combined_table}
format_pct = function(x) format(round(x*100, 2), digits=2, nsmall=2)

combined_table = dx_to_pde_table %>%
  mutate(f_with_abx=format_pct(f_with_abx)) %>%
  spread(year, f_with_abx) %>%
  left_join(dx_to_pde_trends, by=c('dx_cat', 'abx')) %>%
  mutate(p.value=format_p(p.value)) %>%
  arrange(dx_cat, abx)
```

## Respiratory

```{r respiratory}
combined_table %>%
  filter(dx_cat %in% c('pneumonia', 'sinusitis', 'uri', 'bronchitis'),
         abx %in% c('dx', 'azithromycin', 'levofloxacin', 'amoxclav')) %>%
  kable
```

# Supplement

## Claims by demography

```{r claims_by_demography}
claims_by = function(by) {
  read_tsv(str_interp("tables/claims_by_${by}.tsv")) %>%
    mutate(group_type=by) %>%
    rename(group=!!rlang::sym(by)) %>%
    filter(year %in% c(2011, 2014)) %>%
    select(group_type, group, year, cpkp) %>%
    spread(year, cpkp) %>%
    mutate_at(vars(`2011`, `2014`), round)
}

trends_by_demography = read_tsv('tables/demography_models.tsv') %>%
  filter(term=='year') %>%
  mutate(estimate=3*estimate,
         std.error=sqrt(3)*std.error) %>%
  mutate(ci=1.96*std.error,
         ci_lo=estimate-ci,
         ci_hi=estimate+ci) %>%
  mutate(y=est2pct(estimate),
         ymin=est2pct(ci_lo),
         ymax=est2pct(ci_hi)) %>%
  mutate(change=sprintf('%.2f (%.2f -- %.2f)', y, ymin, ymax)) %>%
  select(group_type, group, change, p.value)

# overall trend row
overall_change = drug_trends %>% filter(abx=='overall') %>% pull(change)
overall_row = claims_by_abx %>%
  filter(abx=='overall', year %in% c(2011, 2014)) %>%
  mutate(cpkp=round(cpkp)) %>%
  spread(year, cpkp) %>%
  mutate(group_type='overall', group='overall', change=overall_change) %>%
  select(group_type, group, `2011`, `2014`, change)

bind_rows(
  claims_by('age_group'),
  claims_by('sex'),
  claims_by('race'),
  claims_by('region')
) %>%
  left_join(trends_by_demography, by=c('group', 'group_type')) %>%
  bind_rows(overall_row, .) %>%
  kable
```

## Other respiratory

```{r other_respiratory}
combined_table %>%
  filter(dx_cat %in% c('pharyngitis', 'asthma', 'other_resp'),
         abx %in% c('azithromycin', 'levofloxacin', 'amoxclav')) %>%
  kable
```

## UTI

```{r uti}
combined_table %>%
  filter(dx_cat %in% c('uti', 'uti_t3'),
         abx %in% c('dx', 'ciprofloxacin', 'tmpsmx', 'nitrofurantoin')) %>%
  kable
```

## SSTI

```{r ssti}
combined_table %>%
  filter(dx_cat %in% c('ssti', 'ssti_t3'),
         abx %in% c('dx', 'cephalexin', 'tmpsmx', 'clindamycin')) %>%
  kable
```
