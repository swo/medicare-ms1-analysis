---
title: "Ms 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE, autodep=TRUE)
import::from(knitr, kable)
import::from(tools, md5sum)
library(forcats)
```

# Abstract

```{r abstract, cache.extra=md5sum('tables/model_abx.tsv')}
pctize = function(df, denom_name) {
  for (n_name in Filter(function(x) str_detect(x, '^n_'), names(df))) {
    pct_name = str_replace(n_name, '^n_', 'pct_')
    df[[pct_name]] = df[[n_name]] / df[[denom_name]] * 100
  }
  df
}

totals = read_tsv('tables/totals.tsv') %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sd_age, mean_n_cc, sd_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west)

claims_by_abx = read_tsv('tables/claims_by_abx.tsv')

est2pct = function(x) (exp(x) - 1)*100

mult_est = function(df, m) {
  mutate(df, estimate=m*estimate, std.error=sqrt(m)*std.error)
}

model_ci = function(df) {
  df %>%
    mutate(pct_change=est2pct(estimate),
           ci=1.96*std.error,
           ci_low=est2pct(estimate - ci),
           ci_high=est2pct(estimate + ci),
           change_str=sprintf('%.2f (%.2f -- %.2f)', pct_change, ci_low, ci_high))
}

claims_overall = claims_by_abx %>%
  select(-n_bene) %>%
  group_by(year) %>%
  summarize_at(vars(n, cpkp), sum) %>%
  mutate(antibiotic='overall')

bind_rows(claims_by_abx, claims_overall) %>%
  filter(antibiotic %in% c('overall', 'azithromycin', 'levofloxacin'), year %in% c(2011, 2014)) %>%
  select(antibiotic, year, cpkp) %>%
  spread(year, cpkp) %>%
  mutate(pct_change=round(100*(`2014`-`2011`)/`2011`, 2)) %>%
  kable
```

# Beneficiary characteristics

```{r unique_bene_pde}
round_millions = function(x) round(x / 1e6, 2)
pn = function(x) prettyNum(x, big.mark=',')

n_unique_bene = scan('tables/n_unique_bene.tsv')

claims_by_fill = read_tsv('tables/claims_by_fill.tsv')
n_pde = sum(claims_by_fill$n)
n_refills = claims_by_fill %>% filter(!first_fill) %$% n
```

There were `r round_millions(n_unique_bene)` million unique beneficiaries. They had `r round_millions(n_pde)` million PDEs, of which `r round_millions(n_refills)` million were refills.

A star indicates that the trend (*t*-test for mean difference between years equal to zero) is significant after multiple hypothesis correction. A dot indicates significance ($p < 0.05$) before multiple hypothesis correction. Mean age decreased during the study.

```{r bene_char_table}
trend_p = function(x) tidy(t.test(diff(x)))$p.value
totals_trends = totals %>%
  gather('var', 'val', -year) %>%
  arrange(var, year, val) %>%
  group_by(var) %>%
  summarize(p=trend_p(val)) %>%
  mutate(adj.p=p.adjust(p, method='BH')) %>%
  mutate(sig=case_when(.$adj.p < 0.05 ~ '*',
                       .$p < 0.05 ~ '.',
                       TRUE ~ ''))

totals %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sd_age, mean_n_cc, sd_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west) %>%
  mutate_at(vars(starts_with('pct_')), function(x) round(x, digits=1)) %>%
  mutate(n_bene=prettyNum(n_bene, big.mark=','),
         mean_age=round(mean_age, digits=1)) %>%
  mutate_at(vars(mean_n_cc, sd_age, sd_n_cc),
            function(x) round(x, digits=2)) %>% 
  gather('var', 'val', -year) %>% spread(year, val) %>% # transpose
  left_join(totals_trends %>% select(var, sig), by='var') %>%
  kable
```

# Patterns of consumption

All consumption rates are reported as claims per thousand people per year (CPKP).

## Claims by abx

The top 10 antibiotics account for most of the claims:

```{r top_10_fraction}
claims_by_abx %>%
  group_by(antibiotic) %>%
  summarize(n=sum(n)) %>%
  arrange(desc(n)) %>%
  mutate(f=n/sum(n), cumf=cumsum(f)) %>%
  head(10) %>%
  kable
```

```{r claims_by_abx}
top_abx = claims_by_abx %>%
  group_by(antibiotic) %>%
  summarize(cpkp=mean(cpkp)) %>%
  arrange(desc(cpkp)) %$%
  head(antibiotic, 10)

claims_by_top_abx = claims_by_abx %>%
  bind_rows(claims_overall) %>%
  mutate(antibiotic=fct_relevel(fct_other(antibiotic, keep=c('overall', top_abx)),
                                c('overall', top_abx, 'Other'))) %>%
  group_by(year, antibiotic) %>%
  summarize_at(vars(n, cpkp), sum) %>% ungroup()
```

```{r claims_by_top_abx_figs}
claims_by_top_abx %>%
  filter(antibiotic=='overall') %>%
  ggplot(aes(x=year, y=cpkp)) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(975, 1525), breaks=c(1000, 1125, 1250, 1375, 1500)) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, all abx')

claims_by_top_abx %>%
  filter(antibiotic %in% c('azithromycin', 'ciprofloxacin', 'amoxicillin', 'cephalexin', 'trimethoprim/sulfamethoxazole', 'levofloxacin')) %>%
  ggplot(aes(x=year, y=cpkp, color=antibiotic)) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, 250), breaks=c(0, 50, 100, 150, 200, 250)) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, top 5')

claims_by_top_abx %>%
  filter(antibiotic %in% c('amoxicillin/clavulanate', 'doxycycline', 'nitrofurantoin', 'clindamycin')) %>%
  ggplot(aes(x=year, y=cpkp, color=antibiotic)) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, 100), breaks=c(0, 50, 100)) +
  #ylim(0, 140) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, next 5')
```

## Claims by demography

```{r claims_by_demography}
change_demog = read_tsv('tables/model_overall_demography.tsv') %>%
  mutate(estimate=3*estimate,
         std.error=sqrt(3)*std.error) %>%
  model_ci() %>%
  filter(term=='year') %>%
  select(name, adj_change=change_str)

claims_by = function(x) {
  read_tsv(str_interp("tables/claims_by_${x}.tsv")) %>%
    rename_(.dots=list(name=x)) %>%
    select(name, year, cpkp) %>%
    filter(year %in% c(2011, 2014)) %>%
    spread(year, cpkp) %>%
    mutate(pct_change=round((`2014`-`2011`)/`2011`*100, 2)) %>%
    mutate_at(vars(`2011`, `2014`), round) %>%
    mutate(group=x)
}

# do claims by age group separate
# this could be baked into the analysis step
claims_by_age = read_tsv('tables/claims_by_age.tsv') %>%
  filter(year %in% c(2011, 2014)) %>%
  mutate(name=case_when(between(.$age, 65, 75) ~ 'age65_75',
                        between(.$age, 76, 85) ~ 'age76_85',
                        between(.$age, 86, 95) ~ 'age86_95',
                        .$age >= 96 ~ 'age96_')) %>%
  group_by(year, name) %>%
  summarize_at(vars(n_bene, n_claims), sum) %>%
  ungroup() %>%
  mutate(cpkp=1000*n_claims/n_bene) %>%
  select(year, name, cpkp) %>%
  spread(year, cpkp) %>%
  mutate(pct_change=round((`2014`-`2011`)/`2011`*100, 2)) %>%
  mutate_at(vars(`2011`, `2014`), round) %>%
  mutate(group='age')

# use a common interface for all the others
bind_rows(claims_by_age,
          claims_by('sex'),
          claims_by('race'),
          claims_by('region')) %>%
  left_join(change_demog, by='name') %>%
  select(group, name, `2011`, `2014`, pct_change, adj_change) %>%
  kable
```

That last table could also use an "overall" row:

```{r}
claims_overall %>%
  filter(year %in% c(2011, 2014)) %>%
  mutate(cpkp=round(cpkp)) %>%
  kable
```

# Adjusted consumption changes by drug

Adjusted changes were computed using a Poisson regression predicting claims per capita. The unit of analysis were individual beneficiaries in each year. The covariates in the regression were age, number of chronic conditions, dual eligibility, sex, race (white or not), and region.

## By drug

### Trends in appropriateness

Just by eye, it looks like the changes in appropriateness are small.

```{r tier_graph}
pde_tier_table = read_tsv('tables/pde_approp_table.tsv') %>%
  group_by(year, antibiotic) %>%
  mutate(f=n/sum(n)) %>%
  ungroup()

pde_tier_table %>%
  filter(antibiotic %in% top_abx) %>%
  ggplot(aes(x=factor(year), y=f, fill=factor(tier))) +
  geom_bar(stat='identity') +
  facet_grid(~antibiotic) +
  theme_classic()
```

```{r approp_trends}
raw_adjusted_changes = read_tsv('tables/model_abx.tsv') %>%
  rename(antibiotic=name) %>%
  filter(term=='year') %>%
  mutate(estimate=3*estimate,
         std.error=sqrt(3)*std.error)

# fraction inappropriate in 2011
f_i = pde_tier_table %>%
  filter(year==2011) %>%
  mutate(inapp=tier==3) %>%
  group_by(inapp) %>%
  summarize(n=sum(n)) %>%
  mutate(f=n/sum(n)) %>%
  filter(inapp) %$%
  f

# fold change in consumption
pde_trend = raw_adjusted_changes %>%
  filter(antibiotic=='overall') %>%
  # multiplications by 3 done above
  mutate(ci=1.96*std.error,
         rr=exp(estimate),
         rr_lo=exp(estimate-ci),
         rr_hi=exp(estimate+ci))

d_c = pde_trend$rr
d_c_lo = pde_trend$rr_lo
d_c_hi = pde_trend$rr_hi

risk_ratio_f = function(odr, p) odr / (1 + p * (odr - 1))

pde_inapprop_trend = read_tsv('tables/pde_inapprop_trend.tsv') %>%
  filter(term=='year') %>%
  mutate(estimate=3*estimate,
         std.error=sqrt(3)*std.error,
         ci=1.96*std.error,
         or=exp(estimate),
         or_lo=exp(estimate-ci),
         or_hi=exp(estimate+ci))

d_f = risk_ratio_f(pde_inapprop_trend$or, f_i)
d_f_lo = risk_ratio_f(pde_inapprop_trend$or_lo, f_i)
d_f_hi = risk_ratio_f(pde_inapprop_trend$or_hi, f_i)

rr2pct = function(x) round((x - 1) * 100, 2)

inapprop_changes = data_frame(
  antibiotic=c('overall_inapp', 'overall_app'),
  pct_change=c(d_c * d_f, (1.0 - d_f * f_i) / (1.0 - f_i) * d_c),
  ci_low=c(d_c_lo * d_f_lo, (1.0 - d_f_hi * f_i) / (1.0 - f_i) * d_c_lo),
  ci_high=c(d_c_hi * d_f_hi, (1.0 - d_f_lo * f_i) / (1.0 - f_i) * d_c_hi)
) %>%
  mutate_if(is.numeric, rr2pct)
```

Inappropriate prescribing changed by `r rr2pct(d_c * d_f)`% (95% CI `r rr2pct(d_c_lo * d_f_lo)` -- `r rr2pct(d_c_hi * d_f_hi)`). Appropriate prescribing changed by `r rr2pct((1.0 - d_f * f_i) / (1.0 - f_i) * d_c)`% (95% CI `r rr2pct((1.0 - d_f_hi * f_i) / (1.0 - f_i) * d_c_lo)` -- `r rr2pct((1.0 - d_f_lo * f_i) / (1.0 - f_i) * d_c_hi)`).

### All fills

Bars show adjusted trends in usage, including refills. The dots shows unadjusted trends.

```{r adjusted_changes}
adjusted_changes = raw_adjusted_changes %>%
  model_ci() %>%
  arrange(desc(pct_change)) %>%
  select(antibiotic, pct_change, ci_low, ci_high)

adjusted_change_levels = adjusted_changes %>%
  filter(antibiotic != 'overall') %$%
  { c('overall', 'overall_app', 'overall_inapp', antibiotic) } %>%
  rev

unadjusted_changes = bind_rows(claims_by_abx, claims_overall) %>%
  filter(antibiotic %in% c('overall', top_abx), year %in% c(2011, 2014)) %>%
  select(antibiotic, year, cpkp) %>%
  spread(year, cpkp) %>%
  mutate(change=`2014`-`2011`,
         fold_change=change/`2011`,
         pct_change=100*fold_change) %>%
  select(antibiotic, pct_change)

adjusted_changes %>%
  bind_rows(inapprop_changes) %>%
  mutate(antibiotic=as.character(antibiotic)) %>%
  mutate(antibiotic=factor(antibiotic, levels=adjusted_change_levels)) %>%
  ggplot(aes(x=antibiotic, y=pct_change, ymin=ci_low, ymax=ci_high)) +
  geom_bar(stat='identity', fill=NA, color='black') +
  geom_errorbar(width=0.5) +
  coord_flip() +
  xlab('') +
  ylab('adjusted change in consumption 2011 to 2014 (%)') +
  scale_y_continuous(limits=c(-22, 32), breaks=c(-20, -10, 0, 10, 20, 30)) +
  theme_minimal() +
  theme(axis.title.x = element_text(size=16),
        axis.text = element_text(size=16))
```

The bars show the adjusted change in consumption. Black circles show unadjusted change in consumption. Blue shows the adjusted change in inappropriate prescribing.

### Adjusted changes in usage table

```{r adjusted_changes_table}
adjusted_changes %>% arrange(desc(antibiotic)) %>% kable

adjusted_az_decrease = adjusted_changes %>%
  filter(antibiotic=='azithromycin') %>%
  pull(pct_change) %>%
  round(2)

adjusted_levo_increase = adjusted_changes %>%
  filter(antibiotic=='levofloxacin') %>%
  pull(pct_change) %>%
  round(2)
```

Consumption of azithromycin fell by `r adjusted_az_decrease`% over the entire study period. Levofloxacin consumption increased by `r adjusted_levo_increase`% over the entire study period.

# Prescribing practice

## Methodology

First, I looked at all encounters recorded in the Carrier Line File and the Outpatient file. A large fraction, I think 78%, of PDEs had an encounter 0-7 days before.

Next, I limited by analysis to encounters who HCPCS code indicated an E&M visit, and I grouped diagnostic codes into categories using Fleming-Dutra eTable 2. I determined the trends in the prevalence of these diagnosis categories by counting the diagnoses per beneficiary per year and by using Poisson regressions that account for the unusual covariates.

I analyzed trends in prescribing practice by computing the fraction of encounters in each diagnosis category that were followed by PDEs for each drug. I computed adjusted trends using logistic regression.

Finally, I considered only those PDEs that are downstream of those E&M diagnoses. For each antibiotic, I computed the fraction of PDEs that have each diagnosis category upstream.

To compute appropriateness, I classified each PDE with the maximum appropriateness of all its linked diagnoses. I put PDEs with no associated infectious disease (i.e., FD) diagnoses into their own, lower tier.

## Numbers of diagnoses

The fraction of diagnoses that have E&M HCPCS codes:

```{r hcpcs_count}
hcpcs_count = read_tsv('tables/hcpcs_count.tsv') %>%
  group_by(hcpcs_flag) %>%
  summarize(n_dx=sum(n_dx)) %>%
  mutate(f=n_dx/sum(n_dx))

hcpcs_count %>% kable
```

This equals a total of `r prettyNum(sum(hcpcs_count$n_dx), big.mark=',')` diagnoses.

The fraction of first-fill PDEs that have upstream:

```{r pde_with_dx_upstream}
read_tsv('tables/pde_with_dx_upstream.tsv') %>%
  group_by(has_dx, has_em_dx) %>%
  summarize(n=sum(n)) %>%
  ungroup() %>%
  mutate(f=n/sum(n), cumf=cumsum(f), cumf1=1-cumf) %>%
  kable
```

## Common diagnoses by drug

For each drug, I asked what fraction of PDEs are associated with each diagnosis. This gives you a sense that, say, the diagnoses that give rise to azithromycin are bronchitis, URI, etc. The values are percents in 2011. A row can add up to more than 100% because one PDE can be associated with multiple diagnoses.

```{r dx_from_pde}
dx_from_pde = read_tsv('tables/dx_from_pde.tsv') %>% 
  spread(present, n) %>%
  mutate(pct=`TRUE`/(`TRUE` + `FALSE`)*100 %>% round(2)) %>%
  select(antibiotic, dx_cat, pct) %>%
  spread(dx_cat, pct)

dx_from_pde %>% kable
```

## Trends in prescribing practice

For each diagnosis and each drug, I ask what fraction of diagnoses are followed by a PDE for that drug in 2011 and 2014. I compute the percent change in those fractions.

Second, I do logistic regressions. The unit of analysis is the diagnosis. The outcome is whether a PDE for that drug follows a diagnosis in that category. The main predictor is year; covariates are as above. The adjusted percent change is between 2011 and 2014. (I computed this adjusted change, which is a relative risk, using the odds ratio from the regression and the mean probability of PDE for that diagnosis in 2011. This strictly incorrect: the mean relative risk is the mean of the risks computed using the predicted probabilities for each 2011 diagnosis, *not* the relative risk computed using the mean probability in 2011.)

```{r dx_to_pde}
dx_to_pde_unadj = read_tsv('tables/dx_to_pde_table.tsv') %>%
  filter(year %in% c(2011, 2014)) %>%
  select(dx_cat, antibiotic, year, f=f_encounters_with_abx) %>%
  spread(year, f)

dx_to_pde_adj = read_tsv('tables/dx_to_pde_trends.tsv') %>%
  filter(term=='year') %>%
  mult_est(3) %>%
  mutate(ci=1.96*std.error,
         ci_low=estimate-ci,
         ci_high=estimate+ci) %>%
  select(dx_cat, antibiotic, estimate, ci_low, ci_high) %>%
  arrange(dx_cat, antibiotic)

dx_to_pde = inner_join(dx_to_pde_unadj,
                       dx_to_pde_adj,
                       by=c('dx_cat', 'antibiotic')) %>%
  # convert model estimates to odds ratios, then to risk ratios,
  # then to adjusted fractional changes, then to percentages
  mutate(or=exp(estimate),
         or_low=exp(ci_low),
         or_high=exp(ci_high),
         rr=risk_ratio_f(or, `2011`),
         rr_low=risk_ratio_f(or_low, `2011`),
         rr_high=risk_ratio_f(or_high, `2011`),
         adj_change=rr-1,
         adj_change_low=rr_low-1,
         adj_change_high=rr_high-1,
         pct_change=(`2014`-`2011`)/`2011`) %>%
  mutate_if(is.numeric, function(x) round(x*100, 2)) %>%
  mutate(adj_change=sprintf('%.2f (%.2f -- %.2f)', adj_change, adj_change_low, adj_change_high)) %>%
  select(dx_cat, antibiotic, `2011`, `2014`, pct_change, adj_change) %T>%
  kable
```

## Combined tables

```{r}
x = read_tsv('tables/dx_cat_counts.tsv') %>%
  mutate(value=n_dx/n_bene*1000) %>%
  group_by(dx_cat) %>%
  summarize(value=mean(value)) %>%
  # convert to character to fit with other parts
  mutate(value=as.character(round(value))) %>%
  spread(dx_cat, value) %>%
  mutate(antibiotic='dx', key='mean_per_1kyr')

y = dx_from_pde %>%
  mutate(key='dx_from_pde') %>%
  mutate_if(is.numeric, function(x) as.character(round(x, 2)))

z = dx_to_pde %>%
  gather('key', 'value', -dx_cat, -antibiotic) %>%
  spread(dx_cat, value)

combined_table = bind_rows(x, y, z) %>%
  mutate(antibiotic=factor(antibiotic, levels=c('dx', top_abx)),
         key=factor(key, levels=c('mean_per_1kyr', 'dx_from_pde', '2011', '2014', 'pct_change', 'adj_change'))) %>%
  arrange(antibiotic, key)
```

### Respiratory stuff

All respiratory diagnoses fell, bronchitis the most sharply. Azithromycin prescribing fell for all diagnoses, while levofloxacin, amox, and amox/clav prescribing rose for all diagnoses. 

```{r respiratory}
combined_table %>%
  filter(antibiotic %in% c('dx', 'azithromycin', 'levofloxacin', 'amoxicillin', 'amoxicillin/clavulanate')) %>%
  select(antibiotic, key, asthma, bronchitis, other_resp, pharyngitis, pneumonia, sinusitis, uri) %>%
  kable
```

### UTIs

UTIs declined somewhat in prevalence. Ciprofloxacin prescribing remained nearly constant, nitrofurantion fell 3%, and Bactrim rose 4-6%.

```{r uti}
combined_table %>%
  filter(antibiotic %in% c('dx', 'ciprofloxacin', 'trimethoprim/sulfamethoxazole', 'nitrofurantoin')) %>%
  select(antibiotic, key, uti, uti_t3) %>%
  kable
```

### SSTI

Although skin and soft tissue infections declined in prevalence, prescribing of clindamycin, cephalexin, Bactrim, amox, and amox/clav increased, with one exception: amox/clav use for Tier 2 SSTIs stay nearly constant. Clindamycin was the biggest winner.

```{r ssti}
# swo: I removed amox and amox/clav because they mostly
# showed trends in Tier 3, which is confusing
combined_table %>%
  filter(antibiotic %in% c('dx', 'clindamycin', 'cephalexin', 'trimethoprim/sulfamethoxazole')) %>%
  select(antibiotic, key, ssti, ssti_t3) %>%
  kable
```

### GI

GI indications became less prevalent, and cipro prescribing fell 1-2%. Only a small amount of cipro is used for GI indications: compare the 5-6% of cipro PDEs preceded by GI indications with the 14-20% preceded by UTIs.

```{r gi}
combined_table %>%
  filter(antibiotic %in% c('dx', 'ciprofloxacin')) %>%
  select(antibiotic, key, gi, gi_t3) %>%
  kable
```
