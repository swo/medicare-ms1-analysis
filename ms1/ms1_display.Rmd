---
title: "Ms 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE, autodep=TRUE)
import::from(knitr, kable)
import::from(stringr, str_replace, str_detect)
library(forcats)
import::from(tools, md5sum)
```

# Abstract

```{r abstract, cache.extra=md5sum('tables/model_abx.tsv')}
pctize = function(df, denom_name) {
  for (n_name in Filter(function(x) str_detect(x, '^n_'), names(df))) {
    pct_name = str_replace(n_name, '^n_', 'pct_')
    df[[pct_name]] = df[[n_name]] / df[[denom_name]] * 100
  }
  df
}

totals = read_tsv('tables/totals.tsv') %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sd_age, mean_n_cc, sd_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west)

claims_by_abx = read_tsv('tables/claims_by_abx.tsv')

n_million_bene = totals %$% unique(n_bene) %>% { round(. / 1e6, 1) }
n_million_pde = claims_by_abx %$% sum(n) %>% { round(. / 1e6, 1) }

est2pct = function(x) (exp(x) - 1)*100
model_ci = function(df) {
  df %>%
    filter(model=='poisson') %>%
    mutate(pct_change=est2pct(estimate),
           ci=1.96*std.error,
           ci_low=est2pct(estimate - ci),
           ci_high=est2pct(estimate + ci),
           change_str=sprintf('%.2f%% (%.2f -- %.2f%%)', pct_change, ci_low, ci_high))
}

model_abx = read_tsv('tables/model_abx.tsv') %>%
  model_ci()

total_adjusted_change_str = model_abx %>%
  filter(term=='year', antibiotic=='overall') %$%
  change_str

azithro_adjusted_change_str = model_abx %>%
  filter(term=='year', antibiotic=='azithromycin') %$%
  change_str

levo_adjusted_change_str = model_abx %>%
  filter(term=='year', antibiotic=='levofloxacin') %$%
  change_str
```

There are `r n_million_bene` million beneficiaries and `r n_million_pde` million PDEs. Adjusted total consumption changed by `r total_adjusted_change_str`. Azithromycin changed by `r azithro_adjusted_change_str`. Levofloxacin changed by `r levo_adjusted_change_str`.

# Beneficiary characteristics

In the cohort, all the values remain fixed, except for:

- age
- chronic conditions
- to a lesser degree, dual enrollment
- to a very small degree, geographical location

A star indicates that the trend (*t*-test for mean difference between years equal to zero) is significant after multiple hypothesis correction.

```{r bene_char_table}
trend_p = function(x) tidy(t.test(diff(x)))$p.value
totals_trends = totals %>%
  gather('var', 'val', -year) %>%
  arrange(var, year, val) %>%
  group_by(var) %>%
  summarize(p=trend_p(val)) %>%
  mutate(adj.p=p.adjust(p, method='BH')) %>%
  mutate(sig=case_when(.$adj.p < 0.05 ~ '*',
                       .$p < 0.05 ~ '.',
                       TRUE ~ ''))

totals %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sd_age, mean_n_cc, sd_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west) %>%
  mutate_at(vars(starts_with('pct_')), function(x) round(x, digits=1)) %>%
  mutate(n_bene=prettyNum(n_bene, big.mark=','),
         mean_age=round(mean_age, digits=1)) %>%
  mutate_at(vars(mean_n_cc, sd_age, sd_n_cc),
            function(x) round(x, digits=2)) %>% 
  gather('var', 'val', -year) %>% spread(year, val) %>% # transpose
  left_join(totals_trends %>% select(var, sig), by='var') %>%
  kable
```

# Patterns of consumption

All consumption rates are reported as claims per thousand people per year (CPKP).

## Claims by abx

```{r claims_by_abx}
top_abx = claims_by_abx %>%
  group_by(antibiotic) %>%
  summarize(cpkp=mean(cpkp)) %>%
  arrange(desc(cpkp)) %$%
  head(antibiotic, 10)

# this should be the same list as for the models
stopifnot(all(top_abx %in% model_abx$antibiotic))

# but "overall" should not be in the claims_by_abx list
if('overall' %in% claims_by_abx$antibiotic) stop()

claims_overall = claims_by_abx %>%
  select(-n_bene) %>%
  group_by(year) %>%
  summarize_at(vars(n, cpkp), sum) %>%
  mutate(antibiotic='overall')

claims_by_top_abx = claims_by_abx %>%
  bind_rows(claims_overall) %>%
  mutate(antibiotic=fct_relevel(fct_other(antibiotic, keep=c('overall', top_abx)),
                                c('overall', top_abx, 'Other'))) %>%
  group_by(year, antibiotic) %>%
  summarize_at(vars(n, cpkp), sum) %>% ungroup()

claims_by_top_abx %>%
  ggplot(aes(x=year, y=cpkp)) +
  facet_wrap(~antibiotic, ncol=3, scales='free_y') +
  geom_point() + geom_line() +
  theme_minimal() +
  ggtitle('Unadjusted consumption')

claims_by_top_abx %>%
  filter(antibiotic != 'overall') %>%
  ggplot(aes(x=year, y=cpkp)) +
  facet_wrap(~antibiotic, ncol=3) +
  geom_point() + geom_line() +
  theme_minimal() +
  ggtitle('Unadjusted consumption')

claims_by_top_abx %>%
  select(year, antibiotic, cpkp) %>%
  filter(year %in% c(2011, 2014)) %>%
  spread(year, cpkp) %>%
  mutate(pct_change=(`2014`-`2011`)/`2011`*100) %>%
  kable
```

## Claims by age group

```{r claims_by_age}
read_tsv('tables/claims_by_age.tsv') %>%
  mutate(age_group=case_when(between(.$age, 65, 75) ~ '65-75',
                             between(.$age, 76, 85) ~ '76-85',
                             between(.$age, 86, 95) ~ '86-95')) %>%
  group_by(year, age_group) %>%
  summarize_at(vars(n_bene, n_claims), sum) %>%
  ungroup() %>%
  mutate(cpkp=round(1000*n_claims/n_bene)) %>%
  select(year, age_group, cpkp) %>%
  spread(year, cpkp) %>%
  kable
```

## Consumption by sex

```{r claims_by_sex}
read_tsv('tables/claims_by_sex.tsv') %>%
  select(sex, year, cpkp) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>% 
  mutate_at(vars(-sex), round) %>%
  kable
```

## Consumption by region

```{r claims_by_region}
read_tsv('tables/claims_by_region.tsv') %>%
  select(region, year, cpkp) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>% 
  mutate_at(vars(-region), round) %>%
  kable
```

## Consumption by race

```{r claims_by_race}
read_tsv('tables/claims_by_race.tsv') %>%
  select(race, year, cpkp) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>% 
  mutate_at(vars(-race), round) %>%
  kable
```

# Adjusted consumption changes

"Adjusted" means the `year` coefficient in `y ~ year + age + n_cc + is_dual + region`. Gender and race, though important covariates, are not confounded with time.

```{r adjusted_changes}
x = model_abx %>%
  filter(term=='year') %>%
  select(antibiotic, pct_change, ci_low, ci_high) %>%
  mutate(is_overall=antibiotic=='overall') %>%
  arrange(is_overall, pct_change) %>%
  mutate(antibiotic=fct_inorder(antibiotic)) %>%
  select(-is_overall)

x %>%
  ggplot(aes(x=antibiotic, y=pct_change, ymin=ci_low, ymax=ci_high)) +
  geom_point() +
  geom_linerange() +
  coord_flip() +
  ggtitle('Adjusted changes in consumption') +
  xlab('') +
  ylab('adjusted yearly change in claims per beneficiary per year') +
  #scale_y_continuous(limits=c(-16, 17), breaks=c(-15, -10, -5, 0, 5, 10, 15)) +
  theme_minimal()
```

```{r adjusted_changes_table}
x %>% arrange(-row_number()) %>% kable
```

# Prescribing practice

## Methodology

Let $R_0$ be the event where the drug of interest is prescribed on some specific day in the first study period; let $R_1$ represent the same thing in the second period. Let $D_0$ be the event where the diagnosis of interest was made within some window before the day of interest; similarly $D_1$. Thus we have $P(R_0 | D_0)$, which represents, say, the probability that levo will be prescribed following a pneumonia diagnosis in 2011. The fold change in the
probability that a drug will be prescribed for a diagnosis is
$$
\frac{P(R_1 | D_1)}{P(R_0 | D_0)} = \frac{P(R_1 \cap D_1) / P(R_0 \cap D_0)}{P(D_1) / P(D_0)}.
$$

The ratio of the joint probabilities is the ratio in the number of times a qualifying prescription-diagnosis pair appears in each year. The ratio of the diagnosis-in-window probabilities is the ratio of the number of diagnoses of that type made in each year.

(There's a way to do the age adjustment here too: just replace every appearance
of $D_y$ with $D_y \cap A_{ya}$.)

```{r rxdx}
rxdx = read_tsv('tables/rxdx.tsv')

rxdx_f = function(a) {
  rxdx %>%
    filter(abx==a) %>%
    select(-abx) %>%
    arrange(desc(f_rxdx))
}
```

## Levo

Levofloxacin prescribing increased across diagnoses. Of the respiratory diagnoses, pneumonia was the one associated with the smallest fractional increase in probability of prescription.

```{r rxdx_levo}
rxdx_f('levofloxacin') %>% filter(f_rxdx > 0.03) %>% kable
```

## Azithro

Azithromycin use decreased across diagnoses. Pneumonia experienced a greater decline.

```{r rxdx_azithro}
rxdx_f('azithromycin') %>% filter(f_rxdx > 0.01) %>% kable
```

## Azithromycin & heart disease

Azithromycin prescribing for people with heart disease decreased slightly more than the people without heart disease.

```{r model_azithro}
model_azithro = read_tsv('tables/model_azithro.tsv') %>%
  filter(model=='poisson')

nohd_est = model_azithro %>% filter(term=='year') %$% estimate
nohd_se = model_azithro %>% filter(term=='year') %$% std.error
offset_est = model_azithro %>% filter(term=='year:heart_diseaseTRUE') %$% estimate
offset_se = model_azithro %>% filter(term=='year:heart_diseaseTRUE') %$% std.error

hd_est = nohd_est + offset_est
hd_se = sqrt(nohd_se^2 + offset_se^2)

data_frame(heart_disease=c(FALSE, TRUE),
           estimate=c(nohd_est, hd_est),
           std.error=c(nohd_se, hd_se)) %>%
  mutate(model='poisson') %>%
  model_ci() %>%
  kable
```

Compare these changes to the overall azithromycin change: `r azithro_adjusted_change_str`.

A large fraction of beneficiaries have heart disease in each year:

```{r heart_disease_table}
read_tsv('tables/counts_heartdisease.tsv') %>%
  group_by(year) %>%
  mutate(f=n/sum(n)) %>%
  ungroup %>%
  filter(heart_disease) %>%
  kable
```

## Amox/clav

Amoxicillin increased for sinusitis, its major associated diagnosis, and also for other respiratory diagnoses, except pneumonia (for which it is associated with a very small fraction of prescritions). It seems like most of the increase is attributable to sinusitis.

```{r rxdx_amoxclav}
rxdx_f('amoxicillin/clavulanate') %>% kable
```

## Keflex

Increased prescribing of cephalexin seems t obe mostly for UTIs; prescribing probabilities for skin and soft tissue infections remained nearly steady.

```{r rxdx_cephalexin}
rxdx_f('cephalexin') %>% filter(f_rxdx > 0.017) %>% kable
```
