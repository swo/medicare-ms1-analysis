---
title: "Ms 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE, autodep=TRUE)
import::from(knitr, kable)
import::from(tools, md5sum)
library(forcats)
```

# Abstract

```{r abstract, cache.extra=md5sum('tables/model_abx.tsv')}
pctize = function(df, denom_name) {
  for (n_name in Filter(function(x) str_detect(x, '^n_'), names(df))) {
    pct_name = str_replace(n_name, '^n_', 'pct_')
    df[[pct_name]] = df[[n_name]] / df[[denom_name]] * 100
  }
  df
}

totals = read_tsv('tables/totals.tsv') %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sd_age, mean_n_cc, sd_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west)

claims_by_abx = read_tsv('tables/claims_by_abx.tsv')

n_unique_bene = scan('tables/n_unique_bene.tsv')
n_million_unique_bene = round(scan('tables/n_unique_bene.tsv') / 1e6, 2)
n_pde = sum(claims_by_abx$n)
n_million_pde = round(n_pde / 1e6, 2)

est2pct = function(x) (exp(x) - 1)*100
model_ci = function(df) {
  df %>%
    mutate(pct_change=est2pct(estimate),
           ci=1.96*std.error,
           ci_low=est2pct(estimate - ci),
           ci_high=est2pct(estimate + ci),
           change_str=sprintf('%.2f%% (%.2f -- %.2f%%)', pct_change, ci_low, ci_high))
}

model_abx = read_tsv('tables/model_abx.tsv') %>%
  rename(antibiotic=name) %>%
  model_ci()

claims_overall = claims_by_abx %>%
  select(-n_bene) %>%
  group_by(year) %>%
  summarize_at(vars(n, cpkp), sum) %>%
  mutate(antibiotic='overall')

bind_rows(claims_by_abx, claims_overall) %>%
  filter(antibiotic %in% c('overall', 'azithromycin', 'levofloxacin'), year %in% c(2011, 2014)) %>%
  select(antibiotic, year, cpkp) %>%
  spread(year, cpkp) %>%
  mutate(pct_change=round(100*(`2014`-`2011`)/`2011`, 2)) %>%
  kable
```

There are `r n_million_unique_bene` million unique beneficiaries and `r n_million_pde` million PDEs across all study years.

# Beneficiary characteristics

There were `r prettyNum(n_unique_bene, big.mark=',')` unique beneficiaries and `r prettyNum(n_pde, big.mark=',')` PDEs.

A star indicates that the trend (*t*-test for mean difference between years equal to zero) is significant after multiple hypothesis correction. A dot indicates significance ($p < 0.05$) before multiple hypothesis correction. Mean age decreased during the study.

```{r bene_char_table}
trend_p = function(x) tidy(t.test(diff(x)))$p.value
totals_trends = totals %>%
  gather('var', 'val', -year) %>%
  arrange(var, year, val) %>%
  group_by(var) %>%
  summarize(p=trend_p(val)) %>%
  mutate(adj.p=p.adjust(p, method='BH')) %>%
  mutate(sig=case_when(.$adj.p < 0.05 ~ '*',
                       .$p < 0.05 ~ '.',
                       TRUE ~ ''))

totals %>%
  pctize('n_bene') %>%
  select(year, n_bene, mean_age, sd_age, mean_n_cc, sd_n_cc,
         pct_female, pct_white, pct_dual,
         pct_region_south, pct_region_midwest, pct_region_northeast, pct_region_west) %>%
  mutate_at(vars(starts_with('pct_')), function(x) round(x, digits=1)) %>%
  mutate(n_bene=prettyNum(n_bene, big.mark=','),
         mean_age=round(mean_age, digits=1)) %>%
  mutate_at(vars(mean_n_cc, sd_age, sd_n_cc),
            function(x) round(x, digits=2)) %>% 
  gather('var', 'val', -year) %>% spread(year, val) %>% # transpose
  left_join(totals_trends %>% select(var, sig), by='var') %>%
  kable
```

# Patterns of consumption

All consumption rates are reported as claims per thousand people per year (CPKP).

## Claims by abx

```{r claims_by_abx}
top_abx = claims_by_abx %>%
  group_by(antibiotic) %>%
  summarize(cpkp=mean(cpkp)) %>%
  arrange(desc(cpkp)) %$%
  head(antibiotic, 10)

# this should be the same list as for the models
stopifnot(all(top_abx %in% model_abx$antibiotic))

claims_by_top_abx = claims_by_abx %>%
  bind_rows(claims_overall) %>%
  mutate(antibiotic=fct_relevel(fct_other(antibiotic, keep=c('overall', top_abx)),
                                c('overall', top_abx, 'Other'))) %>%
  group_by(year, antibiotic) %>%
  summarize_at(vars(n, cpkp), sum) %>% ungroup()
```

```{r claims_by_top_abx_figs}
claims_by_top_abx %>%
  filter(antibiotic=='overall') %>%
  ggplot(aes(x=year, y=cpkp)) +
  geom_point() + geom_line() +
  #ylim(0, 1520) +
  scale_y_continuous(limits=c(0, 1525), breaks=c(0, 250, 500, 1000, 1500)) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, all abx')

claims_by_top_abx %>%
  filter(antibiotic %in% c('azithromycin', 'ciprofloxacin', 'amoxicillin', 'cephalexin', 'trimethoprim/sulfamethoxazole', 'levofloxacin')) %>%
  ggplot(aes(x=year, y=cpkp, color=antibiotic)) +
  #ggplot(aes(x=year, y=cpkp)) +
  #facet_wrap(~antibiotic, ncol=5) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, 250), breaks=c(0, 50, 100, 150, 200, 250)) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, top 5')

claims_by_top_abx %>%
  filter(antibiotic %in% c('amoxicillin/clavulanate', 'doxycycline', 'nitrofurantoin', 'clindamycin')) %>%
  ggplot(aes(x=year, y=cpkp, color=antibiotic)) +
  #ggplot(aes(x=year, y=cpkp)) +
  #facet_wrap(~antibiotic, ncol=5) +
  geom_point() + geom_line() +
  scale_y_continuous(limits=c(0, 100), breaks=c(0, 50, 100)) +
  #ylim(0, 140) +
  theme_minimal() +
  ggtitle('Unadjusted consumption, next 5')
```

## Claims by age group

```{r claims_by_age}
change_demog = read_tsv('tables/model_overall_demography.tsv') %>%
  mutate(estimate=3*estimate,
         std.error=sqrt(3)*std.error) %>%
  model_ci() %>%
  filter(term=='year0') %>%
  select(name, adj_change=change_str)

claims_by = function(x) {
  read_tsv(str_interp("tables/claims_by_${x}.tsv")) %>%
    rename_(.dots=list(name=x)) %>%
    select(name, year, cpkp) %>%
    filter(year %in% c(2011, 2014)) %>%
    spread(year, cpkp) %>%
    mutate(pct_change=round((`2014`-`2011`)/`2011`*100, 2)) %>%
    mutate_at(vars(`2011`, `2014`), round) %>%
    mutate(group=x)
}

# do claims by age group separate
# this could be baked into the analysis step
claims_by_age = read_tsv('tables/claims_by_age.tsv') %>%
  filter(year %in% c(2011, 2014)) %>%
  mutate(name=case_when(between(.$age, 65, 75) ~ 'age65_75',
                        between(.$age, 76, 85) ~ 'age76_85',
                        between(.$age, 86, 95) ~ 'age86_95')) %>%
  group_by(year, name) %>%
  summarize_at(vars(n_bene, n_claims), sum) %>%
  ungroup() %>%
  mutate(cpkp=1000*n_claims/n_bene) %>%
  select(year, name, cpkp) %>%
  spread(year, cpkp) %>%
  mutate(pct_change=round((`2014`-`2011`)/`2011`*100, 2)) %>%
  mutate_at(vars(`2011`, `2014`), round) %>%
  mutate(group='age')

# use a common interface for all the others
bind_rows(claims_by_age,
          claims_by('sex'),
          claims_by('race'),
          claims_by('region')) %>%
  left_join(change_demog, by='name') %>%
  select(group, name, `2011`, `2014`, pct_change, adj_change) %>%
  kable
```

# Adjusted consumption changes by drug

Adjusted changes were computed using a Poisson regression predicting claims per capita. The unit of analysis were individual beneficiaries in each year. The covariates in the regression were age, number of chronic conditions, dual eligibility, sex, race (white or not), and region.

## By drug

```{r adjusted_changes}
adjusted_changes = model_abx %>%
  filter(term=='year0') %>%
  select(antibiotic, pct_change, ci_low, ci_high) %>%
  arrange(pct_change) %>%
  mutate(antibiotic=fct_inorder(antibiotic),
         antibiotic=fct_relevel(antibiotic, 'overall', after=Inf))

unadjusted_changes = bind_rows(claims_by_abx, claims_overall) %>%
  filter(antibiotic %in% c('overall', top_abx), year %in% c(2011, 2014)) %>%
  select(antibiotic, year, cpkp) %>%
  spread(year, cpkp) %>%
  mutate(change=(`2014`-`2011`)/3,
         fold_change=change/`2011`,
         pct_change=100*fold_change) %>%
  select(antibiotic, pct_change)

adjusted_changes %>%
  ggplot(aes(x=antibiotic, y=pct_change, ymin=ci_low, ymax=ci_high)) +
  geom_bar(stat='identity', fill=NA, color='black') +
  geom_errorbar(width=0.5) +
  geom_point(dat=unadjusted_changes, aes(x=antibiotic, y=pct_change, ymin=NULL, ymax=NULL), color='red') +
  coord_flip() +
  xlab('') +
  ylab('adjusted yearly change in consumption (%)') +
  scale_y_continuous(limits=c(-10, 10), breaks=c(-10, -5, 0, 5, 10)) +
  theme_minimal() +
  theme(axis.title.x = element_text(size=16),
        axis.text = element_text(size=16))
```

```{r adjusted_changes_table}
adjusted_changes %>% arrange(desc(antibiotic)) %>% kable

adjusted_az_decrease = adjusted_changes %>%
  filter(antibiotic=='azithromycin') %$%
  { (1 + pct_change/100)^3 } %>%
  { (1 - .) * 100 } %>%
  round(2)

adjusted_levo_increase = adjusted_changes %>%
  filter(antibiotic=='levofloxacin') %$%
  { (1 + pct_change/100)^3 } %>%
  { (. - 1) * 100 } %>%
  round(2)
```

Consumption of azithromycin fell by `r adjusted_az_decrease`% over the entire study period. Levofloxacin consumption increased by `r adjusted_levo_increase`% over the entire study period.

## Fluoroquinolones

Consumption of ciprofloxacin is slightly decreasing, and consumption of levofloxacin is increasing. How does fluoroquinolone consumption overall change?

```{r fq}
fq_names = claims_by_abx %>%
  filter(str_detect(antibiotic, 'floxacin')) %>%
  group_by(antibiotic) %>%
  summarize(n=sum(n)) %>%
  arrange(desc(n)) %$%
  antibiotic

read_tsv('tables/model_fq.tsv') %>%
  model_ci() %>%
  select(term, pct_change, ci_low, ci_high, p.value) %>%
  kable
```

Overall, fluoroquinolones changed by about 0% per year during this period. This included `r fq_names`.

# Prescribing practice

## Methodology

I examined encounters recorded in the Carrier Line File whose HCPCS code indicated an office visit. I grouped diagnoses into categories using the Fleming-Dutra eTable 2.

To link diagnoses and PDEs, I looked for all diagnosis-PDE pairs where the PDE came 0-3 days after the diagnosis.

### Delays between diagnosis and prescription

The table shows the number of diagnoses that were followed by that number of days' delay before the following antibiotic prescription. Most prescriptions were filled on the same day as the diagnosis.

```{r dx_delay}
dx_delay = read_tsv('tables/dx_delay.tsv')

dx_delay %>%
  filter(!is.na(delay)) %>%
  mutate(f=n/sum(n)) %>%
  kable
```

## Trends in diagnoses

Are some diagnoses becoming more or less common?

### Unadjusted trends in diagnoses

First, unadjusted trends in the number of diagnoses per 1,000 beneficiaries in each year. The percent change is between 2011 and 2014.

Second, adjusted trends, using Poisson regressions. The unit of analysis is the beneficiary in a year. The outcome variable is number of diagnoses in that category. The main predictor is year; the other covariates are as above. The percent change is between 2011 and 2014.

```{r dx_trends}
dx_unadj = read_tsv('tables/dx_counts.tsv') %>%
  select(diagnosis_category, year, dxpkp) %>%
  filter(year %in% c(2011, 2014)) %>%
  spread(year, dxpkp) %>%
  mutate(unadj_pct_change=(`2014`/`2011`-1)*100) %>%
  arrange(desc(`2011`)) %>%
  mutate_if(is.numeric, function(x) round(x, 2))

dx_adj = read_tsv('tables/dx_models.tsv') %>%
  filter(term=='year0') %>%
  mutate(adj_pct_change=100*(exp(estimate*3)-1),
         p.value=p.adjust(p.value, method='BH')) %>%
  mutate_if(is.numeric, function(x) round(x, 2)) %>%
  select(diagnosis_category, adj_pct_change, p.value)

full_join(dx_unadj, dx_adj, by='diagnosis_category') %>%
  kable
```

## Common diagnoses by drug

For each drug, I asked what fraction of PDEs are associated with each diagnosis. This gives you a sense that, say, the diagnoses that give rise to azithromycin are bronchitis, URI, etc. The values are percents in 2011.

The first table includes a "no diagnosis" category. This means that the majority of PDEs were not downstream of a diagnosis. In the second table, I remove the "none" diagnosis and rescale the values, which helps make it easier to read.

```{r pde_dx}
read_tsv('tables/pde_dx_counts.tsv') %>%
  filter(antibiotic %in% top_abx, year==2011) %>%
  mutate(pct=round(f_pde_with_dx*100, 1)) %>%
  select(antibiotic, diagnosis_category, pct) %>%
  spread(diagnosis_category, pct) %>%
  kable

read_tsv('tables/pde_dx_counts.tsv') %>%
  filter(antibiotic %in% top_abx, year==2011, diagnosis_category != 'none') %>%
  group_by(antibiotic) %>%
  mutate(f=f_pde_with_dx/sum(f_pde_with_dx),
         pct=round(f*100, 1)) %>%
  ungroup() %>%
  select(antibiotic, diagnosis_category, pct) %>%
  spread(diagnosis_category, pct) %>%
  kable
```

I also did logistic regressions for these trends, but I don't think it's very important. We're not particulary interested in whether the diagnoses that contribute to a drug are changing. We're more interested in whether the drugs that *follow* diagnoses are changing, which is next.

## Trends in prescribing practice

For each diagnosis and each drug, I ask what fraction of diagnoses are followed by a PDE for that drug in 2011 and 2014. I compute the percent change in those fractions.

Second, I do logistic regressions. The unit of analysis is the diagnosis. The outcome is whether a PDE for that drug follows a diagnosis in that category. The main predictor is year; covariates are as above. The adjusted percent change is between 2011 and 2014. (I computed this adjusted change, which is a relative risk, using the odds ratio from the regression and the mean probability of PDE for that diagnosis in 2011. This strictly incorrect: the mean relative risk is the mean of the risks computed using the predicted probabilities for each 2011 diagnosis, *not* the relative risk computed using the mean probability in 2011. But it seems like it's decently close, and I think insisting on the thing that is technically correct will only create confusion.)

I broke this into three tables by antibiotic, just to make it easier to navigate.

```{r dx_pde_trends}
dx_pde_unadj = read_tsv('tables/dx_pde_counts.tsv') %>%
  filter(antibiotic %in% top_abx, year %in% c(2011, 2014)) %>%
  mutate(key=str_c('y', year)) %>%
  select(diagnosis_category, antibiotic, key, value=f_dx_with_pde)

dx_pde_adj = read_tsv('tables/dx_pde_model.tsv') %>%
  filter(term=='year0') %>%
  mutate(key='OR',
         p.value=p.adjust(p.value, method='BH'),
         OR=round(exp(3*estimate), 2)) %>%
  filter(p.value < 0.05) %>%
  select(diagnosis_category, antibiotic, key, value=OR)

# risk ratio
rr = function(odds_ratio, p0) odds_ratio / (1 - p0 + (p0 * odds_ratio))

dx_pde_both= bind_rows(dx_pde_unadj, dx_pde_adj) %>%
   spread(key, value) %>%
   mutate(pct_change=(y2014/y2011-1)*100,
          adj_pct_change=(rr(OR, y2011)-1)*100) %>%
   select(-OR) %>%
   #mutate_if(is.numeric, function(x) round(x, 2)) %>%
   gather('key', 'value', y2011:adj_pct_change) %>%
   mutate(value=round(value, 2)) %>%
   spread(diagnosis_category, value) %>%
   mutate(key=factor(key, levels=c('y2011', 'y2014', 'pct_change', 'adj_pct_change'))) %>%
   arrange(antibiotic, key)

dx_pde_both %>%
  filter(str_detect(antibiotic, '^a')) %>%
   kable

dx_pde_both %>%
  filter(str_detect(antibiotic, '^c')) %>%
   kable

dx_pde_both %>%
  filter(str_detect(antibiotic, '^[^ac]')) %>%
   kable
```
