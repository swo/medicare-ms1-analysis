---
title: "Data for ms. 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('pdf', 'png'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE)
import::from(knitr, kable)
import::from(lazyeval, interp)
import::from(broom, tidy)
import::from(stringr, str_replace)
library(assertive)
```

```{r setup, cache=FALSE}
# Group values in x into ranges determined by upper_limits.
# Values below the lowest limit are named as the lowest limit, and so forth.
# You should probably put Inf as the last limit.
bounds_group = function(x, upper_limits) {
  levels = lapply(seq(from=1, to=length(upper_limits)), function(i) {
    if (i == 1) {
      sprintf('<= %.1f', upper_limits[i])
    } else {
      sprintf('> %.1f and <= %.1f', upper_limits[i - 1], upper_limits[i])
    }
  })
  formula_list = mapply(function(str, lim) as.formula(sprintf('x <= %.1f ~ "%s"', lim, str)),
                        levels, upper_limits)
  do.call(case_when, formula_list) %>%
    factor(levels=levels, ordered=TRUE)
}

summarize_by = function(bene, by) {
  group_by_(bene, by) %>%
  summarize(n_claims=sum(n_claims), n_bene=n()) %>%
  mutate(cpkp=n_claims*1000/n_bene) %>%
  select_(by, 'cpkp')
}
```

```{r load_data}
regions = read_tsv('../../db/census-regions/census-regions.tsv') %>%
  select(state, region)
condition_names = read_tsv('../chronic-conditions/names.txt',
                           col_names=c('condition', 'condition_name'))

conditions = c("AMI", "ALZHDMTA", "ATRIALFB", "CATARACT", "CHRNKIDN", "COPD", "CHF", "DIABETES", "GLAUCOMA", "HIPFRAC", "ISCHMCHT", "DEPRESSN", "OSTEOPRS", "RA_OA", "STRKETIA", "CNCRBRST", "CNCRCLRC", "CNCRPRST", "CNCRLUNG", "CNCRENDM", "ANEMIA", "ASTHMA", "HYPERL", "HYPERP", "HYPERT", "HYPOTH")

load_data = function(year) {
  bene = read_tsv(sprintf('../bene_%i.tsv', year)) %>%
    filter(between(age, 66, 96), hmo_months==0) %>%
    mutate(is_female=sex=='female', is_white=race=='white') %>%
    left_join(regions, by='state')
  
  pde = read_tsv(sprintf('../pde_%i.tsv', year)) %>%
    filter(bene_id %in% bene$bene_id)
  
  # get total numbers of PDEs
  n_claims = pde %>% count(bene_id) %>% rename(n_claims=n)
  bene %<>%
    left_join(n_claims, by='bene_id') %>%
    replace_na(list(n_claims=0))
  
  cc = read_feather(sprintf('../cc_%i.feather', year)) %>%
    select(-ALZH) %>%
    mutate(n_cc=rowSums(select_(., '-bene_id')))
  
  bene %<>% left_join(cc, by='bene_id')
  
  cu = read_tsv(sprintf('../cu_%i.tsv', year)) %>%
    select(bene_id, n_visits=hospital_op_visits)
  
  bene %<>% left_join(cu, by='bene_id')
    
  list(bene=bene, pde=pde)
}
```

```{r single_condition_model}
single_condition_model = function(x, condition_code) {
  filter(x, age >= 67) %>%
  rename_(.dots=setNames(condition_code, 'has_condition')) %>%
    glm(n_claims ~ age + is_female + has_condition + n_visits,
        family=quasipoisson(link='identity'), data=.) %>%
    tidy() %>%
    mutate(condition=condition_code)
}

single_condition_models = function(bene) {
  lapply(conditions, function(cond) single_condition_model(bene, cond)) %>%
    bind_rows()
}

all_condition_model = function(bene) {
  f = formula(paste0('n_claims ~ age + is_female + n_visits + ', paste0(conditions, collapse=' + ')))
  start = rep(0.1, length(all.vars(f)))
  filter(bene, age >= 67) %>%
    glm(f, family=quasipoisson(link='identity'), start=start, data=.) %>%
    tidy
}
```

```{r analyze_function}
age_group_f = function(x) bounds_group(x, c(65, 70, 75, 80, 85, 90, 96))
claims_group_f = function(x) bounds_group(x, c(0, 1, 2, 5, 10, 20, Inf))

analyze = function(year) {
  dat = load_data(year)
  
  total_n_bene = nrow(dat$bene)
  total_n_pde = nrow(dat$pde)
  
  totals = data_frame(key=c('n_bene', 'n_pde'),
                      value=c(total_n_bene, total_n_pde))

  # claims per 1,000 people by abx class
  claims_by_class = dat$pde %>%
    count(antibiotic_class) %>%
    mutate(cpkp=n*1000/total_n_bene) %>%
    select(antibiotic_class, cpkp)

  # the top few inidividual antibiotics
  top_abx = dat$pde %>%
    count(antibiotic) %>%
    mutate(cpkp=n*1000/total_n_bene) %>%
    select(antibiotic, cpkp)

  # from here on, the denominators are taken from the beneficiary data grouped
  # in the same way as the consumption data, so we can use the summarize_by function
  claims_by_sex = summarize_by(dat$bene, 'is_female')

  # then by age group
  # (the input to summarize_by is modified, since we want to group by age *group*,
  # not just by raw age)
  claims_by_age = dat$bene %>%
    mutate(group='all') %>%
    bind_rows(filter(., n_cc==0) %>% mutate(group='no_cc'),
              filter(., n_visits==0) %>% mutate(group='no_visits')) %>% 
    group_by(group, age) %>%
    summarize(n_bene=n(),
              mean_n_claims=mean(n_claims),
              sd_n_claims=sd(n_claims),
              mean_n_cc=mean(n_cc),
              sd_n_cc=sd(n_cc),
              mean_n_visits=mean(n_visits),
              sd_n_visits=sd(n_visits)) %>%
    mutate(sem_n_claims=sd_n_claims/sqrt(n_bene),
           sem_n_cc=sd_n_cc/sqrt(n_bene),
           sem_n_visits=sd_n_visits/sqrt(n_bene))
  
  chars_by_age_group = dat$bene %>%
    mutate(age_group=age_group_f(age)) %>%
    group_by(age_group) %>%
    summarize(n_bene=n(),
              mean_n_claims=mean(n_claims),
              mean_n_cc=mean(n_cc)) %>%
    mutate(cpkp=mean_n_claims*1000) %>%
    select(age_group, n_bene, cpkp, mean_n_cc)

  claims_by_region = summarize_by(dat$bene, 'region')
  
  claims_by_race = dat$bene %>%
    mutate(race=if_else(race %in% c('white', 'black', 'Hispanic'), race, 'other')) %>%
    summarize_by('race')

  chars_by_consumption = dat$bene %>%
    mutate(claims_group=claims_group_f(n_claims)) %>%
    group_by(claims_group) %>%
    summarize(`no. beneficiaries`=n(),
              `mean age`=mean(age),
              `% female`=mean(is_female) * 100,
              `mean no. chronic conditions`=mean(n_cc))
  
  condition_model = single_condition_models(dat$bene)
  
  big_model = all_condition_model(dat$bene)

  list(totals=totals,
       claims_by_class=claims_by_class,
       top_abx=top_abx,
       claims_by_sex=claims_by_sex,
       claims_by_race=claims_by_race,
       claims_by_age=claims_by_age,
       chars_by_age_group=chars_by_age_group,
       claims_by_region=claims_by_region,
       chars_by_consumption=chars_by_consumption,
       condition_model=condition_model,
       big_model=big_model) %>%
    lapply(function(x) mutate(x, year=year))
}

years = 2011:2014
results = lapply(years, analyze)
names(results) = as.character(years)
```

```{r arrange_data1}
data_by_field = function(field) lapply(results, function(x) x[[field]]) %>% bind_rows()

totals = data_by_field('totals') %>%
  spread(key, value) %>%
  mutate(cpkp=round(n_pde*1000/n_bene)) %>%
  mutate_at(vars(n_bene, n_pde), function(x) prettyNum(x, big.mark=',')) %>%
  rename(`number of beneficiaries`=n_bene, `number of antibiotic PDEs`=n_pde, `CPKP`=cpkp) %>%
  arrange(year) %T>%
  write_tsv('tables/table1.tsv') %>%
  kable

claims_by_class = data_by_field('claims_by_class')

top_classes = claims_by_class %>%
  filter(year==2011) %>%
  arrange(desc(cpkp)) %>%
  head(9) %$%
  antibiotic_class

class_levels = c(top_classes, 'other')

claims_by_class %<>%
  mutate(antibiotic_class=if_else(antibiotic_class %in% top_classes,
                                  antibiotic_class,
                                  'other')) %>%
  group_by(year, antibiotic_class) %>%
  summarize(cpkp=round(sum(cpkp))) %>%
  spread(year, cpkp) %>%
  mutate(antibiotic_class=factor(antibiotic_class, levels=class_levels, ordered=TRUE)) %>%
  arrange(antibiotic_class) %T>%
  write_tsv('tables/table2_class.tsv') %>%
  kable

top_abx = data_by_field('top_abx') %>%
  mutate(cpkp=round(cpkp)) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>%
  head(11) %T>%
  write_tsv('tables/table2_drug.tsv') %>%
  kable

claims_by_sex = data_by_field('claims_by_sex') %>%
  mutate(cpkp=round(cpkp)) %>%
  spread(year, cpkp) %T>%
  write_tsv('tables/table2_sex.tsv') %>%
  kable

claims_by_race = data_by_field('claims_by_race') %>%
  mutate(cpkp=round(cpkp)) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %T>%
  write_tsv('tables/tmp_race.tsv') %>%
  kable

chars_by_age_group = data_by_field('chars_by_age_group') %>%
  mutate(cpkp=round(cpkp), mean_n_cc=round(mean_n_cc, digits=2)) %>%
  select(age_group, year, cpkp, mean_n_cc) %T>%
  write_tsv('tables/data_age_group.tsv') %>%
  kable

bene_by_age_group = data_by_field('chars_by_age_group') %>%
  mutate(n_bene=prettyNum(n_bene, big.mark=',')) %>%
  select(age_group, year, n_bene) %>%
  spread(year, n_bene) %T>%
  write_tsv('tables/supptable1_age_group_denom.tsv') %>%
  kable

claims_by_age = data_by_field('claims_by_age') %T>%
  write_tsv('tables/tmp_claims_by_age.tsv')

claims_by_region = data_by_field('claims_by_region') %>%
  mutate(cpkp=round(cpkp)) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %T>%
  write_tsv('tables/table2_region.tsv') %>%
  kable

chars_by_consumption = data_by_field('chars_by_consumption') %>%
  mutate_at(vars(`mean age`, `% female`, `mean no. chronic conditions`), function(x) round(x, digits=2)) %>%
  arrange(year, claims_group) %>%
  kable
```

```{r arrange_data2}
condition_model_all_years = data_by_field('condition_model') %>%
  left_join(condition_names, by='condition') %>%
  filter(term != '(Intercept)') %>%
  mutate(estimate=round(estimate, digits=3)) %>%
  select(year, condition=condition_name, term, estimate) %T>%
  write_tsv('tables/supptable4_singlecondition.tsv')

condition_model = condition_model_all_years %>%
  filter(year==2011) %>% select(-year) %>%
  spread(term, estimate) %>%
  arrange(desc(has_conditionTRUE)) %T>%
  write_tsv('tables/table3.tsv') %>%
  kable

add_ci = function(df) mutate(df, ci=1.96*std.error, cil=estimate-ci, ciu=estimate+ci)

big_model = data_by_field('big_model') %>%
  mutate(term=stringr::str_replace(term, 'TRUE$', '')) %>%
  left_join(rename(condition_names, term=condition, condition=condition_name), by='term') %>%
  filter(term != '(Intercept)') %>%
  mutate(term=if_else(is.na(condition), term, condition)) %>%
  mutate(adj.p=p.adjust(p.value, method='BH')) %>%
  select(year, term, estimate, std.error, adj.p) %T>%
  write_tsv('tables/tmp_big_model.tsv') %>%
  add_ci() %>%
  filter(year==2011) %>%
  select(-year, -ci) %>%
  arrange(desc(estimate)) %>%
  kable
```

# Abstract's linear model results

```{r ci}
extract_ci = function(y) {
  f = formula(paste0(y, ' ~ age'))
  claims_by_age %>%
    filter(group=='all') %>%
    lm(f, data=.) %>%
    tidy %>%
    filter(term=='age') %>%
    add_ci() %>%
    mutate(model=y) %>%
    select(model, estimate, cil, ciu) %>%
    mutate_if(is.numeric, function(x) round(x, digits=4))
}

bind_rows(lapply(c('mean_n_claims', 'mean_n_cc', 'mean_n_visits'), extract_ci)) %>% kable
```

# Summary of data

`r totals`

# Table 1: Patterns of consumption

All consumption rates are reported as claims per thousand people per year (CPKP).

## Claims by class

`r claims_by_class`

## Most-prescribed antibiotics

`r top_abx`

## Consumption by sex

`r claims_by_sex`

## Consumption by region

`r claims_by_region`

## Consumption by race

`r claims_by_race`

## Consumption by age

`r chars_by_age_group`

`r bene_by_age_group`

# Figure 1: Claims and conditions by age

```{r fig1_claims_by_age}
# Show three lines: claims among all beneficiaries, among those with no ccs,
# and those with no OP visits. Exclude the no_cc, age=66 datapoint, which is
# artificially high.
claims_by_age %>%
  filter(year==2011, !(group=='no_cc' & age < 67)) %>%
  ggplot(aes(x=age,
             y=mean_n_claims,
             ymin=mean_n_claims-sem_n_claims,
             ymax=mean_n_claims+sem_n_claims,
             color=group)) +
  geom_smooth(method='lm', se=F, size=0.5) +
  geom_point() +
  geom_linerange() +
  theme_minimal() +
  scale_x_continuous(breaks=c(66, 70, 80, 90, 96))
```

```{r fig1_cc_by_age}
claims_by_age %>%
  filter(year==2011, age >= 67, group != 'no_cc') %>%
  ggplot(aes(x=age,
             y=mean_n_cc,
             ymin=mean_n_cc-sem_n_cc,
             ymax=mean_n_cc+sem_n_cc,
             color=group)) +
  geom_point() +
  geom_linerange() +
  theme_minimal() +
  scale_x_continuous(breaks=c(67, 70, 80, 90, 96)) +
  ylim(0, 6)
```

```{r visits_by_age}
claims_by_age %>%
  filter(year==2011, group != 'no_visits') %>%
  ggplot(aes(x=age,
             y=mean_n_visits,
             ymin=mean_n_visits-sem_n_visits,
             ymax=mean_n_visits+sem_n_visits,
             color=group)) +
  geom_point() +
  geom_linerange() +
  theme_minimal() +
  scale_x_continuous(breaks=c(66, 70, 80, 90, 96))
```

# Table 2: Beneficiary characteristics by consumption

`r chars_by_consumption`

# Table 3: Chronic conditions predict consumption

`r condition_model`

`r big_model`

## Table 3 caption: model coefficient p-values

Only $p$-values above (less significant than) $10^{-50}$ are shown. All the remaining values are more significant than the ones shown here.

```{r p_values}
data_by_field('big_model') %>%
  select(term, year, p.value) %>%
  mutate(adj.p=p.adjust(p.value, method='bonferroni'),
         log10.adj.p=log10(adj.p)) %>%
  filter(adj.p > 10^(-50)) %>%
  arrange(desc(log10.adj.p)) %>%
  kable
```
