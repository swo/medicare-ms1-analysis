---
title: "Data for ms. 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('pdf', 'png'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE)
import::from(knitr, kable)
import::from(lazyeval, interp)
import::from(broom, tidy)
import::from(stringr, str_replace)
library(assertive)
```

```{r setup, cache=FALSE}
# Group values in x into ranges determined by upper_limits.
# Values below the lowest limit are named as the lowest limit, and so forth.
# You should probably put Inf as the last limit.
bounds_group = function(x, upper_limits) {
  levels = lapply(seq(from=1, to=length(upper_limits)), function(i) {
    if (i == 1) {
      sprintf('< %.1f', upper_limits[i])
    } else {
      sprintf('>= %.1f and < %.1f', upper_limits[i - 1], upper_limits[i])
    }
  })
  formula_list = mapply(function(str, lim) as.formula(sprintf('x < %.1f ~ "%s"', lim, str)),
                        levels, upper_limits)
  do.call(case_when, formula_list) %>%
    factor(levels=levels, ordered=TRUE)
}

summarize_by = function(bene, pde, by) {
  # e.g., by='sex'
  # count number of beneficiaries in each group
  denom = count_(bene, by) %>% rename(n_bene=n)
  
  pde %>%
    left_join(select_(bene, 'bene_id', by), by='bene_id') %>% # join information about the bene's sex (e.g.)
    count_(by) %>% # count claims
    left_join(denom, by=by) %>% # join n_bene
    mutate(cpkp=n*1000/n_bene) %>%
    select_(by, 'cpkp')
}

multicol_sum = function(x, new_name, target_columns) {
  dummy_vars = sapply(1:length(target_columns), function(i) sprintf('x%i', i))
  dummy_vars_string = paste0(dummy_vars, collapse=',')
  dummy_vars_list = lapply(target_columns, as.name) %>% setNames(dummy_vars)
  f = as.formula(paste0(c('~sum(', dummy_vars_string, ')'), collapse=''))
  
  rowwise(x) %>%
    mutate_(new_attribute=interp(f, .values=dummy_vars_list)) %>%
    rename_(.dots=setNames('new_attribute', new_name)) %>%
    ungroup()
}

conditions = c("AMI", "ALZH", "ALZHDMTA", "ATRIALFB", "CATARACT", "CHRNKIDN", "COPD", "CHF", "DIABETES", "GLAUCOMA", "HIPFRAC", "ISCHMCHT", "DEPRESSN", "OSTEOPRS", "RA_OA", "STRKETIA", "CNCRBRST", "CNCRCLRC", "CNCRPRST", "CNCRLUNG", "CNCRENDM", "ANEMIA", "ASTHMA", "HYPERL", "HYPERP", "HYPERT", "HYPOTH")

multivariate_formula = paste(c('n_claims ~ age + is_female + ', conditions), collapse=' + ') %>% formula

all_condition_model = function(usage) {
  glm(multivariate_formula, data=usage, family='poisson') %>% tidy()
}
```

```{r load_db, cache=FALSE}
regions = read_tsv('../../db/census-regions/census-regions.tsv') %>%
  select(state, region)
condition_names = read_tsv('../chronic-conditions/names.txt',
                           col_names=c('condition', 'condition_name'))
```

```{r analyze_function}
analyze = function(this_year) {
  # bene file is already filtered for plan coverage months and good geographies
  bene = read_tsv(sprintf('../bene_%i.tsv', this_year)) %>%
    filter(age >= 65, hmo_months==0) %>%
    mutate(is_female=sex=='female', is_white=race=='white') %>%
    left_join(regions, by='state')
  
  assert_has_no_duplicates(bene$bene_id)
  total_n_bene = nrow(bene)
  
  pde = read_tsv(sprintf('../pde_%i.tsv', this_year)) %>%
    semi_join(bene, by='bene_id') # keep only PDEs for known beneficiaries
  
  total_n_pde = nrow(pde)
  
  totals = data_frame(key=c('n_bene', 'n_pde'),
                      value=c(total_n_bene, total_n_pde),
                      year=this_year)

  # claims per 1,000 people by abx class
  claims_by_class = pde %>%
    count(antibiotic_class) %>%
    mutate(cpkp=n*1000/total_n_bene) %>%
    select(antibiotic_class, cpkp) %>%
    mutate(year=this_year)

  # the top few inidividual antibiotics
  top_abx = pde %>%
    count(antibiotic) %>%
    mutate(cpkp=n*1000/total_n_bene) %>%
    select(antibiotic, cpkp) %>% 
    mutate(year=this_year)

  # from here on, the denominators are taken from the beneficiary data grouped
  # in the same way as the consumption data, so we can use the summarize_by function
  claims_by_sex = summarize_by(bene, pde, 'sex') %>%
    mutate(year=this_year)

  # then by age group
  # (the input to summarize_by is modified, since we want to group by age *group*,
  # not just by raw age)
  age_group_f = function(x) bounds_group(x, c(65, 75, 85, Inf))
  claims_by_age = summarize_by(
    bene %>% mutate(age_group=age_group_f(age)),
    pde, 'age_group') %>%
    mutate(year=this_year)

  # then by census region
  claims_by_region = summarize_by(bene, pde, 'region') %>%
    mutate(year=this_year)
  
  # characteristics by consumption
  cc = read_tsv(sprintf('../cc_%i.tsv', this_year))
    
  usage = pde %>% count(bene_id) %>% rename(n_claims=n) %>%
    right_join(bene, by='bene_id') %>%
    replace_na(n_claims=0) %>%
    left_join(cc, by='bene_id') %>%
    multicol_sum('n_cc', conditions)
  
  claims_group_f = function(x) bounds_group(x, c(1, 2, 5, 10, 20, Inf))
  chars_by_consumption = usage %>%
    mutate(claims_group=claims_group_f(n_claims)) %>%
    group_by(claims_group) %>%
    summarize(`no. beneficiaries`=n(),
              `mean age`=mean(age),
              `% female`=mean(is_female) * 100,
              `mean no. chronic conditions`=mean(n_cc)) %>%
    mutate(year=this_year)
  
  condition_model = all_condition_model(usage) %>%
    mutate(year=this_year)

  list(totals=totals,
       claims_by_class=claims_by_class,
       top_abx=top_abx,
       claims_by_sex=claims_by_sex,
       claims_by_age=claims_by_age,
       claims_by_region=claims_by_region,
       chars_by_consumption=chars_by_consumption,
       condition_model=condition_model)
}

years = 2011:2014
results = lapply(years, analyze)
names(results) = as.character(years)
```

```{r arrange_data}
data_by_field = function(field) lapply(results, function(x) x[[field]]) %>% bind_rows()

totals = data_by_field('totals') %>%
  spread(key, value) %>%
  mutate(cpkp=n_pde*1000/n_bene) %>%
  mutate_at(vars(n_bene, n_pde), function(x) prettyNum(x, big.mark=',')) %>%
  rename(`number of beneficiaries`=n_bene, `number of antibiotic PDEs`=n_pde, `CPKP`=cpkp) %>%
  arrange(year) %>%
  kable

claims_by_class = data_by_field('claims_by_class')

top_classes = claims_by_class %>%
  filter(year==2011) %>%
  arrange(desc(cpkp)) %>%
  head(9) %$%
  antibiotic_class %>%
  c('other')

claims_by_class %<>%
  mutate(antibiotic_class=if_else(antibiotic_class %in% top_classes,
                                  antibiotic_class,
                                  'other')) %>%
  group_by(year, antibiotic_class) %>%
  summarize(cpkp=sum(cpkp)) %>%
  spread(year, cpkp) %>%
  mutate(antibiotic_class=factor(antibiotic_class, levels=top_classes, ordered=TRUE)) %>%
  arrange(antibiotic_class) %>%
  kable

top_abx = data_by_field('top_abx') %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>%
  head(11) %>%
  kable

claims_by_sex = data_by_field('claims_by_sex') %>%
  filter(sex %in% c('male', 'female')) %>%
  spread(year, cpkp) %>%
  kable

claims_by_age = data_by_field('claims_by_age') %>%
  filter(!is.na(age_group)) %>%
  spread(year, cpkp) %>%
  kable

claims_by_region = data_by_field('claims_by_region') %>%
  filter(!is.na(region)) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>%
  kable

chars_by_consumption = data_by_field('chars_by_consumption') %>%
  arrange(desc(year), desc(claims_group)) %>%
  kable

condition_model = data_by_field('condition_model') %>%
  mutate(condition=str_replace(term, 'TRUE$', '')) %>%
  left_join(condition_names, by='condition') %>%
  mutate(term=if_else(is.na(condition_name), condition, condition_name)) %>%
  select(term, estimate, year) %>%
  spread(year, estimate) %>%
  arrange(desc(`2011`)) %>%
  kable
```

# Summary of data

`r totals`

# Table 1: Patterns of consumption

All consumption rates are reported as claims per thousand people per year (CPKP).

## Claims by class

`r claims_by_class`

## Most-prescribed antibiotics

`r top_abx`

## Consumption by sex

`r claims_by_sex`

## Consumption by region

`r claims_by_region`

## Consumption by age

`r claims_by_age`

# Table 2: Beneficiary characteristics by consumption

`r chars_by_consumption`

# Table 3: Chronic conditions predict consumption

`r condition_model`
