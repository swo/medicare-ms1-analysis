---
title: "Data for ms. 1"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/', dev=c('pdf', 'png'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE,
                      error=FALSE)
import::from(knitr, kable)
import::from(lazyeval, interp)
import::from(broom, tidy)
import::from(stringr, str_replace)
library(assertive)
```

```{r setup, cache=FALSE}
# Group values in x into ranges determined by upper_limits.
# Values below the lowest limit are named as the lowest limit, and so forth.
# You should probably put Inf as the last limit.
bounds_group = function(x, upper_limits) {
  levels = lapply(seq(from=1, to=length(upper_limits)), function(i) {
    if (i == 1) {
      sprintf('<= %.1f', upper_limits[i])
    } else {
      sprintf('> %.1f and <= %.1f', upper_limits[i - 1], upper_limits[i])
    }
  })
  formula_list = mapply(function(str, lim) as.formula(sprintf('x <= %.1f ~ "%s"', lim, str)),
                        levels, upper_limits)
  do.call(case_when, formula_list) %>%
    factor(levels=levels, ordered=TRUE)
}

summarize_by = function(usage, by) {
  group_by_(usage, by) %>%
  summarize(n_claims=sum(n_claims), n_bene=n()) %>%
  mutate(cpkp=n_claims*1000/n_bene) %>%
  select_(by, 'cpkp')
}
```

```{r load_data}
regions = read_tsv('../../db/census-regions/census-regions.tsv') %>%
  select(state, region)
condition_names = read_tsv('../chronic-conditions/names.txt',
                           col_names=c('condition', 'condition_name'))

conditions = c("AMI", "ALZHDMTA", "ATRIALFB", "CATARACT", "CHRNKIDN", "COPD", "CHF", "DIABETES", "GLAUCOMA", "HIPFRAC", "ISCHMCHT", "DEPRESSN", "OSTEOPRS", "RA_OA", "STRKETIA", "CNCRBRST", "CNCRCLRC", "CNCRPRST", "CNCRLUNG", "CNCRENDM", "ANEMIA", "ASTHMA", "HYPERL", "HYPERP", "HYPERT", "HYPOTH")

load_data = function(year) {
  usage = read_tsv(sprintf('usage_%i.tsv', year))
  pde = read_tsv(sprintf('pde_%i.tsv', year))
    
  list(usage=usage, pde=pde)
}
```

```{r single_condition_model}
single_condition_model = function(x, condition) {
  filter(x, age >= 67) %>%
  mutate(age_over_67 = age - 67) %>%
  rename_(.dots=setNames(condition, 'has_condition')) %>%
    glm(n_claims ~ age_over_67 + is_female + has_condition,
        family=quasipoisson(link='identity'), data=.) %>%
    tidy() %>%
    mutate(condition=condition)
}

single_condition_models = function(usage) {
  lapply(conditions, function(cond) single_condition_model(usage, cond)) %>%
    bind_rows()
}
```

```{r analyze_function}
age_group_f = function(x) bounds_group(x, c(66, 70, 75, 80, 85, 90, 95, 100))
claims_group_f = function(x) bounds_group(x, c(0, 1, 2, 5, 10, 20, Inf))

analyze = function(year) {
  dat = load_data(year)
  
  total_n_bene = nrow(dat$usage)
  total_n_pde = nrow(dat$pde)
  
  totals = data_frame(key=c('n_bene', 'n_pde'),
                      value=c(total_n_bene, total_n_pde))

  # claims per 1,000 people by abx class
  claims_by_class = dat$pde %>%
    count(antibiotic_class) %>%
    mutate(cpkp=n*1000/total_n_bene) %>%
    select(antibiotic_class, cpkp)

  # the top few inidividual antibiotics
  top_abx = dat$pde %>%
    count(antibiotic) %>%
    mutate(cpkp=n*1000/total_n_bene) %>%
    select(antibiotic, cpkp)

  # from here on, the denominators are taken from the beneficiary data grouped
  # in the same way as the consumption data, so we can use the summarize_by function
  claims_by_sex = summarize_by(dat$usage, 'is_female')

  # then by age group
  # (the input to summarize_by is modified, since we want to group by age *group*,
  # not just by raw age)
  claims_by_age = dat$usage %>%
    group_by(age) %>%
    summarize(n_bene=n(),
              mean_n_claims=mean(n_claims),
              sd_n_claims=sd(n_claims),
              mean_n_cc=mean(n_cc),
              sd_n_cc=sd(n_cc)) %>%
    mutate(sem_n_claims=sd_n_claims/sqrt(n_bene),
           sem_n_cc=sd_n_cc/sqrt(n_bene))
  
  claims_by_age_group = dat$usage %>%
    mutate(age_group=age_group_f(age)) %>%
    group_by(age_group) %>%
    summarize(n_claims=sum(n_claims), n_bene=n()) %>%
    mutate(cpkp=n_claims*1000/n_bene) %>%
    select(age_group, n_bene, cpkp)

  claims_by_region = summarize_by(dat$usage, 'region')

  chars_by_consumption = dat$usage %>%
    mutate(claims_group=claims_group_f(n_claims)) %>%
    group_by(claims_group) %>%
    summarize(`no. beneficiaries`=n(),
              `mean age`=mean(age),
              `% female`=mean(is_female) * 100,
              `mean no. chronic conditions`=mean(n_cc))
  
  condition_model = single_condition_models(dat$usage)

  list(totals=totals,
       claims_by_class=claims_by_class,
       top_abx=top_abx,
       claims_by_sex=claims_by_sex,
       claims_by_age=claims_by_age,
       claims_by_age_group=claims_by_age_group,
       claims_by_region=claims_by_region,
       chars_by_consumption=chars_by_consumption,
       condition_model=condition_model) %>%
    lapply(function(x) mutate(x, year=year))
}

years = 2011:2014
results = lapply(years, analyze)
names(results) = as.character(years)
```

```{r arrange_data}
data_by_field = function(field) lapply(results, function(x) x[[field]]) %>% bind_rows()

totals = data_by_field('totals') %>%
  spread(key, value) %>%
  mutate(cpkp=round(n_pde*1000/n_bene)) %>%
  mutate_at(vars(n_bene, n_pde), function(x) prettyNum(x, big.mark=',')) %>%
  rename(`number of beneficiaries`=n_bene, `number of antibiotic PDEs`=n_pde, `CPKP`=cpkp) %>%
  arrange(year) %T>%
  write_tsv('tables/table1.tsv') %>%
  kable

claims_by_class = data_by_field('claims_by_class')

top_classes = claims_by_class %>%
  filter(year==2011) %>%
  arrange(desc(cpkp)) %>%
  head(9) %$%
  antibiotic_class

class_levels = c(top_classes, 'other')

claims_by_class %<>%
  mutate(antibiotic_class=if_else(antibiotic_class %in% top_classes,
                                  antibiotic_class,
                                  'other')) %>%
  group_by(year, antibiotic_class) %>%
  summarize(cpkp=round(sum(cpkp))) %>%
  spread(year, cpkp) %>%
  mutate(antibiotic_class=factor(antibiotic_class, levels=class_levels, ordered=TRUE)) %>%
  arrange(antibiotic_class) %T>%
  write_tsv('tables/table2_class.tsv') %>%
  kable

top_abx = data_by_field('top_abx') %>%
  mutate(cpkp=round(cpkp)) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>%
  head(11) %T>%
  write_tsv('tables/table2_drug.tsv') %>%
  kable

claims_by_sex = data_by_field('claims_by_sex') %>%
  mutate(cpkp=round(cpkp)) %>%
  spread(year, cpkp) %T>%
  write_tsv('tables/table2_sex.tsv') %>%
  kable

claims_by_age_group = data_by_field('claims_by_age_group') %>%
  mutate(cpkp=round(cpkp)) %>%
  select(age_group, year, cpkp) %>%
  spread(year, cpkp) %T>%
  write_tsv('tables/supptable1_age_group.tsv') %>%
  kable

bene_by_age_group = data_by_field('claims_by_age_group') %>%
  mutate(n_bene=prettyNum(n_bene, big.mark=',')) %>%
  select(age_group, year, n_bene) %>%
  spread(year, n_bene) %T>%
  write_tsv('tables/supptable1_age_group_denom.tsv') %>%
  kable

claims_by_age = data_by_field('claims_by_age')

claims_by_region = data_by_field('claims_by_region') %>%
  mutate(cpkp=round(cpkp)) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %T>%
  write_tsv('tables/table2_region.tsv') %>%
  kable

chars_by_consumption = data_by_field('chars_by_consumption') %>%
  mutate_at(vars(`mean age`, `% female`, `mean no. chronic conditions`), function(x) round(x, digits=2)) %>%
  arrange(year, claims_group) %>%
  kable

condition_model = data_by_field('condition_model') %>%
  left_join(condition_names, by='condition') %>%
  filter(year==2011, term != '(Intercept)') %>%
  mutate(estimate=round(estimate, digits=3)) %>%
  select(condition=condition_name, term, estimate) %>%
  spread(term, estimate) %>%
  arrange(desc(has_conditionTRUE)) %T>%
  write_tsv('tables/table3.tsv') %>%
  kable
```

# Summary of data

`r totals`

# Table 1: Patterns of consumption

All consumption rates are reported as claims per thousand people per year (CPKP).

## Claims by class

`r claims_by_class`

## Most-prescribed antibiotics

`r top_abx`

## Consumption by sex

`r claims_by_sex`

## Consumption by region

`r claims_by_region`

## Consumption by age

`r claims_by_age_group`

`r bene_by_age_group`

# Figure 1: Claims and conditions by age

```{r fig1_claims_by_age}
claims_by_age %>%
  filter(year==2011) %>%
  ggplot(aes(x=age,
             y=mean_n_claims,
             ymin=mean_n_claims-sem_n_claims,
             ymax=mean_n_claims+sem_n_claims)) +
  geom_point() +
  geom_errorbar() +
  theme_minimal() +
  scale_x_continuous(breaks=c(66, 70, 80, 90, 100))
```

```{r fig1_cc_by_age}
claims_by_age %>%
  filter(year==2011) %>%
  ggplot(aes(x=age,
             y=mean_n_cc,
             ymin=mean_n_cc-sem_n_cc,
             ymax=mean_n_cc+sem_n_cc)) +
  geom_point() +
  geom_errorbar() +
  theme_minimal() +
  scale_x_continuous(breaks=c(66, 70, 80, 90, 100))
```

# Table 2: Beneficiary characteristics by consumption

`r chars_by_consumption`

# Table 3: Chronic conditions predict consumption

`r condition_model`

## Table 3 caption: model coefficient p-values

Only $p$-values above (less significant than) $10^{-50}$ are shown. All the remaining values are more significant than the ones shown here.

```{r p_values}
data_by_field('condition_model') %>%
  select(term, year, p.value) %>%
  mutate(adj.p=p.adjust(p.value, method='bonferroni'),
         log10.adj.p=log10(adj.p)) %>%
  filter(adj.p > 10^(-50)) %>%
  arrange(desc(log10.adj.p)) %>%
  kable
```
