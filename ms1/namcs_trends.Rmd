---
title: "Temporal trends (NAMCS)"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE)

library(survey)
```

```{r load_data}
# Caveat: I removed a stratum from the 2011 data that had only one PSU in it.
# Also: I'm not sure that combining years like this is going to be kosher.

years = 2011:2014
n_years = length(years)
mpy = function(x) x/(1e6 * n_years) # millions per year

read_tsv_years = function(fn_template, ...) {
  f = function(y) sprintf(fn_template, y) %>% read_tsv(..., guess_max=1e6) %>% mutate(year=y, visit_id=paste0(y, '_', visit_id))
  lapply(years, f) %>% bind_rows
}

census = read_tsv('../../../../db/census/census_totals.tsv')

sex_codes = read_tsv('../sex-difference/namcs_sex_codes.tsv') %>%
  rename(dx=code)

dx = read_tsv_years('../../db/namcs/data/namcs_dx_%i.tsv') %>%
  left_join(sex_codes, by='dx')

dx_visit = dx %>%
  group_by(visit_id) %>%
  summarize(acute_rc='acute_rc' %in% diagnosis_type)

top_abx = read_tsv('../../db/namcs/analysis/top_abx.tsv')
abx_cat = read_tsv('../../db/namcs/data/parse/drug_codes/abx_codes.tsv')

drugs = read_tsv_years('../../db/namcs/data/namcs_drugs_%i.tsv') %>%
  mutate(is_abx=cat1 %in% abx_cat$category)

n_abx = drugs %>%
  filter(is_abx) %>%
  group_by(visit_id) %>%
  summarize(n_abx=n())

abx_visit = left_join(top_abx, drugs, by='desc') %>%
  count(visit_id, abx) %>% ungroup() %>%
  spread(abx, n)

visits = read_tsv_years('../../db/namcs/data/namcs_visits_%i.tsv') %>%
  mutate(age_group=case_when(.$age <= 19 ~ 'child',
                             .$age <= 64 ~ 'adult',
                             .$age <= 92 ~ 'elderly')) %>%
  left_join(dx_visit, by='visit_id') %>%
  replace_na(list(acute_rc=FALSE)) %>%
  left_join(n_abx, by='visit_id') %>% replace_na(list(n_abx=0)) %>%
  left_join(abx_visit, by='visit_id') %>%
  mutate_at(top_abx$abx, function(x) if_else(is.na(x), 0L, x))

filter_strata = function(df) {
  bad_strata = select(df, survey_id, stratum) %>% distinct() %>% count(stratum) %>% filter(n==1) %$% stratum
  filter(df, !(stratum %in% bad_strata))
}

design_f = function(df) {
  filter_strata(df) %>%
    as.data.frame() %>%
    svydesign(data=., ids=~survey_id, strata=~stratum, weights=~weight, nest=TRUE)
}

design = design_f(visits)
adult_design = subset(design, age_group != 'child')
```

# Methods

## Data & overall methods

I used the 2011-2014 NAMCS data. All numbers of prescriptions will be presented in millions per year. I'll mostly consider only the adults.

## Drugs

I consider the same drugs as last time:

```{r}
kable(top_abx)
```

# Results

## Trends in numbers of visits and number of Americans

The number of visits went down during this period:

```{r visits_census}
design %>%
  update(x=1) %>%
  svyby(~x, ~year, design=., svytotal) %>%
  as_data_frame() %>%
  rename(n_visits=x) %>%
  kable
```

But the number of Americans went up (but the number of children went down):

```{r}
census %>% kable
```

## Summary of trends

### Overall trends

It looks by eye like the total number of antibiotic prescriptions per capita is going down:

```{r overall}
overall_trend = svyby(~n_abx, ~year, design=design, svytotal) %>%
  as_data_frame() %>%
  left_join(census, by='year') %>%
  mutate(abx_per_capita=n_abx/n_total, se_per_capita=se/n_total)

overall_trend %>%
  mutate(ci=1.96*se_per_capita, ymin=abx_per_capita-ci, ymax=abx_per_capita+ci) %>%
  ggplot(aes(x=year, y=abx_per_capita, ymin=ymin, ymax=ymax)) +
  geom_point() + geom_line() + geom_linerange() +
  theme_minimal()
```

There is no support for a trend per visit:

```{r overall_model1}
svyglm(n_abx ~ year, design=design, family=quasipoisson(link='identity')) %>%
  tidy %>% kable
```

Nor for a trend per capita:

```{r overall_model2}
overall_trend %>%
  mutate(year=year-min(year)) %>%
  lm(abx_per_capita ~ year, weights=1.0/se_per_capita^2, data=.) %>%
  tidy %>% kable
```

### Trends by drug

```{r drugs_time}
# apc = antibiotic per capita
f = function(design, d) {
  svyby(as.formula(paste0('~', d)), ~year, design=design, svytotal) %>%
    as_data_frame() %>%
    rename_(.dots=setNames(d, 'n_abx')) %>%
    mutate(abx=d)
}

g = function(design, denom) {
  lapply(top_abx$abx, function(x) f(design, x)) %>% bind_rows() %>%
    left_join(census, by='year') %>%
    rename_(.dots=setNames(denom, 'denom')) %>%
    mutate(apc=n_abx/denom, se=se/denom)
}

abx_time = g(design, 'n_total')
abx_time_adult = g(adult_design, 'n_adult')
```

```{r drugs_time_plot}
abx_time %>%
  mutate(ci=1.96*se, ymin=apc-ci, ymax=apc+ci) %>%
  ggplot(aes(x=year, y=apc, ymin=ymin, ymax=ymax)) +
  facet_wrap(~abx, ncol=3, scales='free_y') +
  geom_point() + geom_line() + geom_linerange() +
  theme_minimal()
```

And the same plot again, but with fixed scales:

```{r drugs_time_plot_fixed}
abx_time %>%
  mutate(ci=1.96*se, ymin=apc-ci, ymax=apc+ci) %>%
  ggplot(aes(x=year, y=apc, ymin=ymin, ymax=ymax)) +
  facet_wrap(~abx, ncol=3) +
  geom_point() + geom_line() + geom_linerange() +
  theme_minimal()
```

It doesn't look by eye that any trends are particularly strong.

I used weighted linear regression to look for trends in totals:

```{r drugs_time_totals_model}
abx_total_models = abx_time %>%
  group_by(abx) %>%
  do(tidy(lm(apc ~ year, weight=1.0/se^2, data=.))) %>%
  ungroup()

abx_total_models %>%
  filter(term=='year') %>% select(-term) %>%
  arrange(estimate) %>%
  kable

abx_total_models %>%
  filter(term=='year') %>% select(-term) %>%
  mutate(ci=1.96*std.error, ymin=estimate-ci, ymax=estimate+ci) %>%
  mutate(abx=forcats::fct_reorder(abx, estimate)) %>%
  ggplot(aes(x=abx, y=estimate, ymin=ymin, ymax=ymax)) +
  geom_point() + geom_linerange() +
  coord_flip() +
  theme_minimal()
```

I used Poisson regressions to see if anything was changing *per visit* with time. Only levo:

```{r drugs_time_model}
qpglm = function(design, frmla) {
  svyglm(frmla, design=design, family=quasipoisson(link='identity'))
}

f = function(design, d) {
  qpglm(design, as.formula(paste0(d, '~ year'))) %>%
    tidy %>%
    mutate(abx=d) %>%
    filter(term != '(Intercept)')
}

g = function(design) lapply(top_abx$abx, function(x) f(design, x)) %>% bind_rows()

abx_time_model = g(design)
abx_time_model_adult = g(adult_design)
```

```{r drugs_time_model_table}
abx_time_model %>%
  select(abx, estimate, p.value) %>%
  mutate(adj.p.value=p.adjust(p.value, method='BH')) %>%
  arrange(p.value) %>%
  kable
```

## Trends among the adults

I do the same analysis, but just among adults. Weirdly, the results look a lot
different. The confidence intervals get a lot bigger.

```{r adult_trends}
adult_models = abx_time_adult %>%
  group_by(abx) %>%
  do(tidy(lm(apc ~ year, weight=1.0/se^2, data=.))) %>%
  ungroup()

adult_models %>%
  filter(term=='year') %>% select(-term) %>%
  mutate(ci=1.96*std.error, ymin=estimate-ci, ymax=estimate+ci) %>%
  mutate(abx=forcats::fct_reorder(abx, estimate)) %>%
  ggplot(aes(x=abx, y=estimate, ymin=ymin, ymax=ymax)) +
  geom_point() + geom_linerange() +
  coord_flip() +
  theme_minimal()
```

### Just levo

```{r levo_ratio}
levo_time = abx_time_adult %>%
  filter(abx=='levo') %>%
  arrange(year)

t1 = levo_time %>% filter(year==2011) %$% apc
v1 = levo_time %>% filter(year==2011) %$% se
t2 = levo_time %>% filter(year==2014) %$% apc
v2 = levo_time %>% filter(year==2014) %$% se

tr = t2 / t1
vr = v1 / t2^2 + t1^1 / t2^4 * v2
sdr = sqrt(vr)

show_tot = function(tot, v) sprintf('%g (±%g)', round(tot, 4), round(v, 4))
show_pct = function(tot, v) sprintf('%g%% (±%g%%)', round((tot - 1)*100, digits=1), round(sqrt(v)*100, digits=1))
```

```{r}
levo_time %>%
  select(year, abx_per_capita=apc, se) %>%
  kable
```

Levo increased from `r show_tot(t1, v1)` to `r show_tot(t2, v2)` per capita, an increase of `r show_pct(tr, vr)`.


# Conclusions

Levo is definitely going up.
