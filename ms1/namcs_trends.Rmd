---
title: "Temporal trends (NAMCS)"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE)

library(survey)
```

```{r load_namcs_data}
# Caveat: I removed a stratum from the 2011 data that had only one PSU in it.
# Also: I'm not sure that combining years like this is going to be kosher.

years = 2011:2014
n_years = length(years)

read_tsv_years = function(fn_template, ...) {
  f = function(y) sprintf(fn_template, y) %>% read_tsv(..., guess_max=1e6) %>% mutate(year=y, visit_id=paste0(y, '_', visit_id))
  lapply(years, f) %>% bind_rows
}

sex_codes = read_tsv('../sex-difference/namcs_sex_codes.tsv') %>%
  rename(dx=code)

dx = read_tsv_years('../../db/namcs/data/namcs_dx_%i.tsv') %>%
  left_join(sex_codes, by='dx')

dx_visit = dx %>%
  group_by(visit_id) %>%
  summarize(acute_rc='acute_rc' %in% diagnosis_type)

top_abx = read_tsv('namcs_top_abx.tsv')
abx_cat = read_tsv('../../db/namcs/data/parse/drug_codes/abx_codes.tsv')

drugs = read_tsv_years('../../db/namcs/data/namcs_drugs_%i.tsv') %>%
  mutate(is_abx=cat1 %in% abx_cat$category)

n_abx = drugs %>%
  filter(is_abx) %>%
  group_by(visit_id) %>%
  summarize(n_abx=n())

abx_visit = top_abx %>%
  select(desc, abx) %>%
  left_join(drugs, by='desc') %>%
  count(visit_id, abx) %>% ungroup() %>%
  spread(abx, n)

visits = read_tsv_years('../../db/namcs/data/namcs_visits_%i.tsv') %>%
  mutate(age_group=case_when(.$age <= 19 ~ 'child',
                             .$age <= 64 ~ 'adult',
                             .$age <= 92 ~ 'elderly')) %>%
  left_join(dx_visit, by='visit_id') %>%
  replace_na(list(acute_rc=FALSE)) %>%
  left_join(n_abx, by='visit_id') %>% replace_na(list(n_abx=0)) %>%
  left_join(abx_visit, by='visit_id') %>%
  mutate_at(top_abx$abx, function(x) if_else(is.na(x), 0L, x))
```

```{r load_other_data}
census = read_tsv('../../../../db/census/census_totals.tsv') %>%
  mutate(n_nonchild=n_total - n_children)

mpy = function(x) x/(1e6 * n_years) # millions per year

filter_strata = function(df) {
  bad_strata = select(df, survey_id, stratum) %>% distinct() %>% count(stratum) %>% filter(n==1) %$% stratum
  filter(df, !(stratum %in% bad_strata))
}

design_f = function(df) {
  filter_strata(df) %>%
    as.data.frame() %>%
    svydesign(data=., ids=~survey_id, strata=~stratum, weights=~weight, nest=TRUE)
}

design = design_f(visits)
adult_design = subset(design, age_group != 'child')
```

# Methods

## Data & overall methods

I used the 2011-2014 NAMCS data. All numbers of prescriptions will be presented
in millions per year. I'll mostly consider only the adults (i.e., those over 18 years).

## Drugs

I consider the same drugs as in Medicare, except for clindamycin, which I drop,
because NAMCS doesn't have enough information to distinguish between oral and
topical formulations.

```{r top_abx_table}
top_abx %>%
  select(medicare_abx, abx) %>%
  kable
```

## Data validity

The NAMCS methodology recommends that a value be considered sensible only if
(*a*) there are 30 records to support it and (*b*) and standard error is no
more than 30% of the estimate. There are at least 30 records per antibiotic per
year:

```{r data_validity}
visits %>%
  select(year, amox:tmpsmx) %>%
  group_by(year) %>%
  summarize_all(function(x) sum(x > 0)) %>%
  kable
```

# Results

## Trends in numbers of visits and number of Americans

The number of visits went down during this period:

```{r visits_census}
design %>%
  update(x=1) %>%
  svyby(~x, ~year, design=., svytotal) %>%
  as_data_frame() %>%
  rename(n_visits=x) %>%
  kable
```

However, the number of Americans went up (but the number of children went down):

```{r}
census %>% kable
```

This means that visits per American went down. Thus, consumption of some drug
could be increasing per visit but not be increasing per capita, for example.

## Trends per visit

Methodologically, trends per visit is easier, because we just perform
regressions on the records in NAMCS. The con is that the results are more
difficult to interpret in light of the fact that there are trends in population
size as well as in healthcare usage.

In all the results that follow, I'm looking at consumption among the adult
population only.

```{r lm_functions}
add_pct_change = function(df) {
  mutate(df, ci=1.96*std.error,
             pct_change=exp(estimate)-1,
             ci_low=exp(estimate-ci)-1,
             ci_high=exp(estimate+ci)-1) %>%
    mutate_at(vars(pct_change, ci_low, ci_high), function(x) x*100)
}
```

Levofloxacin has the largest apparent increase per visit (i.e., the number of
visits in which levofloxacin was prescribed increases the most).

```{r per_visit_model}
# survey poisson model
svy_pm = function(design, frmla) svyglm(frmla, design=design, family='poisson') %>% tidy

overall_pv = adult_design %>% svy_pm(n_abx ~ year) %>% mutate(abx='overall')

drug_pv = top_abx$abx %>%
  lapply(function(a) svy_pm(adult_design, as.formula(paste0(a, '~year'))) %>% mutate(abx=a)) %>%
  bind_rows()
```

Levofloxacin and amox/clav have statistically significant results, as reported
by the Poisson regressions. Only the levofloxacin result meets the standard
error criterion for data validity.

```{r per_visit_display}
x = bind_rows(overall_pv, drug_pv) %>%
  filter(term=='year') %>%
  mutate(adj.p.value=p.adjust(p.value, method='BH')) %>%
  add_pct_change() %>%
  arrange(pct_change) %>%
  mutate(abx=forcats::fct_inorder(abx))

ggplot(x, aes(x=abx, y=pct_change, ymin=ci_low, ymax=ci_high)) +
  geom_linerange() +
  geom_point() +
  coord_flip() +
  xlab('') +
  ylab('pct change in consumption per visit') +
  ggtitle('Per visit') +
  theme_minimal()

x %>%
  mutate(valid=abs(std.error/estimate)<=0.3, sig=if_else(adj.p.value < 0.05, '*', '')) %>%
  select(abx, ci_low, pct_change, ci_high, p.value, adj.p.value, valid, sig) %>%
  kable
```

## Trends per capita

```{r per_capita_counts}
# apc = antibiotics per capita

overall_pc_f = function(design, denom) {
  svyby(~n_abx, ~year, design=design, svytotal) %>%
    as_data_frame() %>%
    left_join(census, by='year') %>%
    rename_(.dots=setNames(denom, 'denom')) %>%
    mutate(apc=n_abx/denom, se=se/denom) %>%
    mutate(abx='overall')
}

n_abx_f = function(design, a) {
  svyby(as.formula(paste0('~', a)), ~year, design=design, svytotal) %>%
    as_data_frame() %>%
    rename_(.dots=setNames(a, 'n_abx')) %>%
    mutate(abx=a)
}

apc_f = function(design, denom) {
  lapply(top_abx$abx, function(x) n_abx_f(design, x)) %>%
    bind_rows() %>%
    left_join(census, by='year') %>%
    rename_(.dots=setNames(denom, 'denom')) %>%
    mutate(apc=n_abx/denom, se=se/denom) %>%
    bind_rows(overall_pc_f(design, denom))
}

per_capita_counts = apc_f(adult_design, 'n_nonchild')
per_capita_counts_all = apc_f(design, 'n_total')
```

```{r per_capita_counts_display}
# free scales, with overall
per_capita_counts %>%
  mutate(abx=factor(abx, levels=c('overall', top_abx$abx))) %>%
  mutate(ci=1.96*se, ymin=apc-ci, ymax=apc+ci) %>%
  ggplot(aes(x=year, y=apc, ymin=ymin, ymax=ymax)) +
  facet_wrap(~abx, ncol=3, scales='free_y') +
  geom_point() + geom_line() + geom_linerange() +
  theme_minimal()

# fixed scales, without overall
per_capita_counts %>%
  filter(abx != 'overall') %>%
  mutate(abx=factor(abx, levels=top_abx$abx)) %>%
  mutate(ci=1.96*se, ymin=apc-ci, ymax=apc+ci) %>%
  ggplot(aes(x=year, y=apc, ymin=ymin, ymax=ymax)) +
  facet_wrap(~abx, ncol=3, scales='fixed') +
  geom_point() + geom_line() + geom_linerange() +
  theme_minimal()
```

```{r per_capita_models}
per_capita = per_capita_counts %>%
  group_by(abx) %>%
  do(tidy(glm(apc ~ year, data=., family=gaussian(link='log'), weights=1.0/se^2)))
```

The trends in consumption per capita are all consistent with those observed in
Medicare, but none of them meet the standard error criterion for validity or
are statistically significant.

```{r per_capita_models_display}
x = per_capita %>%
  filter(term=='year') %>%
  mutate(valid=abs(std.error/estimate)<=0.3, adj.p.value=p.adjust(p.value, method='BH')) %>%
  add_pct_change()

read_tsv('tables/model_abx.tsv') %>%
  filter(term=='year', model=='poisson') %>%
  left_join(top_abx, by=c('antibiotic'='medicare_abx')) %>%
  mutate(abx=if_else(is.na(abx), antibiotic, abx)) %>%
  mutate(data_source='medicare') %>%
  bind_rows(per_capita %>% filter(term=='year') %>% mutate(data_source='namcs')) %>%
  add_pct_change() %>%
  mutate(abx=forcats::fct_reorder(abx, pct_change)) %>%
  ggplot(aes(x=abx, y=pct_change, ymin=ci_low, ymax=ci_high, color=data_source)) +
  #geom_linerange() +
  geom_errorbar() +
  geom_point() +
  coord_flip() +
  xlab('') +
  ylab('pct change in consumption per capita') +
  ggtitle('Per capita') +
  theme_minimal()

x %>%
  select(abx, ci_low, pct_change, ci_high, p.value, valid, adj.p.value) %>%
  arrange(desc(pct_change)) %>%
  kable
```

## Special drugs

```{r special_times}
levo_t1 = per_capita_counts %>% filter(abx=='levo', year==2011)
levo_t2 = per_capita_counts %>% filter(abx=='levo', year==2014)
amoxclav_t1 = per_capita_counts %>% filter(abx=='amoxclav', year==2011)
amoxclav_t2 = per_capita_counts %>% filter(abx=='amoxclav', year==2014)

show_var = function(df) sprintf('%g (Â±%g)', round(df$apc*1000, 1), round(df$se*1000, 1))
```

Levofloxacin consumption increased from `r show_var(levo_t1)` to `r show_var(levo_t2)` claims per 1,000 people per year.
Amox/clav consumption increased from `r show_var(amoxclav_t1)` to `r show_var(amoxclav_t2)` claims per 1,000 people per year.

