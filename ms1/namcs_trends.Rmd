---
title: "Temporal trends (NAMCS)"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE)

library(survey)
```

```{r load_data}
# Caveat: I removed a stratum from the 2011 data that had only one PSU in it.
# Also: I'm not sure that combining years like this is going to be kosher.

years = 2011:2014
n_years = length(years)
mpy = function(x) x/(1e6 * n_years) # millions per year

read_tsv_years = function(fn_template, ...) {
  f = function(y) sprintf(fn_template, y) %>% read_tsv(..., guess_max=1e6) %>% mutate(year=y, visit_id=paste0(y, '_', visit_id))
  lapply(years, f) %>% bind_rows
}

census = read_tsv('../../../../db/census/census_totals.tsv')

sex_codes = read_tsv('../sex-difference/namcs_sex_codes.tsv') %>%
  rename(dx=code)

dx = read_tsv_years('../../db/namcs/data/namcs_dx_%i.tsv') %>%
  left_join(sex_codes, by='dx')

dx_visit = dx %>%
  group_by(visit_id) %>%
  summarize(acute_rc='acute_rc' %in% diagnosis_type)

top_abx = read_tsv('namcs_top_abx.tsv')
abx_cat = read_tsv('../../db/namcs/data/parse/drug_codes/abx_codes.tsv')

drugs = read_tsv_years('../../db/namcs/data/namcs_drugs_%i.tsv') %>%
  mutate(is_abx=cat1 %in% abx_cat$category)

n_abx = drugs %>%
  filter(is_abx) %>%
  group_by(visit_id) %>%
  summarize(n_abx=n())

abx_visit = top_abx %>%
  select(desc, abx) %>%
  left_join(drugs, by='desc') %>%
  count(visit_id, abx) %>% ungroup() %>%
  spread(abx, n)

visits = read_tsv_years('../../db/namcs/data/namcs_visits_%i.tsv') %>%
  mutate(age_group=case_when(.$age <= 19 ~ 'child',
                             .$age <= 64 ~ 'adult',
                             .$age <= 92 ~ 'elderly')) %>%
  left_join(dx_visit, by='visit_id') %>%
  replace_na(list(acute_rc=FALSE)) %>%
  left_join(n_abx, by='visit_id') %>% replace_na(list(n_abx=0)) %>%
  left_join(abx_visit, by='visit_id') %>%
  mutate_at(top_abx$abx, function(x) if_else(is.na(x), 0L, x))

filter_strata = function(df) {
  bad_strata = select(df, survey_id, stratum) %>% distinct() %>% count(stratum) %>% filter(n==1) %$% stratum
  filter(df, !(stratum %in% bad_strata))
}

design_f = function(df) {
  filter_strata(df) %>%
    as.data.frame() %>%
    svydesign(data=., ids=~survey_id, strata=~stratum, weights=~weight, nest=TRUE)
}

design = design_f(visits)
adult_design = subset(design, age_group != 'child')
```

# Methods

## Data & overall methods

I used the 2011-2014 NAMCS data. All numbers of prescriptions will be presented in millions per year. I'll mostly consider only the adults.

## Drugs

I consider the same drugs as in Medicare, except for clindamycin, which I drop,
because NAMCS doesn't have enough information to distinguish between oral and
topical formulations.

```{r top_abx_table}
top_abx %>%
  select(medicare_abx, abx) %>%
  kable
```

# Results

## Trends in numbers of visits and number of Americans

The number of visits went down during this period:

```{r visits_census}
design %>%
  update(x=1) %>%
  svyby(~x, ~year, design=., svytotal) %>%
  as_data_frame() %>%
  rename(n_visits=x) %>%
  kable
```

However, the number of Americans went up (but the number of children went down):

```{r}
census %>% kable
```

## Summary of trends

### Overall trends

It looks by eye like the total number of antibiotic prescriptions per capita is going down:

```{r overall}
overall_trend = svyby(~n_abx, ~year, design=design, svytotal) %>%
  as_data_frame() %>%
  left_join(census, by='year') %>%
  mutate(abx_per_capita=n_abx/n_total, se_per_capita=se/n_total)

overall_trend %>%
  mutate(ci=1.96*se_per_capita, ymin=abx_per_capita-ci, ymax=abx_per_capita+ci) %>%
  ggplot(aes(x=year, y=abx_per_capita, ymin=ymin, ymax=ymax)) +
  geom_point() + geom_line() + geom_linerange() +
  theme_minimal()
```

There is no support for a trend per visit:

```{r lm_functions}
# survey poisson model
svy_pm = function(design, frmla) svyglm(frmla, design=design, family='poisson') %>% tidy

# log glm
log_glm = function(df, frmla, weights=NULL) glm(formula=as.formula(frmla), data=df, family=gaussian(link='log'), weights=weights) %>% tidy
```

```{r overall_per_visit}
svy_pm(design, n_abx ~ year) %>% kable
```

Nor for a trend per capita:

```{r overall_per_capita}
overall_trend %>%
  mutate(year=year-min(year)) %>%
  log_glm('abx_per_capita ~ year', weights=1.0/.$se_per_capita^2) %>%
  kable
```

### Trends by drug

#### Per capita

```{r drugs_per_capita_model}
n_abx_f = function(design, a) {
  svyby(as.formula(paste0('~', a)), ~year, design=design, svytotal) %>%
    as_data_frame() %>%
    rename_(.dots=setNames(a, 'n_abx')) %>%
    mutate(abx=a)
}

# apc = antibiotic per capita
apc_f = function(design, denom) {
  lapply(top_abx$abx, function(x) n_abx_f(design, x)) %>% bind_rows() %>%
    left_join(census, by='year') %>%
    rename_(.dots=setNames(denom, 'denom')) %>%
    mutate(apc=n_abx/denom, se=se/denom)
}

abx_time = apc_f(design, 'n_total')
abx_time_adult = apc_f(adult_design, 'n_adult')
```

```{r drugs_per_capita_time}
abx_time %>%
  mutate(ci=1.96*se, ymin=apc-ci, ymax=apc+ci) %>%
  ggplot(aes(x=year, y=apc, ymin=ymin, ymax=ymax)) +
  facet_wrap(~abx, ncol=3, scales='free_y') +
  geom_point() + geom_line() + geom_linerange() +
  theme_minimal()
```

And the same plot again, but with fixed scales:

```{r drugs_time_plot_fixed}
abx_time %>%
  mutate(ci=1.96*se, ymin=apc-ci, ymax=apc+ci) %>%
  ggplot(aes(x=year, y=apc, ymin=ymin, ymax=ymax)) +
  facet_wrap(~abx, ncol=3) +
  geom_point() + geom_line() + geom_linerange() +
  theme_minimal()
```

It doesn't look by eye that any trends are particularly strong. I used weighted
log regression to look for trends in totals:

```{r drugs_per_capita_time_trends}
abx_total_models = abx_time %>%
  group_by(abx) %>%
  do(log_glm(., 'apc ~ year', weights=1.0/.$se^2)) %>%
  ungroup()

abx_total_models %>%
  filter(term=='year') %>% select(-term) %>%
  arrange(estimate) %>%
  kable
```

```{r drugs_per_capita_figure}
bind_rows(
  read_tsv('tables/model_abx.tsv') %>%
    filter(term=='year', model=='poisson') %>%
    left_join(top_abx, by=c('antibiotic'='medicare_abx')) %>%
    mutate(abx=if_else(is.na(abx), antibiotic, abx)) %>%
    select(abx, estimate, std.error) %>%
    mutate(data_source='medicare'),
  abx_total_models %>%
    filter(term=='year') %>%
    select(abx, estimate, std.error) %>%
    mutate(data_source='namcs')
) %>%
  #mutate(abx=factor(abx, levels=top_abx$abx)) %>%
#abx_total_models %>%
#  filter(term=='year') %>%
  mutate(ci=1.96*std.error, y=exp(estimate)-1, ymin=exp(estimate-ci)-1, ymax=exp(estimate+ci)-1) %>%
  #select(abx, y, ymin, ymax) %>%
  mutate_if(is.numeric, function(x) x*100) %>%
  #arrange(y) %>% mutate(abx=forcats::fct_inorder(abx)) %>%
  #ggplot(aes(x=abx, y=y, ymin=ymin, ymax=ymax)) +
  ggplot(aes(x=abx, y=y, ymin=ymin, ymax=ymax, color=data_source)) +
  geom_linerange() +
  geom_point() +
  coord_flip() +
  ylab('pct change in consumption per capita') +
  theme_minimal()
```

#### Per visit

I used Poisson regressions to see if anything was changing *per visit* with
time: levo and amox/clav. (These results are only with adults.)

```{r drugs_per_visit}
f = function(design) {
  lapply(top_abx$abx, function(a) {
    svy_pm(design, as.formula(paste0(a, '~year'))) %>%
      mutate(abx=a)
  }) %>% bind_rows()
}

abx_time_model = f(design)
abx_time_model_adult = f(adult_design)
```

```{r drugs_per_visit_table}
abx_time_model_adult %>%
  filter(term=='year') %>%
  select(abx, estimate, p.value) %>%
  mutate(adj.p.value=p.adjust(p.value, method='BH')) %>%
  mutate(pct=100*(exp(estimate)-1)) %>%
  arrange(desc(pct)) %>%
  kable
```

```{r drugs_per_visit_figure}
abx_time_model_adult %>%
  filter(term=='year') %>%
  mutate(ci=1.96*std.error, y=exp(estimate)-1, ymin=exp(estimate-ci)-1, ymax=exp(estimate+ci)-1) %>%
  select(abx, y, ymin, ymax) %>%
  mutate_if(is.numeric, function(x) x*100) %>%
  arrange(y) %>% mutate(abx=forcats::fct_inorder(abx)) %>%
  ggplot(aes(x=abx, y=y, ymin=ymin, ymax=ymax)) +
  geom_point() + geom_linerange() +
  coord_flip() +
  ylab('pct change in consumption per visit') +
  theme_minimal()
```

```{r special_times}
levo_t1 = abx_time_adult %>% filter(abx=='levo', year==2011)
levo_t2 = abx_time_adult %>% filter(abx=='levo', year==2014)
amoxclav_t1 = abx_time_adult %>% filter(abx=='amoxclav', year==2011)
amoxclav_t2 = abx_time_adult %>% filter(abx=='amoxclav', year==2014)

show_var = function(df) sprintf('%g (Â±%g)', round(df$apc*1000, 1), round(df$se*1000, 1))
```

Levofloxacin consumption increased from `r show_var(levo_t1)` to `r show_var(levo_t2)` claims per 1,000 people per year.
Amox/clav consumption increased from `r show_var(amoxclav_t1)` to `r show_var(amoxclav_t2)` claims per 1,000 people per year.

#### Per visit, Among everyone

I do the same analysis, but among everyone.

```{r drugs_per_visit_everyone}
abx_time_model %>%
  filter(term=='year') %>%
  select(-term) %>%
  kable
```

