---
title: "Chronic conditions and antibiotic consumption among the non-elderly"
author: "Scott Olesen"
date: "2/27/2017"
output: html_document
---

# Background

We see that chronic conditions, not age, control consumption among the elderly.
Is the same true among the non-elderly? The Medicare people are going to be
pretty sick.

# Methods

I'll use the Medicare 2011 data with different filters: age below 65, on
Medicare for 12 months of the year).

For each chronic condition, I did a Poisson regression of the number of claims
for a beneficiary against the beneficiary's age and their status for that
condition. I hoped that including age in the regression would prevent a
confounding between age, conditions, and consumption.

To report the results of the regression, I show the "percent increase" due to a
variable in the regression. A Poisson regression estimates that $E(Y|x) =
\exp(\alpha + \beta x)$. Let $\beta_i$ be the term for the boolean variable
$x_i$ of interest. Then the expected increase in consumption due to that $x_i$
being true is $\exp(\beta_i)$.

# Results

```{r global_options, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4,
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE)
library(psych)
library(gplots)
library(broom)
library(glmnet)
require(doMC)
library(stringr)
```

```{r load_data}
bene = read_tsv('../../bene_2011.tsv') %>%
  filter(age < 65) %>%
  mutate(is_female=sex=='female') %>%
  select(bene_id, age, is_female)
chronic_conditions = read_tsv('../cc_2011.tsv') %>%
  rename(bene_id=BENE_ID) %>%
  select(-STRCTFLG) %>%
  mutate_at(vars(AMI:HYPOTH), function(x) x==3)
pde_summary = read_tsv('../../pde_2011.tsv') %>%
  count(bene_id) %>% rename(n_claims=n)

na_to_0 = function(x) if_else(is.na(x), 0L, x)

usage = bene %>%
  left_join(chronic_conditions, by='bene_id') %>%
  left_join(pde_summary, by='bene_id') %>%
  mutate(n_claims=na_to_0(n_claims))

condition_names = read_tsv('../names.txt', col_names=c('condition', 'condition_name'))
```

```{r compute_correlations}
tetra = chronic_conditions %>%
  select(-bene_id) %>%
  tetrachoric()
```

```{r univariate_models}
conditions = c("AMI", "ALZH", "ALZHDMTA", "ATRIALFB", "CATARACT", "CHRNKIDN", "COPD", "CHF", "DIABETES", "GLAUCOMA", "HIPFRAC", "ISCHMCHT", "DEPRESSN", "OSTEOPRS", "RA_OA", "STRKETIA", "CNCRBRST", "CNCRCLRC", "CNCRPRST", "CNCRLUNG", "CNCRENDM", "ANEMIA", "ASTHMA", "HYPERL", "HYPERP", "HYPERT", "HYPOTH")

summarize_condition = function(x, condition) {
  rename_(x, .dots=setNames(condition, 'has_condition')) %>%
    glm(n_claims ~ age + is_female + has_condition, family='poisson', data=.) %>%
    tidy %>%
    mutate(condition=condition)
}

res = lapply(conditions, function(cond) summarize_condition(usage, cond)) %>%
  bind_rows() %>%
  left_join(condition_names, by='condition') %>%
  select(-condition) %>%
  rename(condition=condition_name)
```

```{r lasso_poisson}
registerDoMC(cores=3)

lasso_x = usage %>%
  select(age, is_female, AMI:HYPOTH) %>%
  as.matrix
lasso_y = usage$n_claims

lasso_cv = cv.glmnet(lasso_x, lasso_y, parallel=TRUE, family='poisson')
```

## Correlations

```{r, cache=FALSE}
tetra$rho %>% heatmap
```

Without male conditions (prostate cancer, enlarged prostate):

```{r fig.width=7, fig.height=7, cache=FALSE}
(!(rownames(tetra$rho) %in% c('CNCRPRST', 'HYPERP'))) %>%
  { tetra$rho[., .] } %>%
  heatmap.2(trace='none')
```

## Regression

### Univariate

First, I performed univariate regressions. In each case, the explanatory
variable was the presence of the chronic condition.

Here I show the results of the Poisson regression: the column
`estimate` is the estimate for the parameters associated with each condition,
and `p.value` measures whether the data are consistent with that parameter
being zero. The column `pct.increase` shows that percent increase in number of
claims derived from that estimate.

```{r show_poisson, cache=FALSE}
res %>%
  filter(term=='has_conditionTRUE') %>%
  mutate(pct.increase=round((exp(estimate)-1.0)*100)) %>%
  select(condition, pct.increase, estimate, p.value) %>%
  arrange(desc(estimate)) %>%
  kable
```

### Multivariate lasso

I also performed a multivariate lasso regression with the Poisson model,
keeping all the chronic conditions as well as age and sex (coded as "is
female") as explanatory variables.  I started with 10-fold cross-validation to
pick the lasso $\lambda$.

```{r cache=FALSE}
plot(lasso_cv)
```

Although the error continues to fall with decreasing $\lambda$, it seems like
there are diminishing returns after the first 8 or 10 variables are included.

```{r cache=FALSE}
lasso_df = lasso_cv$glmnet.fit %>%
  tidy %>%
  filter(estimate > 0) %>%
  group_by(step) %>%
  summarize(df=n() - 1)

lasso_cv$glmnet.fit %>%
  tidy %>%
  select(step, lambda, dev.ratio) %>%
  distinct() %>%
  left_join(lasso_df, by='step') %>%
  select(step, df, lambda) %>%
  mutate_at(vars(lambda), function(x) signif(x, digits=2)) %>%
  filter(df < 12) %>%
  kable
```

It looks like this corresponds to $\lambda \sim 0.1$. For that value, the coefficients are:

```{r cache=FALSE}
lasso_cv %>%
  coef(s=0.1) %>%
  tidy %>%
  select(condition=row, coefficient=value) %>%
  left_join(condition_names, by='condition') %>%
  mutate(term=if_else(is.na(condition_name), condition, condition_name)) %>%
  select(term, coefficient) %>%
  arrange(desc(coefficient)) %>%
  kable
```

# Discussion
