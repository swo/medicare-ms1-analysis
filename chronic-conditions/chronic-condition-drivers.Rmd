---
title: "Chronic conditions and increased antibiotic consumption"
author: "Scott Olesen"
date: "2/27/2017"
output: html_document
---

# Background

Just summing up the chronic conditions doesn't seem like a very elegant way to
summarize people's health. Choosing which chronic conditions to consider could
be a matter of expert opinion. It's also worth asking which ones are
interesting, from the data's viewpoint.

# Methods

I'll use the Medicare 2011 data with normal filters (age 65 or above, only beneficiaries on Medicare for 12 months of the year). I'll run separate analyses on those under 65.

For each chronic condition, I did a Poisson regression of the number of claims for a beneficiary against the beneficiary's age and their status for that condition. I hoped that including age in the regression would prevent a confounding between age, conditions, and consumption.

To report the results of the regression, I show the "percent increase" due to a variable in the regression. A Poisson regression estimates that
$E(Y|x) = \exp(\alpha + \beta x)$. Let $\beta_i$ be the term for the boolean variable $x_i$ of interest. Then the expected increase in consumption
due to that $x_i$ being true is $\exp(\beta_i)$.

# Results

```{r global_options, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, 
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE)
library(psych)
library(gplots)
library(broom)
library(glmnet)
require(doMC)
library(stringr)
```

```{r load_data}
bene = read_tsv('../bene_2011.tsv') %>%
  filter(hmo_months==0) %>%
  #filter(age >= 65) %>%
  mutate(is_female=sex=='female', is_white=race=='white') %>%
  select(bene_id, age, is_female, is_white, state)
chronic_conditions = read_tsv('cc_2011.tsv') %>%
  rename(bene_id=BENE_ID) %>%
  select(-STRCTFLG) %>%
  mutate_at(vars(AMI:HYPOTH), function(x) x==3)
pde = read_tsv('../pde_2011.tsv') %>%
  count(bene_id) %>% rename(n_claims=n)

census_regions = read_tsv('../../db/census-regions/census-regions.tsv') %>% 
  select(state, region)

usage = bene %>%
  filter(age >= 65) %>%
  left_join(census_regions, by='state') %>%
  left_join(chronic_conditions, by='bene_id') %>%
  left_join(pde, by='bene_id') %>%
  replace_na(list(n_claims=0))

condition_names = read_tsv('names.txt', col_names=c('condition', 'condition_name'))
```

```{r compute_correlations}
tetra = chronic_conditions %>%
  select(-bene_id) %>%
  tetrachoric()
```

```{r univariate_models}
conditions = c("AMI", "ALZH", "ALZHDMTA", "ATRIALFB", "CATARACT", "CHRNKIDN", "COPD", "CHF", "DIABETES", "GLAUCOMA", "HIPFRAC", "ISCHMCHT", "DEPRESSN", "OSTEOPRS", "RA_OA", "STRKETIA", "CNCRBRST", "CNCRCLRC", "CNCRPRST", "CNCRLUNG", "CNCRENDM", "ANEMIA", "ASTHMA", "HYPERL", "HYPERP", "HYPERT", "HYPOTH")

summarize_condition = function(x, condition) {
  rename_(x, .dots=setNames(condition, 'has_condition')) %>%
    glm(n_claims ~ age + is_female + has_condition, family='poisson', data=.) %>%
    tidy %>%
    mutate(condition=condition)
}

res = lapply(conditions, function(cond) summarize_condition(usage, cond)) %>%
  bind_rows() %>%
  left_join(condition_names, by='condition') %>%
  select(-condition) %>%
  rename(condition=condition_name)
```

```{r multivariate_poisson}
multivariate_formula = paste(c('n_claims ~ age + is_female', conditions), collapse=' + ') %>% formula

multivariate_res = usage %>%
  select(n_claims, age, is_female, AMI:HYPOTH) %>%
  glm(multivariate_formula, data=., family='poisson') %>%
  broom::tidy()
```

```{r multivariate_negbin}
multivariate_negbin_res = usage %>%
  MASS::glm.nb(multivariate_formula, data=.) %>%
  broom::tidy()
```

```{r lasso_poisson}
registerDoMC(cores=3)

lasso_x = usage %>%
  select(age, is_female, AMI:HYPOTH) %>%
  as.matrix
lasso_y = usage$n_claims

lasso_cv = cv.glmnet(lasso_x, lasso_y, parallel=TRUE, family='poisson')
```

## Correlations

Presumably many of the conditions are correlated. I computed tetrachoric correlations, which is a method designed to deal with correlations of dichotomous variables.

```{r, cache=FALSE}
tetra$rho %>% heatmap
```

Thankfully, Alzheimer's correlates strongly with Alzheimer's and dementia, and prostatic hyperplasia and prostate cancer correlate strongly negatively with breast cancer and endometrial cancer. Unfortunately, the negative correlations make everything else harder to see, so here's the same thing but without the male conditions. I also leave out Alzheimer's and dementia, because it's extremely well-correlated with Alzheimer's and leads to some confusing setup.

```{r fig.width=7, fig.height=7, cache=FALSE}
(!(rownames(tetra$rho) %in% c('CNCRPRST', 'HYPERP', 'ALZHDMTA'))) %>%
  { tetra$rho[., .] } %>%
  heatmap.2(trace='none')
```

COPD correlates strongly with asthma and lung cancer, but lung cancer and asthma do not correlate strongly with one another. There is a block of correlations focused around hypertension that includes ischemic heart disease, heart failure, anemia, chronic kidney disease, diabetes, hypertension, hyperlipidemia, and, importantly, COPD.

### MCC correlations

```{r mcc}
mcc = function(true, pred) {
  ut = true - mean(true)
  up = pred - mean(pred)
  
  co = mean(ut * up)
  vt = mean(ut ** 2)
  vp = mean(up ** 2)
  
  if (vt * vp == 0) {
    NA
  } else {
    co / sqrt(vt * vp)
  }
}

mcc_cor = function(x) {
  x = as.matrix(x)
  labels = colnames(x)
  n = length(labels)
  out = matrix(nrow=n, ncol=n, dimnames=list(labels, labels))
  
  for (i in 1:n) out[i, i] = 1.0
  
  for (i in 1:(n-1)) {
    ui = x[,i] - mean(x[,i])
    vi = mean(ui ** 2)
    for (j in (i+1):n) {
      uj = x[,j] - mean(x[,j])
      vj = mean(uj ** 2)
      co = mean(ui * uj)
      val = co / sqrt(vi * vj)
      out[i, j] = val
      out[j, i] = val
    }
  }
  out
}
  
mccs = chronic_conditions %>%
  select(-bene_id) %>%
  mcc_cor
```

Here is a heatmap using the square roots of the Matthews correlation coefficients. (I used square roots because it emphasizes that there are two clusters. Using just raw values is not as nice to look at.) Interestingly, all the correlations are positive.

```{r fig.width=7, fig.height=7, cache=FALSE}
(!(rownames(mccs) %in% c('CNCRPRST', 'HYPERP', 'ALZHDMTA'))) %>%
  { mccs[., .] } %>%
  sqrt %>%
  gplots::heatmap.2(trace='none', symm=TRUE)
```

## Regression

### Univariate

First, I performed univariate regressions. In each case, the explanatory variable was the presence of the chronic condition.

Almost all the conditions are significantly associated with greater consumption. Here I show the results of the Poisson regression: the column `estimate` is the estimate for the parameters associated with each condition, and `p.value` measures whether the data are consistent with that parameter being zero. The column `pct.increase` shows that percent increase in number of claims derived from that estimate.

```{r show_poisson, cache=FALSE}
res %>%
  filter(term=='has_conditionTRUE') %>%
  mutate(pct.increase=round((exp(estimate)-1.0)*100)) %>%
  select(condition, pct.increase, estimate, p.value) %>%
  arrange(desc(estimate)) %>%
  kable
```

As a verification, I'll look at the distribution of number of claims among patients who have COPD or not. The mean for patients with COPD is more than double than that for patients without, which makes the age-adjusted 2.23 fold increase seem reasonable.

```{r copd}
usage %>%
  group_by(COPD) %>%
  do(summary(.$n_claims) %>% tidy) %>%
  kable
```

### Multivariate

```{r show_multivariate, cache=FALSE}
# Here I need to do some fancy footwork to get the condition names in
# The terms look like (Intercept), age, is_female, AMITRUE, COPDTRUE, etc.
# So chop off TRUE where it is, then match with the known names, and
# keep the (Intercept), etc. if it didn't match
multivariate_res %>%
  mutate(pct.increase=round((exp(estimate)-1.0)*100)) %>%
  mutate(condition=str_replace(term, 'TRUE$', '')) %>%
  left_join(condition_names, by='condition') %>%
  mutate(term=if_else(is.na(condition_name), condition, condition_name)) %>%
  select(term, pct.increase, estimate, p.value) %>%
  arrange(desc(abs(estimate))) %>%
  kable
```

#### Comparison to negative binomial

The negative binomial model gave almost exactly the same results. Here I show a plot comparing the coefficients estimates the two models. The one point that's deviated from the line is the intercept, which isn't comparable between the two models anyhow. Notably, the Poisson model appears to slightly underestimates the coefficients.

```{r compare_poisson_negbin}
bind_rows(mutate(multivariate_res, method='Poisson'),
          mutate(multivariate_negbin_res, method='negbin')) %>%
  mutate(condition=str_replace(term, 'TRUE$', '')) %>%
  left_join(condition_names, by='condition') %>%
  mutate(term=if_else(is.na(condition_name), condition, condition_name)) %>%
  select(term, method, estimate) %>%
  spread(method, estimate) %>%
  ggplot(aes(x=Poisson, y=negbin)) +
  geom_point() +
  geom_abline() +
  xlim(-0.2, 0.6) +
  xlab('Poisson multivariate model coefficient') + ylab('negative binomial multivariate model coefficient') +
  theme_minimal()
```

### Multivariate lasso

I also performed a multivariate lasso regression with the Poisson model, keeping all the chronic conditions as well as age and sex (coded as "is female") as explanatory variables.
I started with 10-fold cross-validation to pick the lasso $\lambda$.

```{r cache=FALSE}
plot(lasso_cv)
```

Although the error continues to fall with decreasing $\lambda$, it seems like there are diminishing returns after the first 8 or 10 variables are included.

```{r cache=FALSE}
lasso_df = lasso_cv$glmnet.fit %>%
  tidy %>%
  filter(estimate > 0) %>%
  group_by(step) %>%
  summarize(df=n() - 1)

lasso_cv$glmnet.fit %>%
  tidy %>%
  select(step, lambda, dev.ratio) %>%
  distinct() %>%
  left_join(lasso_df, by='step') %>%
  select(step, df, lambda) %>%
  mutate_at(vars(lambda), function(x) signif(x, digits=2)) %>%
  filter(df < 12) %>%
  kable
```

It looks like this corresponds to $\lambda \sim 0.1$. For that value, the coefficients are:

```{r cache=FALSE}
lasso_cv %>%
  coef(s=0.1) %>%
  tidy %>%
  select(condition=row, coefficient=value) %>%
  left_join(condition_names, by='condition') %>%
  mutate(term=if_else(is.na(condition_name), condition, condition_name)) %>%
  select(term, coefficient) %>%
  arrange(desc(coefficient)) %>%
  kable
```

### Including region and race

I wanted to know if there was a confound with region or race: is it the case that, say, people of one race are consuming more antibiotics and also just happen to have more chronic conditions?

```{r region_race}
usage %>%
  filter(age >= 65) %>%
  mutate(region=factor(region, levels=c('Northeast', 'West', 'Midwest', 'South'))) %>%
  glm(n_claims ~ age + is_female + is_white + region + COPD, family='poisson', data=.) %>%
  broom::tidy() %>%
  kable
```

This model treats the Northeast as the baseline region; all other regions have higher consumption. Notably, the effect of going to the south is about the same as being white (vs. any other race) or being female (vs. male).

### Including young people

I'm making the claim that chronic conditions explain consumption among the elderly. Maybe the effect of age among the elderly is weak, and we would see an effect if we included some younger people. I therefore tried keeping all the beneficiaries to see what would happen.

```{r young_people}
# remake the usage with young people
bene %>%
  left_join(chronic_conditions, by='bene_id') %>%
  left_join(pde, by='bene_id') %>%
  replace_na(list(n_claims=0)) %>%
  glm(n_claims ~ age + is_female + is_white + COPD, family='poisson', data=.) %>%
  broom::tidy() %>%
  kable
```

## On all years

It seems like the multivariate model is the easiest one to understand and interpret. I therefore ran this one analysis on all the years.

```{r}
year_model = function(y) {
  bene_fn = sprintf('../bene_%i.tsv', y)
  pde_fn = sprintf('../pde_%i.tsv', y)
  cc_fn = sprintf('../../data/cc_%i.tsv', y)

  bene = read_tsv(bene_fn) %>%
    filter(hmo_months==0, age >= 65) %>%
    mutate(is_female=sex=='female', is_white=race=='white') %>%
    select(bene_id, age, is_female, is_white, state)
  chronic_conditions = read_tsv(cc_fn) %>%
    rename(bene_id=BENE_ID) %>%
    select(-STRCTFLG) %>%
    mutate_at(vars(AMI:HYPOTH), function(x) x==3)
  pde = read_tsv(pde_fn) %>%
    count(bene_id) %>% rename(n_claims=n)

  usage = bene %>%
    left_join(census_regions, by='state') %>%
    left_join(chronic_conditions, by='bene_id') %>%
    left_join(pde, by='bene_id') %>%
    replace_na(list(n_claims=0))

  multivariate_res = usage %>%
    glm(multivariate_formula, data=., family='poisson') %>%
    broom::tidy() %>%
    mutate(label=y)
  
  multivariate_res
}

yearly_models = lapply(2011:2014, year_model) %>%
  bind_rows
```

```{r}
#yearly_models %>%
#  select(term, label, estimate) %>%
#  spread(label, estimate) %>%
#  arrange(desc(`2011`)) %>%
#  kable
```

```{r}
term_levels = yearly_models %>%
  filter(label==2011) %>%
  arrange(desc(estimate)) %$%
  rev(term)

yearly_models %>%
  mutate(term=factor(term, levels=term_levels, ordered=TRUE)) %>%
  ggplot(aes(x=term, y=estimate, color=factor(label))) +
  geom_point() +
  coord_flip() +
  theme_minimal()
```

# Discussion

Not surprisingly, COPD tops the list of chronic conditions associated with increased consumption. Interestingly, asthma does provide explanatory power beyond COPD, coming in second. Depression and anemia are next. Kidney disease has a middling effect, while age and diabetes have almost no effect!

The lasso results seem to be the nicest: they sum up the major findings very well but seem to avoid some of the weird noise (e.g., enlarged prostate as the #2 coefficient in the multivariate Poisson model, lung cancer as the #3 coefficient in the univariate models).