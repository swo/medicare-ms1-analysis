---
title: "What chronic conditions are associated with increased antibiotic consumption?"
author: "Scott Olesen"
date: "2/27/2017"
output: html_document
---

# Background

Just summing up the chronic conditions doesn't seem like a very elegant way to
summarize people's health. Choosing which chronic conditions to consider could
be a matter of expert opinion. It's also worth asking which ones are
interesting, from the data's viewpoint.

# Methods

I'll use the Medicare 2011 data.

For each chronic condition, I did a Poisson regression of the number of claims for a beneficiary against the beneficiary's age and their status for that condition. I hoped that including age in the regression would prevent a confounding between age, conditions, and consumption.

To report the results of the regression, I show the "percent increase" due to a variable in the regression. A Poisson regression estimates that
$E(Y|x) = \exp(\alpha + \beta x)$. Let $\beta_i$ be the term for the boolean variable $x_i$ of interest. Then the expected increase in consumption
due to that $x_i$ being true is $\exp(\beta_i)$.

# Results

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, 
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE)
```

```{r load_data}
usage = read_tsv('../bene_usage_2011.tsv')
chronic_conditions = read_tsv('cc_2011.tsv') %>%
  rename(bene_id=BENE_ID) %>%
  select(-STRCTFLG)
condition_names = read_tsv('names.txt', col_names=c('condition', 'condition_name'))
```

```{r summarize_users}
usage_summary = usage %>%
  filter(age >= 65) %>%
  group_by(bene_id) %>%
  summarize(n_claims=sum(n_claims), age=max(age)) %>%
  left_join(chronic_conditions, by='bene_id')
```

```{r compute_models}
conditions = c("AMI", "ALZH", "ALZHDMTA", "ATRIALFB", "CATARACT", "CHRNKIDN", "COPD", "CHF", "DIABETES", "GLAUCOMA", "HIPFRAC", "ISCHMCHT", "DEPRESSN", "OSTEOPRS", "RA_OA", "STRKETIA", "CNCRBRST", "CNCRCLRC", "CNCRPRST", "CNCRLUNG", "CNCRENDM", "ANEMIA", "ASTHMA", "HYPERL", "HYPERP", "HYPERT", "HYPOTH")

library(broom)
summarize_condition = function(x, condition) {
  has_condition = x[[condition]] == 3
  
  x %>%
    glm(n_claims ~ has_condition + age, family='poisson', data=.) %>%
    tidy %>%
    mutate(condition=condition)
}

res = lapply(conditions, function(cond) summarize_condition(usage_summary, cond)) %>%
  bind_rows() %>%
  left_join(condition_names, by='condition') %>%
  select(-condition) %>%
  rename(condition=condition_name)
```

Almost all the conditions are significantly associated with greater consumption. Here I show the results of the Poisson regression: the column `estimate` is the estimate for the parameters associated with each condition, and `p.value` measures whether the data are consistent with that parameter being zero. The column `pct.increase` shows that percent increase in number of claims derived from that estimate.

```{r show_poisson}
res %>%
  filter(term=='has_conditionTRUE') %>%
  mutate(pct.increase=round((exp(estimate)-1.0)*100)) %>%
  select(condition, pct.increase, estimate, p.value) %>%
  arrange(desc(estimate)) %>%
  kable
```