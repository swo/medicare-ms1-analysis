---
title: "Chronic conditions and increased antibiotic consumption"
author: "Scott Olesen"
date: "2/27/2017"
output: html_document
---

# Background

Just summing up the chronic conditions doesn't seem like a very elegant way to
summarize people's health. Choosing which chronic conditions to consider could
be a matter of expert opinion. It's also worth asking which ones are
interesting, from the data's viewpoint.

# Methods

I'll use the Medicare 2011 data with normal filters (age 65 or above, only beneficiaries on Medicare for 12 months of the year).

For each chronic condition, I did a Poisson regression of the number of claims for a beneficiary against the beneficiary's age and their status for that condition. I hoped that including age in the regression would prevent a confounding between age, conditions, and consumption.

To report the results of the regression, I show the "percent increase" due to a variable in the regression. A Poisson regression estimates that
$E(Y|x) = \exp(\alpha + \beta x)$. Let $\beta_i$ be the term for the boolean variable $x_i$ of interest. Then the expected increase in consumption
due to that $x_i$ being true is $\exp(\beta_i)$.

# Results

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, 
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE)
library(psych)
library(gplots)
```

```{r load_data}
usage = read_tsv('../bene_usage_2011.tsv')
chronic_conditions = read_tsv('cc_2011.tsv') %>%
  rename(bene_id=BENE_ID) %>%
  select(-STRCTFLG) %>%
  mutate_at(vars(AMI:HYPOTH), function(x) x==3)
condition_names = read_tsv('names.txt', col_names=c('condition', 'condition_name'))
```

```{r summarize_users}
denom = usage %>% select(bene_id, age, sex) %>% distinct

usage_summary = usage %>%
  filter(age >= 65) %>%
  group_by(bene_id) %>%
  summarize(n_claims=sum(n_claims)) %>%
  left_join(denom, by='bene_id') %>%
  mutate(is_female=sex=='female') %>% select(-sex) %>%
  left_join(chronic_conditions, by='bene_id')
```

```{r compute_correlations}
tetra = chronic_conditions %>%
  select(-bene_id) %>%
  tetrachoric()
```

```{r univariate_models}
conditions = c("AMI", "ALZH", "ALZHDMTA", "ATRIALFB", "CATARACT", "CHRNKIDN", "COPD", "CHF", "DIABETES", "GLAUCOMA", "HIPFRAC", "ISCHMCHT", "DEPRESSN", "OSTEOPRS", "RA_OA", "STRKETIA", "CNCRBRST", "CNCRCLRC", "CNCRPRST", "CNCRLUNG", "CNCRENDM", "ANEMIA", "ASTHMA", "HYPERL", "HYPERP", "HYPERT", "HYPOTH")

library(broom)
summarize_condition = function(x, condition) {
  univariate_formula = paste0('n_claims ~ age + is_female + ', condition) %>%
    formula
  
  x %>%
    glm(univariate_formula, family='poisson', data=.) %>%
    tidy %>%
    mutate(condition=condition)
}

res = lapply(conditions, function(cond) summarize_condition(usage_summary, cond)) %>%
  bind_rows() %>%
  left_join(condition_names, by='condition') %>%
  select(-condition) %>%
  rename(condition=condition_name)
```

```{r lasso}
library(glmnet)
require(doMC)
registerDoMC(cores=3)

lasso_x = usage_summary %>%
  select(age, is_female, AMI:HYPOTH) %>%
  as.matrix
lasso_y = usage_summary$n_claims

lasso_cv = cv.glmnet(lasso_x, lasso_y, parallel=TRUE, family='poisson')
#lasso_model = glmnet(lasso_x, lasso_y, family='poisson')
```

```{r multivariate_linear_model}
multivariate_formula = paste(c('n_claims ~ age + is_female', conditions), collapse=' + ') %>%
  formula

multivariate_linear_res = usage_summary %>%
  lm(multivariate_formula, data=.) %>%
  tidy

# For multivariate Poisson:
# glm(multivariate_formula, family='poisson', data=.)
```

## Summary

`r usage_summary %>% kable`

## Correlations

Presumably many of the conditions are correlated. I computed tetrachoric correlations, which is a method designed to deal with correlations of dichotomous variables.

```{r, cache=FALSE}
tetra$rho %>% heatmap
```

Thankfully, Alzheimer's correlates strongly with Alzheimer's and dementia, and prostatic hyperplasia and prostate cancer correlate strongly negatively with breast cancer and endometrial cancer. Unfortunately, the negative correlations make everything else harder to see, so here's the same thing but without the male conditions.

```{r fig.width=7, fig.height=7, cache=FALSE}
(!(rownames(tetra$rho) %in% c('CNCRPRST', 'HYPERP'))) %>%
  { tetra$rho[., .] } %>%
  heatmap.2(trace='none')
```

COPD correlates strongly with asthma and lung cancer, but lung cancer and asthma do not correlate strongly with one another. There is a block of correlations focused around hypertension that includes ischemic heart disease, heart failure, anemia, chronic kidney disease, diabetes, hypertension, hyperlipidemia, and, importantly, COPD.

## Regression

### Univariate

First, I performed univariate regressions. In each case, the explanatory variable was the presence of the chronic condition.

Almost all the conditions are significantly associated with greater consumption. Here I show the results of the Poisson regression: the column `estimate` is the estimate for the parameters associated with each condition, and `p.value` measures whether the data are consistent with that parameter being zero. The column `pct.increase` shows that percent increase in number of claims derived from that estimate.

```{r show_poisson, cache=FALSE}
res %>%
  filter(term=='has_conditionTRUE') %>%
  mutate(pct.increase=round((exp(estimate)-1.0)*100)) %>%
  select(condition, pct.increase, estimate, p.value) %>%
  arrange(desc(estimate)) %>%
  kable
```

As a verification, I'll look at the distribution of number of claims among patients who have COPD or not. The mean for patients with COPD is more than double than that for patients without, which makes the age-adjusted 2.23 fold increase seem reasonable.

```{r copd}
usage_summary %>%
  mutate(has_copd=COPD==3) %>%
  group_by(has_copd) %>%
  do(summary(.$n_claims) %>% tidy) %>%
  kable
```

### Multivariate linear model

I also performed multivariate regressions, keeping all the chronic conditions as well as age and sex (coded as "is female") as explanatory variables.

I don't expect a linear model to work well, since the output is count data, but doing a Poisson regression took a really long time.

Not surprisingly, COPD tops the list. However, asthma does provide explanatory power beyond COPD, coming in second. (Lung cancer, however, now has a negative effect on consumption.) Strangely, depression and anemia are next. Age, kindney disease, and diabetes have coefficients very near zero!

```{r cache=FALSE}
multivariate_linear_res %>%
  mutate(pct.increase=round((exp(estimate)-1.0)*100)) %>%
  arrange(desc(pct.increase)) %>%
  kable
```

### Lasso

I also performed a lasso regression with the Poisson model. I started with 10-fold cross-validation to pick the $\lambda$.

```{r cache=FALSE}
plot(lasso_cv)
```

Although the error continues to fall with decreasing $\lambda$, it seems like there are diminishing returns after the first 8 or 10 variables are included.

```{r cache=FALSE}
lasso_df = lasso_cv$glmnet.fit %>%
  tidy %>%
  filter(estimate > 0) %>%
  group_by(step) %>%
  summarize(df=n() - 1)

lasso_cv$glmnet.fit %>%
  tidy %>%
  select(step, lambda, dev.ratio) %>%
  distinct() %>%
  left_join(lasso_df, by='step') %>%
  select(step, df, lambda) %>%
  mutate_at(vars(lambda), function(x) signif(x, digits=2)) %>%
  kable
```

It looks like this corresponds to $\lambda \sim 0.1$. For that value, the coefficients are:

```{r cache=FALSE}
lasso_cv %>%
  coef(s=0.1) %>%
  tidy %>%
  select(term=row, coefficient=value) %>%
  kable
```