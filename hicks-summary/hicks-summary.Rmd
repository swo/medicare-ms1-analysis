---
title: "Summary of antibiotic consumption"
author: "Scott Olesen"
date: "2/13/2017"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='fig/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r setup}
library(assertive)

# Group values in x into ranges determined by upper_limits.
# Values below the lowest limit are named as the lowest limit, and so forth.
# You should probably put Inf as the last limit.
bounds_group = function(x, upper_limits) {
  levels = lapply(seq(from=1, to=length(upper_limits)), function(i) {
    if (i == 1) {
      sprintf('< %.1f', upper_limits[i])
    } else {
      sprintf('>= %.1f and < %.1f', upper_limits[i - 1], upper_limits[i])
    }
  })
  formula_list = mapply(function(str, lim) as.formula(sprintf('x < %.1f ~ "%s"', lim, str)),
                        levels, upper_limits)
  do.call(case_when, formula_list) %>%
    factor(levels=levels, ordered=TRUE)
}

summarize_by = function(usage, bene, by) {
  denom = group_by_(bene, by) %>%
    summarize(n_ppl=n())
  
  group_by_(usage, by) %>%
    summarize(n_claims=n()) %>%
    left_join(denom, by=by) %>%
    mutate(cpkp=n_claims*1000/n_ppl) %>%
    select_(by, 'cpkp')
}
```

```{r load_db}

regions = read_tsv('../../db/census-regions/census-regions.tsv') %>%
  select(state, region)

antibiotic_class = read_tsv('../abx_class.tsv') %>%
  select(antibiotic, antibiotic_class) %>%
  distinct

assert_has_no_duplicates(antibiotic_class$antibiotic)
```

```{r analyze_data, cache=TRUE}
analyze = function(this_year) {
  bene = read_tsv(sprintf('../bene_%i.tsv', this_year)) %>%
    mutate_at(vars(age, plan_coverage_months), as.integer) %>%
    filter(!is.na(state), plan_coverage_months == 12, age >= 65) %>%
    left_join(regions, by='state')
  
  assert_has_no_duplicates(bene$bene_id)
  total_n_bene = nrow(bene)
  
  pde = read_tsv(sprintf('../pde_%i.tsv', this_year)) %>%
    mutate_at(vars(days_supply), as.integer) %>%
    left_join(antibiotic_class, by='antibiotic')
  
  usage = pde %>%
    inner_join(bene, by='bene_id') # inner join to keep only matching rows
  
  # usage only has PDEs from beneficiaries in our list,
  # so there should be fewer
  is_greater_than_or_equal_to(nrow(pde), nrow(usage))

  # claims per 1,000 people by abx class
  claims_by_class = usage %>%
    group_by(antibiotic_class) %>%
    summarize(n_claims=n()) %>%
    mutate(cpkp=n_claims*1000/total_n_bene) %>%
    select(antibiotic_class, cpkp) %>%
    mutate(year=this_year)

  # the top few inidividual antibiotics
  top_abx = usage %>%
    group_by(antibiotic) %>%
    summarize(n_claims=n()) %>%
    mutate(cpkp=n_claims*1000/total_n_bene) %>%
    select(antibiotic, cpkp) %>% 
    mutate(year=this_year)

  # from here on, the denominators are taken from the beneficiary data grouped
  # in the same way as the consumption data, so we can use the summarize_by function
  claims_by_sex = summarize_by(usage, bene, 'sex') %>%
    mutate(year=this_year)

  # then by age group
  # (the input to summarize_by is modified, since we want to group by age *group*,
  # not just by raw age)
  age_group_f = function(x) bounds_group(x, c(65, 75, 85, Inf))
  claims_by_age = summarize_by(
    usage %>% mutate(age_group=age_group_f(age)),
    bene %>% mutate(age_group=age_group_f(age)),
    'age_group') %>%
    mutate(year=this_year)

  # then by census region
  claims_by_region = summarize_by(usage, bene, 'region') %>%
    mutate(year=this_year)

  # claims by state (broken into sextiles)
  claims_by_state = summarize_by(usage, bene, 'state') %>%
    mutate(sextile=ntile(cpkp, 6), year=this_year)

  list(claims_by_class=claims_by_class,
       top_abx=top_abx,
       claims_by_sex=claims_by_sex,
       claims_by_age=claims_by_age,
       claims_by_region=claims_by_region,
       claims_by_state=claims_by_state)
}

data_2011 = analyze(2011)
data_2012 = analyze(2012)
data_2013 = analyze(2013)
data_2014 = analyze(2014)
```

```{r arrange_data}
library(knitr)
data = list("2011"=data_2011,
            "2012"=data_2012,
            "2013"=data_2013,
            "2014"=data_2014)

data_by_field = function(field) lapply(data, function(x) x[[field]]) %>% bind_rows()

claims_by_class = data_by_field('claims_by_class')

top_classes = claims_by_class %>%
  filter(year==2011) %>%
  arrange(desc(cpkp)) %>%
  head(9) %$%
  antibiotic_class %>%
  c('other')

claims_by_class %<>%
  mutate(antibiotic_class=if_else(antibiotic_class %in% top_classes,
                                  antibiotic_class,
                                  'other')) %>%
  group_by(year, antibiotic_class) %>%
  summarize(cpkp=sum(cpkp)) %>%
  spread(year, cpkp) %>%
  mutate(antibiotic_class=factor(antibiotic_class, levels=top_classes, ordered=TRUE)) %>%
  arrange(antibiotic_class) %>%
  kable

top_abx = data_by_field('top_abx') %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>%
  head(11) %>%
  kable

claims_by_sex = data_by_field('claims_by_sex') %>%
  filter(sex %in% c('male', 'female')) %>%
  spread(year, cpkp) %>%
  kable

claims_by_age = data_by_field('claims_by_age') %>%
  filter(!is.na(age_group)) %>%
  spread(year, cpkp) %>%
  kable

claims_by_region = data_by_field('claims_by_region') %>%
  filter(!is.na(region)) %>%
  spread(year, cpkp) %>%
  arrange(desc(`2011`)) %>%
  kable

state_sextiles_2011 = data_by_field('claims_by_state') %>%
  filter(!is.na(state), state != 'NA', year==2011) %>%
  select(sextile, state) %>%
  arrange(desc(sextile), state)
```

This summary is modeled after @hicks-us-2015. That study, which used the IMS Health Xponent database to infer the number of prescriptions per capita, reported higher prescription rates than what we observe here. In that paper, the number of prescriptions per 1,000 people year (PKPY) is approximately 1,000 for people over 65. In this data, we find that number to be between 600 (in 2011) and 750 (in 2012). Our value is more similar to a report that used the National Ambulatory Care Survey (NAMCS) and National Hospital Ambulatory Care Survey (NHAMCS) rather than the Xponent data. That report estimated about 500 PKPY [@flemingdutra-prevalence-2016]. A third report, which used the Xponent database, reported that prescriptions fell from about 1,000 PKPY in 1996 to about 600 PKPY in 2003 [@hicks-outpatient-2011].

# Antibiotic consumption by class

Our data for antibiotic class roughly correspond to those reported in @hicks-us-2015, when allowing for the fact that their results have about 40% higher consumption overall. The striking difference is a in consumption of quinolones: in our 2011 data, quinolones are the most-prescribed class and account for 127 PKPY. In their data, quinolones are the fourth-most-prescribed class and account for 89 PKPY (adjusted to approximately $90 \times 0.6 = 54$).

Across years, the consumption of drugs seems to follow similar patterns (excepting that consumption in 2012 was about 20% higher than in 2011 and consumption in 2013-2014 was about 10% higher).

All consumption rates are reported as PKPY.

`r claims_by_class`

# Most-prescribed antibiotics

Our data for the most prescribed individual antibiotics also generally accords with @hicks-us-2015 (again, allowing for the 40% discrepancy). The major difference is that ciprofloxacin consumption is greater in our data and amoxicillin (and augmentin) consumption are greater in their data. The reduced consumption of amoxicillin in our data could be explained by the fact that our population is older.

Allowing for the overall differences in consumption, consumption of azithromycin appears to have declined during 2011 to 2014, while the consumption of levofloxacin increased.

`r top_abx`

# Consumption by sex

Our result, that the consumption of antibiotics by women and men is in a 3:2 ratio, agrees with the result in @hicks-us-2015. The ratio also remained steady across years in our dataset.

`r claims_by_sex`

# Consumption by region

In @hicks-us-2015, stratifying consumption in 2011 by census region led to one major divide: the South, West, and Northeast consumed more antibiotics than the West (931, 897, and 848 vs. 647 PKPY). In our results, the major divide is between the South and the Midwest, West, and Northeast (641 vs. 583, 563, and 533 PKPY).

In our data, 2012 appears exceptional: consumption in the Midwest and West was relatively high, and consumption in the Northeast was relatively low. Results from 2013 and 2014 accord more closely with the results from @hicks-us-2015, in which the West is the region with the lowest consumption.

`r claims_by_region`

# Consumption by age

When stratifying by age, @hicks-us-2015 places all people 65 or older into one stratum. Here I stratify within this population. Excepting the beneficiaries under 65, older beneficiaries tend to consume more antibiotics. The beneficiaries under 65 qualify for Medicare because they are disabled, have end stage renal disease, or ALS, which might contribute to their increased consumption of antibiotics. However, this trend across age groups does not hold in 2012.

`r claims_by_age`

```{r}
# In Hicks, they also do:
# logistic regression on...
# dependent: county in top quartile for prescription rate
# independent:
#  - prescribers per capita above median,
#  - proportion of people obese above median,
#  - proportion of people <2 years old above median,
#  - proportion of people black above median,
#  - per capita income in top 2/3s,
#  - proportion with college education in top 2/3s,
#  - proportion female in top 3/4s
#
# Univariate regressions of each independent against the dependent
# Multivariate regression somehow using adjusted ratios with confounders
```
