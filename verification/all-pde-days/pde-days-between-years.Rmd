---
title: "PDEs between years"
author: "Scott Olesen"
date: "2/19/2017"
output: html_document
---

```{r load_data, message=FALSE, echo=FALSE}
library(lubridate)
library(knitr)

read_data = function(fn) {
  read_tsv(fn) %>%
    mutate(date=dmy(date)) %>%
    mutate(week_n=week(date)) %>%
    mutate(month_n=month(date))
}

read_data_year = function(y) {
  sprintf('pde_date_counts_%i.tsv', y) %>%
    read_data() %>%
    mutate(data_year=y)
}

sum_by_week = function(x) {
  data_frame(count=sum(x$count),
             date=head(x$date, 1))
}

dat = 2011:2014 %>%
  lapply(read_data_year) %>%
  bind_rows() %>%
  mutate(data_year=factor(data_year))

week_dat = dat %>%
  group_by(data_year, year(date), week(date)) %>%
  summarize(n_days=n(), count=sum(count), date=head(date, 1)) %>%
  filter(n_days == 7)
  
month_dat = dat %>%
  group_by(data_year, year(date), month(date)) %>%
  summarize(count=sum(count), date=head(date, 1))
```

I'm now concerned about the 2013-2014 data (or the 2011-2012 data). It seems like the increase in the number of PDEs between 2012 and 2013 is larger than the 2011-2012 increase or the 2013-2014 increase.

<style type="text/css">
.table {
    width: 40%;
}
</style>

```{r counts_table, echo=FALSE}
dat %>%
  group_by(data_year) %>%
  summarize(n=sum(count)) %>%
  mutate(n=round(n/1e6, 1), `diff. since prev. year`=c(0, diff(n))) %>%
  rename(`data year`=data_year, `number of PDEs (millions)`=n) %>%
  kable(align='l')
```

Looking week-by-week, I see a discontinuity between December 2012 and January 2013:

```{r plot_weeks, echo=FALSE}
week_dat %>%
  ggplot(aes(x=date, y=count, group=data_year, color=data_year)) +
  geom_line() + geom_point() +
  ylab('PDEs in that week') +
  theme_minimal()
```

I wondered if this was an artifact of the way the busy days (e.g., the first of the month and the first days after holidays tend to have a larger number of PDEs) fell into the weeks. However, I see the same pattern even grouping by month:

```{r plot_months, echo=FALSE}
month_dat %>%
  ggplot(aes(x=date, y=count, group=data_year, color=data_year)) +
  geom_line() + geom_point() +
  ylab('PDEs in that month') +
  theme_minimal()
```
