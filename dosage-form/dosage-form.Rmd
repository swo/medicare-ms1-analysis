---
title: "Dosage forms in antibiotic PDEs"
author: "Scott Olesen"
date: "2/20/2017"
output: html_document
---

```{r load_data, message=FALSE}
dat = 2011:2014 %>%
  lapply(function(y) read_tsv(sprintf('../../data/pde_%i.tsv', y)) %>%
           select(generic_name=GNN, dosage_form_code=GCDF, dosage_form_desc=GCDF_DESC) %>%
           mutate(year=y)) %>%
  bind_rows()
```

Most codes have a unique descriptions.
```{r code_desc}
filter_repeated_block = function(x) {
  if (nrow(x) == 1) {
    data_frame()
  } else {
    x
  }
}

unique_combos = dat %>%
  select(dosage_form_code, dosage_form_desc) %>%
  distinct

unique_combos %>% kable
```

There are a few exceptions:

```{r repeated_codes}
unique_combos %>%
  group_by(dosage_form_code) %>%
  do(filter_repeated_block(.)) %>%
  arrange(dosage_form_code, dosage_form_desc) %>%
  kable
```

None of these repetitions are meaningfully different from one another, so I'll
conclude that the code uniquely identifies the dosage type.

```{r codes_by_year}
canonical_codes = unique_combos %>%
  group_by(dosage_form_code) %>%
  do(head(., 1))

dat %>%
  select(dosage_form_code, year) %>%
  group_by(year) %>%
  count(dosage_form_code) %>%
  spread(year, n) %>%
  left_join(canonical_codes, by='dosage_form_code') %>%
  arrange(desc(`2011`)) %>%
  kable
```

Which ones of the codes should I keep? Let's consider, for each code, the top drugs that match that code. Of these, I should only keep some.

```{r drugs_by_code, message=FALSE}

drugs_by_code = dat %>%
  filter(year == 2011) %>%
  select(generic_name, dosage_form_code) %>%
  group_by(dosage_form_code) %>%
  count(generic_name) %>%
  group_by(dosage_form_code) %>%
  do(head(., 3))

codes_to_keep = scan('oral_injected_codes.txt', what=character())

drugs_by_code %>%
  mutate(keep_code=dosage_form_code %in% codes_to_keep) %>%
  rename(`generic names of top drugs with that code`=generic_name) %>%
  kable
```
