---
title: "ms2"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, fig.path='fig/', dev=c('png', 'pdf'),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE)
import::from(pander, pander)
import::from(broom, tidy)
```

# Consumption data

```{r load_data}
regions = read_tsv('../../db/census-regions/census-regions.tsv') %>%
  select(state, state_abbreviation, region)

hrr = read_tsv('../../db/hrr/hrr.tsv') %>%
  filter(year==2011) %>%
  select(zipcode, hrr)

all_ineq = read_tsv('data/all_drug_ineq.tsv') %>%
  left_join(regions, by='state')
state_ineq = read_tsv('data/drug_ineq.tsv')
hrr_ineq = read_tsv('data/hrr_drug_ineq.tsv')
```

## Aggregate usage correlates with fraction of users

```{r fnz-mean, cache=FALSE}
ggplot(all_ineq, aes(x=mean, y=fnz, color=region, label=state_abbreviation)) +
geom_point() +
geom_label(nudge_x=0.05) +
xlab('claims per beneficiary') +
ylab('fraction of beneficiaries w/ >= 1 claim') +
theme_minimal()
```

## Inequality among users does not correlate well

```{r nzgini-mean, cache=FALSE}
ggplot(all_ineq, aes(x=mean, y=nzgini, color=region, label=state_abbreviation)) +
geom_point() +
geom_label(nudge_x=0.05) +
xlab('claims per beneficiary') +
ylab('Gini coefficient among benes. w/ >= 1 claim') +
theme_minimal()
```

# Resistance data

```{r load_abg}
resistance_groups = read_tsv('../states/resistance/resistance_groups.tsv')

organisms = c('Escherichia coli',
              'Proteus mirabilis', 'Enterobacter cloacae',
              'Enterococcus faecium',
              'Coagulase-negative staphylococci',
              'Methicillin-resistant S. aureus (MRSA)',
              'Methicillin-susceptible S. aureus (MSSA)',
              'Streptococcus pneumoniae (non-meningitis)',
              'Staphylococcus aureus')

abg = read_tsv('../../../antibiogram/data/abg.tsv', col_types=cols(zipcode='c')) %>%
  mutate(drug=tolower(drug), percent_nonsusceptible=100-percent_susceptible) %>%
  left_join(hrr, by='zipcode') %>%
  right_join(resistance_groups, by='drug') %>%
  filter(bug %in% organisms) %>%
  select(bug, drug_group, state, hrr, percent_nonsusceptible, n_isolates)

# Keep only those bug/drug combinations that are in at least 20 states
abg %<>%
  select(bug, drug_group, state) %>%
  distinct %>%
  count(bug, drug_group) %>% rename(n_states=n) %>%
  filter(n_states >= 20) %>%
  left_join(abg, by=c('bug', 'drug_group'))

summarize_abg = function(df, place_name, min_places=20) {
    group_by_(df, 'bug', 'drug_group', place_name) %>%
    summarize(mean_percent_nonsusceptible=weighted.mean(percent_nonsusceptible, sqrt(n_isolates)),
              n_place_antibiograms=n()) %>%
    mutate(place_weight=sqrt(n_place_antibiograms))
}

state_abg = summarize_abg(abg, 'state')
hrr_abg = summarize_abg(abg, 'hrr')
```

I consider resistance among these organisms:

`r organisms %>% as.list %>% pander`

And I join the resistance drugs into classes:

`r kable(resistance_groups)`

I similarly joined the consumption drugs into similar classes.

```{r do_models}
pvalue_stars = function(x) {
  case_when(x < 0.001 ~ '***',
            x < 0.01 ~ '**',
            x < 0.05 ~ '*',
            x < 0.1 ~ 'o',
            TRUE ~ '')
}

linear_model = function(df, dependent_var, explanatory_vars) {
  f = paste0(dependent_var, ' ~ ', paste0(explanatory_vars, collapse = ' + ')) %>% formula
  lm(formula=f, weights=place_weight, data=df) %>%
    tidy %>%
    select(term, estimate, p.value)
}

spearman_model = function(df, dependent_var, explanatory_var) {
  cor.test(df[[dependent_var]], df[[explanatory_var]], method='spearman') %>%
    tidy %>%
    mutate(term=explanatory_var, method='spearman') %>%
    select(term, estimate, p.value)
}

multivariate_term = 'nzgini'
#multivariate_term = 'mean_fnz_residual'
models = function(x) {
  dep = 'mean_percent_nonsusceptible'
  # swo> "mean" is a confusing name
  bind_rows(
    linear_model(x, dep, 'mean') %>% mutate(model='univariate'),
    linear_model(x, dep, c('fnz', multivariate_term)) %>% mutate(model='multivariate'),
    spearman_model(x, dep, 'mean') %>% mutate(model='spearman')
  )
}

# swo> why do I need to redo this filtering?
results = left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  group_by(bug, drug_group) %>%
  do(models(.)) %>%
  ungroup

hrr_results = left_join(hrr_abg, hrr_ineq, by=c('hrr', 'drug_group')) %>%
  group_by(bug, drug_group) %>%
  do(models(.)) %>%
  ungroup
```

## Spearman

Significant results using Spearman correlations of mean percent nonsusceptible ~ claims per beneficiary:

```{r spearman_models, cache=FALSE}
results %>%
  filter(model=='spearman') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.adj < 0.05) %>%
  select(bug, drug_group, estimate, p.adj) %>%
  kable
```

And the same thing using HRRs:

```{r hrr_spearman_models, cache=FALSE}
hrr_results %>%
  filter(model=='spearman') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.adj < 0.05) %>%
  select(bug, drug_group, estimate, p.adj) %>%
  kable
```

## Univariate

The model here is mean percent nonsusceptible ~ claims per beneficiary. The significant results are:

```{r univariate_models, cache=FALSE}
results %>%
  filter(model=='univariate', term == 'mean') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.adj < 0.05) %>%
  select(bug, drug_group, estimate, p.adj) %>%
  kable
```

And the same thing with HRRs:

```{r hrr_univariate_models, cache=FALSE}
hrr_results %>%
  filter(model=='univariate', term == 'mean') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.adj < 0.05) %>%
  select(bug, drug_group, estimate, p.adj) %>%
  kable
```

## Multivariate

The model here is mean percent nonsusceptible ~ fraction nonzero + nonzero Gini. In some of the models, the nonzero Gini term was significant, but not after adjusting for multiple hypotheses. I show just those terms that met the unadjusted threshold:

```{r multivariate_models, cache=FALSE}
results %>%
  filter(model=='multivariate', term==multivariate_term) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.value < 0.05) %>%
  select(bug, drug_group, estimate, p.value, p.adj) %>%
  kable
```

When using the HRRs, some of the values remained significant even after correction. I show all those values that passed the unadjusted threshold (like above):

```{r hrr_multivariate_models, cache=FALSE}
hrr_results %>%
  filter(model=='multivariate', term==multivariate_term) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.value < 0.05) %>%
  select(bug, drug_group, estimate, p.value, p.adj) %>%
  kable
```

## Two metrics

It turns out that the different drugs have different relationships with the two metrics. Each point shows the consumption characteristics for a drug group in a state.

```{r nzgini_cpb_drug}
cbbPalette <- c("#000000", "#D55E00", "#CC79A7", "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2")
state_ineq %>%
  ggplot(aes(x=nzgini, y=mean, color=drug_group)) +
  geom_point() +
  xlab('nonzero Gini') + ylab('claims per beneficiary') +
  theme_minimal() +
  scale_color_manual(values=cbbPalette)
```

## Specific plots

Quinolone consumption predicts *E. coli* quinolone resistance:

```{r ecoli_quin, cache=FALSE}
left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='Escherichia coli', drug_group=='quinolone') %>%
  ggplot(aes(x=mean, y=mean_percent_nonsusceptible, color=region)) +
  geom_smooth(aes(x=mean, y=mean_percent_nonsusceptible, color=NULL), method='lm', col='black') +
  geom_point() +
  xlab('quinolone claims per beneficiary') + ylab('mean percent nonsusceptible E. coli isolates') +
  theme_minimal()
```
