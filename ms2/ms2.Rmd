---
title: "ms2"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, fig.path='fig/', dev=c('png', 'pdf'),
                      pdf.options(useDingbats=FALSE),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE)
import::from(broom, tidy)
```

# Consumption data

```{r load_data}
regions = read_tsv('../../db/census-regions/census-regions.tsv') %>%
  select(state, state_abbreviation, region)

zipcodes = read_tsv('../../db/zipcode/zipcode.tsv') %>%
  select(zipcode=zip, state)

hrr = read_tsv('../../db/hrr/hrr.tsv') %>%
  filter(year==2011) %>%
  select(zipcode, hrr) %>%
  left_join(zipcodes, by='zipcode') %>%
  left_join(regions, by='state')

target_year = 2013
all_ineq = read_tsv(sprintf('data/state_ineq_all_%i.tsv', target_year)) %>%
  left_join(regions, by='state')
state_ineq = read_tsv(sprintf('data/state_ineq_%i.tsv', target_year))
hrr_ineq = read_tsv(sprintf('data/hrr_ineq_%i.tsv', target_year))
```

## Aggregate usage correlates with fraction of users

```{r fnz_mean, cache=FALSE}
ggplot(all_ineq, aes(x=mean, y=fnz, color=region, label=state_abbreviation)) +
geom_point() +
geom_text(nudge_x=0.04) +
xlab('claims per beneficiary') +
ylab('fraction of beneficiaries w/ >= 1 claim') +
theme_minimal()
```

## Inequality among users does not correlate well

```{r nzgini_mean, cache=FALSE}
ggplot(all_ineq, aes(x=mean, y=nzgini, color=region, label=state_abbreviation)) +
geom_point() +
geom_text(nudge_x=0.04) +
xlab('claims per beneficiary') +
ylab('Gini coefficient') +
theme_minimal()
```

# Resistance data

```{r load_abg}
resistance_groups = read_tsv('resistance_groups.tsv')
bug_names = read_tsv('bug_names.tsv')

abg = read_tsv('../../../antibiogram/data/abg.tsv', col_types=cols(zipcode='c')) %>%
  mutate(drug=tolower(drug), percent_nonsusceptible=100-percent_susceptible) %>%
  left_join(hrr, by=c('zipcode', 'state')) %>%
  right_join(resistance_groups, by='drug') %>%
  select(bug, drug_group, state, hrr, percent_nonsusceptible, n_isolates)

possible_bug_drug = read_tsv('bug_drug.tsv')

# Keep only bug/drug combinations that are in at least 75 HRRs
min_n_states = 35
good_combos = semi_join(abg, possible_bug_drug, by=c('bug', 'drug_group')) %>%
  select(bug, drug_group, state) %>%
  distinct %>%
  count(bug, drug_group) %>% rename(n_places=n) %>%
  filter(n_places >= min_n_states)

abg %<>% right_join(good_combos, by=c('bug', 'drug_group')) %>%
  rename(bug_long=bug) %>% left_join(bug_names, by='bug_long') %>% select(-bug_long) %>%
  filter(!is.na(percent_nonsusceptible), !is.na(n_isolates))

# check that all the short names made it in
if (any(is.na(abg$bug))) stop('missing bug names')

summarize_abg = function(df, place_name) {
    group_by_(df, 'bug', 'drug_group', place_name) %>%
    summarize(mean_percent_nonsusceptible=weighted.mean(percent_nonsusceptible, sqrt(n_isolates)),
              n_place_antibiograms=n()) %>%
    #filter(!is.na(mean_percent_nonsusceptible)) %>%
    mutate(place_weight=sqrt(n_place_antibiograms))
}

state_abg = summarize_abg(abg, 'state')
hrr_abg = summarize_abg(abg, 'hrr')
```

And I join the resistance drugs into classes:

`r kable(resistance_groups)`

I similarly joined the consumption drugs into similar classes.

I started by considering these bug/drug combinations:

`r kable(possible_bug_drug)`

Then I filtered to keep only those bug/drug combinations that were present in `r min_n_states` states. That means I'm looking at these `r nrow(good_combos)` bug/drug combinations:

`r good_combos %>% arrange(desc(n_places)) %>% kable`

```{r do_models}
linear_interval = function(model, level) {
  confint(model, level=level) %>%
    tidy %>%
    setNames(c('term', 'ci_low', 'ci_high'))
}

linear_model = function(df, dependent_var, explanatory_vars) {
  f = paste0(dependent_var, ' ~ ', paste0(explanatory_vars, collapse = ' + ')) %>% formula
  m = lm(formula=f, weights=place_weight, data=df)
  tidy(m) %>%
    select(term, estimate, p.value) %>%
    mutate(n=nrow(df)) %>%
    left_join(linear_interval(m, 0.95), by='term')
}

spearman_interval = function(df, rho_name, n_name, level) {
  mada::CIrho(df[[rho_name]], df[[n_name]], level=level) %>%
    tidy %>%
    setNames(c('rho', 'ci_low', 'ci_high')) %>%
    select(-rho)
}

spearman_model = function(df, dependent_var, explanatory_var) {
  cor.test(df[[dependent_var]], df[[explanatory_var]], method='spearman') %>%
    tidy %>%
    mutate(term=explanatory_var, method='spearman') %>%
    mutate(n=nrow(df)) %>%
    group_by(term, estimate, p.value, n) %>%
    do(spearman_interval(., 'estimate', 'n', 0.95)) %>%
    ungroup()
}

multivariate_term = 'nzgini'
models = function(x) {
  dep = 'mean_percent_nonsusceptible'
  # swo> "mean" is a confusing name
  bind_rows(
    linear_model(x, dep, 'mean') %>% mutate(model='univariate'),
    linear_model(x, dep, c('fnz', multivariate_term)) %>% mutate(model='multivariate'),
    linear_model(x, dep, multivariate_term) %>% mutate(model='uni_nzg'),
    spearman_model(x, dep, 'mean') %>% mutate(model='spearman')
  ) %>%
    mutate(n_data=nrow(x))
}

results = left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  group_by(bug, drug_group) %>%
  do(models(.)) %>%
  ungroup

hrr_results = left_join(hrr_abg, hrr_ineq, by=c('hrr', 'drug_group')) %>% 
  group_by(bug, drug_group) %>%
  do(models(.)) %>%
  ungroup
```

## Spearman

Significant results using Spearman correlations of mean percent nonsusceptible ~ claims per beneficiary:

```{r spearman_models, cache=FALSE}
results %>%
  filter(model=='spearman') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.value < 0.05) %>%
  arrange(p.adj) %>%
  select(bug, drug_group, estimate, p.value, p.adj, n) %>%
  kable
```

```{r}
interval_plot = function(df) {
  arrange(df, estimate) %>%
  mutate(bug_drug=interaction(bug, drug_group),
         bug_drug=factor(bug_drug, levels=bug_drug, ordered=TRUE)) %>% 
    ggplot(aes(x=bug_drug, y=estimate, ymin=ci_low, ymax=ci_high, color=drug_group)) +
    geom_point() +
    geom_linerange() +
    coord_flip()
}

results %>%
  filter(model=='spearman') %>%
  interval_plot()
```

```{r}
results %>%
  filter(model=='spearman') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  ggplot(aes(x=estimate, y=-log10(p.adj))) + geom_point() +
  geom_hline(yintercept=-log10(0.05), col='red')
```

And the same thing using HRRs:

```{r hrr_spearman_models}
hrr_results %>%
  filter(model=='spearman') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.value < 0.05) %>%
  arrange(p.value) %>%
  select(bug, drug_group, estimate, p.value, p.adj) %>%
  kable
```

## Univariate Gini

```{r}
filter(results, model=='uni_nzg', term=='nzgini') %>%
  arrange(p.value) %>%
  mutate(adj.p=p.adjust(p.value, method='bonferroni')) %>%
  select(bug, drug_group, estimate, p.value, adj.p, n) %>%
  kable
```

## Univariate

The model here is mean percent nonsusceptible ~ claims per beneficiary. The significant results are:

```{r univariate_models}
results %>%
  filter(model=='univariate', term == 'mean') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  #filter(p.value < 0.05) %>%
  arrange(p.value) %>%
  select(bug, drug_group, estimate, p.value, p.adj, n) %>%
  kable
```

```{r}
results %>%
  filter(model=='univariate', term=='mean') %>%
  interval_plot()
```

```{r}
results %>%
  filter(model=='univariate') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  ggplot(aes(x=estimate, y=-log10(p.adj))) + geom_point() +
  geom_hline(yintercept=-log10(0.05), col='red')
```

And the same thing with HRRs:

```{r hrr_univariate_models}
hrr_results %>%
  filter(model=='univariate', term == 'mean') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.value < 0.05) %>%
  arrange(p.value) %>%
  select(bug, drug_group, estimate, p.value, p.adj) %>%
  kable
```

## Multivariate

The model here is mean percent nonsusceptible ~ fraction nonzero + nonzero Gini. In some of the models, the nonzero Gini term was significant, but not after adjusting for multiple hypotheses. I show just those terms that met the unadjusted threshold:

```{r multivariate_models}
results %>%
  filter(model=='multivariate', term==multivariate_term) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.value < 0.05) %>%
  arrange(p.value) %>%
  select(bug, drug_group, estimate, p.value, p.adj) %>%
  kable
```

```{r}
results %>%
  filter(model=='multivariate', term==multivariate_term) %>%
  interval_plot()
```

```{r}
results %>%
  filter(model=='multivariate') %>%
  filter(term == multivariate_term) %>%
  mutate(bug_drug=interaction(bug, drug_group)) %>%
  ggplot(aes(x=p.value, y=estimate, color=drug_group)) +
  geom_point() +
  scale_color_brewer(palette='Set1')
```

And what about looking at multivariate only for ones that passed the threshold for univariate?

```{r eval=FALSE}
sig_bug_drug = results %>%
  filter(model=='univariate', term=='mean') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.adj < 0.05) %>%
  select(bug, drug_group)

results %>%
  filter(model=='multivariate', term==multivariate_term) %>%
  right_join(sig_bug_drug, by=c('bug', 'drug_group')) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  select(bug, drug_group, estimate, p.value, p.adj) %>%
  kable
```

Using HRRs, adjusting $p$ with all possibilities:

```{r}
hrr_results %>%
  filter(model=='multivariate', term==multivariate_term) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.value < 0.05) %>%
  arrange(p.value) %>%
  select(bug, drug_group, estimate, p.value, p.adj) %>%
  kable
```

And then doing multiple hypothesis correction only for those that made it through the first model:

```{r hrr_multivariate_models}
sig_bug_drug = hrr_results %>%
  filter(model=='univariate', term=='mean') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.adj < 0.05) %>%
  select(bug, drug_group)

hrr_results %>%
  filter(model=='multivariate', term==multivariate_term) %>%
  right_join(sig_bug_drug, by=c('bug', 'drug_group')) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  arrange(p.value) %>%
  select(bug, drug_group, estimate, p.value, p.adj) %>%
  kable
```

## Two metrics

It turns out that the different drugs have different relationships with the two metrics. Each point shows the consumption characteristics for a drug group in a state.

```{r nzgini_cpb_drug}
cbbPalette <- c("#000000", "#D55E00", "#CC79A7", "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2")
state_ineq %>%
  ggplot(aes(x=mean, y=nzgini, color=drug_group)) +
  geom_point() +
  ylab('Gini coefficient among users') + xlab('claims per beneficiary') +
  theme_minimal() +
  scale_color_manual(values=cbbPalette)
```

```{r}
left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  filter(bug %in% c('E. coli', 'Eb. cloacae', 'CNST', 'MSSA', 'MRSA', 'S. pneumoniae')) %>%
  ggplot(aes(x=mean, y=mean_percent_nonsusceptible, color=drug_group, shape=bug)) +
  geom_point() +
  xlab('claims per beneficiary')
```

## Specific plots

Quinolone consumption predicts *E. coli* quinolone resistance:

```{r ecoli_quin, cache=FALSE}
left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='E. coli', drug_group=='quinolone') %>%
  ggplot(aes(x=mean, y=mean_percent_nonsusceptible, color=region)) +
  geom_smooth(aes(x=mean, y=mean_percent_nonsusceptible, color=NULL), method='lm', col='black') +
  geom_point() +
  xlab('quinolone claims per beneficiary') + ylab('mean percent nonsusceptible E. coli isolates') +
  theme_minimal()

left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='E. coli', drug_group=='quinolone') %>%
  ggplot(aes(x=mean, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='black', se=FALSE) +
  geom_point() +
  geom_text() +
  xlim(0.2, 0.45) + ylim(0, 50) +
  xlab('quinolone claims per beneficiary') + ylab('mean percent nonsusceptible E. coli isolates') +
  theme_minimal()
```

## E.coli and bactrim

Bactrim resistance in *E. coli*. First, the aggregate relationship, then the relationship between "excess" resistance (the residual of resistance against aggregate consumption) against nonzero Gini.

```{r ecoli_bactrim}
ecoli_bactrim_dat = left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='E. coli', drug_group=='tmp_smx') #%>%
  #filter(!is.na(mean_percent_nonsusceptible))

ecoli_bactrim_dat %>%
  ggplot(aes(x=mean, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  geom_text() +
  scale_x_continuous(limits=c(0.08, 0.2), breaks=c(0.08, 0.1, 0.15, 0.2)) +
  ylim(10, 45) +
  xlab('TMP/SMX claims per beneficiary') + ylab('mean percent nonsusceptible E. coli isolates') +
  theme_minimal()

ecoli_bactrim_dat %>%
  { mutate(., excess_resistance=residuals(lm(mean_percent_nonsusceptible ~ mean, data=.))) } %>%
  ggplot(aes(x=nzgini, y=excess_resistance)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  scale_x_continuous(limits=c(0.25, 0.375)) +
  scale_y_continuous(limits=c(-12, 20), breaks=c(-12, 0, 10, 20)) +
  xlab('Skew towards high consumers (Gini coefficient)') +
  ylab('"Excess" E. coli resistance (see caption)') +
  theme_minimal()

ecoli_bactrim_dat %>%
  ggplot(aes(x=nzgini, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  geom_text() +
  xlab('Gini coefficient)') +
  ylab('E. coli resistance') +
  theme_minimal()
```

## Pneumococcus and macrolides

```{r}
left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='S. pneumoniae', drug_group=='macrolide') %>%
  filter(!is.na(mean_percent_nonsusceptible)) %>% 
  ggplot(aes(x=mean, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  geom_text() +
  theme_minimal()
```

## E. cloacae and quinolones

```{r}
left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='Eb. cloacae', drug_group=='quinolone') %>%
  filter(!is.na(mean_percent_nonsusceptible)) %>%
  ggplot(aes(x=mean, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  geom_text() +
  theme_minimal()
```

## MSSA and clindamycin

```{r mssa_clinda}
dat = left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='MSSA', drug_group=='clindamycin') #%>%
  #filter(!is.na(mean_percent_nonsusceptible))

dat %>%
  ggplot(aes(x=mean, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  geom_text() +
  #scale_x_continuous(limits=c(0.08, 0.2), breaks=c(0.08, 0.1, 0.15, 0.2)) +
  #ylim(10, 45) +
  xlab('clindamycin claims per beneficiary') + ylab('mean percent nonsusceptible MSSA isolates') +
  theme_minimal()

dat %>%
  { mutate(., excess_resistance=residuals(lm(mean_percent_nonsusceptible ~ mean, data=.))) } %>%
  ggplot(aes(x=nzgini, y=excess_resistance)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  #scale_x_continuous(limits=c(0.25, 0.375)) +
  #scale_y_continuous(limits=c(-12, 20), breaks=c(-12, 0, 10, 20)) +
  xlab('Gini coefficient') +
  ylab('"Excess" MSSA resistance') +
  theme_minimal()
```

## MRSA clinda

```{r}
left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='MRSA', drug_group=='clindamycin') %>%
  ggplot(aes(x=mean, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  geom_text() +
  #scale_x_continuous(limits=c(0.08, 0.2), breaks=c(0.08, 0.1, 0.15, 0.2)) +
  #ylim(10, 45) +
  xlab('clindamycin claims per beneficiary') + ylab('mean percent nonsusceptible MRSA isolates') +
  theme_minimal()
```