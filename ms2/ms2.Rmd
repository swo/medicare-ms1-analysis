---
title: "ms2"
author: "Scott Olesen"
output: html_document
---

# To do

- filter by HRRs, not states

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, fig.path='fig/', dev=c('png', 'pdf'),
                      pdf.options(useDingbats=FALSE),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE)
import::from(broom, tidy)
```

```{r load_data}
regions = read_tsv('../../db/census-regions/census-regions.tsv') %>%
  select(state, state_abbreviation, region)

zipcodes = read_tsv('../../db/zipcode/zipcode.tsv') %>%
  select(zipcode=zip, state)

# Use the zipcode-HRR mapping from 2011
hrr = read_tsv('../../db/hrr/hrr.tsv') %>%
  filter(year==2011) %>%
  select(zipcode, hrr) %>%
  left_join(zipcodes, by='zipcode') %>%
  left_join(regions, by='state')

years = 2011:2014
read_years = function(template_fn) {
  lapply(years, function(y) read_tsv(sprintf(template_fn, y)) %>% mutate(year=y)) %>%
    bind_rows()
}

all_ineq = read_years('data/state_ineq_all_%i.tsv') %>%
  group_by(state) %>%
  summarize(mean_cpb=mean(mean),
            sem_cpb=sd(mean)/sqrt(n()),
            mean_fnz=mean(fnz),
            sem_fnz=sd(fnz)/sqrt(n()),
            mean_nzgini=mean(nzgini),
            sem_nzgini=sd(nzgini)/sqrt(n())) %>%
  left_join(regions, by='state')
  
state_ineq = read_years('data/state_ineq_%i.tsv') %>%
  rename(cpb=mean) %>%
  group_by(state, drug_group) %>%
  summarize(cpb=mean(cpb), fnz=mean(fnz), nzg=mean(nzgini)) %>%
  ungroup()

hrr_ineq = read_years('data/hrr_ineq_%i.tsv') %>%
  rename(cpb=mean) %>%
  group_by(hrr, drug_group) %>%
  summarize(cpb=mean(cpb), fnz=mean(fnz), nzg=mean(nzgini)) %>%
  ungroup()
```

```{r load_abg}
resistance_groups = read_tsv('resistance_groups.tsv')
bug_names = read_tsv('bug_names.tsv')

abg = read_tsv('../../../antibiogram/data/abg.tsv', col_types=cols(zipcode='c')) %>%
  mutate(drug=tolower(drug), percent_nonsusceptible=100-percent_susceptible) %>%
  left_join(hrr, by=c('zipcode', 'state')) %>%
  right_join(resistance_groups, by='drug') %>%
  select(bug, drug_group, state, hrr, percent_nonsusceptible, n_isolates)

possible_bug_drug = read_tsv('bug_drug.tsv')

# Keep only the abundant bug/drug combinations
min_n_states = 35
good_combos = semi_join(abg, possible_bug_drug, by=c('bug', 'drug_group')) %>%
  select(bug, drug_group, state) %>%
  distinct %>%
  count(bug, drug_group) %>% rename(n_places=n) %>%
  filter(n_places >= min_n_states)

abg %<>% right_join(good_combos, by=c('bug', 'drug_group')) %>%
  rename(bug_long=bug) %>% left_join(bug_names, by='bug_long') %>% select(-bug_long) %>%
  filter(!is.na(percent_nonsusceptible), !is.na(n_isolates))

# check that all the short names made it in
if (any(is.na(abg$bug))) stop('missing bug names')

summarize_abg = function(df, place_name) {
    group_by_(df, 'bug', 'drug_group', place_name) %>%
    summarize(mean_percent_nonsusceptible=weighted.mean(percent_nonsusceptible, sqrt(n_isolates)),
              n_place_antibiograms=n()) %>%
    mutate(place_weight=sqrt(n_place_antibiograms))
}

state_abg = summarize_abg(abg, 'state')
hrr_abg = summarize_abg(abg, 'hrr')
```

```{r do_models}
linear_interval = function(model, level) {
  confint(model, level=level) %>%
    tidy %>%
    setNames(c('term', 'ci_low', 'ci_high'))
}

linear_model = function(df, dependent_var, explanatory_vars) {
  f = paste0(dependent_var, ' ~ ', paste0(explanatory_vars, collapse = ' + ')) %>% formula
  m = lm(formula=f, weights=place_weight, data=df)
  tidy(m) %>%
    select(term, estimate, p.value) %>%
    mutate(n=nrow(df)) %>%
    left_join(linear_interval(m, 0.95), by='term')
}

spearman_interval = function(df, rho_name, n_name, level) {
  mada::CIrho(df[[rho_name]], df[[n_name]], level=level) %>%
    tidy %>%
    setNames(c('rho', 'ci_low', 'ci_high')) %>%
    select(-rho)
}

spearman_model = function(df, dependent_var, explanatory_var) {
  cor.test(df[[dependent_var]], df[[explanatory_var]], method='spearman') %>%
    tidy %>%
    mutate(term=explanatory_var, method='spearman') %>%
    mutate(n=nrow(df)) %>%
    group_by(term, estimate, p.value, n) %>%
    do(spearman_interval(., 'estimate', 'n', 0.95)) %>%
    ungroup()
}

uni_term = 'cpb' # univariable explanatory term
multi_term = 'nzg' # multivariable explanatory term (along with fnz)
models = function(x) {
  dep = 'mean_percent_nonsusceptible'
  bind_rows(
    linear_model(x, dep, uni_term) %>% mutate(model='uni'),
    linear_model(x, dep, c('fnz', multi_term)) %>% mutate(model='multi'),
    spearman_model(x, dep, uni_term) %>% mutate(model='spearman')
  ) %>%
    mutate(n_data=nrow(x))
}

results = left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  group_by(bug, drug_group) %>%
  do(models(.)) %>%
  ungroup

hrr_results = left_join(hrr_abg, hrr_ineq, by=c('hrr', 'drug_group')) %>% 
  group_by(bug, drug_group) %>%
  do(models(.)) %>%
  ungroup
```

# Landscape of bug/drug correlations

## Selecting correlations to test

I join the resistance drugs into classes:

`r kable(resistance_groups)`

I similarly joined the consumption drugs into similar classes.

I started by considering these bug/drug combinations:

`r kable(possible_bug_drug)`

Then I filtered to keep only those bug/drug combinations that were present in `r min_n_states` states. That means I'm looking at these `r nrow(good_combos)` bug/drug combinations:

`r good_combos %>% arrange(desc(n_places)) %>% kable`

## Preparing the consumption data

Unlike previous analyses, this time I treated the consumption and resistance data similarly: I averaged both across all data years. Thus, to get a state's Gini coefficient, I computed that number each year and then took the average.

## Spearman

Significant results using Spearman correlations of mean percent nonsusceptible ~ claims per beneficiary. A star after the bug/drug combination implies that the adjusted $p < 0.05$, and a dot means the unadjusted $p < 0.05$.

```{r spearman_models}
results %>%
  filter(model=='spearman') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.value < 0.05) %>%
  arrange(p.adj) %>%
  select(bug, drug_group, estimate, p.value, p.adj, n) %>%
  kable
```

Aside from individual significant results, we can look at the landscape of correlations. They are almost all positive, with MRSA/Bactrim making an interesting exception. Lines show 95% confidence intervals.

```{r spearman_interval}
interval_plot = function(df) {
  arrange(df, estimate) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  mutate(sig=case_when(.$p.adj < 0.05 ~ '*',
                       .$p.value < 0.05 ~ '.',
                       TRUE ~ ''),
         bug_drug=interaction(bug, drug_group, sig),
         bug_drug=factor(bug_drug, levels=bug_drug, ordered=TRUE)) %>% 
    ggplot(aes(x=bug_drug, y=estimate, ymin=ci_low, ymax=ci_high, color=drug_group)) +
    geom_point() +
    geom_linerange() +
    coord_flip()
}

results %>%
  filter(model=='spearman') %>%
  interval_plot() +
  ylab("Spearman's rho")
```

## Differences in consumption/resistance patterns explain some of these results

Different bug/drug combinations have different spreads along the consumption and resistance axes, so we would expect to see different strengths of association for each one.

```{r}
left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  filter(bug %in% c('E. coli', 'Eb. cloacae', 'CNST', 'MSSA', 'MRSA', 'S. pneumoniae')) %>%
  ggplot(aes(x=cpb, y=mean_percent_nonsusceptible, color=drug_group, shape=bug)) +
  geom_point() +
  xlab('claims per beneficiary')
```

# Unevenness of consumption and antibiotic resistance

## Drugs are consumed differently in different places

```{r nzgini_cpb_drug}
cbbPalette <- c("#000000", "#D55E00", "#CC79A7", "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2")
state_ineq %>%
  ggplot(aes(x=cpb, y=nzg, color=drug_group)) +
  geom_point() +
  ylab('Gini coefficient among users') + xlab('claims per beneficiary') +
  theme_minimal() +
  scale_color_manual(values=cbbPalette)
```

## Effect of unevenness on antibiotic resistance

Here we use the same bug/drug combinations, but instead we test the multivariable model mean percent nonsusceptible ~ fraction nonzero + nonzero Gini.

There is only one significant and one marginally significant result:

```{r multi_models}
results %>%
  filter(model=='multi', term==multi_term) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.value < 0.05) %>%
  arrange(p.value) %>%
  select(bug, drug_group, estimate, p.value, p.adj) %>%
  kable
```

```{r}
results %>%
  filter(model=='multi', term==multi_term) %>%
  interval_plot() +
  ylab('Gini coefficient')
```

Using HRRs, one of the answers remains the same, but a different marginally-significant result pops up.

```{r}
hrr_results %>%
  filter(model=='multi', term==multi_term) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.value < 0.05) %>%
  arrange(p.value) %>%
  select(bug, drug_group, estimate, p.value, p.adj) %>%
  kable
```

```{r}
hrr_results %>%
  filter(model=='multi', term==multi_term) %>%
  interval_plot()
```

## Specific plots

Quinolone consumption predicts *E. coli* quinolone resistance:

```{r ecoli_quin}
left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='E. coli', drug_group=='quinolone') %>%
  ggplot(aes(x=cpb, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  geom_text() +
  xlim(0.2, 0.45) + ylim(0, 50) +
  xlab('quinolone claims per beneficiary') + ylab('mean percent nonsusceptible E. coli isolates') +
  theme_minimal()
```

## E.coli and bactrim

```{r ecoli_bactrim}
ecoli_bactrim_dat = left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='E. coli', drug_group=='tmp_smx') #%>%
  #filter(!is.na(mean_percent_nonsusceptible))

ecoli_bactrim_dat %>%
  ggplot(aes(x=cpb, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  geom_text() +
  scale_x_continuous(limits=c(0.08, 0.2), breaks=c(0.08, 0.1, 0.15, 0.2)) +
  ylim(10, 45) +
  xlab('TMP/SMX claims per beneficiary') + ylab('mean percent nonsusceptible E. coli isolates') +
  theme_minimal()
```

```{r}
ecoli_bactrim_dat %>%
  ggplot(aes(x=nzg, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  geom_text() +
  xlab('Gini coefficient)') +
  ylab('E. coli resistance') +
  theme_minimal()
```

## Pneumococcus and macrolides

```{r}
left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='S. pneumoniae', drug_group=='macrolide') %>%
  filter(!is.na(mean_percent_nonsusceptible)) %>% 
  ggplot(aes(x=cpb, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  geom_text() +
  theme_minimal()
```

## E. cloacae and quinolones

```{r}
left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='Eb. cloacae', drug_group=='quinolone') %>%
  filter(!is.na(mean_percent_nonsusceptible)) %>%
  ggplot(aes(x=cpb, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  geom_text() +
  theme_minimal()
```

## MSSA and clindamycin

```{r mssa_clinda}
left_join(state_abg, state_ineq, by=c('state', 'drug_group')) %>%
  left_join(regions, by='state') %>%
  filter(bug=='MSSA', drug_group=='clindamycin') %>%
  ggplot(aes(x=cpb, y=mean_percent_nonsusceptible, label=state)) +
  geom_smooth(method='lm', col='gray', se=FALSE) +
  geom_point() +
  geom_text() +
  xlab('clindamycin claims per beneficiary') + ylab('mean percent nonsusceptible MSSA isolates') +
  theme_minimal()
```

# Supplementary results

## Metrics of unevenness

### Aggregate usage correlates with fraction of users

Error bars show the s.e.m. across the four data years.

```{r fnz_mean}
all_ineq %>%
  mutate_at(vars(matches('fnz')), function(x) x*100) %>%
  ggplot(aes(x=mean_cpb, xmin=mean_cpb-sem_cpb, xmax=mean_cpb+sem_cpb,
             y=mean_fnz, ymin=mean_fnz-sem_fnz, ymax=mean_fnz+sem_fnz,
             color=region, label=state_abbreviation)) +
  geom_point() +
  geom_linerange() +
  geom_errorbarh(height=0) +
  geom_text(nudge_x=0.04) +
  xlab('mean claims per beneficiary') +
  ylab('mean % beneficiaries with at least one claim') +
  theme_minimal()
```

```{r}
all_ineq %$%
  cor.test(mean_cpb, mean_fnz, method='spearman')
```

### The two inequality metrics not correlate well

Error bars show the s.e.m. across the four data years.

```{r nzgini_mean}
all_ineq %>%
  ggplot(aes(x=mean_fnz, xmin=mean_fnz-sem_fnz, xmax=mean_fnz+sem_fnz,
             y=mean_nzgini, ymin=mean_nzgini-sem_nzgini, ymax=mean_nzgini+sem_nzgini,
             color=region, label=state_abbreviation)) +
  geom_point() +
  geom_linerange() +
  geom_errorbarh(height=0) +
  geom_text(nudge_x=0.00) +
  xlab('mean fraction with at least one claim') +
  ylab('mean Gini coefficient') +
  theme_minimal()
```

The correlation exists but it's much less strong.

```{r}
all_ineq %$%
  cor.test(mean_fnz, mean_nzgini, method='spearman')
```

There is an intermediate correlation between claims per beneficiary and the Gini coefficient (see below), so in multivariable regressions I will use those two (rather than CPB and Gini).

```{r}
all_ineq %$% cor.test(mean_cpb, mean_nzgini, method='spearman')
```

## Spearman models

### State-level volcano plot

```{r}
results %>%
  filter(model=='spearman') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  ggplot(aes(x=estimate, y=-log10(p.adj))) + geom_point() +
  geom_hline(yintercept=-log10(0.05), col='red')
```

### HRR-level correlations

```{r hrr_spearman_models}
hrr_results %>%
  filter(model=='spearman') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.value < 0.05) %>%
  arrange(p.value) %>%
  select(bug, drug_group, estimate, p.value, p.adj) %>%
  kable
```

## Univariable regressions

Like the Spearman models, the model here is mean percent nonsusceptible ~ claims per beneficiary, only this time it's a normal linear regression.

### State-level

```{r uni_models}
results %>%
  filter(model=='uni', term==uni_term) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  #filter(p.value < 0.05) %>%
  arrange(p.value) %>%
  select(bug, drug_group, estimate, p.value, p.adj, n) %>%
  kable
```

```{r}
results %>%
  filter(model=='uni', term==uni_term) %>%
  interval_plot()
```

```{r}
results %>%
  filter(model=='uni') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  ggplot(aes(x=estimate, y=-log10(p.adj))) + geom_point() +
  geom_hline(yintercept=-log10(0.05), col='red')
```

### HRR-level

```{r hrr_uni_models}
hrr_results %>%
  filter(model=='uni', term==uni_term) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.value < 0.05) %>%
  arrange(p.value) %>%
  select(bug, drug_group, estimate, p.value, p.adj) %>%
  kable
```