---
title: "ms2"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, fig.path='fig/', dev=c('png', 'pdf'),
                      pdf.options(useDingbats=FALSE),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE)
import::from(tools, md5sum)
library(forcats)
```

```{r load_data, cache.extra=c(md5sum('ineq.tsv'), md5sum('results.tsv'))}
ineq_table = read_tsv('ineq.tsv')

ineq = ineq_table %>%
  group_by(year, unit_type, unit, drug_group) %>%
  summarize(mean=weighted.mean(n_claims, w=n_bene),
            fnz=sum(n_bene[n_claims > 0]) / sum(n_bene),
            mup=mean/fnz) %>%
  group_by(unit_type, unit, drug_group) %>%
  summarize_at(vars(mean, fnz,mup), mean) %>% 
  ungroup()

results = read_tsv('results.tsv')

consumption_groups = read_tsv('consumption_groups.tsv')
resistance_groups = read_tsv('resistance_groups.tsv')
possible_bug_drug = read_tsv('bug_drug.tsv')

regions = read_tsv('../../db/census-regions/census-regions.tsv') %>%
  select(state, state_abbreviation, region)

zipcodes = read_tsv('../../db/zipcode/zipcode.tsv') %>%
  select(zipcode=zip, state)

# Use the zipcode-HRR mapping from 2011
hrr = read_tsv('../../db/hrr/hrr.tsv', col_types=list(hrr='c')) %>%
  filter(year==2011) %>%
  select(zipcode, hrr) %>%
  left_join(zipcodes, by='zipcode') %>%
  left_join(regions, by='state')

hrr_regions = hrr %>%
  count(hrr, region) %>%
  group_by(hrr) %>%
  filter(n==max(n)) %>%
  ungroup() %>%
  select(hrr, region)

state_abg = read_tsv('abg_state.tsv')
hrr_abg = read_tsv('abg_hrr.tsv', col_types=list(hrr='c'))
```

# Methods

## Consumption data

I used the same inclusion criteria as in ms. #1. I grouped the beneficiaries by state or by HRR. (When zipcode-to-HRR links differed between years, I used the one from 2014.)

Then I grouped the drugs into consumption groups:

`r kable(consumption_groups)`

For each year, in each geographical unit, for each drug group, I computed the mean consumption per capita, the fraction of beneficiaries who had at least one claim ("fraction nonzero"), and the Gini coefficient among those nonzero users.

I then took the mean of these statistics across years.

## Resistance data

I join the resistance drugs into the classes shown below:

`r kable(resistance_groups)`

The *S. aureus* antibiograms are listed as MSSA, MRSA, or plain old *S. aureus*. For tetracycline, Bactrim, and clindamycin, I didn't find any big difference in resistance patterns about the three groups, so I merged them all into one group for purposes of the analysis. For the cephalosporins, I joined MSSA and plain old *S. aureus*. (MRSA, on the other hand, had clear indications that the data were artificially set to 100% resistance. Intriguingly, it seemed like this was also the case for MSSA and the beta-lactams [penicillin and ampicillin], so I did not include those.)

I included both inpatient and outpatient data, because although inpatient resistances were mostly higher than outpatient resistances, the overall trends by state appeared to be the same for both sets of data, and the difference between in- vs. outpatient were smaller than the differences between extreme ends of the states.

I summarized the resistance data for each geographical unit with a weighted mean, where the weight was the square root of the number of isolates. (In the rare cases where the number of isolates was not reported, I put in the median number of isolates for that organism.)

## Bug/drug combinations

I started by considering these `r nrow(possible_bug_drug)` bug/drug combinations on the basis of their clinical relevance and plausibility:

`r kable(possible_bug_drug)`

For each combination, I computed three models:

- a Spearman correlation of mean claims per beneficiary $\mu$ against mean percent nonsusceptible $R$
- a linear model predicting mean resistance from the fraction $f$ of people who are consumers
- a linear model predicting resistance from mean consumption among consumers $\nu = \mu/f$
- if both univariate linear models are significant, a linear model predicting resistance from both $f$ and $\nu$

When running regressions, I weight the states/HRRs by the inverse square of the standard error of the unit-level estimates.

# Results

## Landscape of correlations

## Spearman

The plot shows the Spearman correlation coefficient $\rho$ between resistance $R$ and mean consumption $\mu$. Two stars after the bug/drug combination indicates that the adjusted $p < 0.05$, and one star means the unadjusted $p < 0.05$. Intervals show 95% confidence intervals. 

```{r hrr_spearman}
interval_plot = function(df) {
  arrange(df, estimate) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  mutate(sig=case_when(.$p.adj < 0.05 ~ '**',
                       .$p.value < 0.05 ~ '*',
                       TRUE ~ ''),
         bug_drug=fct_inorder(str_c(bug, drug_group, sig, sep=' '))) %>% 
    ggplot(aes(x=bug_drug, y=estimate, ymin=ci_low, ymax=ci_high, color=drug_group)) +
    geom_point() +
    geom_errorbar(width=0.5) +
    coord_flip()
}

results %>%
  filter(model=='spearman', unit_type=='hrr') %>%
  interval_plot() +
  ylab("Spearman's rho") +
  ggtitle("Spearman, res. vs. mean consumption, HRR")
```

```{r state_spearman}
results %>%
  filter(model=='spearman', unit_type=='state') %>%
  interval_plot() +
  ylab("Spearman's rho") +
  ggtitle("Spearman, res. vs. mean consumption, state")
```

All the demonstrably-different-from-zero relationships are positive. This jibes with our general understanding that more consumption means more resistance.

This table has the significant and marginally significant results from the previous figure.

## Linear models

We're interested in how it is that mean consumption drives resistance. Is it at the intensive or extensive margin? We separate that by writing $\mu = f \nu$.

I run models $R \sim f$, that is $R^{(u)} = \beta_0 + \beta_f f^{(u)} + \varepsilon^{(u)}$, where the superscript $u$ indicates the geographical unit (HRR or state). The plots show $\beta_f$. This model is equivalent to one in which the population resistance $R^{(u)}$ in unit $u$ is the mean of the resistance $r_i^{(u)}$ in the individual people $i$ in unit $u$, where $r_i^{(u)}$ is $\beta_0$ if person $i$ took no drug and $\beta_0 + \beta_f$ if that person took at least one dose.

The gray line shows $\beta_f = 1$. Most confidence intervals include that line, i.e., we can explain our data with a transmission-free model where individuals who take drug have 100% resistance and others have some smaller amount. In only one case do we have a place where the data are inconsistent with this simple model. (Note that the $\beta_0$ can mean the resistance among non-consumers or the fraction of non-consumers who are cryptic consumers.)

```{r hrr_linear}
results %>%
  filter(model=='univariate_fnz', unit_type=='hrr', term=='fnz') %>%
  interval_plot() +
  geom_hline(yintercept=0, col='gray') +
  geom_hline(yintercept=1, col='gray') +
  ylab(expression(beta[f])) +
  ggtitle("Linear univariate, HRR")
```

```{r state_linear}
results %>%
  filter(model=='univariate_fnz', unit_type=='state', term=='fnz') %>%
  interval_plot() +
  geom_hline(yintercept=0, color='gray') +
  geom_hline(yintercept=1, color='gray') +
  ylab(expression(beta[f])) +
  ggtitle("Linear univariate, state")
```

# Unevenness of consumption and antibiotic resistance

## Unevenness of consumption

For each drug, what fraction of people took that drug? Of people who took it, how many had one claim? How many claims are accounted for by singleton users? This is data from 2011.

```{r ineq_table}
pct = function(x) round(x*100, 2)

ineq_table %>%
  filter(unit_type=='state') %>%
  # sum across units
  group_by(year, drug_group, n_claims) %>%
  summarize(n_bene=sum(n_bene)) %>%
  ungroup() %>%
  # compute the number of claims made by people making 1 claim, etc.
  mutate(n_class_claims = n_claims * n_bene) %>%
  # compute percentages: fr. of benes w/ 1 claim, fr. of claims made by 1-claimers, etc.
  group_by(year, drug_group) %>%
  mutate(pct_bene=pct(n_bene/sum(n_bene)),
         pct_claims=pct(n_class_claims/sum(n_class_claims))) %>%
  ungroup() %>%
  select(year, drug_group, n_claims, pct_bene, pct_claims) %>%
  # group 3+ claims into one group, then sum up fractions in that new group
  mutate(n_claims=fct_other(factor(n_claims), keep=0:2, other_level='3+')) %>%
  group_by(year, drug_group, n_claims) %>%
  summarize_at(vars(pct_bene, pct_claims), sum) %>%
  ungroup() %>%
  # merge the claims group and metric into one key, and spread
  gather('key', 'val', pct_bene:pct_claims) %>%
  mutate(key2=str_c(n_claims, ':', key)) %>%
  select(year, drug_group, key2, val) %>%
  spread(key2, val) %>%
  # keep only 2011 data
  filter(year==2011) %>%
  select(-year) %>%
  kable
```

```{r ineq_hist}
cbbPalette <- c("#000000", "#D55E00", "#CC79A7", "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2")

ineq_table %>%
  filter(unit_type=='state') %>%
  # sum across units
  group_by(year, drug_group, n_claims) %>%
  summarize(n_bene=sum(n_bene)) %>%
  ungroup() %>%
  # compute the number of claims made by people making 1 claim, etc.
  mutate(n_class_claims = n_claims * n_bene) %>%
  # compute percentages: fr. of benes w/ 1 claim, fr. of claims made by 1-claimers, etc.
  group_by(year, drug_group) %>%
  mutate(pct_bene=pct(n_bene/sum(n_bene))) %>%
  select(year, drug_group, n_claims, pct_bene) %>%
  # group 3+ claims into one group, then sum up fractions in that new group
  mutate(n_claims=fct_other(factor(n_claims), keep=0:2, other_level='3+')) %>%
  group_by(year, drug_group, n_claims) %>%
  summarize_at(vars(pct_bene), sum) %>%
  ungroup() %>%
  # show only 2011 data
  filter(year==2011) %>%
  mutate(drug_group=fct_reorder(drug_group, pct_bene, fun=max)) %>%
  ggplot(aes(x=n_claims, y=pct_bene, fill=drug_group)) +
  geom_bar(stat='identity', position='dodge') +
  scale_fill_manual(values=cbbPalette) +
  theme_minimal()
```

## Unevenness is mostly related to the "extensive margin"

The line has slope 1.5.

```{r fnz_mean_drug}
cbbPalette <- c("#000000", "#D55E00", "#CC79A7", "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2")

ineq %>%
  filter(unit_type=='state', drug_group != 'overall') %>%
  ggplot(aes(x=fnz, y=mean, color=drug_group)) +
  stat_smooth(aes(color=NA), color='gray', method='lm', se=F, fullrange=TRUE) +
  geom_point(shape=1) +
  xlab('fraction nonzero (f)') + ylab('mean consumption (mu)') +
  geom_hline(yintercept=0) + geom_vline(xintercept=0) +
  ggtitle('Fraction consuming and mean consumption, states') +
  theme_minimal() +
  scale_color_manual(values=cbbPalette)
```

Because $f$ is so collinear with $\mu$, multiple regressions using both as predictors will cause problems (cf. the Supplement). Rather than mean consumption $\mu$, I'll use the mean consumption among consumers $\nu = \mu / f$ as my second predictor.

```{r fnz_mup}
ineq %>%
  filter(unit_type=='state', drug_group != 'overall') %>%
  ggplot(aes(x=fnz, y=mup, color=drug_group)) +
  geom_smooth(method='lm', se=F) +
  geom_point(shape=1) +
  xlab(expression(f)) +
  ylab(expression(nu)) +
  ggtitle('Consumption among consumers (nu) vs. fraction consuming (f), states') +
  theme_minimal() +
  scale_color_manual(values=cbbPalette)
```

The tetracyclines and Bactrim are the interesting exceptions: in these drugs, states where consumption is more widespread are the states where consumption per consumer is lower. (The trend in clindamycin is not significant.) For tetracyclines, there appear to be downward trends within regions (except the Northeast, where the trend is up). For Bactrim, there's a Simpson's paradox: the trend is down overall, and down for the South, but it's up for all the other regions.

In both cases, it seems like the South is the mass with the most leverage, and it leverages downward.

For $\beta$-lactams, cephalosporins, clindamycin, macrolides, and quinolones, the slopes seem to mostly agree with one another. This suggests that tetracycline and Bactrim prescribing are somehow quite variable between regions.

```{r fnz_mup_by_drug}
ineq %>%
  filter(unit_type=='hrr') %>%
  rename(hrr=unit) %>% left_join(hrr_regions, by='hrr') %>%
  ggplot(aes(x=fnz, y=mup, color=region)) +
  facet_wrap(~drug_group, scales='free') +
  geom_smooth(method='lm', se=F, aes(color=NULL), color='gray') +
  geom_smooth(method='lm', se=F) +
  geom_point(shape=1) +
  xlab(expression(f)) +
  ylab(expression(nu)) +
  ggtitle('Mean nonzero consumption vs. fraction consuming, HRR') +
  theme_minimal()
```

Tetracycline and Bactrim are interesting: the South has this long tail where $f$ is exceptionally high and $\nu$ is low. I imagined a model where the South was like the Midwest, but just with more people taking one does of, say, Bactrim. So it goes from $d$ doses into $c$ consumers to $d + \Delta c$ doses into $c + \Delta c$ consumers. This predicts that $\nu' = (\nu + \Delta f)/(1 + \Delta f)$. This prediction is too high: it's not *just* that more people in some parts of the South are getting these drugs; it's also that those getting the drug are getting less of it.

## The South has more consumers per capita

However, among those people who do consume, consumption is smaller per capita (i.e., the slope is similar but the intercept is smaller). In this sense, consumption in the South is less concentrated than in the Midwest.

```{r fnz_mean_region}
ineq %>%
  filter(unit_type=='state', drug_group=='overall') %>%
  rename(state=unit) %>%
  filter(state != 'District of Columbia') %>%
  left_join(regions, by='state') %>%
  ggplot(aes(x=fnz, y=mean, color=region)) +
  geom_smooth(aes(color=NULL), method='lm', se=F, color='gray') +
  geom_point() +
  xlab('Fraction nonzero (f)') + ylab('claims per beneficiary (mu)') +
  ggtitle('All antibiotics, f and mean consumption, states') +
  theme_minimal()
```

## Effect of unevenness on antibiotic resistance

### Effect along intensive margin $\nu$

```{r hrr_linear_mup}
results %>%
  filter(model=='univariate_mup', unit_type=='hrr', term=='mup') %>%
  interval_plot() +
  ylab(expression(beta[nu])) +
  ggtitle("Linear univariate, HRR")
```

### Effect of $f$ beyond $\nu$, or vice versa

We ask if consumption among consumers $\nu$ has any information beyond fraction nonzero $f$ for predicting resistance $R$ (and vice versa). We do regressions $R = \beta_0 + \beta_f f + \beta_\nu \nu + \varepsilon$ and perform $F$-tests on the nested regression models.

```{r double_sig_hrr}
double_sig = results %>%
  filter(model %in% c('univariate_fnz', 'univariate_mup'),
         term != '(Intercept)',
         unit_type == 'hrr') %>%
  group_by(model) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  ungroup() %>%
  filter(p.value < 0.05) %>%
  group_by(bug, drug_group) %>%
  summarize(n=n()) %>%
  filter(n == 2) %>%
  select(-n)

results %>%
  semi_join(double_sig, by=c('bug', 'drug_group')) %>%
  filter(unit_type == 'hrr',
         model %in% c('multivariate_fnz_mup', 'multivariate_mup_fnz'),
         term != '(Intercept)') %>%
  mutate(second_anova_term=str_extract(model, '(mup|fnz)$')) %>%
  filter(term == second_anova_term) %>%
  select(bug, drug_group, term, anova.p.value) %>%
  spread(term, anova.p.value) %>%
  kable
```

At the HRR level, we see that:

- For CoNS/FQ and *E. cloacae*/FQ, neither $f$ nor $\nu$ gives information beyond the other
- For *E. coli*/FQ and *S. pneumonia*/macrolides, $f$ gives informatio beyond $\nu$
- For *P. mirabilis*/quinolones, $\nu$ gives information beyond $f$
- For *E. coli*/Bactrim, $f$ and $\nu$ each give information beyond the other

And at the state level:

```{r double_sig_state}
double_sig = results %>%
  filter(model %in% c('univariate_fnz', 'univariate_mup'),
         term != '(Intercept)',
         unit_type == 'state') %>%
  group_by(model) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  ungroup() %>%
  filter(p.value < 0.05) %>%
  group_by(bug, drug_group) %>%
  summarize(n=n()) %>%
  filter(n == 2) %>%
  select(-n)

results %>%
  semi_join(double_sig, by=c('bug', 'drug_group')) %>%
  filter(unit_type == 'state',
         model %in% c('multivariate_fnz_mup', 'multivariate_mup_fnz'),
         term != '(Intercept)') %>%
  mutate(second_anova_term=str_extract(model, '(mup|fnz)$')) %>%
  filter(term == second_anova_term) %>%
  select(bug, drug_group, term, anova.p.value) %>%
  spread(term, anova.p.value) %>%
  kable
```

There are only two bug/drug combinations that are double-significant, and in those cases, neither metric gives information beyond the other.

### E. coli and Bactrim

This negative relationship is the most tricky.

Increased fraction consuming $f$ is correlated with increased resistance:

```{r ecoli_bactrim_fnz_hrr}
ineq %>%
  filter(unit_type=='hrr') %>%
  rename(hrr=unit) %>% left_join(hrr_regions, by='hrr') %>%
  right_join(hrr_abg, by=c('hrr', 'drug_group')) %>%
  filter(bug=='E. coli', drug_group=='tmp_smx') %>%
  filter(percent_nonsusceptible < 50) %>% # filter one crazy Nevada point
  ggplot(aes(x=fnz, y=percent_nonsusceptible, color=region)) +
  #geom_abline(intercept=16.86, slope=114.8, color='pink') +
  geom_smooth(method='lm', se=F, aes(color=NULL), color='black') +
  geom_smooth(method='lm', se=F) +
  geom_point() +
  xlab('fraction who consumed Bactrim') +
  ylab('Bactrim-resistance E. coli') +
  ggtitle('E. coli & Bactrim, f, HRRs')
```

But increased consumption among consumers $\nu$ is anticorrelated resistance, both within and across regions:

```{r ecoli_bactrim_mup}
ineq %>%
  filter(unit_type=='hrr') %>%
  rename(hrr=unit) %>% left_join(hrr_regions, by='hrr') %>%
  right_join(hrr_abg, by=c('hrr', 'drug_group')) %>%
  filter(bug=='E. coli', drug_group=='tmp_smx') %>%
  filter(percent_nonsusceptible < 50) %>% # filter one crazy Nevada point
  ggplot(aes(x=mup, y=percent_nonsusceptible, color=region)) +
  geom_smooth(method='lm', se=F, aes(color=NULL), color='black') +
  geom_smooth(method='lm', se=F) +
  geom_point() +
  xlab('mean Bactrim cons. among Bactrim-eaters') +
  ylab('Bactrim-resistance E. coli') +
  ggtitle('E. coli & Bactrim, nu, HRRs')
```

### E. faecium and beta-lactams

```{r efaecium_betalactam}
ineq %>%
  filter(unit_type=='hrr') %>%
  rename(hrr=unit) %>% left_join(hrr_regions, by='hrr') %>%
  right_join(hrr_abg, by=c('hrr', 'drug_group')) %>%
  filter(bug=='Ec. faecium', drug_group=='beta_lactam') %>%
  ggplot(aes(x=fnz, y=percent_nonsusceptible, color=region)) +
  geom_smooth(method='lm', se=F, aes(color=NULL), color='black') +
  geom_smooth(method='lm', se=F) +
  geom_point() +
  xlab('fraction who consumed beta-lactams') +
  ylab('Beta-lactam resistance in E. faecium') +
  ggtitle('E. faecium & beta-lactams across HRRs')

ineq %>%
  filter(unit_type=='state') %>%
  rename(state=unit) %>%
  left_join(regions, by='state') %>%
  right_join(state_abg, by=c('state', 'drug_group')) %>%
  filter(bug=='Ec. faecium', drug_group=='beta_lactam') %>%
  ggplot(aes(x=mean, y=percent_nonsusceptible, color=region)) +
  geom_smooth(method='lm', se=F, aes(color=NULL), color='black') +
  geom_smooth(method='lm', se=F) +
  geom_point() +
  xlab('fraction who consumed beta-lactams') +
  ylab('Beta-lactam resistance E. coli') +
  ggtitle('E. faecium & beta-lactams across states')
```

### S. pneumonia and tetracyclines

```{r pneumo_tetra}
ineq %>%
  filter(unit_type=='hrr') %>%
  rename(hrr=unit) %>% left_join(hrr_regions, by='hrr') %>%
  right_join(hrr_abg, by=c('hrr', 'drug_group')) %>%
  filter(bug=='S. pneumoniae', drug_group=='tetracycline') %>%
  ggplot(aes(x=fnz, y=percent_nonsusceptible, color=region)) +
  geom_smooth(method='lm', se=F, aes(color=NULL), color='black') +
  geom_smooth(method='lm', se=F) +
  geom_point() +
  xlab('f') +
  ylab('tetra resistance pneumo') +
  ggtitle('pneumo & tetra, f, HRRs')

ineq %>%
  filter(unit_type=='hrr') %>%
  rename(hrr=unit) %>% left_join(hrr_regions, by='hrr') %>%
  right_join(hrr_abg, by=c('hrr', 'drug_group')) %>%
  filter(bug=='S. pneumoniae', drug_group=='tetracycline') %>%
  ggplot(aes(x=mup, y=percent_nonsusceptible, color=region)) +
  geom_smooth(method='lm', se=F, aes(color=NULL), color='black') +
  geom_smooth(method='lm', se=F) +
  geom_point() +
  xlab('nu') +
  ylab('R') +
  ggtitle('pneumo & tetra, nu, HRRs')
```

### E. coli and beta-lactams

```{r ecoli_betalactam}
ineq %>%
  filter(unit_type=='hrr') %>%
  rename(hrr=unit) %>% left_join(hrr_regions, by='hrr') %>%
  right_join(hrr_abg, by=c('hrr', 'drug_group')) %>%
  filter(bug=='E. coli', drug_group=='beta_lactam') %>%
  filter(percent_nonsusceptible < 50) %>% # filter one crazy Nevada point
  ggplot(aes(x=fnz, y=percent_nonsusceptible, color=region)) +
  geom_smooth(method='lm', se=F, aes(color=NULL), color='black') +
  geom_smooth(method='lm', se=F) +
  geom_point() +
  xlab('f') +
  ylab('Beta-lactam resistance in E. coli') +
  ggtitle('E. coli & beta-lactams, f, HRRs')

ineq %>%
  filter(unit_type=='hrr') %>%
  rename(hrr=unit) %>% left_join(hrr_regions, by='hrr') %>%
  right_join(hrr_abg, by=c('hrr', 'drug_group')) %>%
  filter(bug=='E. coli', drug_group=='beta_lactam') %>%
  filter(percent_nonsusceptible < 50) %>% # filter one crazy Nevada point
  ggplot(aes(x=mup, y=percent_nonsusceptible, color=region)) +
  geom_smooth(method='lm', se=F, aes(color=NULL), color='black') +
  geom_smooth(method='lm', se=F) +
  geom_point() +
  xlab('nu') +
  ylab('Beta-lactam resistance in E. coli') +
  ggtitle('E. coli & beta-lactams, nu, HRRs')
```

## Specific plots

### E. coli & quinolones

```{r ecoli_quin_state}
state_cons_res_plot = function(b, d) {
  p = inner_join(
    ineq %>%
      filter(unit_type=='state', drug_group==d) %>%
      select(state=unit, mean),
    state_abg %>%
      filter(bug==b, drug_group==d) %>%
      select(state, percent_nonsusceptible),
    by='state') %>%
    left_join(regions, by='state') %>%
    ggplot(aes(x=mean, y=percent_nonsusceptible, label=state, color=region)) +
    geom_smooth(method='lm', se=F) +
    geom_smooth(method='lm', se=F, col='gray') +
    geom_point() +
    geom_text() +
    xlab(str_interp('mean ${d} claims per beneficiary')) +
    ylab(str_interp('mean percent nonsusceptible ${b} isolates')) +
    ggtitle(str_interp('${b} & ${d}, state'))
  
  p
}

show(state_cons_res_plot('E. coli', 'quinolone'))
```

### Pneumococcus and macrolides

```{r pneumo_macro_state}
show(state_cons_res_plot('S. pneumoniae', 'macrolide'))
```

# Appropriateness at the margins

Stewardship should also be motivated by whether consumption is more appropriate along the extensive or intensive margin.

For each drug, take all claims made by beneficiaries who had $N$ claims for that drug. Of those $N$ claims, what fraction were associated with appropriate diagnoses? I exclude re-fills, since we don't expect them to be associated with diagnoses.

I also do logistic regressions predicting inappropriate prescribing from the number of claims. (In other words, we predict whether a claim is appropriate using the number of claims for that drug its beneficiary had.) I used all the data, rather than truncating at 9 claims like for the figure. Where inappropriate prescribing increases (significantly, after multiple hypothesis correction), I put "+" after the name; where it decreases, "-".

```{r approp_margin}
top_abx = c('azithromycin', 'ciprofloxacin', 'amoxicillin',
            'cephalexin', 'trimethoprim/sulfamethoxazole',
            'levofloxacin', 'amoxicillin/clavulanate',
            'doxycycline', 'nitrofurantoin', 'clindamycin')

approp = read_tsv('../ms1/tables/pde_approp_margin.tsv') %>%
  filter(year==2014, antibiotic %in% top_abx) %>%
  select(-year, -f_app) %>%
  complete(antibiotic, n_abx_claims, app, fill=list(n_abx_app_claims=0)) %>%
  spread(app, n_abx_app_claims) %>%
  rename(n_app=`TRUE`, n_inapp=`FALSE`) %>%
  mutate(n_total=n_app+n_inapp)

approp_trends = approp %>%
  mutate(y=n_inapp / n_total) %>%
  group_by(antibiotic) %>%
  do(tidy(glm(y ~ n_abx_claims, data=., weights=n_total, family='quasibinomial'))) %>%
  filter(term=='n_abx_claims') %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  filter(p.adj < 0.05) %>%
  select(antibiotic, estimate, std.error, p.adj)

top_abx_short = c('azithromycin', 'ciprofloxacin', 'amoxicillin',
                  'cephalexin', 'TMP/SMX', 'levofloxacin',
                  'amox/clav', 'doxycycline', 'nitrofurantoin',
                  'clindamycin')

approp_abx_labels = data_frame(antibiotic=top_abx,
                               short_antibiotic=top_abx_short) %>%
  left_join(approp_trends, by='antibiotic') %>%
  mutate(sig=case_when(is.na(.$estimate) ~ '',
                       estimate > 0 ~ ' (+)',
                       estimate < 0 ~ ' (-)')) %>%
  mutate(short_antibiotic=str_c(short_antibiotic, sig)) %>%
  pull(short_antibiotic)

approp %>%
  filter(n_total > 0) %>%
  group_by(antibiotic, n_abx_claims) %>%
  do((function (x, n) {
    m = binom.test(x, n)
    data_frame(estimate=m$estimate,
               ci_low=m$conf.int[1],
               ci_high=m$conf.int[2])
  })(.$n_inapp, .$n_total)) %>%
  ungroup() %>%
  # throw out the messy end margins
  filter(n_abx_claims <= 9) %>%
  # order the antibiotics
  mutate(antibiotic=factor(antibiotic,
                           levels=top_abx,
                           labels=approp_abx_labels)) %>%
  ggplot(aes(x=n_abx_claims, y=estimate, ymin=ci_low, ymax=ci_high)) +
  geom_point() +
  geom_line() +
  geom_errorbar() +
  facet_wrap(~antibiotic) +
  ylab('fraction inappropriate') +
  scale_x_continuous(breaks=c(1, 3, 5, 7, 9))
```

This table has the data from the tests: the estimate is the odds ratio for each additional claim. Positive estimates mean that inappropriate increases with more intensive usage; negative means that inappropriate prescribing decreases. I only show the drugs that has significant results after multiple hypothesis correction.

```{r approp_trends}
approp_trends %>% kable
```

Thus, amoxicillin is the only drug that is more inappropriate among high intensity users. All the other drugs are either the same across intensiveness or actually more appropriate among intensive users. This is another argument for, in general, focusing on the extensive margin.

# Supplementary results

## Correlations between the metrics

The mean and the fraction nonzero are highly correlated ($\rho \sim 1$) for all drug groups. (Note the range on the $x$-axis!)

```{r metrics}
f = function(df, x, y) {
  cor.test(df[[x]], df[[y]], method='spearman') %>% tidy
}

ineq %>%
  group_by(unit_type, drug_group) %>%
  do(f(., 'fnz', 'mean')) %>%
  ungroup() %>%
  select(unit_type, drug_group, estimate, p.value) %>%
  ggplot(aes(x=drug_group, y=estimate, color=unit_type)) +
  geom_point() +
  ylab('Spearman correlation between metrics') +
  coord_flip()
```

## Comparing state and HRR Spearman models

Each point shows the $\rho$ and $p$-value from a Spearman correlation test for a bug/drug combination in a geographic unit (state or HRR). Gray lines connect the two points representing the test for the same bug/drug combination; one point is for states, the other for HRRs.

It seems like the states generally have more positive estimates. I wonder if that means that states are the "correct" geographical level at which to look at these effects, but there just aren't enough of them to be able to make a sufficiently small $p$-value.

The dumbbells that cross the black, $p = 0.05$ line are the ones that are significant for one geographical unit but not the other.

```{r spearman_state_hrr_compare}
results %>%
  filter(model=='spearman') %>%
  mutate(group=interaction(bug, drug_group),
         adj.p.value=p.adjust(p.value, method='BH')) %>%
  ggplot(aes(x=estimate, y=-log10(adj.p.value), color=unit_type, group=group)) +
  geom_line(color='gray') +
  geom_hline(yintercept=-log10(0.05)) +
  geom_point() +
  xlab("Spearman's rho")
```

## Comparing state and HRR univariate $f$ models

For univariate models on $f$, HRRs have better $p$-values but similar estimates.

```{r compare_uni_f}
results %>%
  filter(model=='univariate_fnz', term=='fnz') %>%
  mutate(group=interaction(bug, drug_group),
         adj.p=p.adjust(p.value, method='BH')) %>%
  ggplot(aes(x=estimate, y=-log10(adj.p), color=unit_type, group=group)) +
  geom_line(color='gray') +
  geom_hline(yintercept=-log10(0.05)) +
  geom_point() +
  xlab(expression(beta[f]))
```

## Comparing state and HRR univariate $\nu$ models

For univariate models on $\nu$, the two negative-estimate results follow the same pattern: HRRs have better $p$-values but similar estimates. *Proteus* is way up in the corner. For the other positive-estimate results, it's a little more muddy.

```{r compare_uni_nu}
results %>%
  filter(model=='univariate_mup', term=='mup') %>%
  mutate(group=interaction(bug, drug_group),
         adj.p=p.adjust(p.value, method='BH')) %>%
  ggplot(aes(x=estimate, y=-log10(adj.p), color=unit_type, group=group)) +
  geom_line(color='gray') +
  geom_hline(yintercept=-log10(0.05)) +
  geom_point() +
  xlab(expression(beta[nu]))
```