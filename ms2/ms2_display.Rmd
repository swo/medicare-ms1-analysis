---
title: "ms2"
author: "Scott Olesen"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, fig.path='fig/', dev=c('png', 'pdf'),
                      pdf.options(useDingbats=FALSE),
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE)
import::from(tools, md5sum)
library(forcats)
```

```{r load_data}
ineq = read_tsv('ineq.tsv') %>%
  group_by(drug_group, unit_type, unit) %>%
  summarize_at(vars(mean, fnz, nzgini, gini), mean) %>%
  ungroup()

results = read_tsv('results.tsv')

consumption_groups = read_tsv('consumption_groups.tsv')
resistance_groups = read_tsv('resistance_groups.tsv')
possible_bug_drug = read_tsv('bug_drug.tsv')

regions = read_tsv('../../db/census-regions/census-regions.tsv') %>%
  select(state, state_abbreviation, region)

zipcodes = read_tsv('../../db/zipcode/zipcode.tsv') %>%
  select(zipcode=zip, state)

# Use the zipcode-HRR mapping from 2011
hrr = read_tsv('../../db/hrr/hrr.tsv') %>%
  filter(year==2011) %>%
  select(zipcode, hrr) %>%
  left_join(zipcodes, by='zipcode') %>%
  left_join(regions, by='state')
```

# Methods

## Consumption data

I used the same inclusion criteria as in ms. #1. I grouped the beneficiaries by state or by HRR. (When zipcode-to-HRR links differed between years, I used the one from 2014.)

Then I grouped the drugs into consumption groups:

`r kable(consumption_groups)`

For each year, in each geographical unit, for each drug group, I computed the mean consumption per capita, the fraction of beneficiaries who had at least one claim ("fraction nonzero"), and the Gini coefficient among those nonzero users.

I then took the mean of these statistics across years.

## Resistance data

I join the resistance drugs into the classes shown below:

`r kable(resistance_groups)`

The *S. aureus* antibiograms are listed as MSSA, MRSA, or plain old *S. aureus*. For tetracycline, Bactrim, and clindamycin, I didn't find any big difference in resistance patterns about the three groups, so I merged them all into one group for purposes of the analysis. For the cephalosporins, I joined MSSA and plain old *S. aureus*. (MRSA, on the other hand, had clear indications that the data were artificially set to 100% resistance. Intriguingly, it seemed like this was also the case for MSSA and the beta-lactams [penicillin and ampicillin], so I did not include those.)

I included both inpatient and outpatient data, because although inpatient resistances were mostly higher than outpatient resistances, the overall trends by state appeared to be the same for both sets of data, and the difference between in- vs. outpatient were smaller than the differences between extreme ends of the states.

## Bug/drug combinations

I started by considering these `r nrow(possible_bug_drug)` bug/drug combinations on the basis of their clinical relevance and plausibility:

`r kable(possible_bug_drug)`

(In previous iterations, I filtered by the number of states/HRRs in which each bug/drug combination appeared. Weirdly, there is a relationship in the data, that better-represented bug/drug combinations are the ones with the stronger relationships [i.e., the higher $\rho$, not necessarily the lower $p$]. When using the HRR data, that kind of fancy footwork wasn't necessary, so I just didn't do it.)

For each combination, I computed three models:

- a Spearman correlation of mean claims per beneficiary against mean percent nonsusceptible
- a linear model predicting mean resistance from mean consumption
- a linear model predicting mean resistance from fraction nonzero and nonzero Gini

# Results

## Landscape of correlations

## Spearman

Two stars after the bug/drug combination implies that the adjusted $p < 0.05$, and one star means the unadjusted $p < 0.05$. Intervals show 95% confidence intervals. 

```{r hrr_spearman}
interval_plot = function(df) {
  arrange(df, estimate) %>%
  mutate(p.adj=p.adjust(p.value, method='BH')) %>%
  mutate(sig=case_when(.$p.adj < 0.05 ~ '**',
                       .$p.value < 0.05 ~ '*',
                       TRUE ~ ''),
         bug_drug=fct_inorder(str_c(bug, drug_group, sig, sep=' '))) %>% 
    ggplot(aes(x=bug_drug, y=estimate, ymin=ci_low, ymax=ci_high, color=drug_group)) +
    geom_point() +
    geom_errorbar(width=0.5) +
    coord_flip()
}

results %>%
  filter(model=='spearman', unit_type=='hrr') %>%
  interval_plot() +
  ylab("Spearman's rho") +
  ggtitle("Spearman, HRR")
```

```{r state_spearman}
results %>%
  filter(model=='spearman', unit_type=='state') %>%
  interval_plot() +
  ylab("Spearman's rho") +
  ggtitle("Spearman, state")
```

All the demonstrably-different-from-zero relationships are positive. This jibes with our general understanding that more consumption means more resistance.

This table has the significant and marginally significant results from the previous figure.

## Linear models

```{r hrr_linear}
results %>%
  filter(model=='univariate', unit_type=='hrr', term=='mean') %>%
  interval_plot() +
  ylab("Linear coeff., mean cons.") +
  ggtitle("Linear univariate, HRR")
```

```{r state_linear}
results %>%
  filter(model=='univariate', unit_type=='state', term=='mean') %>%
  interval_plot() +
  ylab("Linear coeff., mean cons.") +
  ggtitle("Linear univariate, state")
```

# Unevenness of consumption and antibiotic resistance

## Drugs are consumed differently in different places

```{r nzgini_cpb_drug}
cbbPalette <- c("#000000", "#D55E00", "#CC79A7", "#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2")

ineq %>%
  filter(unit_type=='state', drug_group != 'overall') %>%
  ggplot(aes(x=mean, y=nzgini, color=drug_group)) +
  geom_point() +
  ylab('Gini coefficient among users') + xlab('claims per beneficiary') +
  ggtitle('Unevenness and mean consumption, states') +
  theme_minimal() +
  scale_color_manual(values=cbbPalette)
```

## Unevenness is mostly related to the "extensive margin"

```{r nzgini_fnz}
ineq %>%
  filter(unit_type=='state', drug_group != 'overall') %>%
  ggplot(aes(x=fnz, y=mean, color=drug_group)) +
  geom_point() +
  xlab('Fraction nonzero') + ylab('claims per beneficiary') +
  ggtitle('Fraction consuming and mean consumption, states') +
  theme_minimal() +
  scale_color_manual(values=cbbPalette)
```

## Effect of unevenness on antibiotic resistance

```{r hrr_multi}
results %>%
  filter(model=='multivariate', unit_type=='hrr', term=='nzgini') %>%
  interval_plot() +
  ylab("Linear coeff., nonzero Gini") +
  ggtitle("Linear multivariate, HRR")
```

```{r state_multi}
results %>%
  filter(model=='multivariate', unit_type=='state', term=='nzgini') %>%
  interval_plot() +
  ylab("Linear coeff., nonzero Gini") +
  ggtitle("Linear multivariate, state")
```

## Specific plots

### E. coli & quinolones

```{r ecoli_quin_state}
state_abg = read_tsv('abg_state.tsv')

state_cons_res_plot = function(b, d) {
  p = inner_join(
    ineq %>%
      filter(unit_type=='state', drug_group==d) %>%
      select(state=unit, mean),
    state_abg %>%
      filter(bug==b, drug_group==d) %>%
      select(state, mean_percent_nonsusceptible),
    by='state') %>%
    left_join(regions, by='state') %>%
    ggplot(aes(x=mean, y=mean_percent_nonsusceptible, label=state, color=region)) +
    geom_smooth(method='lm', se=F, col='gray') +
    geom_point() +
    geom_text() +
    xlab(str_interp('mean ${d} claims per beneficiary')) +
    ylab(str_interp('mean percent nonsusceptible ${b} isolates')) +
    ggtitle(str_interp('${b} & ${d}, state'))
  
  p
}

show(state_cons_res_plot('E. coli', 'quinolone'))
```

### Pneumococcus and macrolides

```{r pneumo_macro_state}
show(state_cons_res_plot('S. pneumoniae', 'macrolide'))
```

- *E. cloacae* and quinolone
- *S. aureus* and clindamycin

# Supplementary results

## Correlations between the metrics

I use a few metrics: the mean consumption $\mu$, the fraction nonzero $f_+$ (i.e., the fraction who are consumers), the Gini coefficient $G$, and the nonzero Gini $G_+$ (i.e., the Gini coefficient ignoring the nonconsumers). Here I explore the relationship between these.

Some math shows that
$$
G = (1 - f_+) + f_+ G_+,
$$
i.e., the Gini coefficient is a mixture of a "subcoefficient" of 1 for the nonconsumers and $G_+$ for the consumers.

In the plots below, I compare the correlations between these metrics across states and HRRs. Blessedly, the correlations are very similar across both sets of geographic units.

```{r metrics}
f = function(df, x, y) {
  cor.test(df[[x]], df[[y]], method='spearman') %>%
    tidy %>%
    mutate(comparison=str_interp("${x}/${y}"))
}

x = ineq %>%
  group_by(unit_type, drug_group) %>%
  do(bind_rows(f(., 'mean', 'fnz'),
               f(., 'fnz', 'gini'),
               f(., 'mean', 'gini'),
               f(., 'mean', 'nzgini'),
               f(., 'fnz', 'nzgini'))) %>%
  ungroup() %>%
  select(comparison, unit_type, drug_group, estimate, p.value)

comparison_plot_f = function(comp) {
  p = x %>%
    filter(comparison==comp) %>%
    ggplot(aes(x=drug_group, y=estimate, color=unit_type)) +
    geom_point() +
    ylab('Spearman correlation between metrics') +
    ylim(-1, 1) +
    coord_flip() +
    ggtitle(comp)
  p
}
```

The mean and the fraction nonzero are highly correlated ($\rho \sim 1$) for all drug groups:

```{r mean_fnz}
comparison_plot_f('mean/fnz') %>% show
```

In contrast, the fraction nonzero is almost perfectly *anticorrelated* with the Gini coefficient, i.e., the more people consuming, the more even the consumption:

```{r fnz_gini}
comparison_plot_f('fnz/gini') %>% show
```

$\mu$ is very well correlated with $f_+$, and $f_+$ is very well anticorrelated with $G$, so, not surprisingly, the anticorrelation between $\mu$ and $G$ is also strong:

```{r mean_gini}
comparison_plot_f('mean/gini') %>% show
```

However, mean consumption $\mu$ and the nonzero Gini coefficient $G_+$ are not as well correlated with one another. For most drug groups, increased mean consumption is somewhat correlated with increased unevenness among consumers. For two drug groups, the relationship is near zero:

```{r mean_nzgini}
comparison_plot_f('mean/nzgini') %>% show
```

When replacing $\mu$ with $f_+$ (recall that the two are closely correlated), all correlations get more negative, i.e., the positive ones get less positive and the near-zero ones get negative:

```{r fnz_nzgini}
comparison_plot_f('fnz/nzgini') %>% show
```

## Comparing state and HRR Spearman models

Each point shows the $\rho$ and $p$-value from a Spearman correlation test for a bug/drug combination in a geographic unit (state or HRR). Gray lines connect the two points representing the test for the same bug/drug combination; one point is for states, the other for HRRs.

It seems like the states generally have more positive estimates. I wonder if that means that states are the "correct" geographical level at which to look at these effects, but there just aren't enough of them to be able to make a sufficiently small $p$-value.

The dumbbells that cross the black, $p = 0.05$ line are the ones that are significant for one geographical unit but not the other.

```{r spearman_state_hrr_compare}
results %>%
  filter(model=='spearman') %>%
  mutate(group=interaction(bug, drug_group),
         adj.p.value=p.adjust(p.value, method='BH')) %>%
  ggplot(aes(x=estimate, y=-log10(adj.p.value), color=unit_type, group=group)) +
  geom_line(color='gray') +
  geom_hline(yintercept=-log10(0.05)) +
  geom_point() +
  xlab("Spearman's rho")
```
