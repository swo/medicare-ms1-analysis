---
title: "Ms. 2: Consumption and resistance across states and HRRs"
bibliography: refs.bib
output:
  html_document:
    fig_height: 4
  pdf_document:
    fig_height: 3
---

# To do

- Join multiple results into one table, or do pairwise comparisons of analytical methods
- How to use consumption data from multiple years?
- Show that resistance doesn't have a pattern over years
- more intelligently pooling data from the different *S. aureus* designations (in the antibiogram data, *S. aureus* is reported as one of *S. aureus*, MRSA, or MSSA)
- do Spearman so we can compare with Goossens?
- Get the right bug list

# Background

Here I report results of comparisons antibiotic consumption and resistance across states and HRRs.

# Methods

I used the Medicare Part D data from 2011. Normal filtering was applied to beneficiaries: at least 65 years old, no HMO, 12 months of coverage.

I pooled the antiobiograms from all years. To ensure coherence, I only use the bug/drug combinations that appear in antibiograms in at least 20 states. This is equivalent to filtering those bug/drug combinations that have at least 125 records. I selected a set of organisms in the antibiogram to examine. They mostly represent the most abundant organisms in the data. I also matched particular drugs in the consumption data to match to drugs in the resistance data.

For each bug/drug/state, I computed a weighted mean resistance: the values are $r_i/n_i$, the number of resistant isolates over the total number of isolates, and the weights are $\sqrt{n_i}$. I similarly computed a mean resistance for each HRR.

For each bug/drug, I ran a linear model predicting the state resistance means from the state consumptions, weighted by the square root of the number of antibiograms for that bug/drug/state. I adjusted the $p$-values for the slope terms using the Benjamini-Hochberg method. I performed a similar analysis using HRRs. The explanatory variable was claims per 1,000 people per year (CPKP).

```{r global_options, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, cache=TRUE,
                      echo=FALSE, warning=FALSE, message=FALSE)
import::from(broom, tidy)
import::from(mblm, mblm)
library(pander)
library(assertr)
```

```{r setup}
gram_negs = c('Escherichia coli',
              'Proteus mirabilis', 'Enterobacter cloacae',
              'Enterococcus faecium')
gram_poss = c('Coagulase-negative staphylococci',
              'Methicillin-resistant S. aureus (MRSA)',
              'Methicillin-susceptible S. aureus (MSSA)',
              'Streptococcus pneumoniae (non-meningitis)',
              'Staphylococcus aureus')
organisms = c(gram_negs, gram_poss)

consumption_groups = read_tsv('consumption_groups.tsv')
resistance_groups = read_tsv('resistance_groups.tsv')
```

## Organisms

I selected a list of organisms from the ones that were most abundant in the data:

`r organisms`

## Matching consumption and resistance drugs

I performed this matching by hand. I placed the consumption drugs into groups:

`r consumption_groups %>% kable`

And did the same with the resistance drugs:

`r resistance_groups %>% kable`

I chose not to merge the penicillin and amoxicillin groups because antibiograms often reported very different susceptibilities for the two drugs.

## Consumption and resistance data

```{r load_data}
hrr = read_tsv('../../../db/hrr/hrr.tsv') %>%
  filter(year==2011) %>%
  select(zipcode, hrr)

# Antibiogram data, with individual records
abg = read_tsv('../../../../antibiogram/data/abg.tsv', col_types=cols(zipcode='c')) %>%
  filter(!is.na(n_isolates), n_isolates > 0) %>%
  mutate(drug=tolower(drug), percent_nonsusceptible=100-percent_susceptible) %>%
  left_join(hrr, by='zipcode') %>%
  right_join(resistance_groups, by='drug') %>%
  filter(bug %in% organisms) %>%
  select(bug, drug_group, state, hrr, percent_nonsusceptible, n_isolates)

# Keep only those bug/drug combinations that are in at least 20 states
abg %<>%
  select(bug, drug_group, state) %>%
  distinct %>%
  count(bug, drug_group) %>% rename(n_states=n) %>%
  filter(n_states >= 20) %>%
  left_join(abg, by=c('bug', 'drug_group'))

summarize_abg = function(df, place_name) {
  group_by_(df, 'bug', 'drug_group', place_name) %>%
    summarize(mean_percent_nonsusceptible=weighted.mean(percent_nonsusceptible, sqrt(n_isolates)),
              n_place_antibiograms=n()) %>%
    mutate(place_weight=sqrt(n_place_antibiograms))
}

abg_state_dat = summarize_abg(abg, 'state')
abg_hrr_dat = summarize_abg(abg, 'hrr')

# swo> State beneficiary information could be used as control variables
# in regressions
#state_bene = read_tsv('../../bene-consumption/state-bene-2011.tsv') %>%
  #filter(state %in% known_states)
```

```{r load_consumption_data}
state_usage = read_tsv('../bene-consumption/state_usage.tsv') %>%
  filter(year==2011) %>%
  right_join(consumption_groups, by=c('antibiotic'='drug')) %>%
  group_by(state, drug_group) %>%
  summarize_at(vars(cpkp, did), sum) %>%
  ungroup()

hrr_usage = read_tsv('../bene-consumption/hrr_usage.tsv') %>%
  filter(year==2011) %>%
  right_join(consumption_groups, by=c('antibiotic'='drug')) %>%
  group_by(hrr, drug_group) %>%
  summarize_at(vars(cpkp, did), sum) %>%
  ungroup()

state_dat = left_join(abg_state_dat, state_usage, by=c('drug_group', 'state')) %>%
  rename(place=state)
hrr_dat = left_join(abg_hrr_dat, hrr_usage, by=c('drug_group', 'hrr')) %>%
  rename(place=hrr)
```

```{r run_models}
pvalue_stars = function(x) {
  case_when(x < 0.001 ~ '***',
            x < 0.01 ~ '**',
            x < 0.05 ~ '*',
            x < 0.1 ~ 'o',
            TRUE ~ '')
}

linear_model_formula = function(independent_var, explanatory_vars) {
  paste0(independent_var, ' ~ ', paste0(explanatory_vars, collapse = ' + ')) %>% formula
}

linear_models = function(df, independent_var, explanatory_vars) {
  f = linear_model_formula(independent_var, explanatory_vars)
  lm(formula=f, weights=place_weight, data=df) %>% tidy
}

spearman_model = function(df, independent_var, explanatory_vars) {
  cor.test(df[[independent_var]], df[[explanatory_vars]], method='spearman') %>% tidy
}

models_result = function(df) {
  group_by(df, bug, drug_group) %>%
    do(linear_models(., 'mean_percent_nonsusceptible', 'cpkp')) %>%
    ungroup %>%
    filter(term=='cpkp') %>%
    mutate(adj.p.value=p.adjust(p.value, method='BH'),
           sig=pvalue_stars(adj.p.value))
   # %>%
    #mutate(record_number=1:n(),
    #       plot_fn=sprintf('plots/%s_%03i.pdf', this_place, record_number),
    #       plot_link=pandoc.link.return(url=plot_fn, text='plot')) %>%
    #select(bug, drug_group,
    #       explanatory, correlation=estimate, p.value,
    #       adj.p.value, sig,
    #       plot_fn, plot_link)
}

cor_models_result = function(df) {
  group_by(df, bug, drug_group) %>%
    do(spearman_model(., 'mean_percent_nonsusceptible', 'cpkp')) %>%
    ungroup %>%
    #filter(term=='cpkp') %>%
    mutate(adj.p.value=p.adjust(p.value, method='BH'),
           sig=pvalue_stars(adj.p.value))
}

state_res = models_result(state_dat)
hrr_res = models_result(hrr_dat)

result = bind_rows(
  state_res %>% mutate(place_type='state'),
  hrr_res %>% mutate(place_type='hrr')
)

cor_result = bind_rows(
  cor_models_result(state_dat) %>% mutate(place_type='state'),
  cor_models_result(hrr_dat) %>% mutate(place_type='hrr')
)
```

```{r make_plots, eval=FALSE}
unlink('plots/*.pdf')

for (i in 1:nrow(result)) {
  row = result[i,]
  
  if (row$place == 'state') {
    plot_dat = state_dat
  } else if (row$place == 'hrr') {
    plot_dat = hrr_dat
  } else {
    plot_dat = NULL
  }

  p = plot_dat %>%
    filter(bug==row$bug, drug_group==row$drug_group) %>%
    ggplot(aes_string(row$explanatory, 'percent_nonsusceptible')) +
    geom_point(shape=1) +
    xlab(row$explanatory) +
    ylab('percent non-susceptible') +
    theme_minimal()

  ggsave(row$plot_fn, plot=p)
}
```

# Results

## Consumption and resistance

Here a relationship where increased consumption leads to increased nonsusceptibility is encoded in a positive correlation.

### Resistance-averaged results

In these results, the percent nonsusceptible in each geography (state or HRR) was averaged, and the averages of the nonsusceptibilities were compared against the consumption data.

#### State-level, resistance-averaged linear models

```{r state_average_results_table}
result %>%
  filter(place_type=='state') %>%
  mutate_if(is.numeric, function(x) signif(x, digits=3)) %>%
  select(bug, drug_group,
         term, estimate, std.error,
         adj.p.value, sig
         #,plot_link
         ) %>%
  kable
```

(red line marks $p = 0.05$).

```{r state_average_volcano}
result %>%
  filter(place_type=='state') %>%
  ggplot(aes(x=estimate, y=adj.p.value)) +
  geom_point() +
  geom_hline(yintercept=0.05, col='red') +
  xlab('slope') + ylab('p value (reversed)') +
  scale_y_reverse() +
  theme_minimal()
```

#### HRR-level, resistance-averaged linear models

```{r hrr_average_results_table}
result %>%
  filter(place_type=='hrr') %>%
  mutate_if(is.numeric, function(x) signif(x, digits=3)) %>%
  select(bug, drug_group,
         term, estimate, std.error,
         adj.p.value, sig
         #,plot_link
         ) %>%
  kable
```

(red line marks $p = 0.05$).

```{r hrr_average_volcano}
result %>%
  filter(place_type=='hrr') %>%
  ggplot(aes(x=estimate, y=adj.p.value)) +
  geom_point() +
  geom_hline(yintercept=0.05, col='red') +
  xlab('slope') + ylab('p value (reversed)') +
  scale_y_reverse() +
  theme_minimal()
```

#### State-level resistance-averaged robust regressions

```{r}
mblm_model = function(df, independent_var, explanatory_vars) {
  f = linear_model_formula(independent_var, explanatory_vars)
  mblm(f, dataframe=df) %>% tidy
}

mblm_models = function(df) {
  group_by(df, bug, drug_group) %>%
    do(mblm_model(., 'mean_percent_nonsusceptible', 'cpkp')) %>%
    ungroup %>%
    filter(term=='cpkp') %>%
    mutate(adj.p.value=p.adjust(p.value, method='BH'),
           sig=pvalue_stars(adj.p.value))
}

mblm_state_res = mblm_models(state_dat)
mblm_hrr_res = mblm_models(hrr_dat)

mblm_result = bind_rows(
  mblm_models(state_dat) %>% mutate(place_type='state'),
  mblm_models(hrr_dat) %>% mutate(place_type='hrr')
)
```

These results are fairly well-correlated with the linear models. I'll compare the slopes:

```{r}
left_join(result, mblm_result, by=c('bug', 'drug_group', 'place_type')) %>%
  filter(estimate.y > 1e-9) %>%
  ggplot(aes(x=estimate.x, y=estimate.y)) +
  geom_point() +
  geom_abline() + geom_smooth(method='lm') +
  xlab('weighted least squares slope') + ylab('robust regression slope') +
  theme_minimal()
```

And the $p$-values:

```{r}
left_join(result, mblm_result, by=c('bug', 'drug_group', 'place_type')) %>%
  ggplot(aes(x=p.value.x, y=p.value.y)) +
  geom_point() +
  geom_abline() + geom_hline(yintercept = 0.05) + geom_vline(xintercept = 0.05) +
  xlab('weighted least squares p') + ylab('robust regression p') +
  scale_x_log10() + scale_y_log10() +
  theme_minimal()
```

## Cor vs lm

I asked whether using Spearman correlations is better/different than using linear models. For the most part, they identify the same relationships.

```{r cor_vs_lm}
f = function(x) select(x, bug, drug_group, adj.p.value, place_type)
x = bind_rows(
  cor_result %>% f %>% mutate(model='cor'),
  result %>% f %>% mutate(model='lm')
) %>% spread(model, adj.p.value)

x %>% filter(place_type=='state') %>% ggplot(aes(x=lm, y=cor)) +
  geom_point() +
  scale_x_log10() + scale_y_log10() +
  geom_abline() + geom_hline(yintercept = 0.05) + geom_vline(xintercept = 0.05) +
  coord_fixed()

x %>% filter(cor < 0.05, lm > 0.05) %>% kable
```

# Discussion

## Correlations are overall weak

There were only a few significant results from these tests:

- CNST and quinolones (HRR only)
- *E. faecium* and penicillin (state only)
- *E. coli* with penicillin and quinolones (state & HRR)
- MSSA and macrolides (state only)
- MSSA and clindamycin (HRR only)
- *P. mirabilis* and quinolones (HRR only)
- Pneumococcus with macrolides (HRR; marginal in state)

Interestingly, this accords with some of the conclusions from @bell-systematic-2014, namely:

- the relationship between antibiotic consumption and resistance inside the US is weak (compared to across European countries, especially southern European countries)
- reliable consumption/resistance relationships were found for enteric bacteria and streptococcus (though, in contrast, not with *Staphylococcus*, which is one of our strongest correlations)
- among enteric bacteria, the only reliable consumption/resistance relationship was for quinolones