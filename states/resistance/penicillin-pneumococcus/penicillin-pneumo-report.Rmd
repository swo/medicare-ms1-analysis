---
title: "Pen-pneumo"
author: "Scott Olesen"
output: pdf_document
fontsize: 10pt
---

# Background

To compare against Goossens *et al.*, I wanted to compare the consumption of penicillin against the susceptibility of pneumococcus to penicillin. Because *S. pneumoniae* susceptibility to penicillin was not coherent at the state level, I wrote this result up separately. I do not filter the data used for coherence: I just run the correlations.

# Methods

```{r echo=FALSE}

library(broom)

bug = 'Streptococcus pneumoniae (non-meningitis)'
consumption_drug=c('amoxicillin', 'penicillin')
resistance_drug=c('ampicillin', 'penicillin')

bug_drug = expand.grid(bug=bug,
                       consumption_drug=consumption_drug,
                       resistance_drug=resistance_drug,
                       stringsAsFactors=FALSE)
```

I'm going to look at this one organism but a few consumption drugs and resistance drugs:

```{r echo=FALSE}
bug_drug
```

```{r echo=FALSE, message=FALSE}
abg = read_tsv('../../../../../antibiogram/data/abg.tsv') %>%
  mutate(drug=tolower(drug)) %>%
  rename(resistance_drug=drug)

known_states = abg %$% state %>% unique %>% sort

state_bene = read_tsv('../../bene-consumption/state-bene-2011.tsv') %>%
  filter(state %in% known_states)
state_cons = read_tsv('../../bene-consumption/state-consumption-2011.tsv') %>%
  filter(state %in% known_states) %>%
  rename(consumption_drug=drug)

sus = bug_drug %>%
  left_join(abg, by=c('bug', 'resistance_drug')) %>%
  group_by(bug, consumption_drug, resistance_drug, state) %>%
  summarize(n_abg=n(),
            n_isolates=sum(n_isolates, na.rm=TRUE),
            n_years=length(unique(year)),
            median_sus=median(percent_susceptible, na.rm=TRUE),
            mean_sus=mean(percent_susceptible, na.rm=TRUE),
            sd_sus=sd(percent_susceptible, na.rm=TRUE),
            min_sus=min(percent_susceptible, na.rm=TRUE),
            max_sus=max(percent_susceptible, na.rm=TRUE))
```

The susceptibility data:
```{r echo=FALSE}
sus
```

```{r echo=FALSE}
models = function(df) {
  out = data_frame()
  for (resp in c('median_sus', 'mean_sus', 'min_sus', 'max_sus')) {
    for (expl in c('claims_per_1k_ppl', 'did')) {
      new_rows = cor.test(df[[resp]], df[[expl]], method='spearman') %>%
        tidy %>%
        mutate(response=resp, explanatory=expl)
      out = bind_rows(out, new_rows)
    }
  }
  out
}

dat = sus %>%
  left_join(bug_drug, by=c('bug', 'consumption_drug', 'resistance_drug')) %>%
  left_join(state_cons, by=c('state', 'consumption_drug')) %>%
  group_by(bug, consumption_drug, resistance_drug)
```

The data used for correlations:
```{r echo=FALSE}
dat
```

The model results:
```{r echo=FALSE, warning=FALSE}
res = dat %>%
  do(models(.))
res
```

# Results

Of which, the statistically significant correlations are:

```{r echo=FALSE}
res %>%
  filter(p.value < 0.05) %>%
  select(bug, consumption_drug, resistance_drug, explanatory, response, correlation=estimate, p.value) %>%
  mutate(correlation=signif(correlation, digits=3), p.value=signif(p.value, digits=3)) %>%
  ungroup() %>%
  select(-bug) %>%
  t
```

Weirdly, these are *positive* correlations: more consumption means more susceptibility.

```{r echo=FALSE}
dat %>%
  filter(consumption_drug=='penicillin',
         resistance_drug=='penicillin') %>%
  ggplot(aes(x=claims_per_1k_ppl, y=mean_sus)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  xlab('claims per 1k people') +
  ylab('mean susceptibility (%)') +
  ggtitle('Pneumococcus sus. to pen. vs. pen. cons. by state') +
  theme_minimal()
```