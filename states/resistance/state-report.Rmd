---
title: "Consumption and resistance across states and HRRs"
bibliography: refs.bib
output:
  html_document:
    fig_height: 4
  pdf_document:
    fig_height: 3
---

# Background

Here I report results of comparisons antibiotic consumption and resistance across states and HRRs.

In a separate analysis, I determined that the antibiogram data in certain locales, separating the data into those locales decreased variance more than could be expected by chance. Thus, for some bug/drug combinations, it is sensible to break the antibiogram data from census regions down into states, while for other bug/drug combinations, it does not. Similarly, HRRs can be coherent or not.

# Methods

I used the Medicare Part D data from 2011. Only beneficiaries greater than 65 years old were used. I also used the antibiogram data. I pooled the antiobiograms from all years.

I selected a set of organisms in the antibiogram to examine. They mostly represent the most abundant organisms in the data. I also matched particular drugs in the consumption data to match to drugs in the resistance data.

For each bug, consumption/resistance drug, and state, I ran a Spearman correlation test and adjusted the $p$-values using the Benjamini-Hochberg method. I also separately adjusted the $p$-values considering only the tests performed on coherent bug/drug/state combinations. I performed a similar analysis using HRRs.

The explanatory variable in the correlation was either claims per 1,000 people per year (CPKP) or days' supply (my proxy for daily defined dose) per 1,000 people per day (DID). The dependent variable was always mean percent susceptibility of that bug to that resistance drug across antibiograms from that state/HRR.

# Results

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, cache=TRUE,
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r setup}
library(broom)
library(pander)

gram_negs = c('Escherichia coli', 'Klebsiella pneumoniae',
              'Proteus mirabilis', 'Enterobacter cloacae',
              'Klebisella oxytoca', 'Enterococcus faecium')
gram_poss = c('Coagulase-negative staphylococci',
              'Methicillin-resistant S. aureus (MRSA)',
              'Methicillin-susceptible S. aureus (MSSA)',
              'Streptococcus pneumoniae (non-meningitis)',
              'Staphylococcus aureus')
organisms = c(gram_negs, gram_poss)

consumption_drugs=c('trimethoprim/sulfamethoxazole', 'ciprofloxacin',
                    'levofloxacin', 'ceftriaxone', 'nitrofurantoin',
                    'amoxicillin', 'penicillin', 'doxycycline',
                    'azithromycin')
resistance_drugs=c('trimethoprim-sulfamethoxazole', 'ciprofloxacin',
                   'levofloxacin', 'ceftriaxone', 'nitrofurantoin',
                   'ampicillin', 'penicillin',
                   'tetracycline/doxycycline', 'erythromycin')

consumption_resistance = data_frame(consumption_drug=consumption_drugs,
                                    resistance_drug=resistance_drugs)

# get all bug/drug combos (i.e., all bug/cons drug combos with appropriate res drugs)
bug_drug = expand.grid(bug=organisms,
                       consumption_drug=consumption_drugs,
                       stringsAsFactors=FALSE) %>%
  left_join(consumption_resistance, by='consumption_drug') %>%
  select(bug, consumption_drug, resistance_drug)
```

## Matching consumption and resistance drugs

I performed this matching by hand.

`r consumption_resistance %>% kable`

```{r load_data}
coherence = read_tsv('../../../../antibiogram/analysis/geographic-coherence/coherences.tsv') %>%
  rename(resistance_drug=drug) %>%
  mutate(resistance_drug=tolower(resistance_drug),
         state=level %in% c('state', 'hrr', 'zipcode'),
         hrr=level %in% c('hrr', 'zipcode')) %>%
  select(bug, resistance_drug, state, hrr) %>%
  gather('place', 'coherent', state, hrr)

hrr = read_tsv('../../../db/hrr/hrr_2011.tsv') %>%
  select(zipcode, hrr)

# Antibiogram data, with individual records
abg = read_tsv('../../../../antibiogram/data/abg.tsv', col_types=cols(zipcode='c')) %>%
  mutate(drug=tolower(drug), percent_nonsusceptible=100-percent_susceptible) %>%
  rename(resistance_drug=drug) %>%
  left_join(hrr, by='zipcode') %>%
  select(bug, resistance_drug, state, hrr, percent_nonsusceptible)

# swo> State beneficiary information could be used as control variables
# in regressions
#state_bene = read_tsv('../../bene-consumption/state-bene-2011.tsv') %>%
  #filter(state %in% known_states)

# State-level consumption data
state_consumption = read_tsv('../bene-consumption/state_usage_2011.tsv') %>%
  rename(consumption_drug=antibiotic) %>%
  select(state, consumption_drug, cpkp, did)

hrr_consumption = read_tsv('../bene-consumption/hrr_usage_2011.tsv') %>%
  rename(consumption_drug=antibiotic) %>%
  select(hrr, consumption_drug, cpkp, did)

state_dat = bug_drug %>%
  left_join(abg, by=c('bug', 'resistance_drug')) %>%
  left_join(state_consumption, by=c('state', 'consumption_drug'))

hrr_dat = bug_drug %>%
  left_join(abg, by=c('bug', 'resistance_drug')) %>%
  left_join(hrr_consumption, by=c('hrr', 'consumption_drug'))
```

```{r run_models}
safe_spearman = function(df, expl, indep) {
  if (dim(df)[1] < 3L) {
    data_frame(estimate=NA, statistic=NA, p.value=NA, method=NA, alternative=NA)
  } else {
    cor.test(df[[indep]], df[[expl]], method='spearman') %>% tidy
  }
}

models = function(df, indep, keep=NULL) {
  lapply(c('cpkp', 'did'), function(expl) {
    safe_spearman(df, expl, indep) %>%
      mutate(explanatory=expl)
  }) %>%
    bind_rows
}

pvalue_stars = function(x) {
  case_when(x < 0.001 ~ '***',
            x < 0.01 ~ '**',
            x < 0.05 ~ '*',
            x < 0.1 ~ 'o',
            TRUE ~ '')
}

models_result = function(x, this_place, consumption) {
  result = x %>%
    group_by_('bug', 'resistance_drug', this_place) %>%
    summarize(mean_nonsus=mean(percent_nonsusceptible, na.rm=TRUE)) %>%
    left_join(bug_drug, by=c('bug', 'resistance_drug')) %>%
    left_join(consumption, by=c(this_place, 'consumption_drug')) %>%
    mutate_at(vars(cpkp, did), function(x) if_else(is.na(x), 0, x)) %>%
    group_by(bug, resistance_drug, consumption_drug) %>%
    do(models(., 'mean_nonsus')) %>%
    ungroup %>%
    filter(!is.na(estimate)) %>%
    mutate(adj.p.value=p.adjust(p.value, method='BH'),
           sig=pvalue_stars(adj.p.value)) %>%
    left_join(filter(coherence, place==this_place), by=c('bug', 'resistance_drug')) %>%
    mutate(record_number=1:n(),
           plot_fn=sprintf('plots/%s_%03i.pdf', this_place, record_number),
           plot_link=pandoc.link.return(url=plot_fn, text='plot')) %>%
    select(bug, consumption_drug, resistance_drug, coherent,
           explanatory, correlation=estimate, p.value,
           adj.p.value, sig,
           plot_fn, plot_link)
  
  # add adjusted p-values for just the coherent stuff
  # swo> there's probably a more elegant way to do this
  coherent.adj.p.value = result %>%
    filter(coherent) %$%
    p.adjust(p.value, method='BH')
  coherent.sig = pvalue_stars(coherent.adj.p.value)
  result$coherent.adj.p.value = NA
  result$coherent.sig = NA
  result$coherent.adj.p.value[result$coherent] = coherent.adj.p.value
  result$coherent.sig[result$coherent] = coherent.sig
  
  result
}

state_res = models_result(state_dat, 'state', state_consumption)
hrr_res = models_result(hrr_dat, 'hrr', hrr_consumption)

result = bind_rows(
  state_res %>% mutate(place='state'),
  hrr_res %>% mutate(place='hrr')
)
```

```{r make_plots}
unlink('plots/*.pdf')

for (i in 1:nrow(result)) {
  row = result[i,]
  
  if (row$place == 'state') {
    plot_dat = state_dat
  } else if (row$place == 'hrr') {
    plot_dat = hrr_dat
  } else {
    plot_dat = NULL
  }

  p = plot_dat %>%
    filter(bug==row$bug, consumption_drug==row$consumption_drug) %>%
    ggplot(aes_string(row$explanatory, 'percent_nonsusceptible')) +
    geom_point(shape=1) +
    xlab(row$explanatory) +
    ylab('percent non-susceptible') +
    theme_minimal()

  ggsave(row$plot_fn, plot=p)
}
```

## Consumption and resistance

Here a relationship where increased consumption leads to increased nonsusceptibility is encoded in a positive correlation.

### Geography-averaged results

In these results, the percent nonsusceptible in each geography (state or HRR) was averaged, and the averages of the nonsusceptibilities were compared against the consumption data.

#### State-level geography-averaged correlations

```{r state_average_results_table}
results %>%
  filter(place=='state') %>%
  mutate_if(is.numeric, function(x) signif(x, digits=3)) %>%
  select(bug, consumption_drug,
         coherent, explanatory, correlation,
         adj.p.value, sig,
         plot_link) %>%
  kable
```

There correlations are mostly positive, but only a small number are significant (red line marks $p = 0.05$):

```{r state_average_histogram}
result %>%
  filter(place=='state') %>%
  ggplot(aes(x=correlation, y=adj.p.value)) +
  geom_point() +
  geom_hline(yintercept=0.05, col='red') +
  xlab('correlation coefficient') + ylab('p value (reversed)') +
  scale_y_reverse() +
  theme_minimal()
```

### HRR

```{r}
hrr_res %>%
  mutate_if(is.numeric, function(x) signif(x, digits=3)) %>%
  select(bug, consumption_drug,
         hrr_coherent, explanatory, correlation,
         adj.p.value, sig,
         plot_link) %>%
  kable
```

### Coherent state

Second, I show the results from the coherent tests only. The $p$-values here are different because I adjusted those values using only this subset of tests.

```{r display_coherent_result}
coherent_state_res %>%
  mutate_if(is.numeric, function(x) signif(x, digits=3)) %>%
  select(bug, consumption_drug,
     explanatory, correlation,
     adj.p.value, sig,
     plot_link) %>%
  kable
```

### Coherent results from the HRR level

```{r}
coherent_hrr_res %>%
  mutate_if(is.numeric, function(x) signif(x, digits=3)) %>%
  select(bug, consumption_drug,
     explanatory, correlation,
     adj.p.value, sig,
     plot_link) %>%
  kable
```

### State, all points

And I try the same thing again, but this time keeping all the data points:

```{r correlations_with_all_points}
state_dat %>%
  mutate_at(vars(cpkp, did), function(x) if_else(is.na(x), 0, x)) %>%
  group_by(bug, resistance_drug, consumption_drug) %>%
  do(models(., 'percent_susceptible')) %>%
  ungroup %>%
  left_join(coherence, by=c('bug', 'resistance_drug')) %>%
  filter(!is.na(estimate), hrr_coherent) %>%
  mutate(adj.p.value=p.adjust(p.value, method='BH'),
         sig=pvalue_stars(adj.p.value)) %>%
  select(bug, consumption_drug, resistance_drug,
         explanatory, correlation=estimate, p.value,
         adj.p.value, sig) %>%
  mutate_if(is.numeric, function(x) signif(x, digits=3)) %>%
  kable
```

### HRR, all points

```{r}
hrr_dat %>%
  mutate_at(vars(cpkp, did), function(x) if_else(is.na(x), 0, x)) %>%
  group_by(bug, resistance_drug, consumption_drug) %>%
  do(models(., 'percent_susceptible')) %>%
  ungroup %>%
  left_join(coherence, by=c('bug', 'resistance_drug')) %>%
  filter(!is.na(estimate), state_coherent) %>%
  mutate(adj.p.value=p.adjust(p.value, method='BH'),
         sig=pvalue_stars(adj.p.value)) %>%
  select(bug, consumption_drug, resistance_drug,
         explanatory, correlation=estimate, p.value,
         adj.p.value, sig) %>%
  mutate_if(is.numeric, function(x) signif(x, digits=3)) %>%
  kable
```

# Discussion

## Future work

In the future, I intend to refine this analysis by:

- pooling various consumption drugs (e.g., cipro and levo consumption probably have comparable effects on cipro resistance)
- more intelligently pooling data from the different *S. aureus* designations (in the antibiogram data, *S. aureus* is reported as one of *S. aureus*, MRSA, or MSSA)
- comparing data from various years (i.e., is there any evidence that a consumption/resistance relationship changed drastically?)
- pooling data from various years (i.e., if the relationship doesn't change over years, we might get more power by including

## Correlations are overall weak

There were only a few significant results from these tests:

- *S. aureus* and azithromycin
- Potentially, a backward relationship for *S. aureus* and TMP-SMX
- *S. pneumoniae* and azithromycin
- *E. coli* and quinolones

Interestingly, this accords with some of the conclusions from @bell-systematic-2014, namely:

- the relationship between antibiotic consumption and resistance inside the US is weak (compared to across European countries, especially southern European countries)
- reliable consumption/resistance relationships were found for enteric bacteria and streptococcus (though, in contrast, not with *Staphylococcus*, which is one of our strongest correlations)
- among enteric bacteria, the only reliable consumption/resistance relationship was for quinolones