---
title: "Top antibiotic users"
author: "Scott Olesen"
date: "27 March 2017"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=4, 
                      echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE)
```

```{r}
pn = function(x) prettyNum(x, big.mark=',')
```

# Motivation

What drugs are the top users taking? Are they different from the drugs that people take in general? Are the patterns of drug-drug correlations different among the top users?

# Data

I use the 2011 Medicare data. I will sometimes exclude claims for the anti-tuberculosis drugs (ethambutol, rifampin, isoniazid, pyrazinamide) because many of the "top" users, depending on the defintion, are taking these drugs, which constitute a different problem.

I merged amoxicillin/clavulanate into amoxicillin.

```{r load_data}
bene = read_tsv('../bene_2011.tsv')
n_bene = nrow(bene)
pde = read_tsv('../pde_2011.tsv') %>%
  rename(drug=antibiotic) %>%
  mutate(drug=if_else(drug=='amoxicillin/clavulanate', 'amoxicillin', drug)) %>%
  group_by(bene_id, drug) %>%
  summarize(n_claims=n(), n_days=sum(days_supply)) %>%
  ungroup()
```

# Results

## Drug consumption sort-of follows a power law

That is, the *exponent* of the number of beneficiaries with a certain of claims *n* (or days' supply of drug) falls with *n*.

```{r drug_distribution}
pde_total = pde %>%
  group_by(bene_id) %>%
  summarize(n_total_claims=sum(n_claims), n_total_days=sum(n_days))

pde_total %>%
  count(n_total_claims) %>%
  ggplot(aes(x=n_total_claims, y=n)) +
  geom_point() +
  scale_y_log10() +
  xlab('number of claims') + ylab('number of beneficiaries') +
  theme_minimal()

pde_total %>%
  count(n_total_days) %>%
  ggplot(aes(x=n_total_days, y=n)) +
  geom_point() +
  scale_y_log10() +
  xlab('number of days\' supply') + ylab('number of beneficiaries') +
  theme_minimal()
```

## Top users by claim

```{r top_claims_use}
top_claims_cutoff = 15

# classify beneficiaries as in top bracket or not
top_claims_bene = pde %>%
  group_by(bene_id) %>%
  summarize(top = sum(n_claims) >= top_claims_cutoff)

n_top_claims_bene = sum(top_claims_bene$top)

top_claims_table = pde %>%
  left_join(top_claims_bene, by='bene_id') %>%
  group_by(drug, top) %>%
  summarize(n_claims=sum(n_claims)) %>%
  ungroup() %>%
  mutate(n_bene=if_else(top, n_top_claims_bene, n_bene - n_top_claims_bene),
         cpkp=n_claims*1000/n_bene) %>%
  select(drug, top, cpkp) %>%
  spread(top, cpkp) %>%
  arrange(desc(`TRUE`)) %>%
  head(20) %>%
  rename(`non-top user CPKP`=`FALSE`, `top user CPKP`=`TRUE`) %>%
  kable
```

Of `r pn(n_bene)` total beneficiaries, there are `r pn(n_top_claims_bene)` that had more than `r top_claims_cutoff` claims. In aggregate, their consumption looks fairly different from the rest of the population:

`r top_claims_table`

Notable differences include:

- More urinary anti-infectives (Bactrim, nitro, and trimethoprim)
- Much more vancomycin
- More anti-TB drugs (esp. rifampin, ethambutol)

## Top users by days

Measuring top users by claims biases toward people taking drugs that are given with short dosages.

```{r top_days_use}
# classify beneficiaries as in top bracket or not
top_days_bene = pde %>%
  group_by(bene_id) %>%
  summarize(top = sum(n_days) >= 365)

n_top_days_bene = sum(top_days_bene$top)

top_days_table = pde %>%
  left_join(top_days_bene, by='bene_id') %>%
  group_by(drug, top) %>%
  summarize(n_days=sum(n_days)) %>%
  ungroup() %>%
  mutate(n_bene=if_else(top, n_top_days_bene, n_bene - n_top_days_bene),
         did=n_days*1000/(365*n_bene)) %>%
  select(drug, top, did) %>%
  spread(top, did) %>%
  arrange(desc(`TRUE`)) %>%
  head(20) %>%
  rename(`non-top user DID`=`FALSE`, `top user DID`=`TRUE`) %>%
  kable
```

Of `r pn(n_bene)` total beneficiaries, there are `r pn(n_top_days_bene)` that had more than 365 days of days' supply. In aggregate, their consumption looks fairly different from the rest of the population:

`r top_days_table`

The drugs that make it into the top-days-users top list are similar to those from the top-claims-users, except that vancomycin is missing here.

## Top claims, no anti-TB

I worry that we're mostly selecting for people who have TB when doing these analyses, so I did a different version where I excluded the TB drugs:

```{r tb_drugs}
tb_drugs = c('isoniazid', 'rifabutin', 'rifampin', 'rifampin/isoniazid', 'rifampin/isoniazid/pyrazinamide', 'rifapentine', 'rifaximin', 'pyrazinamide', 'ethambutol')
stopifnot(all(tb_drugs %in% unique(pde$drug)))

data_frame(drug=tb_drugs) %>% kable
```

```{r top_claims_notb}
top_notb_cutoff = 15

# classify beneficiaries as in top bracket or not
top_notb_bene = pde %>%
  filter(!(drug %in% tb_drugs)) %>%
  group_by(bene_id) %>%
  summarize(top = sum(n_claims) >= top_notb_cutoff)

n_top_notb_bene = sum(top_notb_bene$top)

top_notb_table = pde %>%
  left_join(top_notb_bene, by='bene_id') %>%
  group_by(drug, top) %>%
  summarize(n_claims=sum(n_claims)) %>%
  ungroup() %>%
  mutate(n_bene=if_else(top, n_top_notb_bene, n_bene - n_top_notb_bene),
         cpkp=n_claims*1000/n_bene) %>%
  select(drug, top, cpkp) %>%
  spread(top, cpkp) %>%
  arrange(desc(`TRUE`)) %>%
  head(20) %>%
  rename(`non-top user CPKP`=`FALSE`, `top user CPKP`=`TRUE`) %>%
  kable
```

`r top_notb_table`

The results don't seem like they change that much.